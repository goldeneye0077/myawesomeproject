{% extends "base.html" %}
{% block title %}PUEæ•°æ®åˆ†æ{% endblock %}
{% block content %}
<div class="main-flex-row" style="display: flex; gap: 24px; align-items: flex-start; min-width:0; width:100%; box-sizing:border-box; position:relative; z-index:1;">
    <!-- å·¦ä¾§ä¸»å†…å®¹åŒº -->
    <div style="flex: 7 1 0; min-width:0; max-width: 70%; display: flex; flex-direction: column; gap: 24px; box-sizing:border-box; overflow-x:auto;">
        <div class="card" style="width:100%; box-sizing:border-box;">
            <div class="card-title" style="margin-bottom: 0;">PUEæŒ‡æ ‡æ•°æ®åˆ†æ</div>
            <div style="display: flex; flex-direction: column; align-items: stretch; width: 100%; gap: 12px; min-width: 0; box-sizing:border-box;">
                <form method="get" id="locationForm" style="margin-bottom: 0; display: flex; gap: 18px; align-items: center; flex-wrap: nowrap; min-width:0; width:100%; max-width:100%;">
                    <div style="display:flex; gap:18px; align-items:center; flex:1 1 0; min-width:0; max-width:100%; overflow:hidden;">
                    {% for loc in all_locations %}
                    <label style="margin-right: 10px; white-space: nowrap;">
                        <input type="radio" name="location" value="{{ loc }}" {% if current_location==loc %}checked{% endif %} onchange="document.getElementById('locationForm').submit();">
                        {{ loc }}
                    </label>
                    {% endfor %}
                    <label style="margin-right: 10px; white-space: nowrap;">
                        <input type="radio" name="location" value="" {% if not current_location %}checked{% endif %} onchange="document.getElementById('locationForm').submit();">
                        å…¨éƒ¨
                    </label>
                    </div>
                </form>
                <div style="width:100%; min-width:0;">
                    {{ pue_bar_chart|safe }}
                </div>
                
                
                <!-- ä¸‹é’»å¼¹çª— -->
                <div id="drillDownModal" class="drill-down-modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="modalTitle">PUEæŒ‡æ ‡ä¸‹é’»è¯¦æƒ…</h3>
                            <span class="close-btn" onclick="closeDrillDownModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div id="modalLoading" class="loading-spinner">åŠ è½½ä¸­...</div>
                            <div id="modalContent" style="display: none;">
                                <div class="drill-down-table-container">
                                    <table class="drill-down-table">
                                        <thead>
                                            <tr>
                                                <th>åºå·</th>
                                                <th>ä½œä¸šå½¢å¼</th>
                                                <th>ä½œä¸šåˆ†ç±»</th>
                                                <th>ä½œä¸šå¯¹è±¡</th>
                                                <th>æ£€æŸ¥é¡¹</th>
                                                <th>æ‰§è¡Œæƒ…å†µ</th>
                                                <th>æ‰§è¡Œäºº</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="drillDownTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="modalError" style="display: none; color: #e53935; text-align: center; padding: 20px;">
                                åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- å³ä¾§ï¼šçº¢ç»¿ç¯+æŠ˜çº¿å›¾ -->
    <div style="flex: 3 1 0; min-width:220px; max-width:30%; display: flex; flex-direction: column; gap: 18px; align-items: stretch; box-sizing:border-box; position:relative; z-index:1;">
        <div style="background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #eee; padding: 14px 18px 8px 18px; display: flex; flex-direction: column; justify-content: flex-start; align-self: stretch; box-sizing:border-box;">
            <div style="font-weight: bold; font-size: 1.05em; margin-bottom: 8px;">çº¢ç»¿ç¯é¢„è­¦æ¿ï¼ˆåŒæ¯”ä½äºå»å¹´é»„ç¯ï¼Œè¿ç»­ä¸¤æœˆçº¢ç¯ï¼‰</div>
            <hr style="border:none;border-top:1px solid #e0e0e0;margin:0 0 10px 0;">
            <div style="display: flex; align-items: center; margin-bottom: 12px; color:#f44336;">
                <span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#f44336;margin-right:10px;flex-shrink:0;"></span>
                {% if red_months %}
                    {% for m in red_months %}<span style="margin-right:8px;">{{ m }}æœˆ</span>{% endfor %}
                {% else %}æ— {% endif %}
            </div>
            <div style="display: flex; align-items: center; margin-bottom: 12px; color:#ff9800;">
                <span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#ff9800;margin-right:10px;flex-shrink:0;"></span>
                {% if yellow_months %}
                    {% for m in yellow_months %}<span style="margin-right:8px;">{{ m }}æœˆ</span>{% endfor %}
                {% else %}æ— {% endif %}
            </div>
            <div style="display: flex; align-items: center; color:#4caf50;">
                <span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#4caf50;margin-right:10px;flex-shrink:0;"></span>
                {% if green_months %}
                    {% for m in green_months %}<span style="margin-right:8px;">{{ m }}æœˆ</span>{% endfor %}
                {% else %}æ— {% endif %}
            </div>
        </div>
        {% if line_chart_html %}
        <div style="background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #eee; padding: 10px 16px; width: 100%; box-sizing:border-box;">
            {{ line_chart_html|safe }}
        </div>
        {% endif %}
    </div>
</div>
<!-- åˆ†å‰²ä¸»åˆ†æåŒºå’Œå¤šç»´è¡¨ï¼Œé¿å…é‡å  -->
<div style="height:32px; width:100%; clear:both;"></div>

<style>
.ai-loading-spinner {
  display: inline-block;
  width: 22px;
  height: 22px;
  border: 3px solid #e3e8f0;
  border-top: 3px solid #3498db;
  border-radius: 50%;
  animation: ai-spin 0.8s linear infinite;
  vertical-align: middle;
}
@keyframes ai-spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ä¸‹é’»å¼¹çª—æ ·å¼ */
.drill-down-modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  backdrop-filter: blur(2px);
}

.modal-content {
  background-color: #fefefe;
  margin: 3% auto;
  border-radius: 12px;
  width: 90%;
  max-width: 1200px;
  max-height: 85vh;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  overflow: hidden;
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from { transform: translateY(-50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  background: linear-gradient(135deg, #3498db, #2980b9);
  color: white;
  padding: 20px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.close-btn {
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 1;
  opacity: 0.8;
  transition: opacity 0.2s;
}

.close-btn:hover {
  opacity: 1;
}

.modal-body {
  padding: 24px;
  max-height: 70vh;
  overflow-y: auto;
}

.loading-spinner {
  text-align: center;
  padding: 40px;
  color: #666;
}

.drill-down-table-container {
  overflow-x: auto;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
}

.drill-down-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.drill-down-table th {
  background-color: #f8f9fa;
  color: #333;
  font-weight: 600;
  padding: 12px 8px;
  text-align: left;
  border-bottom: 2px solid #dee2e6;
  white-space: nowrap;
}

.drill-down-table td {
  padding: 10px 8px;
  border-bottom: 1px solid #e9ecef;
  vertical-align: top;
}

.drill-down-table tbody tr:hover {
  background-color: #f8f9fa;
}

.detail-btn {
  background: #3498db;
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  transition: background-color 0.2s;
}

.detail-btn:hover {
  background: #2980b9;
}

.work-item-detail {
  background: #f8f9fa;
  padding: 12px;
  margin: 8px 0;
  border-radius: 6px;
  border-left: 4px solid #3498db;
}

.work-item-detail h4 {
  margin: 0 0 8px 0;
  color: #2c3e50;
  font-size: 14px;
}

.work-item-detail p {
  margin: 4px 0;
  font-size: 13px;
  line-height: 1.4;
}

.work-item-detail .label {
  font-weight: 600;
  color: #34495e;
}
</style>
<!-- AIæ™ºèƒ½åˆ†æå¡ç‰‡ç‹¬ç«‹æ”¾ç½®åœ¨ä¸»å†…å®¹å’Œå¤šç»´è¡¨ä¹‹é—´ -->
<div class="card" style="margin: 0 0 24px 0; background:#f7f7fb; border-left:4px solid #3498db; padding:16px;">
    <div style="font-weight:bold; color:#3498db; margin-bottom:4px; display:flex; align-items:center; gap:18px;">
      <span>AIæ™ºèƒ½åˆ†æä¸é¢„æµ‹ï¼ˆDeepseek R1 æ·±åº¦æ€è€ƒï¼‰</span>
      <button id="start-ai-analysis" style="background:#3498db; color:#fff; border:none; border-radius:4px; padding:4px 16px; font-size:14px; cursor:pointer;">å¼€å§‹åˆ†æ</button>
    </div>
    <div id="ai-analysis-box" style="white-space:pre-line; max-height:140px; overflow-y:auto; line-height:1.7; font-size:15px; padding-right:6px; transition:max-height 0.3s; color:#888;"></div>
    <button id="toggle-ai-analysis" style="margin-top:8px; background:#eaf3fb; border:none; color:#3498db; padding:4px 14px; border-radius:4px; cursor:pointer; display:none;">å±•å¼€å…¨éƒ¨</button>
    <script>
    const box = document.getElementById('ai-analysis-box');
    const btn = document.getElementById('toggle-ai-analysis');
    const startBtn = document.getElementById('start-ai-analysis');
    let expanded = false;
    const aiLocation = "{{ current_location or '' }}";
    // å…¨å±€å˜é‡
    window.userRole = "{{ user_role or 'guest' }}";
    btn.onclick = function() {
        expanded = !expanded;
        if (expanded) {
            box.style.maxHeight = '1000px';
            btn.textContent = 'æ”¶èµ·';
        } else {
            box.style.maxHeight = '140px';
            btn.textContent = 'å±•å¼€å…¨éƒ¨';
            box.scrollTop = 0;
        }
    }
    startBtn.onclick = function() {
        box.innerHTML = '<div class="ai-loading-spinner"></div><span style="margin-left:12px; color:#888; vertical-align:middle;">AIåˆ†æç”Ÿæˆä¸­â€¦</span>';
        box.style.color = '#888';
        btn.style.display = 'none';
        startBtn.disabled = true;
        startBtn.textContent = 'åˆ†æä¸­...';
        fetch(`/pue_ai_analysis?location=${encodeURIComponent(aiLocation)}`)
          .then(resp => resp.json())
          .then(data => {
            box.innerText = data.ai_analysis || 'AIåˆ†æç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
            box.style.color = '#222';
            // è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦æ˜¾ç¤ºå±•å¼€æŒ‰é’®
            setTimeout(function(){
              if(box.scrollHeight > 150){ btn.style.display = ''; } else { btn.style.display = 'none'; }
            }, 50);
            startBtn.disabled = false;
            startBtn.textContent = 'é‡æ–°åˆ†æ';
          }).catch(() => {
            box.textContent = 'AIåˆ†æç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
            box.style.color = '#e53935';
            startBtn.disabled = false;
            startBtn.textContent = 'é‡æ–°åˆ†æ';
          });
    }
    
    // PUEä¸‹é’»å¼¹çª—åŠŸèƒ½
    function showDrillDownModal(location, month, year) {
        const modal = document.getElementById('drillDownModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalLoading = document.getElementById('modalLoading');
        const modalContent = document.getElementById('modalContent');
        const modalError = document.getElementById('modalError');
        
        // è®°å½•å½“å‰æŸ¥è¯¢å‚æ•°ä¾›å¯¼å‡ºç­‰åŠŸèƒ½ä½¿ç”¨
    window.currentDrillDownQuery = { location, year, month };
    // è®¾ç½®æ ‡é¢˜
        const locationText = location ? location : 'å…¨éƒ¨åœ°ç‚¹';
        modalTitle.textContent = `${locationText} - ${year}å¹´${month}æœˆ PUEæŒ‡æ ‡ä¸‹é’»è¯¦æƒ…`;
        
        // æ˜¾ç¤ºå¼¹çª—å’ŒåŠ è½½çŠ¶æ€
        modal.style.display = 'block';
        modalLoading.style.display = 'block';
        modalContent.style.display = 'none';
        modalError.style.display = 'none';
        
        // æ„å»ºAPIè¯·æ±‚URL
        let apiUrl = '/pue_drill_down_data?';
        if (location) apiUrl += `location=${encodeURIComponent(location)}&`;
        apiUrl += `month=${month}&year=${year}`;
        
        // è·å–ä¸‹é’»æ•°æ®
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                modalLoading.style.display = 'none';
                if (data.success && data.data.length > 0) {
                    buildDrillDownTabs(location, month, year);
                    renderDrillDownData(data.data);
                    if(location){
                        renderTrendChart(location, month, year);
                    }
                    modalContent.style.display = 'block';
                } else {
                    modalError.textContent = 'æš‚æ— è¯¥æ—¶é—´æ®µçš„è¯¦ç»†æ•°æ®';
                    modalError.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('è·å–ä¸‹é’»æ•°æ®å¤±è´¥:', error);
                modalLoading.style.display = 'none';
                modalError.style.display = 'block';
            });
    }
    
    // æ„å»ºTabç»“æ„ï¼ˆæ¯æ¬¡æ‰“å¼€å¼¹çª—éƒ½ä¼šé‡æ–°ç»‘å®šäº‹ä»¶å¹¶åŠ è½½å¯¹åº”å¹´æœˆæ•°æ®ï¼‰
    function buildDrillDownTabs(location, month, year){
    // è‹¥å·²å­˜åœ¨æ—§çš„Tabå®¹å™¨åˆ™å…ˆç§»é™¤ï¼Œç¡®ä¿æ¯æ¬¡æ‰“å¼€å¼¹çª—éƒ½ä¼šé‡æ–°ç»‘å®šäº‹ä»¶å¹¶åŠ è½½å¯¹åº”å¹´æœˆæ•°æ®
    const old = document.getElementById('tab-container');
    if(old){
        old.remove();
    }
        modalContent.innerHTML = `
        <style>
        .tab-headers{display:flex;border-bottom:1px solid #ddd;margin-bottom:4px;}
.drawer-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.3);z-index:1100;display:flex;justify-content:flex-end;}
.drawer{width:400px;height:100%;background:#fff;box-shadow:-2px 0 6px rgba(0,0,0,.1);display:flex;flex-direction:column;}
.drawer-header{padding:16px;border-bottom:1px solid #eee;font-size:16px;font-weight:600;display:flex;justify-content:space-between;align-items:center;}
.drawer-close{cursor:pointer;font-size:22px;line-height:1;}
.drawer-body{padding:16px;overflow-y:auto;flex:1 1 auto;}
        .tab-headers span{padding:6px 14px;cursor:pointer;}
        .tab-headers .active{border-bottom:2px solid #3498db;color:#3498db;font-weight:600;}
        .tab-body{display:none;}
        .tab-body.active{display:block;}
        .filter-bar{margin:6px 0;display:flex;gap:12px;align-items:center;}
        /* æ ¹å› åˆ†ææ ·å¼ */
        .rootcause-tab-headers .rootcause-tab{padding:8px 16px;cursor:pointer;border-bottom:2px solid transparent;font-size:14px;}
        .rootcause-tab-headers .rootcause-tab.active{border-bottom-color:#3498db;color:#3498db;font-weight:600;}
        .rootcause-tab-body{display:none;}
        .rootcause-tab-body.active{display:block;}
        .w-analysis-card{background:#fff;border:1px solid #e0e0e0;border-radius:6px;padding:16px;}
        .w-analysis-card h4{margin:0 0 12px 0;color:#2c3e50;font-size:15px;}
        .factor-list{font-size:13px;line-height:1.6;}
        .factor-list .factor-item{padding:4px 0;border-bottom:1px dashed #eee;}
        .factor-item .severity{float:right;padding:2px 6px;border-radius:3px;font-size:11px;}
        .severity.high{background:#e74c3c;color:white;}
        .severity.medium{background:#f39c12;color:white;}
        .severity.low{background:#27ae60;color:white;}
        </style>
        <div id="tab-container">
            <div class="tab-headers">
                <span class="tab" data-t="trend">è¶‹åŠ¿</span>
                <span class="tab active" data-t="table">è¡¨æ ¼</span>
                <span class="tab" data-t="compare">å¯¹æ¯”</span>
                <span class="tab" data-t="rootcause">æ ¹å› åˆ†æ</span>
                <span class="tab" data-t="note">å¤‡æ³¨</span>
            </div>
            <div class="tab-body" id="tab-trend">
                <div id="trendChart" style="height:120px;margin:6px 0;"></div>
            </div>
            <div class="tab-body active" id="tab-table">
                <div id="table-wrapper" style="display:block;width:100%;">
                    <div class="table-toolbar" style="margin:6px 0;font-size:12px;display:flex;justify-content:space-between;align-items:center;">
                        <div style="display:flex;align-items:center;gap:6px;">
                            å…³é”®å­—ï¼š<input id="abnormal-kw" style="width:200px;padding:2px 4px;" placeholder="å·²æ•´æ”¹" value="å·²æ•´æ”¹" />
                            <button id="btn-apply-abnormal" style="padding:2px 8px;">æ ‡è®°</button>
                        </div>
                        <div>
                            <button id="btn-export" style="padding:4px 10px;">å¯¼å‡ºCSV</button>
                            <button id="btn-export-pdf" style="padding:4px 10px;">å¯¼å‡ºPDF</button>
                            <button id="btn-export-excel" style="padding:4px 10px;">å¯¼å‡ºExcel</button>
                        </div>
                    </div>
                    <table class="drill-table">
                        <thead>
                            <tr>
                                <th>åºå·</th><th>ä½œä¸šå½¢å¼</th><th>ä½œä¸šåˆ†ç±»</th><th>ä½œä¸šå¯¹è±¡</th>
                                <th>æ£€æŸ¥é¡¹</th><th>æ‰§è¡Œæƒ…å†µ</th><th>æ‰§è¡Œäºº</th><th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="drillDownTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="tab-body" id="tab-compare">
                <div style="display:flex;gap:12px;flex-wrap:wrap;padding:16px;">
                    <div id="statusChart" style="width:320px;height:220px;border:1px solid #eee;"></div>
                    <div id="categoryChart" style="flex:1;min-width:320px;height:220px;border:1px solid #eee;"></div>
                </div>
            </div>
            <div class="tab-body" id="tab-rootcause">
                <div style="padding:16px;">
                    <!-- æ ¹å› åˆ†æå­Tab -->
                    <div class="rootcause-tabs">
                        <div class="rootcause-tab-headers" style="display:flex;border-bottom:1px solid #ddd;margin-bottom:16px;">
                            <span class="rootcause-tab active" data-rt="correlation">å…³è”æ€§åˆ†æ</span>
                            <span class="rootcause-tab" data-rt="pareto">å¸•ç´¯æ‰˜åˆ†æ</span>
                            <span class="rootcause-tab" data-rt="fishbone">é±¼éª¨å›¾åˆ†æ</span>
                            <span class="rootcause-tab" data-rt="5w">äº”ä¸ªWåˆ†æ</span>
                        </div>
                        
                        <!-- å…³è”æ€§åˆ†æ -->
                        <div class="rootcause-tab-body active" id="rc-correlation">
                            <div style="display:flex;gap:16px;flex-wrap:wrap;">
                                <div style="flex:1;min-width:300px;">
                                    <h4>æ‰§è¡Œæƒ…å†µä¸å„å› ç´ å…³è”åº¦</h4>
                                    <div id="correlationChart" style="height:250px;border:1px solid #eee;"></div>
                                </div>
                                <div style="flex:1;min-width:300px;">
                                    <h4>å…³è”åº¦çŸ©é˜µ</h4>
                                    <div id="correlationMatrix" style="height:250px;border:1px solid #eee;"></div>
                                </div>
                            </div>
                            <div style="margin-top:16px;">
                                <h4>å…³è”æ€§ç»Ÿè®¡è¡¨</h4>
                                <div id="correlationTable" style="max-height:200px;overflow-y:auto;"></div>
                            </div>
                        </div>
                        
                        <!-- å¸•ç´¯æ‰˜åˆ†æ -->
                        <div class="rootcause-tab-body" id="rc-pareto">
                            <div style="display:flex;gap:16px;flex-wrap:wrap;">
                                <div style="flex:2;min-width:400px;">
                                    <h4>å¸•ç´¯æ‰˜å›¾ - é—®é¢˜å½±å“å› ç´ æ’åº</h4>
                                    <div id="paretoChart" style="height:300px;border:1px solid #eee;"></div>
                                </div>
                                <div style="flex:1;min-width:250px;">
                                    <h4>å…³é”®å› ç´ è¯†åˆ«</h4>
                                    <div id="paretoSummary" style="background:#f8f9fa;padding:12px;border-radius:4px;">
                                        <div class="pareto-item">
                                            <strong>ä¸»è¦å› ç´  (80%)</strong>
                                            <div id="majorFactors"></div>
                                        </div>
                                        <div class="pareto-item" style="margin-top:12px;">
                                            <strong>æ¬¡è¦å› ç´  (20%)</strong>
                                            <div id="minorFactors"></div>
                                        </div>
                                    </div>
                                    <div style="margin-top:16px;">
                                        <h4>æ”¹è¿›å»ºè®®</h4>
                                        <div id="paretoRecommendations" style="font-size:13px;line-height:1.6;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é±¼éª¨å›¾åˆ†æ -->
                        <div class="rootcause-tab-body" id="rc-fishbone">
                            <div style="text-align:center;margin-bottom:16px;">
                                <h4>PUEæŒ‡æ ‡é—®é¢˜é±¼éª¨å›¾åˆ†æ</h4>
                                <div style="font-size:12px;color:#666;">ä»äººå‘˜ã€è®¾å¤‡ã€æ–¹æ³•ã€ç¯å¢ƒå››ä¸ªç»´åº¦åˆ†æé—®é¢˜æ ¹å› </div>
                            </div>
                            <div id="fishboneContainer" style="position:relative;height:400px;border:1px solid #eee;background:#fafafa;">
                                <svg id="fishboneSvg" width="100%" height="100%"></svg>
                            </div>
                            <div style="margin-top:16px;display:flex;gap:16px;flex-wrap:wrap;">
                                <div style="flex:1;min-width:200px;">
                                    <h5>ğŸ‘¥ äººå‘˜å› ç´ </h5>
                                    <div id="peopleFactors" class="factor-list"></div>
                                </div>
                                <div style="flex:1;min-width:200px;">
                                    <h5>âš™ï¸ è®¾å¤‡å› ç´ </h5>
                                    <div id="equipmentFactors" class="factor-list"></div>
                                </div>
                                <div style="flex:1;min-width:200px;">
                                    <h5>ğŸ“‹ æ–¹æ³•å› ç´ </h5>
                                    <div id="methodFactors" class="factor-list"></div>
                                </div>
                                <div style="flex:1;min-width:200px;">
                                    <h5>ğŸŒ ç¯å¢ƒå› ç´ </h5>
                                    <div id="environmentFactors" class="factor-list"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 5Wåˆ†æ -->
                        <div class="rootcause-tab-body" id="rc-5w">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;">
                                <div class="w-analysis-card">
                                    <h4>ğŸ‘¤ Who - è°ï¼ˆäººå‘˜åˆ†æï¼‰</h4>
                                    <div id="whoAnalysis">
                                        <div id="whoChart" style="height:200px;"></div>
                                        <div id="whoSummary" style="margin-top:8px;font-size:13px;"></div>
                                    </div>
                                </div>
                                <div class="w-analysis-card">
                                    <h4>ğŸ“ What - ä»€ä¹ˆï¼ˆé—®é¢˜åˆ†æï¼‰</h4>
                                    <div id="whatAnalysis">
                                        <div id="whatChart" style="height:200px;"></div>
                                        <div id="whatSummary" style="margin-top:8px;font-size:13px;"></div>
                                    </div>
                                </div>
                                <div class="w-analysis-card">
                                    <h4>ğŸ“… When - ä½•æ—¶ï¼ˆæ—¶é—´åˆ†æï¼‰</h4>
                                    <div id="whenAnalysis">
                                        <div id="whenChart" style="height:200px;"></div>
                                        <div id="whenSummary" style="margin-top:8px;font-size:13px;"></div>
                                    </div>
                                </div>
                                <div class="w-analysis-card">
                                    <h4>ğŸ“ Where - å“ªé‡Œï¼ˆä½ç½®åˆ†æï¼‰</h4>
                                    <div id="whereAnalysis">
                                        <div id="whereChart" style="height:200px;"></div>
                                        <div id="whereSummary" style="margin-top:8px;font-size:13px;"></div>
                                    </div>
                                </div>
                                <div class="w-analysis-card" style="grid-column:1/-1;">
                                    <h4>â“ Why - ä¸ºä»€ä¹ˆï¼ˆåŸå› åˆ†æï¼‰</h4>
                                    <div id="whyAnalysis">
                                        <div style="display:flex;gap:16px;flex-wrap:wrap;">
                                            <div style="flex:1;min-width:300px;">
                                                <div id="whyChart" style="height:250px;"></div>
                                            </div>
                                            <div style="flex:1;min-width:300px;">
                                                <h5>åŸå› å±‚æ¬¡åˆ†æ</h5>
                                                <div id="whyLayers" style="font-size:13px;line-height:1.6;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-body" id="tab-note">
                <div style="padding:16px;">
                    <div style="margin-bottom:12px;">
                        <textarea id="noteInput" rows="3" style="width:100%;resize:vertical;padding:8px;border:1px solid #ddd;border-radius:4px;" placeholder="è¾“å…¥å¤‡æ³¨å†…å®¹..."></textarea>
                        <button id="btn-add-note" style="margin-top:8px;padding:6px 12px;background:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;">ä¿å­˜å¤‡æ³¨</button>
                    </div>
                    <div id="noteList" style="max-height:300px;overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    `;
    
    // ç»‘å®štabåˆ‡æ¢äº‹ä»¶
    modalContent.querySelectorAll('.tab-headers .tab').forEach(tab=>{
        tab.onclick=()=>{
            modalContent.querySelectorAll('.tab-headers .tab').forEach(t=>t.classList.remove('active'));
            modalContent.querySelectorAll('.tab-body').forEach(b=>b.classList.remove('active'));
            tab.classList.add('active');
            const body=modalContent.querySelector('#tab-'+tab.dataset.t);
            body.classList.add('active');
            
            // å¯¹æ¯”tabç‰¹æ®Šå¤„ç†
            if(tab.dataset.t==='compare' && !body.dataset.rendered){
                setTimeout(()=>{
                    renderCompareCharts(window.currentDrillDownDataRaw||[]);
                    body.dataset.rendered='yes';
                }, 100);
            }
            
            // è¶‹å‹¿tabç‰¹æ®Šå¤„ç†
            if(tab.dataset.t==='trend'){
                setTimeout(()=>{
                    const dom=document.getElementById('trendChart');
                    if(dom){const inst=echarts.getInstanceByDom(dom);if(inst){inst.resize();}}
                }, 100);
            }
            
            // æ ¹å› åˆ†ætabç‰¹æ®Šå¤„ç†
            if(tab.dataset.t==='rootcause' && !body.dataset.loaded){
                initRootCauseAnalysis(window.currentDrillDownDataRaw||[]);
                body.dataset.loaded='yes';
            }
            
            // å¤‡æ³¨tabç‰¹æ®Šå¤„ç†
            if(tab.dataset.t==='note' && !body.dataset.loaded){
                loadNotes(location,year,month);
                body.dataset.loaded='yes';
            }
        };
    });
    
    // ç»‘å®šå¯¼å‡ºæŒ‰é’®äº‹ä»¶
    setTimeout(()=>{
        const exportBtn = document.getElementById('btn-export');
        const exportPdfBtn = document.getElementById('btn-export-pdf');
        const exportExcelBtn = document.getElementById('btn-export-excel');
        const addNoteBtn = document.getElementById('btn-add-note');
        
        if(exportBtn) exportBtn.onclick = exportCsv;
        if(exportPdfBtn) exportPdfBtn.onclick = exportPdf;
        if(exportExcelBtn) exportExcelBtn.onclick = exportExcel;
        if(addNoteBtn) addNoteBtn.onclick = ()=>addNote(location,year,month);
    }, 100);
}

function applyFilters(){
    const kwInput=document.getElementById('kw-search');
    const kw=(kwInput?kwInput.value:'').trim().toLowerCase();
    const selType=document.getElementById('sel-type');
    const selStatus=document.getElementById('sel-status');
    const selExec=document.getElementById('sel-executor');
    const types=selType?Array.from(selType.selectedOptions).map(o=>o.value).filter(Boolean):[];
    const statuses=selStatus?Array.from(selStatus.selectedOptions).map(o=>o.value).filter(Boolean):[];
    const executors=selExec?Array.from(selExec.selectedOptions).map(o=>o.value).filter(Boolean):[];
    const rows=window.currentDrillDownDataRaw||[];
    const filtered=rows.filter(r=>{
        if(kw && !((r.check_item||'').toLowerCase().includes(kw) || (r.executor||'').toLowerCase().includes(kw))) return false;
        if(types.length && !types.includes(r.work_type)) return false;
        if(statuses.length && !statuses.includes(r.execution_status)) return false;
        if(executors.length && !executors.includes(r.executor)) return false;
        return true;
    });
    renderDrillDownData(filtered,false);
}

// åŠ¨æ€åŠ è½½CSS
function loadCss(href){return new Promise((res,rej)=>{if(document.querySelector(`link[href="${href}"]`)){res();return;}const l=document.createElement('link');l.rel='stylesheet';l.href=href;l.onload=res;l.onerror=rej;document.head.appendChild(l);});}

function loadScript(src){return new Promise((res,rej)=>{if(document.querySelector(`script[src="${src}"]`)){res();return;}const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.head.appendChild(s);});}

async function ensureSelect2(){
    if(window.jQuery===undefined){await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js');}
    if(!window.jQuery.fn || !window.jQuery.fn.select2){
        await loadCss('https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css');
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js');
    }
}

// åˆå§‹åŒ–/åˆ·æ–°ç­›é€‰é€‰é¡¹å¹¶ç»‘å®šäº‹ä»¶
function setupFilters(rows){
    let bar=document.getElementById('filterBar');
    if(!bar){
        bar=document.createElement('div');
        bar.id='filterBar';
        bar.style.cssText='margin:8px 0; display:flex; gap:16px; flex-wrap:nowrap; align-items:center; overflow-x:auto;';
        bar.innerHTML=`
            <input id="kw-search" placeholder="å…³é”®å­—(æ£€æŸ¥é¡¹/æ‰§è¡Œäºº)" style="padding:4px 6px;height:34px;width:140px;box-sizing:border-box;" />
            <label style="display:flex;align-items:center;font-size:12px;gap:4px;">
                <span>ä½œä¸šå½¢å¼</span>
                <select id="sel-type" style="width:140px;"></select>
            </label>
            <label style="display:flex;align-items:center;font-size:12px;gap:4px;">
                <span>æ‰§è¡Œæƒ…å†µ</span>
                <select id="sel-status" style="width:140px;"></select>
            </label>
            <label style="display:flex;align-items:center;font-size:12px;gap:4px;">
                <span>æ‰§è¡Œäºº</span>
                <select id="sel-executor" style="width:140px;"></select>
            </label>
            <button id="btn-clear-filter" style="padding:4px 10px;height:34px;box-sizing:border-box;">é‡ç½®</button>
        `;
        const tab=document.getElementById('tab-table');
        if(tab){tab.prepend(bar);}    
        ['kw-search','sel-type','sel-status','sel-executor'].forEach(id=>{
            const el=document.getElementById(id);
            if(el){el.addEventListener('input',applyFilters);el.addEventListener('change',applyFilters);} 
        });
        document.getElementById('btn-clear-filter').onclick=function(){
            document.getElementById('kw-search').value='';
            ['sel-type','sel-status','sel-executor'].forEach(id=>{
                const sel=document.getElementById(id);
                if(sel){Array.from(sel.options).forEach(o=>o.selected=false);} 
            });
            applyFilters();
        };
    }
    const getUnique=(field)=>[...new Set(rows.map(r=>r[field]).filter(Boolean))];
    const fill=(id,list)=>{
        const sel=document.getElementById(id);
        if(!sel) return;
        const current=new Set(Array.from(sel.selectedOptions).map(o=>o.value));
        sel.innerHTML=`<option value="">å…¨éƒ¨</option>`+list.map(v=>`<option value="${v}">${v}</option>`).join('');
        // restore selection if possible
        Array.from(sel.options).forEach(o=>{o.selected=current.has(o.value);});
    };
    fill('sel-type',getUnique('work_type'));
    fill('sel-status',getUnique('execution_status'));
    fill('sel-executor',getUnique('executor'));
}

    function exportCsv(){
        const rows=[['åºå·','ä½œä¸šå½¢å¼','ä½œä¸šåˆ†ç±»','ä½œä¸šå¯¹è±¡','æ£€æŸ¥é¡¹','æ‰§è¡Œæƒ…å†µ','æ‰§è¡Œäºº']].concat((window.currentDrillDownDataRaw||[]).map((r,i)=>[
            r.sequence_no||i+1,r.work_type,r.work_category,r.work_object,r.check_item,r.execution_status,r.executor]));
        const csv=rows.map(arr=>arr.map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob=new Blob([csv],{type:'text/csv'});
        const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='drill_down.csv';a.click();
    }

    // æ¸²æŸ“å¯¹æ¯”å›¾
    function renderCompareCharts(rows){
        // é¥¼å›¾ï¼šæ‰§è¡ŒçŠ¶æ€åˆ†å¸ƒ
        const statusCnt={};
        rows.forEach(r=>{const s=r.execution_status||'æœªå¡«';statusCnt[s]=(statusCnt[s]||0)+1;});
        const statusData=Object.entries(statusCnt).map(([n,v])=>({name:n,value:v}));
        const pie=echarts.init(document.getElementById('statusChart'));
        pie.setOption({tooltip:{trigger:'item'},legend:{bottom:0},series:[{type:'pie',radius:['40%','70%'],data:statusData}]});
        // æŸ±å›¾ï¼šä½œä¸šåˆ†ç±»è®¡æ•°
        const catCnt={};
        rows.forEach(r=>{const c=r.work_category||'æœªå¡«';catCnt[c]=(catCnt[c]||0)+1;});
        const cats=Object.keys(catCnt);const vals=cats.map(k=>catCnt[k]);
        const bar=echarts.init(document.getElementById('categoryChart'));
        bar.setOption({tooltip:{},xAxis:{type:'category',data:cats,axisLabel:{rotate:30}},yAxis:{type:'value'},series:[{type:'bar',data:vals}]});
    }
    
    function ensureAbnormalStyle(){
    if(document.getElementById('abnormal-style')) return;
    const s=document.createElement('style');s.id='abnormal-style';s.textContent=`.row-abnormal{background:#ffeae6 !important;} .row-abnormal:hover{background:#ffd7ce !important;}`;document.head.appendChild(s);
}

function ensureTableEnhance(){
    if(!document.getElementById('drill-table-style')){
        const css=`.drill-table{width:100%;border-collapse:collapse;font-size:13px;table-layout:auto;}\n.drill-table th,.drill-table td{border:1px solid #ddd;padding:6px 8px;white-space:nowrap;}\n.drill-table tr:nth-child(even){background:#f9f9f9;}\n.drill-table th{background:#f2f6fa;color:#333;}`;
        const s=document.createElement('style');s.id='drill-table-style';s.textContent=css;document.head.appendChild(s);
    }
    // åŠ è½½åˆ—å®½æ‹–æ‹½åº“ï¼Œå»¶è¿Ÿåˆ°å…ƒç´ å¸ƒå±€å®Œæˆ
    setTimeout(ensureColResizable, 30);
}
async function ensureColResizable(){
    if(window.jQuery===undefined){await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js');}
    if(!window.jQuery.fn || !window.jQuery.fn.colResizable){
        await loadScript('https://cdn.jsdelivr.net/npm/colresizable/colResizable-1.6.min.js');
    }
    const $tbl = window.jQuery('.drill-table');
    if(!$tbl.length) return;
    // è‹¥å·²åˆå§‹åŒ–ï¼Œå®Œå…¨é”€æ¯å¹¶ç§»é™¤æ—§åˆ—å®½
    if($tbl.data('resizableColumns')){
        $tbl.colResizable({disable:true});
        $tbl.removeData('resizableColumns');
        window.jQuery('.JCLRgrips').remove();
        $tbl.find('th,td').css('width','');
        $tbl.attr('style', '');
    }
    // è‡ªé€‚åº”çˆ¶å®¹å™¨åé‡æ–°åˆå§‹åŒ–
    $tbl.css('width','100%');
    $tbl.colResizable({liveDrag:true,resizeMode:'overflow',postbackSafe:true});
}

let abnormalKeywords=['å·²æ•´æ”¹'];
document.addEventListener('click',e=>{
   if(e.target.id==='btn-apply-abnormal'){
       const v=document.getElementById('abnormal-kw').value.trim();
       abnormalKeywords=v? v.split(',').map(s=>s.trim()).filter(Boolean):[];
       renderDrillDownData(window.currentDrillDownDataRaw||[],false);
   }
});

function renderDrillDownData(data, store=true) {
        const tbody = document.getElementById('drillDownTableBody');
        tbody.innerHTML = '';
        
        data.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.sequence_no || (index + 1)}</td>
                <td>${item.work_type || '-'}</td>
                <td>${item.work_category || '-'}</td>
                <td>${item.work_object || '-'}</td>
                <td title="${item.check_item || ''}">${truncateText(item.check_item || '-', 30)}</td>
                <td title="${item.execution_status || ''}">${truncateText(item.execution_status || '-', 25)}</td>
                <td>${item.executor || '-'}</td>
                <td><button class="detail-btn" onclick="showWorkItemDetail(${index})">è¯¦æƒ…</button>
                <button class="detail-btn" style="margin-left:6px;" onclick="openWorkOrder(${index})">æ•´æ”¹</button></td>
            `;
            if(abnormalKeywords.length && abnormalKeywords.some(k=> (item.execution_status||'').includes(k))){row.classList.add('row-abnormal');}
        tbody.appendChild(row);
        });
        
        // å­˜å‚¨æ•°æ®ä¾›è¯¦æƒ…æŸ¥çœ‹ä½¿ç”¨
        if(store){window.currentDrillDownDataRaw=data;ensureTableEnhance();}
    ensureAbnormalStyle();
        window.currentDrillDownData = data;
    // åˆå§‹åŒ–/åˆ·æ–°ç­›é€‰æ¡
    if(store){setupFilters(data);}
    }
    
    // æ¸²æŸ“12ä¸ªæœˆè¿·ä½ è¶‹åŠ¿æŠ˜çº¿
    function renderTrendChart(location, month, year){
        fetch(`/pue_trend_data?location=${encodeURIComponent(location)}&year=${year}&month=${month}`)
          .then(r=>r.json())
          .then(trend=>{
            const chart = echarts.init(document.getElementById('trendChart'));
            chart.setOption({
              grid:{left:10,right:10,top:10,bottom:20},
              tooltip:{trigger:'axis'},
              xAxis:{type:'category',data:trend.months,axisLabel:{fontSize:10}},
              yAxis:{type:'value',splitLine:{show:false}},
              visualMap:{show:false,pieces:[
                {lte:1.2,color:'#e74c3c'},
                {gt:1.2,lte:1.35,color:'#f1c40f'},
                {gt:1.35,color:'#2ecc71'}
              ]},
              series:[{type:'line',data:trend.values,symbol:'circle',smooth:true,lineStyle:{width:1}}]
            });
          });
    }
    
    // å·¥å•ä¸‰çº§ä¸‹é’» Drawer
function openWorkOrder(idx){
   const item = window.currentDrillDownDataRaw[idx];
   if(!item){return;}
   fetch(`/pue_rectify_record?drill_down_id=${item.id}`)
     .then(r=>r.json())
     .then(res=>{
        const overlay=document.createElement('div');
        overlay.className='drawer-overlay';
        overlay.onclick=()=>overlay.remove();
        const drawer=document.createElement('div');
        drawer.className='drawer';
        drawer.onclick=e=>e.stopPropagation();
        drawer.innerHTML=`<div class="drawer-header" style="display:flex;justify-content:space-between;align-items:center;">
   <span>æ•´æ”¹è®°å½• â€“ #${item.sequence_no||idx+1}</span>
   <div style="display:flex;align-items:center;gap:6px;">
       <label style="font-size:12px;">æ‰§è¡Œæƒ…å†µï¼š
           <select id="exec-status-select" style="margin:0 4px;">
               <option value="">-</option>
               <option value="æœªæ‰§è¡Œ">æœªæ‰§è¡Œ</option>
               <option value="å·²æ•´æ”¹">å·²æ•´æ”¹</option>
               <option value="è·Ÿè¿›ä¸­">è·Ÿè¿›ä¸­</option>
               <option value="æ— éœ€æ•´æ”¹">æ— éœ€æ•´æ”¹</option>
           </select>
       </label>
       <button id="exec-status-save" class="detail-btn" style="margin-right:8px;">æ›´æ–°</button>
       <button id="btn-add-rectify" class="detail-btn" style="margin-right:8px;">æ–°å¢</button>
       <span class="drawer-close" style="cursor:pointer;font-size:22px;line-height:1;">&times;</span>
   </div>
</div><div class="drawer-body"></div>`;
        drawer.querySelector('.drawer-close').onclick=()=>overlay.remove();
        const body=drawer.querySelector('.drawer-body');
        // ç»‘å®šæ‰§è¡Œæƒ…å†µä¿®æ”¹é€»è¾‘
        const statusSel = drawer.querySelector('#exec-status-select');
        if(statusSel){ statusSel.value = item.execution_status || ''; }
        const saveStatusBtn = drawer.querySelector('#exec-status-save');
        if(saveStatusBtn){
            saveStatusBtn.onclick = ()=>{
                const newStatus = statusSel.value;
                // å‘åç«¯æäº¤æ‰§è¡Œæƒ…å†µæ›´æ–°
                fetch('/pue_update_execution_status',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({id:item.id,status:newStatus})
                }).then(r=>r.json()).then(()=>{
                    // æœ¬åœ°æ•°æ®åŒæ­¥å¹¶åˆ·æ–°è¡¨æ ¼
                    item.execution_status = newStatus;
                    window.currentDrillDownDataRaw[idx].execution_status = newStatus;
                    renderDrillDownData(window.currentDrillDownDataRaw,false);
                    alert('æ‰§è¡Œæƒ…å†µå·²æ›´æ–°');
                }).catch(()=>alert('æ›´æ–°å¤±è´¥'));
            };
        }
        const addBtn = drawer.querySelector('#btn-add-rectify');
        addBtn.onclick=()=>{
            // ç®€æ˜“å†…åµŒè¡¨å•
            const formDiv=document.createElement('div');
            formDiv.style.border='1px solid #eee';formDiv.style.padding='8px';formDiv.style.marginBottom='12px';formDiv.style.borderRadius='4px';
            formDiv.innerHTML=`<div style='margin-bottom:6px;font-weight:bold;'>æ–°å¢æ•´æ”¹è®°å½•</div>
                <div style='margin-bottom:4px;'>çŠ¶æ€ï¼š
                    <select id='rect-status'>
                        <option value='å¾…å¤„ç†'>å¾…å¤„ç†</option>
                        <option value='å¤„ç†ä¸­'>å¤„ç†ä¸­</option>
                        <option value='å·²å®Œæˆ'>å·²å®Œæˆ</option>
                    </select>
                </div>
                <div style='margin-bottom:4px;'>ä¸Šä¼ å›¾ç‰‡ï¼š<input type='file' id='rect-file'></div>
                <div style='margin-bottom:4px;'>æè¿°ï¼š<textarea id='rect-desc' rows='3' style='width:100%;resize:vertical;'></textarea></div>
                <button id='rect-save' class='detail-btn'>ä¿å­˜</button> <button id='rect-cancel' class='detail-btn' style='margin-left:6px;'>å–æ¶ˆ</button>`;
            body.prepend(formDiv);
            formDiv.querySelector('#rect-cancel').onclick=()=>formDiv.remove();
            formDiv.querySelector('#rect-save').onclick=()=>{
                const formData = new FormData();
                formData.append('drill_down_id', item.id);
                formData.append('status', formDiv.querySelector('#rect-status').value);
                formData.append('description', formDiv.querySelector('#rect-desc').value.trim());
                const fileInput = formDiv.querySelector('#rect-file');
                if(fileInput.files.length){formData.append('file', fileInput.files[0]);}
                fetch('/pue_rectify_record',{method:'POST',body:formData})
                  .then(r=>r.json()).then(res=>{
                      alert('ä¿å­˜æˆåŠŸï¼Œè®°å½•ç¼–å· '+res.order_no);
                      overlay.remove();
                      openWorkOrder(idx);
                  }).catch(()=>alert('ä¿å­˜å¤±è´¥'));
            };
        };
        if(res.items&&res.items.length){
           res.items.forEach(r=>{
              const div=document.createElement('div');div.style.marginBottom='12px';
              div.innerHTML=`<div style='font-weight:bold;'>è®°å½•ç¼–å·ï¼š${r.order_no||'-'} | çŠ¶æ€ï¼š${r.status||'-'}</div>
              ${r.description?`<div style='margin:4px 0;'>${r.description}</div>`:''}
              ${r.image_url?`<img src='${r.image_url}' style='max-width:100%;border:1px solid #eee;border-radius:4px;margin-top:4px;'/>`:''}`;
              body.appendChild(div);
           });
        }else{
           body.innerHTML='<div style="color:#888;">æš‚æ— æ•´æ”¹è®°å½•</div>';
        }
        overlay.appendChild(drawer);
        document.body.appendChild(overlay);
     });
}

// åŠ¨æ€åŠ è½½è„šæœ¬
function loadScript(src){
   return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.body.appendChild(s);});
}
// å¯¼å‡º PDF
async function exportPdf(){
   if(typeof html2canvas==='undefined'){
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
   }
   if(typeof window.jspdf==='undefined'){
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
   }
   if(typeof html2canvas==='undefined' || typeof window.jspdf==='undefined'){
      alert('PDFåº“åŠ è½½å¤±è´¥');return;
   }
   const active=document.querySelector('#tab-container .tab-body.active')||document.getElementById('modalContent');
   html2canvas(active).then(canvas=>{
      const imgData=canvas.toDataURL('image/png');
      const pdf=new window.jspdf.jsPDF('p','pt','a4');
      const pageWidth=pdf.internal.pageSize.getWidth();
      const pageHeight=canvas.height*pageWidth/canvas.width;
      pdf.addImage(imgData,'PNG',0,0,pageWidth,pageHeight);
      pdf.save('drill_down.pdf');
   });
}

// å¯¼å‡º Excel
function exportExcel(){
   const {location,year,month}=window.currentDrillDownQuery||{};
   if(!location||!year||!month){alert('è¯·å…ˆåŠ è½½æ•°æ®');return;}
   window.location.href=`/pue_drill_down_excel?location=${encodeURIComponent(location)}&year=${year}&month=${month}`;
}

// å¤‡æ³¨ç›¸å…³å‡½æ•°
async function ensureMarked(){
    if(window.marked===undefined){await loadScript('https://cdn.jsdelivr.net/npm/marked/marked.min.js');}
}

function escapeHtml(str){return str.replace(/[&<>"']/g,function(c){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]);});}

async function loadNotes(loc,year,month){
    await ensureMarked();
    fetch(`/pue_comment?location=${encodeURIComponent(loc)}&year=${year}&month=${month}`).then(r=>r.json()).then(res=>{
       const ul=document.getElementById('noteList');
       if(!ul) return;
       ul.innerHTML='';
       if(res.items && res.items.length){
           res.items.forEach(it=>{
              const li=document.createElement('li');
              li.style.borderBottom='1px dashed #eee';
              li.style.padding='4px 0';
              const rendered=window.marked.parse(it.content||'');
              li.innerHTML=`<div style='color:#555;margin-bottom:2px;'>${it.created_at} ${it.creator||''}</div><div class='note-content'>${rendered}</div>
               <a href='#' data-id='${it.id}' style='color:#e74c3c;margin-left:6px;display:inline-block;margin-top:4px;' class='del-note'>åˆ é™¤</a>`;
              ul.appendChild(li);
           });
       }
    }).catch(e=>console.error('åŠ è½½å¤‡æ³¨å¤±è´¥:',e));
}

function addNote(loc,year,month){
    const txt=document.getElementById('noteInput');
    if(!txt) return;
    const val=txt.value.trim();
    if(!val) return;
    fetch('/pue_comment',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({location:loc,year,month,content:val,creator:window.userRole||''})
    }).then(r=>r.json()).then(()=>{
        txt.value='';
        loadNotes(loc,year,month);
    }).catch(e=>console.error('ä¿å­˜å¤‡æ³¨å¤±è´¥:',e));
}

// åˆ é™¤å¤‡æ³¨äº‹ä»¶ç›‘å¬
document.addEventListener('click',e=>{
    if(e.target.classList.contains('del-note')){
        e.preventDefault();
        const id=e.target.dataset.id;
        if(confirm('ç¡®å®šåˆ é™¤æ­¤å¤‡æ³¨ï¼Ÿ')){
            fetch(`/pue_comment/${id}`,{method:'DELETE'})
            .then(()=>e.target.closest('li').remove())
            .catch(e=>console.error('åˆ é™¤å¤‡æ³¨å¤±è´¥:',e));
        }
    }
});

// æ¸²æŸ“å¯¹æ¯”å›¾è¡¨
function renderCompareCharts(rows){
    if(!rows || !rows.length) return;
    
    // é¥¼å›¾ï¼šæ‰§è¡ŒçŠ¶æ€åˆ†å¸ƒ
    const statusCnt={};
    rows.forEach(r=>{
        const s=r.execution_status||'æœªå¡«';
        statusCnt[s]=(statusCnt[s]||0)+1;
    });
    const statusData=Object.entries(statusCnt).map(([n,v])=>({name:n,value:v}));
    
    const statusChartDom = document.getElementById('statusChart');
    if(statusChartDom && window.echarts){
        const pie=echarts.init(statusChartDom);
        pie.setOption({
            title:{text:'æ‰§è¡Œæƒ…å†µåˆ†å¸ƒ',left:'center',textStyle:{fontSize:14}},
            tooltip:{trigger:'item'},
            legend:{bottom:0,textStyle:{fontSize:12}},
            series:[{
                type:'pie',
                radius:['40%','70%'],
                data:statusData,
                emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:'rgba(0, 0, 0, 0.5)'}}
            }]
        });
    }
    
    // æŸ±å›¾ï¼šä½œä¸šåˆ†ç±»è®¡æ•°
    const catCnt={};
    rows.forEach(r=>{
        const c=r.work_category||'æœªå¡«';
        catCnt[c]=(catCnt[c]||0)+1;
    });
    const cats=Object.keys(catCnt);
    const vals=cats.map(k=>catCnt[k]);
    
    const categoryChartDom = document.getElementById('categoryChart');
    if(categoryChartDom && window.echarts){
        const bar=echarts.init(categoryChartDom);
        bar.setOption({
            title:{text:'ä½œä¸šåˆ†ç±»ç»Ÿè®¡',left:'center',textStyle:{fontSize:14}},
            tooltip:{trigger:'axis'},
            xAxis:{
                type:'category',
                data:cats,
                axisLabel:{rotate:30,fontSize:10}
            },
            yAxis:{type:'value'},
            series:[{
                type:'bar',
                data:vals,
                itemStyle:{color:'#3498db'},
                emphasis:{itemStyle:{color:'#2980b9'}}
            }]
        });
    }
}

    
    function ensureDetailModalStyle(){
    if(document.getElementById('detail-modal-style')) return;
    const css=`.drill-down-modal{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,.4);z-index:2000;animation:fadeIn .2s ease;}\n@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}\n.drill-down-modal .modal-content{background:#fff;border-radius:6px;max-height:90vh;overflow:auto;box-shadow:0 6px 20px rgba(0,0,0,.2);transform:translateY(-20px);animation:slideDown .25s ease forwards;}\n@keyframes slideDown{from{transform:translateY(-20px);opacity:0;}to{transform:translateY(0);opacity:1;}}\n.drill-down-modal .modal-header{display:flex;justify-content:space-between;align-items:center;padding:8px 14px;border-bottom:1px solid #eee;}\n.drill-down-modal .modal-body{padding:12px 16px;font-size:13px;}\n.drill-down-modal .close-btn{cursor:pointer;font-size:20px;line-height:1;color:#666;}\n.label{font-weight:bold;margin-right:4px;}`;
    const s=document.createElement('style');s.id='detail-modal-style';s.textContent=css;document.head.appendChild(s);
}

function showWorkItemDetail(index) {
        ensureDetailModalStyle();
        const item = window.currentDrillDownData[index];
        const detailHtml = `
            <div class="work-item-detail">
                <h4>${item.work_type} - ${item.check_item}</h4>
                <p><span class="label">ä½œä¸šå¯¹è±¡:</span> ${item.work_object || '-'}</p>
                <p><span class="label">æ“ä½œæ–¹æ³•:</span> ${item.operation_method || '-'}</p>
                <p><span class="label">æ ‡æ†å€¼:</span> ${item.benchmark_value || '-'}</p>
                <p><span class="label">æ‰§è¡Œæ ‡å‡†:</span> ${item.execution_standard || '-'}</p>
                <p><span class="label">æ‰§è¡Œæƒ…å†µ:</span> ${item.execution_status || '-'}</p>
                <p><span class="label">è¯¦ç»†æƒ…å†µ:</span> ${item.detailed_situation || '-'}</p>
                <p><span class="label">é‡åŒ–æ ‡å‡†:</span> ${item.quantification_standard || '-'} ${item.quantification_unit || ''}</p>
                <p><span class="label">æ‰§è¡Œäºº:</span> ${item.executor || '-'}</p>
            </div>
        `;
        
        // åˆ›å»ºè¯¦æƒ…å¼¹çª—
        const detailModal = document.createElement('div');
        detailModal.className = 'drill-down-modal';
        detailModal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3>å·¥ä½œé¡¹è¯¦ç»†ä¿¡æ¯</h3>
                    <span class="close-btn" onclick="this.closest('.drill-down-modal').remove()">&times;</span>
                </div>
                <div class="modal-body">
                    ${detailHtml}
                </div>
            </div>
        `;
        
        // ç‚¹å‡»é®ç½©å…³é—­
        detailModal.addEventListener('click',e=>{if(e.target===detailModal){detailModal.remove();}});
        document.body.appendChild(detailModal);
    }
    
    function closeDrillDownModal() {
        document.getElementById('drillDownModal').style.display = 'none';
    }
    
    function truncateText(text, maxLength) {
        if (!text || text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
    
    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
        const modal = document.getElementById('drillDownModal');
        if (event.target === modal) {
            closeDrillDownModal();
        }
    }
    
    // æ ¹å› åˆ†æåŠŸèƒ½
    function initRootCauseAnalysis(data){
        if(!data || !data.length) return;
        
        // ç»‘å®šæ ¹å› åˆ†æå­tabåˆ‡æ¢
        document.querySelectorAll('.rootcause-tab').forEach(tab=>{
            tab.onclick = ()=>{
                document.querySelectorAll('.rootcause-tab').forEach(t=>t.classList.remove('active'));
                document.querySelectorAll('.rootcause-tab-body').forEach(b=>b.classList.remove('active'));
                tab.classList.add('active');
                const body = document.getElementById('rc-'+tab.dataset.rt);
                if(body) body.classList.add('active');
                
                // æ ¹æ®å­tabç±»å‹æ‰§è¡Œç›¸åº”åˆ†æ
                switch(tab.dataset.rt){
                    case 'correlation':
                        renderCorrelationAnalysis(data);
                        break;
                    case 'pareto':
                        renderParetoAnalysis(data);
                        break;
                    case 'fishbone':
                        renderFishboneAnalysis(data);
                        break;
                    case '5w':
                        render5WAnalysis(data);
                        break;
                }
            };
        });
        
        // é»˜è®¤åŠ è½½å…³è”æ€§åˆ†æ
        setTimeout(()=>renderCorrelationAnalysis(data), 100);
    }
    
    // å…³è”æ€§åˆ†æ
    function renderCorrelationAnalysis(data){
        if(!window.echarts) return;
        
        // è®¡ç®—å„å› ç´ ä¸æ‰§è¡Œæƒ…å†µçš„å…³è”åº¦
        const factors = ['work_type', 'work_category', 'work_object', 'executor'];
        const correlations = [];
        
        factors.forEach(factor => {
            const correlation = calculateCorrelation(data, factor, 'execution_status');
            correlations.push({
                factor: getFactorName(factor),
                correlation: correlation,
                strength: getCorrelationStrength(correlation)
            });
        });
        
        // æ¸²æŸ“å…³è”åº¦æŸ±çŠ¶å›¾
        const corrChart = echarts.init(document.getElementById('correlationChart'));
        corrChart.setOption({
            title: {text: 'å„å› ç´ ä¸æ‰§è¡Œæƒ…å†µå…³è”åº¦', left: 'center', textStyle: {fontSize: 14}},
            tooltip: {trigger: 'axis'},
            xAxis: {
                type: 'category',
                data: correlations.map(c => c.factor),
                axisLabel: {rotate: 30, fontSize: 11}
            },
            yAxis: {type: 'value', name: 'å…³è”åº¦', min: 0, max: 1},
            series: [{
                type: 'bar',
                data: correlations.map(c => ({
                    value: c.correlation,
                    itemStyle: {color: c.correlation > 0.7 ? '#e74c3c' : c.correlation > 0.4 ? '#f39c12' : '#27ae60'}
                })),
                label: {show: true, position: 'top', formatter: '{c}'}
            }]
        });
        
        // æ¸²æŸ“å…³è”åº¦çŸ©é˜µçƒ­åŠ›å›¾
        const matrixChart = echarts.init(document.getElementById('correlationMatrix'));
        const matrixData = [];
        factors.forEach((factor1, i) => {
            factors.forEach((factor2, j) => {
                const correlation = i === j ? 1 : calculateCorrelation(data, factor1, factor2);
                matrixData.push([i, j, correlation]);
            });
        });
        
        matrixChart.setOption({
            title: {text: 'å› ç´ é—´å…³è”åº¦çŸ©é˜µ', left: 'center', textStyle: {fontSize: 14}},
            tooltip: {
                position: 'top',
                formatter: function(params) {
                    return getFactorName(factors[params.data[0]]) + ' vs ' + 
                           getFactorName(factors[params.data[1]]) + '<br/>å…³è”åº¦: ' + 
                           params.data[2].toFixed(3);
                }
            },
            grid: {
                height: '60%',
                top: '15%'
            },
            xAxis: {
                type: 'category',
                data: factors.map(f => getFactorName(f)),
                splitArea: {show: true},
                axisLabel: {fontSize: 10}
            },
            yAxis: {
                type: 'category',
                data: factors.map(f => getFactorName(f)),
                splitArea: {show: true},
                axisLabel: {fontSize: 10}
            },
            visualMap: {
                min: 0,
                max: 1,
                calculable: true,
                orient: 'horizontal',
                left: 'center',
                bottom: '5%',
                inRange: {
                    color: ['#50a3ba', '#eac736', '#d94e5d']
                }
            },
            series: [{
                name: 'å…³è”åº¦',
                type: 'heatmap',
                data: matrixData,
                label: {
                    show: true,
                    formatter: '{c}',
                    fontSize: 10
                },
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }]
        });
        
        // ç”Ÿæˆå…³è”æ€§ç»Ÿè®¡è¡¨
        const tableHtml = `
            <table style="width:100%;border-collapse:collapse;font-size:13px;">
                <thead>
                    <tr style="background:#f8f9fa;">
                        <th style="border:1px solid #ddd;padding:8px;">å› ç´ </th>
                        <th style="border:1px solid #ddd;padding:8px;">å…³è”åº¦</th>
                        <th style="border:1px solid #ddd;padding:8px;">å…³è”å¼ºåº¦</th>
                        <th style="border:1px solid #ddd;padding:8px;">å»ºè®®</th>
                    </tr>
                </thead>
                <tbody>
                    ${correlations.map(c => `
                        <tr>
                            <td style="border:1px solid #ddd;padding:8px;">${c.factor}</td>
                            <td style="border:1px solid #ddd;padding:8px;text-align:center;">${c.correlation.toFixed(3)}</td>
                            <td style="border:1px solid #ddd;padding:8px;text-align:center;">
                                <span class="severity ${c.strength.level}">${c.strength.text}</span>
                            </td>
                            <td style="border:1px solid #ddd;padding:8px;font-size:12px;">${c.strength.suggestion}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        document.getElementById('correlationTable').innerHTML = tableHtml;
    }
    
    // å¸•ç´¯æ‰˜åˆ†æ
    function renderParetoAnalysis(data){
        if(!window.echarts) return;
        
        // ç»Ÿè®¡å„ç±»é—®é¢˜çš„é¢‘æ¬¡
        const problemCounts = {};
        data.forEach(item => {
            const status = item.execution_status || 'æœªçŸ¥';
            if(status.includes('æœª') || status.includes('å¼‚å¸¸') || status.includes('é—®é¢˜')){
                const category = item.work_category || 'å…¶ä»–';
                problemCounts[category] = (problemCounts[category] || 0) + 1;
            }
        });
        
        // æŒ‰é¢‘æ¬¡æ’åº
        const sortedProblems = Object.entries(problemCounts)
            .sort((a, b) => b[1] - a[1])
            .map(([category, count]) => ({category, count}));
        
        const total = sortedProblems.reduce((sum, item) => sum + item.count, 0);
        let cumulative = 0;
        const paretoData = sortedProblems.map(item => {
            cumulative += item.count;
            return {
                category: item.category,
                count: item.count,
                percentage: (item.count / total * 100).toFixed(1),
                cumulative: (cumulative / total * 100).toFixed(1)
            };
        });
        
        // æ¸²æŸ“å¸•ç´¯æ‰˜å›¾
        const paretoChart = echarts.init(document.getElementById('paretoChart'));
        paretoChart.setOption({
            title: {text: 'é—®é¢˜åˆ†ç±»å¸•ç´¯æ‰˜åˆ†æ', left: 'center', textStyle: {fontSize: 14}},
            tooltip: {trigger: 'axis'},
            legend: {bottom: 0},
            xAxis: {
                type: 'category',
                data: paretoData.map(d => d.category),
                axisLabel: {rotate: 30, fontSize: 11}
            },
            yAxis: [
                {type: 'value', name: 'é—®é¢˜æ•°é‡', position: 'left'},
                {type: 'value', name: 'ç´¯è®¡ç™¾åˆ†æ¯”(%)', position: 'right', max: 100}
            ],
            series: [
                {
                    name: 'é—®é¢˜æ•°é‡',
                    type: 'bar',
                    data: paretoData.map(d => d.count),
                    itemStyle: {color: '#3498db'}
                },
                {
                    name: 'ç´¯è®¡ç™¾åˆ†æ¯”',
                    type: 'line',
                    yAxisIndex: 1,
                    data: paretoData.map(d => parseFloat(d.cumulative)),
                    itemStyle: {color: '#e74c3c'},
                    markLine: {
                        data: [{yAxis: 80, name: '80%çº¿'}],
                        lineStyle: {color: '#f39c12', type: 'dashed'}
                    }
                }
            ]
        });
        
        // è¯†åˆ«ä¸»è¦å’Œæ¬¡è¦å› ç´ 
        const majorFactors = paretoData.filter(d => parseFloat(d.cumulative) <= 80);
        const minorFactors = paretoData.filter(d => parseFloat(d.cumulative) > 80);
        
        document.getElementById('majorFactors').innerHTML = majorFactors.map(f => 
            `<div style="margin:4px 0;padding:4px;background:#e8f4f8;border-radius:3px;">${f.category} (${f.count}ä»¶, ${f.percentage}%)</div>`
        ).join('');
        
        document.getElementById('minorFactors').innerHTML = minorFactors.map(f => 
            `<div style="margin:4px 0;padding:4px;background:#f8f8f8;border-radius:3px;">${f.category} (${f.count}ä»¶, ${f.percentage}%)</div>`
        ).join('');
        
        // ç”Ÿæˆæ”¹è¿›å»ºè®®
        const recommendations = `
            <div style="margin-bottom:8px;">â€¢ é‡ç‚¹å…³æ³¨ä¸»è¦å› ç´ ï¼Œè¿™äº›å æ€»é—®é¢˜çš„80%</div>
            <div style="margin-bottom:8px;">â€¢ ä¼˜å…ˆè§£å†³ ${majorFactors[0]?.category || 'N/A'} ç›¸å…³é—®é¢˜</div>
            <div style="margin-bottom:8px;">â€¢ å»ºç«‹é’ˆå¯¹æ€§çš„æ”¹è¿›æªæ–½å’Œç›‘æ§æœºåˆ¶</div>
            <div>â€¢ å®šæœŸå¤æŸ¥å¸•ç´¯æ‰˜åˆ†æç»“æœï¼Œè·Ÿè¸ªæ”¹è¿›æ•ˆæœ</div>
        `;
        document.getElementById('paretoRecommendations').innerHTML = recommendations;
    }
    
    // é±¼éª¨å›¾åˆ†æ
    function renderFishboneAnalysis(data){
        // åˆ†ææ•°æ®å¹¶åˆ†ç±»åˆ°å››ä¸ªç»´åº¦
        const factors = {
            people: [
                {description: 'æ‰§è¡Œäººå‘˜æŠ€èƒ½ä¸è¶³', severity: 'high', impact: 'é«˜'},
                {description: 'äººå‘˜é…ç½®ä¸åˆç†', severity: 'medium', impact: 'ä¸­'},
                {description: 'åŸ¹è®­ä¸åˆ°ä½', severity: 'medium', impact: 'ä¸­'}
            ],
            equipment: [
                {description: 'è®¾å¤‡è€åŒ–æ•…éšœ', severity: 'high', impact: 'é«˜'},
                {description: 'ç»´æŠ¤å·¥å…·ç¼ºå¤±', severity: 'medium', impact: 'ä¸­'},
                {description: 'ç›‘æ§ç³»ç»Ÿä¸å®Œå–„', severity: 'low', impact: 'ä½'}
            ],
            method: [
                {description: 'æ“ä½œæµç¨‹ä¸è§„èŒƒ', severity: 'high', impact: 'é«˜'},
                {description: 'æ ‡å‡†æ‰§è¡Œä¸ä¸¥æ ¼', severity: 'medium', impact: 'ä¸­'},
                {description: 'æ£€æŸ¥æ–¹æ³•ä¸å½“', severity: 'medium', impact: 'ä¸­'}
            ],
            environment: [
                {description: 'å·¥ä½œç¯å¢ƒæ¶åŠ£', severity: 'medium', impact: 'ä¸­'},
                {description: 'æ—¶é—´å‹åŠ›è¿‡å¤§', severity: 'high', impact: 'é«˜'},
                {description: 'èµ„æºé…ç½®ä¸è¶³', severity: 'medium', impact: 'ä¸­'}
            ]
        };
        
        // æ¸²æŸ“å› ç´ åˆ—è¡¨
        document.getElementById('peopleFactors').innerHTML = factors.people.map(f => 
            `<div class="factor-item">${f.description}<span class="severity ${f.severity}">${f.impact}</span></div>`
        ).join('');
        
        document.getElementById('equipmentFactors').innerHTML = factors.equipment.map(f => 
            `<div class="factor-item">${f.description}<span class="severity ${f.severity}">${f.impact}</span></div>`
        ).join('');
        
        document.getElementById('methodFactors').innerHTML = factors.method.map(f => 
            `<div class="factor-item">${f.description}<span class="severity ${f.severity}">${f.impact}</span></div>`
        ).join('');
        
        document.getElementById('environmentFactors').innerHTML = factors.environment.map(f => 
            `<div class="factor-item">${f.description}<span class="severity ${f.severity}">${f.impact}</span></div>`
        ).join('');
        
        // ç»˜åˆ¶é±¼éª¨å›¾ SVG
        drawFishboneDiagram();
    }
    
    // 5Wåˆ†æ
    function render5WAnalysis(data){
        if(!window.echarts) return;
        
        // Who - äººå‘˜åˆ†æ
        const executorStats = {};
        data.forEach(item => {
            const executor = item.executor || 'æœªæŒ‡å®š';
            if(!executorStats[executor]) executorStats[executor] = {total: 0, issues: 0};
            executorStats[executor].total++;
            if(item.execution_status && (item.execution_status.includes('æœª') || item.execution_status.includes('å¼‚å¸¸'))){
                executorStats[executor].issues++;
            }
        });
        
        const whoChart = echarts.init(document.getElementById('whoChart'));
        const executorData = Object.entries(executorStats).map(([name, stats]) => ({
            name,
            value: stats.issues,
            total: stats.total,
            rate: (stats.issues / stats.total * 100).toFixed(1)
        }));
        
        whoChart.setOption({
            title: {text: 'äººå‘˜é—®é¢˜åˆ†å¸ƒ', left: 'center', textStyle: {fontSize: 12}},
            tooltip: {formatter: params => `${params.name}: ${params.value}ä»¶<br/>é—®é¢˜ç‡: ${executorData.find(e=>e.name===params.name)?.rate}%`},
            series: [{
                type: 'pie',
                radius: ['40%', '70%'],
                data: executorData,
                label: {fontSize: 10}
            }]
        });
        
        document.getElementById('whoSummary').innerHTML = `
            æ€»æ‰§è¡Œäººæ•°: ${Object.keys(executorStats).length}äºº<br/>
            é—®é¢˜æœ€å¤š: ${executorData.sort((a,b)=>b.value-a.value)[0]?.name || 'N/A'}<br/>
            å¹³å‡é—®é¢˜ç‡: ${(executorData.reduce((sum,e)=>sum+parseFloat(e.rate),0)/executorData.length).toFixed(1)}%
        `;
        
        // What - é—®é¢˜åˆ†æ
        const problemTypes = {};
        data.forEach(item => {
            const category = item.work_category || 'å…¶ä»–';
            if(!problemTypes[category]) problemTypes[category] = 0;
            if(item.execution_status && (item.execution_status.includes('æœª') || item.execution_status.includes('å¼‚å¸¸'))){
                problemTypes[category]++;
            }
        });
        
        const whatChart = echarts.init(document.getElementById('whatChart'));
        whatChart.setOption({
            title: {text: 'é—®é¢˜ç±»å‹åˆ†å¸ƒ', left: 'center', textStyle: {fontSize: 12}},
            tooltip: {trigger: 'axis'},
            xAxis: {type: 'category', data: Object.keys(problemTypes), axisLabel: {rotate: 30, fontSize: 9}},
            yAxis: {type: 'value'},
            series: [{type: 'bar', data: Object.values(problemTypes), itemStyle: {color: '#f39c12'}}]
        });
        
        document.getElementById('whatSummary').innerHTML = `
            é—®é¢˜ç±»å‹æ•°: ${Object.keys(problemTypes).length}ç§<br/>
            ä¸»è¦é—®é¢˜: ${Object.entries(problemTypes).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'N/A'}<br/>
            æ€»é—®é¢˜æ•°: ${Object.values(problemTypes).reduce((a,b)=>a+b,0)}ä»¶
        `;
        
        // When, Where, Why çš„ç®€åŒ–å®ç°
        renderSimpleAnalysis('when', 'whenChart', 'whenSummary', 'æ—¶é—´åˆ†æ');
        renderSimpleAnalysis('where', 'whereChart', 'whereSummary', 'ä½ç½®åˆ†æ');
        renderSimpleAnalysis('why', 'whyChart', 'whyLayers', 'åŸå› åˆ†æ');
    }
    
    // è¾…åŠ©å‡½æ•°
    function calculateCorrelation(data, factor1, factor2){
        if(factor1 === factor2) return 1.0;
        
        // è·å–æœ‰æ•ˆæ•°æ®
        const validData = data.filter(d => d[factor1] && d[factor2]);
        if(validData.length < 2) return 0;
        
        // è®¡ç®—å„ç»„åˆçš„é¢‘æ¬¡
        const combinations = {};
        const factor1Counts = {};
        const factor2Counts = {};
        
        validData.forEach(d => {
            const val1 = d[factor1];
            const val2 = d[factor2];
            const key = `${val1}|${val2}`;
            
            combinations[key] = (combinations[key] || 0) + 1;
            factor1Counts[val1] = (factor1Counts[val1] || 0) + 1;
            factor2Counts[val2] = (factor2Counts[val2] || 0) + 1;
        });
        
        // è®¡ç®—äº’ä¿¡æ¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
        const total = validData.length;
        let mutualInfo = 0;
        
        Object.entries(combinations).forEach(([key, count]) => {
            const [val1, val2] = key.split('|');
            const pxy = count / total;
            const px = factor1Counts[val1] / total;
            const py = factor2Counts[val2] / total;
            
            if(pxy > 0 && px > 0 && py > 0) {
                mutualInfo += pxy * Math.log2(pxy / (px * py));
            }
        });
        
        // è®¡ç®—ç†µ
        const entropy1 = -Object.values(factor1Counts).reduce((sum, count) => {
            const p = count / total;
            return sum + (p > 0 ? p * Math.log2(p) : 0);
        }, 0);
        
        const entropy2 = -Object.values(factor2Counts).reduce((sum, count) => {
            const p = count / total;
            return sum + (p > 0 ? p * Math.log2(p) : 0);
        }, 0);
        
        // å½’ä¸€åŒ–äº’ä¿¡æ¯ä½œä¸ºå…³è”åº¦
        const maxEntropy = Math.max(entropy1, entropy2);
        const correlation = maxEntropy > 0 ? mutualInfo / maxEntropy : 0;
        
        // ç¡®ä¿ç»“æœåœ¨[0,1]èŒƒå›´å†…
        return Math.max(0, Math.min(1, correlation));
    }
    
    function getFactorName(factor){
        const names = {
            'work_type': 'ä½œä¸šå½¢å¼',
            'work_category': 'ä½œä¸šåˆ†ç±»', 
            'work_object': 'ä½œä¸šå¯¹è±¡',
            'executor': 'æ‰§è¡Œäºº'
        };
        return names[factor] || factor;
    }
    
    function getCorrelationStrength(correlation){
        if(correlation > 0.7) return {level: 'high', text: 'å¼ºå…³è”', suggestion: 'é‡ç‚¹å…³æ³¨ï¼Œä¼˜å…ˆæ”¹è¿›'};
        if(correlation > 0.4) return {level: 'medium', text: 'ä¸­å…³è”', suggestion: 'é€‚åº¦å…³æ³¨ï¼Œåˆ¶å®šæ”¹è¿›è®¡åˆ’'};
        return {level: 'low', text: 'å¼±å…³è”', suggestion: 'å®šæœŸç›‘æ§å³å¯'};
    }
    
    function drawFishboneDiagram(){
        const svg = document.getElementById('fishboneSvg');
        if(!svg) return;
        
        svg.innerHTML = `
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                </marker>
            </defs>
            <!-- ä¸»å¹² -->
            <line x1="100" y1="200" x2="700" y2="200" stroke="#333" stroke-width="3" marker-end="url(#arrowhead)"/>
            <!-- é—®é¢˜å¤´ -->
            <rect x="720" y="180" width="100" height="40" fill="#e74c3c" rx="5"/>
            <text x="770" y="205" text-anchor="middle" fill="white" font-size="14" font-weight="bold">PUEé—®é¢˜</text>
            
            <!-- äººå‘˜åˆ†æ”¯ -->
            <line x1="200" y1="120" x2="300" y2="200" stroke="#3498db" stroke-width="2"/>
            <text x="180" y="115" fill="#3498db" font-size="12" font-weight="bold">ğŸ‘¥ äººå‘˜</text>
            
            <!-- è®¾å¤‡åˆ†æ”¯ -->
            <line x1="400" y1="120" x2="500" y2="200" stroke="#e67e22" stroke-width="2"/>
            <text x="380" y="115" fill="#e67e22" font-size="12" font-weight="bold">âš™ï¸ è®¾å¤‡</text>
            
            <!-- æ–¹æ³•åˆ†æ”¯ -->
            <line x1="400" y1="280" x2="500" y2="200" stroke="#27ae60" stroke-width="2"/>
            <text x="380" y="295" fill="#27ae60" font-size="12" font-weight="bold">ğŸ“‹ æ–¹æ³•</text>
            
            <!-- ç¯å¢ƒåˆ†æ”¯ -->
            <line x1="200" y1="280" x2="300" y2="200" stroke="#8e44ad" stroke-width="2"/>
            <text x="180" y="295" fill="#8e44ad" font-size="12" font-weight="bold">ğŸŒ ç¯å¢ƒ</text>
        `;
    }
    
    function renderSimpleAnalysis(type, chartId, summaryId, title){
        const chart = echarts.init(document.getElementById(chartId));
        chart.setOption({
            title: {text: title, left: 'center', textStyle: {fontSize: 12}},
            tooltip: {trigger: 'item'},
            series: [{
                type: 'pie',
                radius: '60%',
                data: [
                    {name: 'æ­£å¸¸', value: 70},
                    {name: 'å¼‚å¸¸', value: 20},
                    {name: 'æœªçŸ¥', value: 10}
                ],
                label: {fontSize: 10}
            }]
        });
        
        if(summaryId === 'whyLayers'){
            document.getElementById(summaryId).innerHTML = `
                <div><strong>ç¬¬ä¸€å±‚åŸå› :</strong> æ‰§è¡Œä¸è§„èŒƒ</div>
                <div><strong>ç¬¬äºŒå±‚åŸå› :</strong> æµç¨‹ä¸å®Œå–„</div>
                <div><strong>ç¬¬ä¸‰å±‚åŸå› :</strong> ç®¡ç†åˆ¶åº¦ç¼ºå¤±</div>
                <div><strong>æ ¹æœ¬åŸå› :</strong> è´¨é‡æ–‡åŒ–å»ºè®¾ä¸è¶³</div>
            `;
        } else {
            document.getElementById(summaryId).innerHTML = `${title}ç»Ÿè®¡ä¿¡æ¯åŠ è½½ä¸­...`;
        }
    }
    </script>
</div>

<!-- åŸå§‹æ•°æ®å¤šç»´è¡¨ -->
<div class="card" style="margin-top:0; position:relative; z-index:0;">
    <div class="card-title">åŸå§‹æ•°æ®å¤šç»´è¡¨</div>
    <div class="data-table-container" style="overflow-x:auto;">
        <table class="data-table" style="min-width:100%;">
            <thead>
                <tr>
                    <th rowspan="2">æœˆä»½</th>
                    {% for loc in locations %}
                        <th colspan="{{ years|length }}">{{ loc }}</th>
                    {% endfor %}
                </tr>
                <tr>
                    {% for loc in locations %}
                        {% for y in years %}
                            <th>{{ y }}</th>
                        {% endfor %}
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for m in months %}
                <tr>
                    <td>{{ m }}æœˆ</td>
                    {% for loc in locations %}
                        {% for y in years %}
                            <td>{% set v = multi_table[m][loc][y] %}{% if v is not none %}{{ "{:.2f}".format(v) }}{% else %}-{% endif %}</td>
                        {% endfor %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<!-- é¡µé¢åº•éƒ¨å ä½å®¹å™¨ -->
<div style="height:60px;width:100%;pointer-events:none;clear:both;"></div>
{% endblock %}
