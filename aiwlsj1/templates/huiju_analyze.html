{% extends "base.html" %}

{% block title %}汇聚骨干指标数据分析 - 网络视界指标后台管理{% endblock %}

{% block page_title %}汇聚骨干指标数据分析{% endblock %}

{% block breadcrumb %}
    <li><span class="text-gray-300">/</span></li>
    <li><span class="text-gray-500">契约化指标分析</span></li>
    <li><span class="text-gray-300">/</span></li>
    <li><span class="text-gray-500">汇聚骨干指标</span></li>
    <li><span class="text-gray-300">/</span></li>
    <li><span class="text-primary-600">汇聚骨干指标数据分析</span></li>
{% endblock %}

{% block content %}
{% set city_order = ['深圳', '广州', '东莞', '佛山'] %}
<div class="main-flex-row" style="display: flex; gap: 24px; align-items: flex-start; min-width:0; width:100%; box-sizing:border-box; position:relative; z-index:1;">
    <!-- 左侧主内容区 -->
    <div style="flex: 6 1 0; min-width:0; max-width: 60%; display: flex; flex-direction: column; gap: 24px; box-sizing:border-box; overflow-x:auto;">
        <div class="card" style="width:100%; box-sizing:border-box;">
            <div class="card-title" style="margin-bottom: 0;">汇聚骨干指标数据分析</div>
            <div style="display: flex; flex-direction: column; align-items: stretch; width: 100%; gap: 12px; min-width: 0; box-sizing:border-box;">
                <form method="get" id="cityForm" style="margin-bottom: 0; display: flex; gap: 18px; align-items: center; flex-wrap: nowrap; min-width:0; width:100%; max-width:100%;">
                    <div style="display:flex; gap:18px; align-items:center; flex:1 1 0; min-width:0; max-width:100%; overflow:hidden;">
                    {% set city_order = ['深圳', '广州', '东莞', '佛山'] %}
                    {% for city in city_order %}
                        {% if city in all_cities %}
                        <label style="margin-right: 10px; white-space: nowrap;">
                            <input type="radio" name="city" value="{{ city }}" {% if current_city==city %}checked{% endif %} onchange="document.getElementById('cityForm').submit();">
                            {{ city }}
                        </label>
                        {% endif %}
                    {% endfor %}
                    <label style="margin-right: 10px; white-space: nowrap;">
                        <input type="radio" name="city" value="" {% if not current_city %}checked{% endif %} onchange="document.getElementById('cityForm').submit();">
                        全部
                    </label>
                    </div>
                </form>
                <div style="width:100%; min-width:0;">
                    {% if bar_chart %}
                        {{ bar_chart|safe }}
                    {% endif %}
                </div>

            </div>
        </div>
    </div>
    <!-- 右侧：红绿灯+折线图 -->
    <div style="flex: 3 1 0; min-width:220px; max-width:30%; display: flex; flex-direction: column; gap: 18px; align-items: stretch; box-sizing:border-box; position:relative; z-index:1;">
        <div style="background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #eee; padding: 14px 18px 8px 18px; display: flex; flex-direction: column; justify-content: flex-start; align-self: stretch; box-sizing:border-box;">
            <div style="font-weight: bold; font-size: 1.05em; margin-bottom: 8px;">红绿灯预警板</div>
            <hr style="border:none;border-top:1px solid #e0e0e0;margin:0 0 10px 0;">
            <div style="display: flex; align-items: center; margin-bottom: 12px; color:#f44336;">
                <span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#f44336;margin-right:10px;flex-shrink:0;"></span>
                {% if red_months %}
                    {% for m in red_months %}<span style="margin-right:8px;">{{ m }}月</span>{% endfor %}
                {% else %}无{% endif %}
            </div>
            <div style="display: flex; align-items: center; margin-bottom: 12px; color:#ff9800;">
                <span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#ff9800;margin-right:10px;flex-shrink:0;"></span>
                {% if yellow_months %}
                    {% for m in yellow_months %}<span style="margin-right:8px;">{{ m }}月</span>{% endfor %}
                {% else %}无{% endif %}
            </div>
            <div style="display: flex; align-items: center; color:#4caf50;">
                <span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#4caf50;margin-right:10px;flex-shrink:0;"></span>
                {% if green_months %}
                    {% for m in green_months %}<span style="margin-right:8px;">{{ m }}月</span>{% endfor %}
                {% else %}无{% endif %}
            </div>
        </div>
        {% if shenzhen_line_chart %}
        <div style="background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #eee; padding: 10px 16px; width: 100%; box-sizing:border-box;">
            {{ shenzhen_line_chart|safe }}
        </div>
        {% endif %}
    </div>
</div>
<!-- 分割主分析区和多维表，避免重叠 -->
<div style="height:32px; width:100%; clear:both;"></div>

<style>
.ai-loading-spinner {
  display: inline-block;
  width: 22px;
  height: 22px;
  border: 3px solid #e3e8f0;
  border-top: 3px solid #3498db;
  border-radius: 50%;
  animation: ai-spin 0.8s linear infinite;
  vertical-align: middle;
}
@keyframes ai-spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<!-- AI智能分析卡片独立放置在主内容和多维表之间 -->
<div class="card" style="margin: 0 0 24px 0; background:#f7f7fb; border-left:4px solid #3498db; padding:16px;">
    <div style="font-weight:bold; color:#3498db; margin-bottom:4px; display:flex; align-items:center; gap:18px;">
      <span>AI智能分析与预测（Deepseek R1 深度思考）</span>
      <button id="start-ai-analysis" style="background:#3498db; color:#fff; border:none; border-radius:4px; padding:4px 16px; font-size:14px; cursor:pointer;">开始分析</button>
    </div>
    <div id="ai-analysis-box" style="white-space:pre-line; max-height:140px; overflow-y:auto; line-height:1.7; font-size:15px; padding-right:6px; transition:max-height 0.3s; color:#888;">
        <!-- 初始不显示内容 -->
    </div>
    <button id="toggle-ai-analysis" style="margin-top:8px; background:#eaf3fb; border:none; color:#3498db; padding:4px 14px; border-radius:4px; cursor:pointer; display:none;">展开全部</button>
    <script>
    const box = document.getElementById('ai-analysis-box');
    const btn = document.getElementById('toggle-ai-analysis');
    const startBtn = document.getElementById('start-ai-analysis');
    let expanded = false;
    let city = "{{ current_city or '' }}";
    btn.onclick = function() {
        expanded = !expanded;
        if (expanded) {
            box.style.maxHeight = '1000px';
            btn.textContent = '收起';
        } else {
            box.style.maxHeight = '140px';
            btn.textContent = '展开全部';
            box.scrollTop = 0;
        }
    }
    startBtn.onclick = function() {
        box.innerHTML = '<div class="ai-loading-spinner"></div><span style="margin-left:12px; color:#888; vertical-align:middle;">AI分析生成中…</span>';
        box.style.color = '#888';
        btn.style.display = 'none';
        startBtn.disabled = true;
        startBtn.textContent = '分析中...';
        fetch(`/huiju/ai_analysis?city=${encodeURIComponent(city)}`)
          .then(resp => resp.json())
          .then(data => {
            box.innerText = data.ai_analysis || 'AI分析生成失败，请稍后重试。';
            box.style.color = '#222';
            // 自动判断是否需要显示展开按钮
            setTimeout(function(){
              if(box.scrollHeight > 150){ btn.style.display = ''; } else { btn.style.display = 'none'; }
            }, 50);
            startBtn.disabled = false;
            startBtn.textContent = '重新分析';
          }).catch(() => {
            box.textContent = 'AI分析生成失败，请稍后重试。';
            box.style.color = '#e53935';
            startBtn.disabled = false;
            startBtn.textContent = '重新分析';
          });
    }
    </script>
</div>

<!-- 原始数据多维表 -->
<!-- 引入 Element Plus 样式和JS -->
<link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
<script src="https://unpkg.com/vue@3"></script>
<script src="https://unpkg.com/element-plus"></script>

<div class="card" style="margin-top:0; position:relative; z-index:0;">
  <div class="card-title">原始数据多维表</div>
  <div class="data-table-container" style="overflow-x:auto;">
    <div id="ep-table-app">
      <el-table :data="tableData" border style="width: 100%" :header-cell-style="{ textAlign: 'center' }">
        <el-table-column label="月份" prop="month" fixed></el-table-column>
        <el-table-column
          v-for="city in cities"
          :key="city"
          :label="city"
        >
          <el-table-column label="汇聚总量" :prop="city + '_huiju_amount'"></el-table-column>
          <el-table-column label="超4小时" :prop="city + '_over_4h'"></el-table-column>
          <el-table-column label="重要紧急" :prop="city + '_important_amount'"></el-table-column>
          <el-table-column label="超12小时" :prop="city + '_over_12h'"></el-table-column>
        </el-table-column>
      </el-table>
    </div>
  </div>
</div>

<script>
// 定义城市顺序
const cityOrder = ['深圳', '广州', '东莞', '佛山'];
const months = JSON.parse('{{ months|default([])|tojson|safe }}');
const pivotData = JSON.parse('{{ pivot_data|default({})|tojson|safe }}');
// 获取后端传来的城市列表并过滤排序
const allCities = JSON.parse('{{ cities|default([])|tojson|safe }}');
// 初始化cities数组
let cities = [];
// 按照指定顺序过滤城市
const sortedCities = cityOrder.filter(city => allCities.includes(city));
// 更新cities数组
cities = [...sortedCities]; // 使用排序后的城市

// 构造 Element Plus 需要的表格数据（适配pivot_data新格式，key为'huiju_amount|城市'）
const tableData = months.map(month => {
  const row = { month };
  const pd = pivotData[month] || {};
  cities.forEach(city => {
    row[city + '_huiju_amount'] = pd['huiju_amount|' + city] ?? 0;
    row[city + '_over_4h'] = pd['over_4h|' + city] ?? 0;
    row[city + '_important_amount'] = pd['important_amount|' + city] ?? 0;
    row[city + '_over_12h'] = pd['over_12h|' + city] ?? 0;
  });
  return row;
});
// 合计行（如需，可按需遍历tableData求和，这里不强制生成）


const { createApp } = Vue;
const app = createApp({
  data() {
    return {
      cities,
      tableData
    }
  }
});
app.use(ElementPlus);
app.mount('#ep-table-app');
</script>

<!-- 页面底部占位容器 -->
<div style="height:60px;width:100%;pointer-events:none;clear:both;"></div>
{% endblock %}
