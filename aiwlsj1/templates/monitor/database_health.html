{% extends "monitor/base_monitor.html" %}

{% block monitor_title %}数据库健康监控{% endblock %}
{% block monitor_subtitle %}实时监控数据库连接状态、表统计信息和性能指标{% endblock %}

{% block monitor_content %}
<div class="monitor-grid">
    <!-- 数据库连接状态卡片 -->
    <div class="monitor-card">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M12 2L2 7V10C2 16 6 20.9 12 22C18 20.9 22 16 22 10V7L12 2Z"/>
                </svg>
                连接状态
            </h3>
            <span id="connection-status" class="status-badge status-success">正常</span>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">数据库类型</span>
            <span class="monitor-metric-value">SQLite</span>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">连接状态</span>
            <span id="connection-text" class="monitor-metric-value">已连接</span>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">最后检查时间</span>
            <span id="last-check" class="monitor-metric-value">--</span>
        </div>
    </div>

    <!-- 数据库概览卡片 -->
    <div class="monitor-card">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M12 2C16.97 2 21 6.03 21 11C21 16.97 16.97 21 12 21C7.03 21 3 16.97 3 11C3 6.03 7.03 2 12 2ZM12 4C8.13 4 5 7.13 5 11C5 14.87 8.13 18 12 18C15.87 18 19 14.87 19 11C19 7.13 15.87 4 12 4Z"/>
                </svg>
                数据库概览
            </h3>
            <button class="refresh-btn" onclick="refreshDatabaseHealth()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 4V2A10 10 0 0 0 2 12H4A8 8 0 0 1 12 4Z"/>
                </svg>
                刷新
            </button>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">表数量</span>
            <span id="table-count" class="monitor-metric-value">--</span>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">总记录数</span>
            <span id="total-records" class="monitor-metric-value">--</span>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">数据库状态</span>
            <span id="database-status" class="monitor-metric-value">--</span>
        </div>
    </div>

    <!-- 表统计图表 -->
    <div class="monitor-card" style="grid-column: span 2;">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M3 3H21V21H3V3ZM5 5V19H19V5H5ZM7 7H17V9H7V7ZM7 11H17V13H7V11ZM7 15H17V17H7V15Z"/>
                </svg>
                数据表统计
            </h3>
        </div>
        <div class="chart-container">
            <div id="tables-chart"></div>
        </div>
    </div>
</div>

<!-- 详细表信息 -->
<div class="monitor-card">
    <div class="monitor-card-header">
        <h3 class="monitor-card-title">
            <svg class="monitor-card-icon" viewBox="0 0 24 24">
                <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM19 19H5V5H19V19Z"/>
            </svg>
            表详细信息
        </h3>
    </div>
    <div style="overflow-x: auto;">
        <table class="data-table">
            <thead>
                <tr>
                    <th>表名</th>
                    <th>记录数</th>
                    <th>状态</th>
                    <th>描述</th>
                </tr>
            </thead>
            <tbody id="tables-detail">
                <tr>
                    <td colspan="4" class="loading">加载中...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block monitor_js %}
<script>
let databaseData = null;
let tablesChart = null;

// 表名中文映射
const tableDisplayNames = {
    'pue_data': 'PUE数据',
    'fault_record': '故障记录',
    'huijugugan': '汇聚骨干',
    'zbk': '指标库',
    'pue_comment': 'PUE评论',
    'pue_drill_down_data': 'PUE钻取数据'
};

const tableDescriptions = {
    'pue_data': '机房PUE指标数据',
    'fault_record': '网络故障记录数据',
    'huijugugan': '汇聚骨干网络指标',
    'zbk': '基础指标库数据',
    'pue_comment': 'PUE分析评论数据',
    'pue_drill_down_data': 'PUE指标钻取明细'
};

async function loadDatabaseHealth() {
    try {
        console.log('开始加载数据库健康状态...');
        const response = await fetch('/tools/monitor/health/database');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('获取到数据:', data);
        databaseData = data;
        
        updateConnectionStatus(data.connection_status);
        updateDatabaseOverview(data);
        updateTablesChart(data.tables);
        updateTablesDetail(data.tables);
        
        document.getElementById('last-check').textContent = 
            new Date(data.check_timestamp).toLocaleString('zh-CN');
            
        console.log('数据库健康状态加载完成');
            
    } catch (error) {
        console.error('加载数据库健康状态失败:', error);
        updateConnectionStatus('异常');
        
        // 显示错误信息
        const chartContainer = document.getElementById('tables-chart');
        if (chartContainer) {
            chartContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 300px; color: #ef4444;">数据加载失败: ' + error.message + '</div>';
        }
    }
}

function updateConnectionStatus(status) {
    const statusElement = document.getElementById('connection-status');
    const textElement = document.getElementById('connection-text');
    
    statusElement.className = 'status-badge ' + (
        status === '正常' ? 'status-success' : 'status-danger'
    );
    statusElement.textContent = status;
    textElement.textContent = status === '正常' ? '已连接' : '连接失败';
}

function updateDatabaseOverview(data) {
    document.getElementById('table-count').textContent = data.table_count;
    document.getElementById('total-records').textContent = data.total_records.toLocaleString('zh-CN');
    document.getElementById('database-status').textContent = data.status;
}

function updateTablesChart(tables) {
    try {
        console.log('更新图表数据:', tables);
        
        if (tablesChart) {
            tablesChart.dispose();
        }
        
        // 检查容器是否存在
        const chartContainer = document.getElementById('tables-chart');
        if (!chartContainer) {
            console.error('图表容器不存在');
            return;
        }
        
        // 确保容器有尺寸
        chartContainer.style.width = '100%';
        chartContainer.style.height = '300px';
        
        const chartData = Object.entries(tables).map(([name, count]) => ({
            name: tableDisplayNames[name] || name,
            value: count
        })).filter(item => item.value > 0).sort((a, b) => b.value - a.value);
        
        console.log('处理后的图表数据:', chartData);
        
        if (chartData.length === 0) {
            chartContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 300px; color: #64748b;">暂无数据</div>';
            return;
        }
        
        tablesChart = echarts.init(chartContainer);
        
        const option = {
            tooltip: {
                trigger: 'item',
                formatter: '{a} <br/>{b}: {c} ({d}%)'
            },
            legend: {
                type: 'scroll',
                orient: 'vertical',
                right: 10,
                top: 20,
                bottom: 20,
                data: chartData.map(item => item.name),
                textStyle: {
                    fontSize: 12
                }
            },
            series: [
                {
                    name: '记录数',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['40%', '50%'],
                    avoidLabelOverlap: false,
                    label: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: '16',
                            fontWeight: 'bold'
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: chartData,
                    itemStyle: {
                        borderRadius: 8,
                        borderColor: '#fff',
                        borderWidth: 2
                    }
                }
            ],
            color: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4']
        };
        
        tablesChart.setOption(option);
        
        // 延迟调用resize确保图表正确显示
        setTimeout(() => {
            if (tablesChart) {
                tablesChart.resize();
            }
        }, 100);
        
        console.log('图表初始化完成');
        
    } catch (error) {
        console.error('图表更新失败:', error);
        const chartContainer = document.getElementById('tables-chart');
        if (chartContainer) {
            chartContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 300px; color: #ef4444;">图表加载失败</div>';
        }
    }
}

function updateTablesDetail(tables) {
    const tbody = document.getElementById('tables-detail');
    
    const rows = Object.entries(tables).map(([name, count]) => `
        <tr>
            <td>
                <strong>${tableDisplayNames[name] || name}</strong>
                <br><small style="color: #64748b;">${name}</small>
            </td>
            <td>
                <span style="font-size: 1.1em; font-weight: 600;">
                    ${count.toLocaleString('zh-CN')}
                </span>
            </td>
            <td>
                <span class="status-badge ${count > 0 ? 'status-success' : 'status-warning'}">
                    ${count > 0 ? '正常' : '空表'}
                </span>
            </td>
            <td>${tableDescriptions[name] || '暂无描述'}</td>
        </tr>
    `).join('');
    
    tbody.innerHTML = rows;
}

function refreshDatabaseHealth() {
    loadDatabaseHealth();
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadDatabaseHealth();
    
    // 自动刷新已禁用，用户可手动点击刷新按钮
    // setInterval(loadDatabaseHealth, 30000);
    
    // 响应式图表
    window.addEventListener('resize', function() {
        if (tablesChart) {
            tablesChart.resize();
        }
    });
});
</script>
{% endblock %}