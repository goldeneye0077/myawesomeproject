{% extends "monitor/base_monitor.html" %}

{% block monitor_breadcrumb %}
<li><span class="text-gray-400 mx-2">/</span></li>
<li class="text-gray-600">ä»ªè¡¨ç›˜</li>
{% endblock %}

{% block monitor_title %}ç³»ç»Ÿç›‘æ§ä»ªè¡¨ç›˜{% endblock %}
{% block monitor_subtitle %}ç³»ç»ŸçŠ¶æ€ç»¼åˆæ¦‚è§ˆ - ä¸€ç«™å¼ç›‘æ§æ‰€æœ‰å…³é”®æŒ‡æ ‡{% endblock %}

{% block monitor_content %}
<style>
/* è‡ªå®šä¹‰æŒ‰é’®æ ·å¼ - æ›´å°æ›´ç²¾è‡´ */
.monitor-card-header .refresh-btn {
    padding: 0.4rem 0.8rem !important;
    font-size: 0.8rem !important;
    border-radius: 6px !important;
    gap: 0.3rem !important;
    min-height: auto !important;
    line-height: 1.2 !important;
}

.monitor-card-header .refresh-btn svg {
    width: 14px !important;
    height: 14px !important;
}

.monitor-card-header .refresh-btn span {
    font-size: 0.8rem !important;
    line-height: 1 !important;
}

/* æŒ‰é’®å®¹å™¨å¯¹é½ */
.monitor-card-header > div {
    display: flex !important;
    align-items: center !important;
    gap: 0.5rem !important;
}

.monitor-card-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    min-height: 2rem !important;
}

/* è¡¨æƒ…ç¬¦å·å¤§å°è°ƒæ•´ */
.monitor-card-header .refresh-btn #auto-refresh-icon {
    font-size: 0.9rem !important;
    line-height: 1 !important;
}
</style>

<!-- é¡¶éƒ¨çŠ¶æ€å¡ç‰‡ -->
<div class="monitor-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 2rem;">
    <div class="monitor-card" style="text-align: center;">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M12 2L2 7V10C2 16 6 20.9 12 22C18 20.9 22 16 22 10V7L12 2Z"/>
                </svg>
                ç³»ç»ŸçŠ¶æ€
            </h3>
        </div>
        <div style="padding: 1rem 0;">
            <div id="system-status-icon" style="font-size: 3rem; margin-bottom: 0.5rem;">âš¡</div>
            <div id="system-status-text" style="font-size: 1.2rem; font-weight: 600; color: var(--success-color);">è¿è¡Œæ­£å¸¸</div>
            <div id="system-uptime" style="color: var(--text-secondary); margin-top: 0.5rem;">è¿è¡Œæ—¶é—´: --</div>
        </div>
    </div>

    <div class="monitor-card" style="text-align: center;">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM19 19H5V5H19V19Z"/>
                </svg>
                æ•°æ®åº“
            </h3>
        </div>
        <div style="padding: 1rem 0;">
            <div id="database-status-icon" style="font-size: 3rem; margin-bottom: 0.5rem;">ğŸ’¾</div>
            <div id="database-status-text" style="font-size: 1.2rem; font-weight: 600; color: var(--success-color);">è¿æ¥æ­£å¸¸</div>
            <div id="database-records" style="color: var(--text-secondary); margin-top: 0.5rem;">æ€»è®°å½•: --</div>
        </div>
    </div>

    <div class="monitor-card" style="text-align: center;">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M17 7H22V17H17V19A1 1 0 0 1 16 20H4A1 1 0 0 1 3 19V5A1 1 0 0 1 4 4H16A1 1 0 0 1 17 5V7ZM5 6V18H15V6H5Z"/>
                </svg>
                CPU
            </h3>
        </div>
        <div style="padding: 1rem 0;">
            <div id="cpu-usage-display" style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">--%</div>
            <div id="cpu-status-text" style="color: var(--success-color);">ä½¿ç”¨ç‡æ­£å¸¸</div>
        </div>
    </div>

    <div class="monitor-card" style="text-align: center;">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M6 2V20H18V2H6ZM16 18H8V4H16V18Z"/>
                </svg>
                å†…å­˜
            </h3>
        </div>
        <div style="padding: 1rem 0;">
            <div id="memory-usage-display" style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">--%</div>
            <div id="memory-status-text" style="color: var(--success-color);">ä½¿ç”¨ç‡æ­£å¸¸</div>
        </div>
    </div>

    <div class="monitor-card" style="text-align: center;">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M6 2C4.89 2 4 2.89 4 4V20A2 2 0 0 0 6 22H18A2 2 0 0 0 20 20V8L14 2H6Z"/>
                </svg>
                ç£ç›˜
            </h3>
        </div>
        <div style="padding: 1rem 0;">
            <div id="disk-usage-display" style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">--%</div>
            <div id="disk-status-text" style="color: var(--success-color);">ä½¿ç”¨ç‡æ­£å¸¸</div>
        </div>
    </div>
</div>

<!-- ä¸»è¦ç›‘æ§å›¾è¡¨ -->
<div class="monitor-grid">
    <!-- ç³»ç»Ÿæ€§èƒ½æ€»è§ˆ -->
    <div class="monitor-card" style="grid-column: span 2;">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M22 6.92L20.59 5.51L16.5 9.6L13 6.1L2.39 16.71L3.81 18.12L13 8.93L16.5 12.43L22 6.92Z"/>
                </svg>
                ç³»ç»Ÿæ€§èƒ½å®æ—¶ç›‘æ§
            </h3>
            <div>
                <button class="refresh-btn" onclick="refreshDashboard()" style="margin-right: 0.5rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 4V2A10 10 0 0 0 2 12H4A8 8 0 0 1 12 4Z"/>
                    </svg>
                    åˆ·æ–°
                </button>
                <button class="refresh-btn" id="auto-refresh-toggle" onclick="toggleAutoRefresh()">
                    <span id="auto-refresh-icon">â¸ï¸</span>
                    <span id="auto-refresh-text">æš‚åœ</span>
                </button>
            </div>
        </div>
        <div class="chart-container" style="height: 350px;">
            <div id="performance-overview" style="height: 100%;"></div>
        </div>
    </div>

    <!-- æ•°æ®åº“è¡¨ç»Ÿè®¡ -->
    <div class="monitor-card">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M3 3H21V21H3V3ZM5 5V19H19V5H5Z"/>
                </svg>
                æ•°æ®åº“è¡¨ç»Ÿè®¡
            </h3>
        </div>
        <div class="chart-container" style="height: 300px;">
            <div id="database-tables-chart" style="height: 100%;"></div>
        </div>
    </div>

    <!-- ç³»ç»Ÿæ•…éšœç»Ÿè®¡ -->
    <div class="monitor-card">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M12 9C13.1 9 14 8.1 14 7C14 5.9 13.1 5 12 5C10.9 5 10 5.9 10 7C10 8.1 10.9 9 12 9ZM12 11C10.9 11 10 11.9 10 13C10 14.1 10.9 15 12 15C13.1 15 14 14.1 14 13C14 11.9 13.1 11 12 11ZM12 17C10.9 17 10 17.9 10 19C10 20.1 10.9 21 12 21C13.1 21 14 20.1 14 19C14 17.9 13.1 17 12 17Z"/>
                </svg>
                ç³»ç»Ÿæ•…éšœç»Ÿè®¡
            </h3>
            <span id="system-fault-status" class="status-badge status-success">æ­£å¸¸</span>
        </div>
        <div style="padding: 1rem 0;">
            <div class="monitor-metric">
                <span class="monitor-metric-label">æ€»æ•…éšœæ•°</span>
                <span id="total-faults" class="monitor-metric-value">--</span>
            </div>
            <div class="monitor-metric">
                <span class="monitor-metric-label">æœªè§£å†³ä¸¥é‡æ•…éšœ</span>
                <span id="critical-open-faults" class="monitor-metric-value">--</span>
            </div>
            <div class="monitor-metric">
                <span class="monitor-metric-label">è¿‘7å¤©æ•…éšœ</span>
                <span id="recent-faults" class="monitor-metric-value">--</span>
            </div>
        </div>
    </div>
</div>

<!-- è¯¦ç»†ä¿¡æ¯è¡¨æ ¼ -->
<div class="monitor-grid">
    <!-- ç³»ç»Ÿè¯¦ç»†ä¿¡æ¯ -->
    <div class="monitor-card">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M4 6H20V18H4V6ZM6 8V16H18V8H6Z"/>
                </svg>
                ç³»ç»Ÿè¯¦ç»†ä¿¡æ¯
            </h3>
        </div>
        <div style="overflow-y: auto; max-height: 300px;">
            <table class="data-table">
                <tbody id="system-details">
                    <tr><td>ç³»ç»Ÿè¿è¡Œæ—¶é—´</td><td id="detail-uptime">--</td></tr>
                    <tr><td>CPUä½¿ç”¨ç‡</td><td id="detail-cpu">--</td></tr>
                    <tr><td>å†…å­˜ä½¿ç”¨ç‡</td><td id="detail-memory">--</td></tr>
                    <tr><td>å·²ç”¨å†…å­˜</td><td id="detail-memory-used">--</td></tr>
                    <tr><td>å¯ç”¨å†…å­˜</td><td id="detail-memory-available">--</td></tr>
                    <tr><td>ç£ç›˜ä½¿ç”¨ç‡</td><td id="detail-disk">--</td></tr>
                    <tr><td>æ•°æ®åº“çŠ¶æ€</td><td id="detail-db-status">--</td></tr>
                    <tr><td>æœ€åæ›´æ–°</td><td id="detail-last-update">--</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- å¿«é€Ÿæ“ä½œé¢æ¿ -->
    <div class="monitor-card">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1L9 7V9C9 10.1 9.9 11 11 11V15L13 13.5V11C14.1 11 15 10.1 15 9V7L21 9Z"/>
                </svg>
                å¿«é€Ÿæ“ä½œ
            </h3>
        </div>
        <div style="display: flex; flex-direction: column; gap: 0.75rem; padding: 1rem 0;">
            <a href="/tools/monitor/database" class="refresh-btn" style="text-decoration: none; text-align: center;">
                ğŸ“Š æ•°æ®åº“è¯¦æƒ…
            </a>
            <a href="/tools/monitor/performance" class="refresh-btn" style="text-decoration: none; text-align: center;">
                âš¡ æ€§èƒ½ç›‘æ§
            </a>
            <a href="/tools/monitor/logs" class="refresh-btn" style="text-decoration: none; text-align: center;">
                ğŸ“ æŸ¥çœ‹æ—¥å¿—
            </a>
            <button class="refresh-btn" onclick="downloadReport()" style="background: var(--success-color);">
                ğŸ“¥ ä¸‹è½½æŠ¥å‘Š
            </button>
        </div>
    </div>
</div>

<!-- çŠ¶æ€æ€»ç»“å¡ç‰‡ -->
<div class="monitor-card">
    <div class="monitor-card-header">
        <h3 class="monitor-card-title">
            <svg class="monitor-card-icon" viewBox="0 0 24 24">
                <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z"/>
            </svg>
            ç³»ç»Ÿå¥åº·è¯„åˆ†
        </h3>
        <span id="health-score-badge" class="status-badge status-success">ä¼˜ç§€</span>
    </div>
    <div style="display: flex; align-items: center; gap: 2rem; padding: 1rem 0;">
        <div class="chart-container" style="height: 150px; width: 150px;">
            <div id="health-score-gauge" style="height: 100%; width: 100%;"></div>
        </div>
        <div style="flex: 1;">
            <div id="health-summary" style="color: var(--text-secondary); line-height: 1.6;">
                æ­£åœ¨è®¡ç®—ç³»ç»Ÿå¥åº·è¯„åˆ†...
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block monitor_js %}
<script>
let dashboardData = {
    system: null,
    database: null,
    performance: null
};
let charts = {};
let autoRefreshEnabled = true;
// refreshInterval å·²åœ¨ base_monitor.html ä¸­å£°æ˜

async function loadAllMonitoringData() {
    console.log('å¼€å§‹åŠ è½½ç›‘æ§æ•°æ®...');
    try {
        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰ç›‘æ§æ•°æ®
        console.log('å‘èµ·APIè¯·æ±‚...');
        const [systemResponse, databaseResponse, performanceResponse, systemFaultsResponse] = await Promise.all([
            fetch('/tools/monitor/status/overview'),
            fetch('/tools/monitor/health/database'),
            fetch('/tools/monitor/performance/metrics'),
            fetch('/tools/monitor/system-faults/stats')
        ]);
        
        console.log('APIå“åº”çŠ¶æ€:', {
            system: systemResponse.status,
            database: databaseResponse.status,
            performance: performanceResponse.status,
            systemFaults: systemFaultsResponse.status
        });

        const systemData = await systemResponse.json();
        const databaseData = await databaseResponse.json();
        const performanceData = await performanceResponse.json();
        const systemFaultsData = await systemFaultsResponse.json();

        console.log('æ¥æ”¶åˆ°çš„æ•°æ®:', {
            systemData,
            databaseData,
            performanceData,
            systemFaultsData
        });

        dashboardData.system = systemData;
        dashboardData.database = databaseData;
        dashboardData.performance = performanceData;
        dashboardData.systemFaults = systemFaultsData;

        console.log('dashboardDataå·²æ›´æ–°:', dashboardData);
        updateDashboard();

    } catch (error) {
        console.error('åŠ è½½ç›‘æ§æ•°æ®å¤±è´¥:', error);
        console.error('é”™è¯¯è¯¦æƒ…:', {
            message: error.message,
            stack: error.stack,
            name: error.name
        });
        
        // å°è¯•å•ç‹¬å¤„ç†æ¯ä¸ªAPIçš„é”™è¯¯
        try {
            console.log('å°è¯•å•ç‹¬åŠ è½½å„ä¸ªAPI...');
            await loadDataIndividually();
        } catch (fallbackError) {
            console.error('å•ç‹¬åŠ è½½ä¹Ÿå¤±è´¥:', fallbackError);
            showErrorStatus();
        }
    }
}

// å•ç‹¬åŠ è½½æ¯ä¸ªAPIçš„å‡½æ•°
async function loadDataIndividually() {
    console.log('å¼€å§‹å•ç‹¬åŠ è½½APIæ•°æ®...');
    
    // ç³»ç»ŸçŠ¶æ€
    try {
        const systemResponse = await fetch('/tools/monitor/status/overview');
        if (systemResponse.ok) {
            dashboardData.system = await systemResponse.json();
            console.log('ç³»ç»ŸçŠ¶æ€åŠ è½½æˆåŠŸ');
        }
    } catch (e) { console.error('ç³»ç»ŸçŠ¶æ€åŠ è½½å¤±è´¥:', e); }
    
    // æ•°æ®åº“çŠ¶æ€
    try {
        const databaseResponse = await fetch('/tools/monitor/health/database');
        if (databaseResponse.ok) {
            dashboardData.database = await databaseResponse.json();
            console.log('æ•°æ®åº“çŠ¶æ€åŠ è½½æˆåŠŸ');
        }
    } catch (e) { console.error('æ•°æ®åº“çŠ¶æ€åŠ è½½å¤±è´¥:', e); }
    
    // æ€§èƒ½æ•°æ®
    try {
        const performanceResponse = await fetch('/tools/monitor/performance/metrics');
        if (performanceResponse.ok) {
            dashboardData.performance = await performanceResponse.json();
            console.log('æ€§èƒ½æ•°æ®åŠ è½½æˆåŠŸ');
        }
    } catch (e) { console.error('æ€§èƒ½æ•°æ®åŠ è½½å¤±è´¥:', e); }
    
    // ç³»ç»Ÿæ•…éšœ
    try {
        const systemFaultsResponse = await fetch('/tools/monitor/system-faults/stats');
        if (systemFaultsResponse.ok) {
            dashboardData.systemFaults = await systemFaultsResponse.json();
            console.log('ç³»ç»Ÿæ•…éšœæ•°æ®åŠ è½½æˆåŠŸ');
        }
    } catch (e) { console.error('ç³»ç»Ÿæ•…éšœæ•°æ®åŠ è½½å¤±è´¥:', e); }
    
    console.log('å•ç‹¬åŠ è½½å®Œæˆï¼Œå¼€å§‹æ›´æ–°ç•Œé¢...');
    updateDashboard();
}

function updateDashboard() {
    updateStatusCards();
    updatePerformanceChart();
    updateDatabaseChart();
    updateSystemFaultStats();
    updateSystemDetails();
    updateHealthScore();
}

function updateStatusCards() {
    console.log('å¼€å§‹æ›´æ–°çŠ¶æ€å¡ç‰‡...');
    const { system, database, performance } = dashboardData;
    console.log('è§£æ„çš„æ•°æ®:', { system, database, performance });

    // ç³»ç»ŸçŠ¶æ€
    if (system) {
        console.log('æ›´æ–°ç³»ç»ŸçŠ¶æ€...', system);
        const statusIcon = document.getElementById('system-status-icon');
        const statusText = document.getElementById('system-status-text');
        const uptime = document.getElementById('system-uptime');
        
        console.log('ç³»ç»ŸçŠ¶æ€DOMå…ƒç´ :', { statusIcon, statusText, uptime });
        
        if (statusIcon && statusText && uptime) {
            if (system.database_health === 'æ­£å¸¸') {
                statusIcon.textContent = 'âœ…';
                statusText.textContent = 'è¿è¡Œæ­£å¸¸';
                statusText.style.color = 'var(--success-color)';
            } else {
                statusIcon.textContent = 'âš ï¸';
                statusText.textContent = 'å¼‚å¸¸';
                statusText.style.color = 'var(--danger-color)';
            }
            uptime.textContent = `è¿è¡Œæ—¶é—´: ${formatUptime(system.uptime_seconds)}`;
            console.log('ç³»ç»ŸçŠ¶æ€æ›´æ–°å®Œæˆ');
        } else {
            console.error('ç³»ç»ŸçŠ¶æ€DOMå…ƒç´ æœªæ‰¾åˆ°:', { statusIcon, statusText, uptime });
        }
    }

    // æ•°æ®åº“çŠ¶æ€
    if (database) {
        console.log('æ›´æ–°æ•°æ®åº“çŠ¶æ€...', database);
        const dbIcon = document.getElementById('database-status-icon');
        const dbText = document.getElementById('database-status-text');
        const dbRecords = document.getElementById('database-records');
        
        console.log('æ•°æ®åº“çŠ¶æ€DOMå…ƒç´ :', { dbIcon, dbText, dbRecords });
        
        if (dbIcon && dbText && dbRecords) {
            if (database.connection_status === 'æ­£å¸¸') {
                dbIcon.textContent = 'âœ…';
                dbText.textContent = 'è¿æ¥æ­£å¸¸';
                dbText.style.color = 'var(--success-color)';
            } else {
                dbIcon.textContent = 'âŒ';
                dbText.textContent = 'è¿æ¥å¼‚å¸¸';
                dbText.style.color = 'var(--danger-color)';
            }
            dbRecords.textContent = `æ€»è®°å½•: ${database.total_records.toLocaleString('zh-CN')}`;
            console.log('æ•°æ®åº“çŠ¶æ€æ›´æ–°å®Œæˆ');
        } else {
            console.error('æ•°æ®åº“çŠ¶æ€DOMå…ƒç´ æœªæ‰¾åˆ°:', { dbIcon, dbText, dbRecords });
        }
    }

    // CPUçŠ¶æ€
    if (performance) {
        console.log('æ›´æ–°æ€§èƒ½æ•°æ®...', performance);
        const cpuDisplay = document.getElementById('cpu-usage-display');
        const cpuText = document.getElementById('cpu-status-text');
        
        console.log('CPU DOMå…ƒç´ :', { cpuDisplay, cpuText });
        
        if (cpuDisplay && cpuText) {
            cpuDisplay.textContent = `${performance.cpu_percent}%`;
            
            if (performance.cpu_percent < 70) {
                cpuText.textContent = 'ä½¿ç”¨ç‡æ­£å¸¸';
                cpuText.style.color = 'var(--success-color)';
                cpuDisplay.style.color = 'var(--success-color)';
            } else if (performance.cpu_percent < 90) {
                cpuText.textContent = 'ä½¿ç”¨ç‡åé«˜';
                cpuText.style.color = 'var(--warning-color)';
                cpuDisplay.style.color = 'var(--warning-color)';
            } else {
                cpuText.textContent = 'ä½¿ç”¨ç‡å±é™©';
                cpuText.style.color = 'var(--danger-color)';
                cpuDisplay.style.color = 'var(--danger-color)';
            }
            console.log('CPUçŠ¶æ€æ›´æ–°å®Œæˆ');
        } else {
            console.error('CPU DOMå…ƒç´ æœªæ‰¾åˆ°:', { cpuDisplay, cpuText });
        }

        // å†…å­˜çŠ¶æ€
        const memoryDisplay = document.getElementById('memory-usage-display');
        const memoryText = document.getElementById('memory-status-text');
        
        console.log('å†…å­˜DOMå…ƒç´ :', { memoryDisplay, memoryText });
        
        if (memoryDisplay && memoryText) {
            memoryDisplay.textContent = `${performance.memory_percent}%`;
            
            if (performance.memory_percent < 75) {
                memoryText.textContent = 'ä½¿ç”¨ç‡æ­£å¸¸';
                memoryText.style.color = 'var(--success-color)';
                memoryDisplay.style.color = 'var(--success-color)';
            } else if (performance.memory_percent < 85) {
                memoryText.textContent = 'ä½¿ç”¨ç‡åé«˜';
                memoryText.style.color = 'var(--warning-color)';
                memoryDisplay.style.color = 'var(--warning-color)';
            } else {
                memoryText.textContent = 'ä½¿ç”¨ç‡å±é™©';
                memoryText.style.color = 'var(--danger-color)';
                memoryDisplay.style.color = 'var(--danger-color)';
            }
            console.log('å†…å­˜çŠ¶æ€æ›´æ–°å®Œæˆ');
        } else {
            console.error('å†…å­˜DOMå…ƒç´ æœªæ‰¾åˆ°:', { memoryDisplay, memoryText });
        }

        // ç£ç›˜çŠ¶æ€
        const diskDisplay = document.getElementById('disk-usage-display');
        const diskText = document.getElementById('disk-status-text');
        
        console.log('ç£ç›˜DOMå…ƒç´ :', { diskDisplay, diskText });
        
        if (diskDisplay && diskText) {
            diskDisplay.textContent = `${performance.disk_usage_percent}%`;
            
            if (performance.disk_usage_percent < 80) {
                diskText.textContent = 'ä½¿ç”¨ç‡æ­£å¸¸';
                diskText.style.color = 'var(--success-color)';
                diskDisplay.style.color = 'var(--success-color)';
            } else if (performance.disk_usage_percent < 90) {
                diskText.textContent = 'ä½¿ç”¨ç‡åé«˜';
                diskText.style.color = 'var(--warning-color)';
                diskDisplay.style.color = 'var(--warning-color)';
            } else {
                diskText.textContent = 'ä½¿ç”¨ç‡å±é™©';
                diskText.style.color = 'var(--danger-color)';
                diskDisplay.style.color = 'var(--danger-color)';
            }
            console.log('ç£ç›˜çŠ¶æ€æ›´æ–°å®Œæˆ');
        } else {
            console.error('ç£ç›˜DOMå…ƒç´ æœªæ‰¾åˆ°:', { diskDisplay, diskText });
        }
    }
}

function updatePerformanceChart() {
    console.log('updatePerformanceChart è°ƒç”¨, dashboardData.performance:', dashboardData.performance);
    if (!dashboardData.performance) {
        console.error('ç³»ç»Ÿæ€§èƒ½å›¾è¡¨: æ²¡æœ‰æ€§èƒ½æ•°æ®');
        return;
    }

    const performance = dashboardData.performance;
    console.log('ç³»ç»Ÿæ€§èƒ½å›¾è¡¨: å‡†å¤‡æ¸²æŸ“å›¾è¡¨', performance);
    
    if (charts.performance) {
        charts.performance.dispose();
    }

    const performanceElement = document.getElementById('performance-overview');
    console.log('ç³»ç»Ÿæ€§èƒ½å›¾è¡¨DOMå…ƒç´ :', performanceElement);
    console.log('EChartsæ˜¯å¦åŠ è½½:', typeof echarts);
    
    charts.performance = echarts.init(performanceElement);
    console.log('ç³»ç»Ÿæ€§èƒ½å›¾è¡¨åˆå§‹åŒ–:', charts.performance);

    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' }
        },
        legend: {
            data: ['ä½¿ç”¨ç‡', 'å®‰å…¨é˜ˆå€¼']
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: [
            {
                type: 'category',
                data: ['CPU', 'å†…å­˜', 'ç£ç›˜']
            }
        ],
        yAxis: [
            {
                type: 'value',
                max: 100,
                axisLabel: {
                    formatter: '{value}%'
                }
            }
        ],
        series: [
            {
                name: 'ä½¿ç”¨ç‡',
                type: 'bar',
                data: [
                    {
                        value: performance.cpu_percent,
                        itemStyle: {
                            color: performance.cpu_percent > 70 ? '#ef4444' : performance.cpu_percent > 50 ? '#f59e0b' : '#10b981'
                        }
                    },
                    {
                        value: performance.memory_percent,
                        itemStyle: {
                            color: performance.memory_percent > 75 ? '#ef4444' : performance.memory_percent > 50 ? '#f59e0b' : '#10b981'
                        }
                    },
                    {
                        value: performance.disk_usage_percent,
                        itemStyle: {
                            color: performance.disk_usage_percent > 80 ? '#ef4444' : performance.disk_usage_percent > 60 ? '#f59e0b' : '#10b981'
                        }
                    }
                ]
            },
            {
                name: 'å®‰å…¨é˜ˆå€¼',
                type: 'line',
                data: [70, 75, 80],
                lineStyle: { color: '#f59e0b', type: 'dashed' },
                symbol: 'none'
            }
        ]
    };

    console.log('ç³»ç»Ÿæ€§èƒ½å›¾è¡¨é…ç½®é€‰é¡¹:', option);
    try {
        charts.performance.setOption(option);
        // å¼ºåˆ¶å›¾è¡¨é‡æ–°è®¡ç®—å¤§å°
        setTimeout(() => {
            charts.performance.resize();
        }, 100);
        console.log('ç³»ç»Ÿæ€§èƒ½å›¾è¡¨æ¸²æŸ“æˆåŠŸ');
    } catch (error) {
        console.error('ç³»ç»Ÿæ€§èƒ½å›¾è¡¨æ¸²æŸ“å¤±è´¥:', error);
    }
}

function updateDatabaseChart() {
    console.log('updateDatabaseChart è°ƒç”¨, dashboardData.database:', dashboardData.database);
    if (!dashboardData.database) {
        console.error('æ•°æ®åº“ç»Ÿè®¡å›¾è¡¨: æ²¡æœ‰æ•°æ®åº“æ•°æ®');
        return;
    }

    const database = dashboardData.database;
    console.log('æ•°æ®åº“ç»Ÿè®¡å›¾è¡¨: å‡†å¤‡æ¸²æŸ“å›¾è¡¨', database);
    
    if (charts.database) {
        charts.database.dispose();
    }

    const databaseElement = document.getElementById('database-tables-chart');
    console.log('æ•°æ®åº“ç»Ÿè®¡å›¾è¡¨DOMå…ƒç´ :', databaseElement);
    
    charts.database = echarts.init(databaseElement);
    console.log('æ•°æ®åº“ç»Ÿè®¡å›¾è¡¨åˆå§‹åŒ–:', charts.database);

    const tableData = Object.entries(database.tables).map(([name, count]) => ({
        name: name === 'pue_data' ? 'PUEæ•°æ®' :
              name === 'fault_record' ? 'ç½‘ç»œæ•…éšœæ•°æ®' :
              name === 'huijugugan' ? 'æ±‡èšéª¨å¹²' :
              name === 'zbk' ? 'æŒ‡æ ‡åº“' :
              name === 'pue_comment' ? 'PUEè¯„è®º' :
              name === 'pue_drill_down_data' ? 'PUEé’»å–' : name,
        value: count
    })).sort((a, b) => b.value - a.value);

    const option = {
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c} ({d}%)'
        },
        series: [
            {
                type: 'pie',
                radius: ['50%', '70%'],
                avoidLabelOverlap: false,
                label: {
                    show: false
                },
                emphasis: {
                    label: {
                        show: true,
                        fontSize: '12',
                        fontWeight: 'bold'
                    }
                },
                labelLine: {
                    show: false
                },
                data: tableData
            }
        ]
    };

    console.log('æ•°æ®åº“ç»Ÿè®¡å›¾è¡¨é…ç½®é€‰é¡¹:', option);
    console.log('æ•°æ®åº“è¡¨æ•°æ®:', tableData);
    try {
        charts.database.setOption(option);
        // å¼ºåˆ¶å›¾è¡¨é‡æ–°è®¡ç®—å¤§å°
        setTimeout(() => {
            charts.database.resize();
        }, 100);
        console.log('æ•°æ®åº“ç»Ÿè®¡å›¾è¡¨æ¸²æŸ“æˆåŠŸ');
    } catch (error) {
        console.error('æ•°æ®åº“ç»Ÿè®¡å›¾è¡¨æ¸²æŸ“å¤±è´¥:', error);
    }
}

function updateSystemFaultStats() {
    if (!dashboardData.systemFaults) return;

    const faultStats = dashboardData.systemFaults;
    
    // æ›´æ–°æ€»æ•…éšœæ•°
    document.getElementById('total-faults').textContent = faultStats.total_faults.toLocaleString('zh-CN');
    
    // æ›´æ–°æœªè§£å†³ä¸¥é‡æ•…éšœ
    const criticalOpenElement = document.getElementById('critical-open-faults');
    criticalOpenElement.textContent = faultStats.critical_open.toLocaleString('zh-CN');
    
    // æ›´æ–°è¿‘7å¤©æ•…éšœ
    document.getElementById('recent-faults').textContent = faultStats.recent_7_days.toLocaleString('zh-CN');
    
    // æ›´æ–°ç³»ç»Ÿæ•…éšœçŠ¶æ€æŒ‡ç¤ºå™¨
    const faultStatusElement = document.getElementById('system-fault-status');
    const healthStatus = faultStats.health_status;
    
    faultStatusElement.className = 'status-badge ' + 
        (healthStatus === 'healthy' ? 'status-success' : 
         healthStatus === 'warning' ? 'status-warning' : 'status-danger');
    
    faultStatusElement.textContent = 
        healthStatus === 'healthy' ? 'æ­£å¸¸' : 
        healthStatus === 'warning' ? 'è­¦å‘Š' : 'ä¸¥é‡';
}

function updateSystemDetails() {
    const { system, performance } = dashboardData;

    if (system) {
        document.getElementById('detail-uptime').textContent = formatUptime(system.uptime_seconds);
        document.getElementById('detail-db-status').textContent = system.database_health;
    }

    if (performance) {
        document.getElementById('detail-cpu').textContent = `${performance.cpu_percent}%`;
        document.getElementById('detail-memory').textContent = `${performance.memory_percent}%`;
        document.getElementById('detail-memory-used').textContent = formatBytes(performance.memory_used_mb * 1024 * 1024);
        document.getElementById('detail-memory-available').textContent = formatBytes(performance.memory_available_mb * 1024 * 1024);
        document.getElementById('detail-disk').textContent = `${performance.disk_usage_percent}%`;
        document.getElementById('detail-last-update').textContent = new Date(performance.timestamp).toLocaleString('zh-CN');
    }
}

function updateHealthScore() {
    console.log('updateHealthScore è°ƒç”¨, dashboardData:', dashboardData);
    const { system, database, performance } = dashboardData;
    console.log('å¥åº·è¯„åˆ†è®¡ç®—æ•°æ®:', { system, database, performance });
    let score = 100;
    let issues = [];

    // è®¡ç®—å¥åº·è¯„åˆ†
    if (system && system.database_health !== 'æ­£å¸¸') {
        score -= 30;
        issues.push('æ•°æ®åº“è¿æ¥å¼‚å¸¸');
    }

    if (performance) {
        if (performance.cpu_percent > 90) {
            score -= 25;
            issues.push('CPUä½¿ç”¨ç‡è¿‡é«˜');
        } else if (performance.cpu_percent > 70) {
            score -= 10;
            issues.push('CPUä½¿ç”¨ç‡åé«˜');
        }

        if (performance.memory_percent > 85) {
            score -= 20;
            issues.push('å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜');
        } else if (performance.memory_percent > 75) {
            score -= 8;
            issues.push('å†…å­˜ä½¿ç”¨ç‡åé«˜');
        }

        if (performance.disk_usage_percent > 90) {
            score -= 15;
            issues.push('ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜');
        } else if (performance.disk_usage_percent > 80) {
            score -= 5;
            issues.push('ç£ç›˜ä½¿ç”¨ç‡åé«˜');
        }
    }

    score = Math.max(0, score);

    // æ›´æ–°è¯„åˆ†æ˜¾ç¤º
    const badge = document.getElementById('health-score-badge');
    let status = 'ä¼˜ç§€';
    let badgeClass = 'status-success';
    
    if (score < 60) {
        status = 'å±é™©';
        badgeClass = 'status-danger';
    } else if (score < 80) {
        status = 'è­¦å‘Š';
        badgeClass = 'status-warning';
    }

    badge.textContent = status;
    badge.className = `status-badge ${badgeClass}`;

    // æ›´æ–°å¥åº·è¯„åˆ†ä»ªè¡¨ç›˜
    updateHealthScoreGauge(score);

    // æ›´æ–°å¥åº·æ€»ç»“
    const summary = document.getElementById('health-summary');
    if (issues.length === 0) {
        summary.innerHTML = `
            <div style="color: var(--success-color); font-weight: 600;">ğŸ‰ ç³»ç»Ÿè¿è¡ŒçŠ¶æ€è‰¯å¥½ï¼</div>
            <div style="margin-top: 0.5rem;">æ‰€æœ‰å…³é”®æŒ‡æ ‡å‡åœ¨æ­£å¸¸èŒƒå›´å†…ï¼Œç³»ç»Ÿæ€§èƒ½ç¨³å®šã€‚</div>
        `;
    } else {
        summary.innerHTML = `
            <div style="color: var(--warning-color); font-weight: 600;">âš ï¸ å‘ç° ${issues.length} ä¸ªéœ€è¦å…³æ³¨çš„é—®é¢˜ï¼š</div>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                ${issues.map(issue => `<li>${issue}</li>`).join('')}
            </ul>
            <div style="color: var(--text-secondary); font-size: 0.9rem;">å»ºè®®åŠæ—¶å¤„ç†ä»¥ä¿è¯ç³»ç»Ÿç¨³å®šè¿è¡Œã€‚</div>
        `;
    }
}

function updateHealthScoreGauge(score) {
    console.log('updateHealthScoreGauge è°ƒç”¨, score:', score);
    if (charts.healthScore) {
        charts.healthScore.dispose();
    }

    const gaugeElement = document.getElementById('health-score-gauge');
    console.log('å¥åº·è¯„åˆ†ä»ªè¡¨ç›˜DOMå…ƒç´ :', gaugeElement);
    
    charts.healthScore = echarts.init(gaugeElement);
    console.log('å¥åº·è¯„åˆ†ä»ªè¡¨ç›˜åˆå§‹åŒ–:', charts.healthScore);

    let color = '#10b981'; // ç»¿è‰²
    if (score < 60) color = '#ef4444'; // çº¢è‰²
    else if (score < 80) color = '#f59e0b'; // é»„è‰²

    const option = {
        series: [{
            type: 'gauge',
            progress: {
                show: true,
                width: 12,
                itemStyle: { color: color }
            },
            axisLine: {
                lineStyle: {
                    width: 12,
                    color: [[1, '#e5e7eb']]
                }
            },
            axisTick: { show: false },
            splitLine: {
                length: 8,
                lineStyle: { width: 2, color: '#999' }
            },
            axisLabel: {
                distance: 15,
                color: '#666',
                fontSize: 10
            },
            anchor: { show: false },
            title: { show: false },
            detail: {
                valueAnimation: true,
                formatter: '{value}',
                color: color,
                fontSize: 24,
                fontWeight: 'bold',
                offsetCenter: [0, '70%']
            },
            data: [{ value: Math.round(score), name: 'å¥åº·è¯„åˆ†' }]
        }]
    };

    console.log('å¥åº·è¯„åˆ†ä»ªè¡¨ç›˜é…ç½®é€‰é¡¹:', option);
    try {
        charts.healthScore.setOption(option);
        // å¼ºåˆ¶å›¾è¡¨é‡æ–°è®¡ç®—å¤§å°
        setTimeout(() => {
            charts.healthScore.resize();
        }, 100);
        console.log('å¥åº·è¯„åˆ†ä»ªè¡¨ç›˜æ¸²æŸ“æˆåŠŸ');
    } catch (error) {
        console.error('å¥åº·è¯„åˆ†ä»ªè¡¨ç›˜æ¸²æŸ“å¤±è´¥:', error);
    }
}

function refreshDashboard() {
    loadAllMonitoringData();
}

function toggleAutoRefresh() {
    const icon = document.getElementById('auto-refresh-icon');
    const text = document.getElementById('auto-refresh-text');
    
    autoRefreshEnabled = !autoRefreshEnabled;
    
    if (autoRefreshEnabled) {
        icon.textContent = 'â¸ï¸';
        text.textContent = 'æš‚åœ';
        startAutoRefresh();
    } else {
        icon.textContent = 'â–¶ï¸';
        text.textContent = 'å¯åŠ¨';
        stopAutoRefresh();
    }
}

function startAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(loadAllMonitoringData, 10000); // æ¯10ç§’åˆ·æ–°
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

function downloadReport() {
    const report = {
        timestamp: new Date().toISOString(),
        system: dashboardData.system,
        database: dashboardData.database,
        performance: dashboardData.performance
    };
    
    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `system_report_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function showErrorStatus() {
    document.getElementById('system-status-icon').textContent = 'âŒ';
    document.getElementById('system-status-text').textContent = 'åŠ è½½å¤±è´¥';
    document.getElementById('system-status-text').style.color = 'var(--danger-color)';
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMå·²åŠ è½½ï¼Œæ£€æŸ¥å…³é”®å…ƒç´ ...');
    
    // æ£€æŸ¥å…³é”®DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
    const keyElements = [
        'system-status-icon', 'system-status-text', 'system-uptime',
        'database-status-icon', 'database-status-text', 'database-records',
        'cpu-usage-display', 'cpu-status-text',
        'memory-usage-display', 'memory-status-text',
        'disk-usage-display', 'disk-status-text'
    ];
    
    const missingElements = keyElements.filter(id => !document.getElementById(id));
    if (missingElements.length > 0) {
        console.error('ç¼ºå¤±çš„DOMå…ƒç´ :', missingElements);
    } else {
        console.log('æ‰€æœ‰å…³é”®DOMå…ƒç´ å·²æ‰¾åˆ°');
    }
    
    // å»¶è¿Ÿ500mså†åŠ è½½æ•°æ®ï¼Œç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å·²æ¸²æŸ“
    setTimeout(() => {
        console.log('å¼€å§‹åˆå§‹åŒ–æ•°æ®åŠ è½½...');
        loadAllMonitoringData();
        startAutoRefresh();
    }, 500);
    
    // å“åº”å¼å›¾è¡¨
    window.addEventListener('resize', function() {
        Object.values(charts).forEach(chart => {
            if (chart && typeof chart.resize === 'function') {
                chart.resize();
            }
        });
    });
});

// é¡µé¢ç¦»å¼€æ—¶æ¸…ç†
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
    Object.values(charts).forEach(chart => {
        if (chart && typeof chart.dispose === 'function') {
            chart.dispose();
        }
    });
});
</script>
{% endblock %}