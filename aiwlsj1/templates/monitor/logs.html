{% extends "monitor/base_monitor.html" %}

{% block monitor_breadcrumb %}
<li><span class="text-gray-400 mx-2">/</span></li>
<li class="text-gray-600">ç³»ç»Ÿæ—¥å¿—</li>
{% endblock %}

{% block monitor_title %}ç³»ç»Ÿæ—¥å¿—ç›‘æ§{% endblock %}
{% block monitor_subtitle %}æŸ¥çœ‹ç³»ç»Ÿè¿è¡Œæ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯{% endblock %}

{% block monitor_content %}
<div class="monitor-grid">
    <!-- æ—¥å¿—ç»Ÿè®¡å¡ç‰‡ -->
    <div class="monitor-card">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M14 17H4V19H14V17ZM20 9H4V11H20V9ZM4 15H16V13H4V15ZM4 5V7H20V5H4Z"/>
                </svg>
                æ—¥å¿—ç»Ÿè®¡
            </h3>
            <button class="refresh-btn" onclick="refreshLogs()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 4V2A10 10 0 0 0 2 12H4A8 8 0 0 1 12 4Z"/>
                </svg>
                åˆ·æ–°
            </button>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">æ€»æ—¥å¿—è¡Œæ•°</span>
            <span id="total-logs" class="monitor-metric-value">--</span>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">è¯·æ±‚è¡Œæ•°</span>
            <span id="requested-logs" class="monitor-metric-value">--</span>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">æœ€åæ›´æ–°</span>
            <span id="logs-timestamp" class="monitor-metric-value">--</span>
        </div>
    </div>

    <!-- æ—¥å¿—æ§åˆ¶é¢æ¿ -->
    <div class="monitor-card">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2Z"/>
                </svg>
                æ—¥å¿—æ§åˆ¶
            </h3>
        </div>
        <div style="display: flex; flex-direction: column; gap: 1rem; padding: 1rem 0;">
            <div>
                <label for="log-lines" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æ˜¾ç¤ºè¡Œæ•°:</label>
                <select id="log-lines" class="form-select" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                    <option value="20">20 è¡Œ</option>
                    <option value="50" selected>50 è¡Œ</option>
                    <option value="100">100 è¡Œ</option>
                    <option value="200">200 è¡Œ</option>
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                    <input type="checkbox" id="auto-scroll" checked style="margin-right: 0.5rem;">
                    è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                </label>
            </div>
            <button class="refresh-btn" onclick="loadLogs()">
                ğŸ”„ é‡æ–°åŠ è½½æ—¥å¿—
            </button>
        </div>
    </div>
</div>

<!-- æ—¥å¿—å†…å®¹æ˜¾ç¤º -->
<div class="monitor-card">
    <div class="monitor-card-header">
        <h3 class="monitor-card-title">
            <svg class="monitor-card-icon" viewBox="0 0 24 24">
                <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM19 19H5V5H19V19Z"/>
            </svg>
            ç³»ç»Ÿæ—¥å¿—å†…å®¹
        </h3>
        <div>
            <button class="refresh-btn" onclick="downloadLogs()" style="background: var(--success-color); margin-right: 0.5rem;">
                ğŸ“¥ ä¸‹è½½æ—¥å¿—
            </button>
            <button class="refresh-btn" onclick="clearLogDisplay()">
                ğŸ—‘ï¸ æ¸…ç©ºæ˜¾ç¤º
            </button>
        </div>
    </div>
    <div id="log-container" style="background: #1a1a1a; color: #e5e5e5; padding: 1rem; border-radius: var(--radius-md); height: 500px; overflow-y: auto; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.875rem; line-height: 1.4;">
        <div class="loading">åŠ è½½æ—¥å¿—ä¸­...</div>
    </div>
</div>
{% endblock %}

{% block monitor_js %}
<script>
let logsData = null;

async function loadLogs() {
    try {
        const lines = document.getElementById('log-lines').value;
        const response = await fetch(`/tools/monitor/logs/recent?lines=${lines}`);
        const data = await response.json();
        logsData = data;
        
        updateLogsStatistics(data);
        displayLogs(data.logs);
        
    } catch (error) {
        console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
        document.getElementById('log-container').innerHTML = 
            '<div style="color: #ef4444;">âŒ åŠ è½½æ—¥å¿—å¤±è´¥: ' + error.message + '</div>';
    }
}

function updateLogsStatistics(data) {
    document.getElementById('total-logs').textContent = data.total_lines;
    document.getElementById('requested-logs').textContent = data.requested_lines;
    document.getElementById('logs-timestamp').textContent = new Date().toLocaleString('zh-CN');
}

function displayLogs(logs) {
    const container = document.getElementById('log-container');
    
    if (!logs || logs.length === 0) {
        container.innerHTML = '<div style="color: #f59e0b;">âš ï¸ æš‚æ— æ—¥å¿—æ•°æ®</div>';
        return;
    }
    
    const logHtml = logs.map(log => {
        const lineClass = getLogLineClass(log.content);
        return `<div class="log-line ${lineClass}" data-line="${log.line_number}">
            <span class="log-line-number">${String(log.line_number).padStart(4, ' ')}:</span>
            <span class="log-content">${escapeHtml(log.content)}</span>
        </div>`;
    }).join('');
    
    container.innerHTML = `
        <style>
        .log-line {
            margin-bottom: 2px;
            padding: 2px 0;
            border-left: 3px solid transparent;
        }
        .log-line:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: #3b82f6;
        }
        .log-line-number {
            color: #6b7280;
            margin-right: 1rem;
            user-select: none;
        }
        .log-content {
            color: #e5e5e5;
        }
        .log-error {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        .log-error .log-content {
            color: #fca5a5;
        }
        .log-warning {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        .log-warning .log-content {
            color: #fbbf24;
        }
        .log-info {
            border-left-color: #3b82f6;
        }
        .log-info .log-content {
            color: #93c5fd;
        }
        .log-success {
            border-left-color: #10b981;
        }
        .log-success .log-content {
            color: #6ee7b7;
        }
        </style>
        ${logHtml}
    `;
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    if (document.getElementById('auto-scroll').checked) {
        container.scrollTop = container.scrollHeight;
    }
}

function getLogLineClass(content) {
    const lowerContent = content.toLowerCase();
    
    if (lowerContent.includes('error') || lowerContent.includes('exception') || 
        lowerContent.includes('failed') || lowerContent.includes('fatal')) {
        return 'log-error';
    }
    if (lowerContent.includes('warning') || lowerContent.includes('warn')) {
        return 'log-warning';
    }
    if (lowerContent.includes('info') || lowerContent.includes('information')) {
        return 'log-info';
    }
    if (lowerContent.includes('success') || lowerContent.includes('completed') || 
        lowerContent.includes('started')) {
        return 'log-success';
    }
    
    return '';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function refreshLogs() {
    loadLogs();
}

function downloadLogs() {
    if (!logsData || !logsData.logs) {
        alert('æš‚æ— æ—¥å¿—æ•°æ®å¯ä¸‹è½½');
        return;
    }
    
    const logContent = logsData.logs.map(log => 
        `${log.line_number}: ${log.content}`
    ).join('\n');
    
    const blob = new Blob([logContent], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `system_logs_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function clearLogDisplay() {
    document.getElementById('log-container').innerHTML = 
        '<div style="color: #6b7280;">ğŸ“ æ—¥å¿—æ˜¾ç¤ºå·²æ¸…ç©ºï¼Œç‚¹å‡»"é‡æ–°åŠ è½½æ—¥å¿—"æ¥è·å–æœ€æ–°æ—¥å¿—</div>';
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadLogs();
    
    // ç›‘å¬è¡Œæ•°é€‰æ‹©å˜åŒ–
    document.getElementById('log-lines').addEventListener('change', loadLogs);
    
    // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ï¼ˆå¦‚æœå¯ç”¨è‡ªåŠ¨åˆ·æ–°ï¼‰
    setInterval(() => {
        if (document.querySelector('.monitor-container')) { // ç¡®ä¿é¡µé¢è¿˜åœ¨æ˜¾ç¤º
            loadLogs();
        }
    }, 30000);
});
</script>
{% endblock %}