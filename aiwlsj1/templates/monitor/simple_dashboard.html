{% extends "base.html" %}

{% block title %}系统监控仪表盘 - 网络视界指标后台管理{% endblock %}

{% block page_title %}系统监控仪表盘{% endblock %}

{% block breadcrumb %}
    <li><span class="text-gray-300">/</span></li>
    <li><span class="text-gray-500">系统监控工具</span></li>
    <li><span class="text-gray-300">/</span></li>
    <li><span class="text-primary-600">监控仪表盘</span></li>
{% endblock %}

{% block page_actions %}
    <div class="flex items-center space-x-3">
        <button onclick="refreshMonitorData()" class="p-2 text-gray-400 hover:text-gray-500 rounded-md hover:bg-gray-100 transition-colors duration-200" data-tooltip="刷新监控数据">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
        </button>
    </div>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- 系统状态概览 -->
    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-sm">
        <div class="px-6 py-8 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold mb-2">系统监控仪表盘</h1>
                    <p class="text-blue-100">实时监控系统运行状态和性能指标</p>
                    <div class="mt-4 flex items-center space-x-4">
                        <div class="flex items-center">
                            <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                            <span class="text-sm" id="system-status">系统运行正常</span>
                        </div>
                        <div class="text-sm" id="last-check">最后检查: 加载中...</div>
                    </div>
                </div>
                <div class="hidden lg:block">
                    <div class="text-center">
                        <div class="text-3xl font-bold mb-1" id="uptime-display">--</div>
                        <div class="text-sm text-blue-200">系统运行时间</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 监控指标卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- 数据库状态 -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-medium text-gray-500">数据库状态</h3>
                    <div class="mt-2">
                        <div class="text-2xl font-bold text-gray-900" id="db-status">连接中...</div>
                        <div class="flex items-center mt-1">
                            <span class="text-sm text-gray-500">PUE记录</span>
                            <span class="ml-1 text-sm text-gray-500" id="pue-count">--</span>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="mt-4">
                <div class="text-xs text-gray-500" id="db-detail">数据库连接状态</div>
            </div>
        </div>

        <!-- 故障记录统计 -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-medium text-gray-500">系统故障记录</h3>
                    <div class="mt-2">
                        <div class="text-2xl font-bold text-gray-900" id="fault-count">--</div>
                        <div class="flex items-center mt-1">
                            <span class="text-sm text-gray-500">总记录数</span>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="mt-4">
                <div class="text-xs text-gray-500">系统故障监控</div>
            </div>
        </div>

        <!-- 系统信息 -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-medium text-gray-500">系统信息</h3>
                    <div class="mt-2">
                        <div class="text-lg font-bold text-gray-900">运行中</div>
                        <div class="flex items-center mt-1">
                            <span class="text-sm text-gray-500">状态正常</span>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="mt-4">
                <div class="text-xs text-gray-500">系统运行状态</div>
            </div>
        </div>
    </div>

    <!-- 快速操作 -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">监控操作</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <button onclick="checkDatabaseHealth()" class="flex flex-col items-center p-4 text-center rounded-lg hover:bg-gray-50 transition-colors duration-200 group">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center group-hover:bg-blue-200 mb-3">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                    </svg>
                </div>
                <span class="text-sm font-medium text-gray-900">数据库检查</span>
            </button>
            
            <button onclick="refreshMonitorData()" class="flex flex-col items-center p-4 text-center rounded-lg hover:bg-gray-50 transition-colors duration-200 group">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center group-hover:bg-green-200 mb-3">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </div>
                <span class="text-sm font-medium text-gray-900">刷新数据</span>
            </button>
            
            <a href="/" class="flex flex-col items-center p-4 text-center rounded-lg hover:bg-gray-50 transition-colors duration-200 group">
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center group-hover:bg-purple-200 mb-3">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                </div>
                <span class="text-sm font-medium text-gray-900">返回主页</span>
            </a>
            
            <button onclick="showSystemInfo()" class="flex flex-col items-center p-4 text-center rounded-lg hover:bg-gray-50 transition-colors duration-200 group">
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center group-hover:bg-yellow-200 mb-3">
                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <span class="text-sm font-medium text-gray-900">系统信息</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 全局变量
let monitorInterval = null;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadMonitorData();
    startAutoRefresh();
});

// 加载监控数据
async function loadMonitorData() {
    try {
        const response = await fetch('/api/monitor/system');
        const data = await response.json();
        
        if (data.status === 'healthy') {
            updateMonitorDisplay(data);
        } else {
            showError(data.message || '获取监控数据失败');
        }
    } catch (error) {
        console.error('加载监控数据失败:', error);
        showError('无法连接到监控API');
    }
}

// 更新监控显示
function updateMonitorDisplay(data) {
    // 更新数据库状态
    document.getElementById('db-status').textContent = data.database.status === 'connected' ? '连接正常' : '连接异常';
    document.getElementById('pue-count').textContent = data.database.pue_records || 0;
    // 加载系统故障统计
    loadSystemFaultStats();
    
    // 更新系统状态
    document.getElementById('system-status').textContent = '系统运行正常';
    document.getElementById('uptime-display').textContent = data.system.uptime || '运行中';
    
    // 更新检查时间
    const now = new Date().toLocaleString('zh-CN');
    document.getElementById('last-check').textContent = `最后检查: ${now}`;
    
    console.log('监控数据已更新');
}

// 手动刷新监控数据
async function refreshMonitorData() {
    const button = event.target.closest('button');
    const originalText = button.querySelector('span').textContent;
    button.querySelector('span').textContent = '刷新中...';
    button.disabled = true;
    
    try {
        await loadMonitorData();
        button.querySelector('span').textContent = '刷新完成';
        setTimeout(() => {
            button.querySelector('span').textContent = originalText;
            button.disabled = false;
        }, 1000);
    } catch (error) {
        button.querySelector('span').textContent = '刷新失败';
        setTimeout(() => {
            button.querySelector('span').textContent = originalText;
            button.disabled = false;
        }, 2000);
    }
}

// 检查数据库健康
async function checkDatabaseHealth() {
    try {
        await loadMonitorData();
        alert('数据库连接正常，监控数据已刷新');
    } catch (error) {
        alert('数据库连接检查失败: ' + error.message);
    }
}

// 显示系统信息
function showSystemInfo() {
    const info = `
系统监控仪表盘
- 数据库连接监控
- 系统状态检查
- 实时数据统计
- 自动刷新机制

当前时间: ${new Date().toLocaleString('zh-CN')}
    `;
    alert(info);
}

// 启动自动刷新
function startAutoRefresh() {
    // 每2分钟自动刷新一次
    monitorInterval = setInterval(async () => {
        try {
            await loadMonitorData();
            console.log('监控数据自动刷新完成');
        } catch (error) {
            console.error('自动刷新失败:', error);
        }
    }, 2 * 60 * 1000);
}

// 停止自动刷新
function stopAutoRefresh() {
    if (monitorInterval) {
        clearInterval(monitorInterval);
        monitorInterval = null;
    }
}

// 显示错误信息
function showError(message) {
    console.error(message);
    document.getElementById('db-status').textContent = '连接异常';
    document.getElementById('system-status').textContent = '状态异常';
    document.getElementById('last-check').textContent = `错误: ${message}`;
}

// 页面卸载时清理资源
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
// 加载系统故障统计数据
async function loadSystemFaultStats() {
    try {
        const response = await fetch('/tools/monitor/system-faults/stats');
        const faultStats = await response.json();
        
        // 更新故障计数显示
        document.getElementById('fault-count').textContent = faultStats.total_faults || 0;
        
        console.log('系统故障统计加载成功:', faultStats);
    } catch (error) {
        console.error('加载系统故障统计失败:', error);
        document.getElementById('fault-count').textContent = '--';
    }
}
</script>
{% endblock %}