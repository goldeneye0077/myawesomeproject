{% extends "monitor/base_monitor.html" %}

{% block monitor_title %}ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ{% endblock %}
{% block monitor_subtitle %}ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’Œå…³é”®æŒ‡æ ‡å¿«é€Ÿæ¦‚è§ˆ{% endblock %}

{% block monitor_content %}
<div class="monitor-grid">
    <!-- ç³»ç»Ÿè¿è¡Œæ—¶é—´ -->
    <div class="monitor-card" style="text-align: center;">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20Z"/>
                </svg>
                ç³»ç»Ÿè¿è¡Œæ—¶é—´
            </h3>
        </div>
        <div style="padding: 1.5rem 0;">
            <div id="uptime-display" style="font-size: 3rem; font-weight: 700; color: var(--primary-color); margin-bottom: 1rem;">--</div>
            <div id="uptime-text" style="color: var(--text-secondary);">ç³»ç»Ÿè¿è¡Œæ­£å¸¸</div>
        </div>
    </div>

    <!-- æ•°æ®åº“çŠ¶æ€ -->
    <div class="monitor-card" style="text-align: center;">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM19 19H5V5H19V19Z"/>
                </svg>
                æ•°æ®åº“çŠ¶æ€
            </h3>
        </div>
        <div style="padding: 1.5rem 0;">
            <div id="db-status-icon" style="font-size: 4rem; margin-bottom: 1rem;">ğŸ’¾</div>
            <div id="db-status-text" style="font-size: 1.3rem; font-weight: 600; margin-bottom: 0.5rem;">è¿æ¥æ­£å¸¸</div>
            <div id="db-health-text" style="color: var(--text-secondary);">æ•°æ®åº“è¿è¡Œæ­£å¸¸</div>
        </div>
    </div>

    <!-- æ€§èƒ½æ¦‚è§ˆ -->
    <div class="monitor-card" style="grid-column: span 2;">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M22 6.92L20.59 5.51L16.5 9.6L13 6.1L2.39 16.71L3.81 18.12L13 8.93L16.5 12.43L22 6.92Z"/>
                </svg>
                æ€§èƒ½æ¦‚è§ˆ
            </h3>
            <button class="refresh-btn" onclick="refreshStatus()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 4V2A10 10 0 0 0 2 12H4A8 8 0 0 1 12 4Z"/>
                </svg>
                åˆ·æ–°
            </button>
        </div>
        <div class="chart-container">
            <div id="performance-gauges" style="height: 300px;"></div>
        </div>
    </div>
</div>

<!-- ç³»ç»Ÿè¯¦ç»†ä¿¡æ¯ -->
<div class="monitor-card">
    <div class="monitor-card-header">
        <h3 class="monitor-card-title">
            <svg class="monitor-card-icon" viewBox="0 0 24 24">
                <path d="M4 6H20V18H4V6ZM6 8V16H18V8H6ZM8 10H16V12H8V10ZM8 14H13V15H8V14Z"/>
            </svg>
            è¯¦ç»†ä¿¡æ¯
        </h3>
        <div>
            <a href="/tools/monitor/dashboard" class="refresh-btn" style="text-decoration: none; margin-right: 0.5rem;">
                ğŸ“Š å®Œæ•´ä»ªè¡¨ç›˜
            </a>
            <button class="refresh-btn" onclick="exportStatus()">
                ğŸ“¤ å¯¼å‡ºçŠ¶æ€
            </button>
        </div>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; padding: 1rem;">
        <div>
            <h4 style="margin-bottom: 1rem; color: var(--text-primary);">ç³»ç»Ÿä¿¡æ¯</h4>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div class="monitor-metric">
                    <span class="monitor-metric-label">è¿è¡Œæ—¶é—´</span>
                    <span id="detail-uptime" class="monitor-metric-value">--</span>
                </div>
                <div class="monitor-metric">
                    <span class="monitor-metric-label">æ•°æ®åº“å¥åº·</span>
                    <span id="detail-db-health" class="monitor-metric-value">--</span>
                </div>
                <div class="monitor-metric">
                    <span class="monitor-metric-label">æœ€åæ£€æŸ¥</span>
                    <span id="detail-last-check" class="monitor-metric-value">--</span>
                </div>
            </div>
        </div>
        <div>
            <h4 style="margin-bottom: 1rem; color: var(--text-primary);">æ€§èƒ½æŒ‡æ ‡</h4>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div class="monitor-metric">
                    <span class="monitor-metric-label">CPUä½¿ç”¨ç‡</span>
                    <span id="detail-cpu" class="monitor-metric-value">--</span>
                </div>
                <div class="monitor-metric">
                    <span class="monitor-metric-label">å†…å­˜ä½¿ç”¨ç‡</span>
                    <span id="detail-memory" class="monitor-metric-value">--</span>
                </div>
                <div class="monitor-metric">
                    <span class="monitor-metric-label">ç£ç›˜ä½¿ç”¨ç‡</span>
                    <span id="detail-disk" class="monitor-metric-value">--</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block monitor_js %}
<script>
let statusData = null;
let gaugesChart = null;

async function loadSystemStatus() {
    try {
        const response = await fetch('/tools/monitor/status/overview');
        const data = await response.json();
        statusData = data;
        
        updateStatusDisplay(data);
        updatePerformanceGauges(data.performance);
        updateSystemDetails(data);
        
    } catch (error) {
        console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
        showErrorState();
    }
}

function updateStatusDisplay(data) {
    // æ›´æ–°è¿è¡Œæ—¶é—´æ˜¾ç¤º
    const uptimeDisplay = document.getElementById('uptime-display');
    const uptimeText = document.getElementById('uptime-text');
    
    const formattedUptime = formatUptime(data.uptime_seconds);
    uptimeDisplay.textContent = formattedUptime;
    
    if (data.uptime_seconds > 0) {
        uptimeText.textContent = 'ç³»ç»Ÿè¿è¡Œæ­£å¸¸';
        uptimeText.style.color = 'var(--success-color)';
    } else {
        uptimeText.textContent = 'ç³»ç»ŸçŠ¶æ€å¼‚å¸¸';
        uptimeText.style.color = 'var(--danger-color)';
    }
    
    // æ›´æ–°æ•°æ®åº“çŠ¶æ€
    const dbIcon = document.getElementById('db-status-icon');
    const dbStatusText = document.getElementById('db-status-text');
    const dbHealthText = document.getElementById('db-health-text');
    
    if (data.database_health === 'æ­£å¸¸') {
        dbIcon.textContent = 'âœ…';
        dbStatusText.textContent = 'è¿æ¥æ­£å¸¸';
        dbStatusText.style.color = 'var(--success-color)';
        dbHealthText.textContent = 'æ•°æ®åº“è¿è¡Œæ­£å¸¸';
    } else {
        dbIcon.textContent = 'âŒ';
        dbStatusText.textContent = 'è¿æ¥å¼‚å¸¸';
        dbStatusText.style.color = 'var(--danger-color)';
        dbHealthText.textContent = 'æ•°æ®åº“è¿æ¥å‡ºç°é—®é¢˜';
    }
}

function updatePerformanceGauges(performance) {
    if (gaugesChart) {
        gaugesChart.dispose();
    }
    
    gaugesChart = echarts.init(document.getElementById('performance-gauges'));
    
    const option = {
        series: [
            {
                name: 'CPU',
                type: 'gauge',
                center: ['20%', '50%'],
                radius: '60%',
                min: 0,
                max: 100,
                progress: {
                    show: true,
                    width: 8
                },
                axisLine: {
                    lineStyle: {
                        width: 8
                    }
                },
                axisTick: {
                    show: false
                },
                splitLine: {
                    length: 8,
                    lineStyle: {
                        width: 2,
                        color: '#999'
                    }
                },
                axisLabel: {
                    distance: 16,
                    color: '#999',
                    fontSize: 10
                },
                anchor: {
                    show: false
                },
                title: {
                    show: true,
                    offsetCenter: [0, '-10%'],
                    fontSize: 14,
                    color: '#333'
                },
                detail: {
                    valueAnimation: true,
                    formatter: '{value}%',
                    fontSize: 16,
                    fontWeight: 'bold',
                    offsetCenter: [0, '70%']
                },
                data: [
                    {
                        value: performance.cpu_percent,
                        name: 'CPUä½¿ç”¨ç‡',
                        title: {
                            color: performance.cpu_percent > 70 ? '#ef4444' : '#10b981'
                        },
                        detail: {
                            color: performance.cpu_percent > 70 ? '#ef4444' : '#10b981'
                        }
                    }
                ]
            },
            {
                name: 'å†…å­˜',
                type: 'gauge',
                center: ['50%', '50%'],
                radius: '60%',
                min: 0,
                max: 100,
                progress: {
                    show: true,
                    width: 8
                },
                axisLine: {
                    lineStyle: {
                        width: 8
                    }
                },
                axisTick: {
                    show: false
                },
                splitLine: {
                    length: 8,
                    lineStyle: {
                        width: 2,
                        color: '#999'
                    }
                },
                axisLabel: {
                    distance: 16,
                    color: '#999',
                    fontSize: 10
                },
                anchor: {
                    show: false
                },
                title: {
                    show: true,
                    offsetCenter: [0, '-10%'],
                    fontSize: 14,
                    color: '#333'
                },
                detail: {
                    valueAnimation: true,
                    formatter: '{value}%',
                    fontSize: 16,
                    fontWeight: 'bold',
                    offsetCenter: [0, '70%']
                },
                data: [
                    {
                        value: performance.memory_percent,
                        name: 'å†…å­˜ä½¿ç”¨ç‡',
                        title: {
                            color: performance.memory_percent > 75 ? '#ef4444' : '#10b981'
                        },
                        detail: {
                            color: performance.memory_percent > 75 ? '#ef4444' : '#10b981'
                        }
                    }
                ]
            },
            {
                name: 'ç£ç›˜',
                type: 'gauge',
                center: ['80%', '50%'],
                radius: '60%',
                min: 0,
                max: 100,
                progress: {
                    show: true,
                    width: 8
                },
                axisLine: {
                    lineStyle: {
                        width: 8
                    }
                },
                axisTick: {
                    show: false
                },
                splitLine: {
                    length: 8,
                    lineStyle: {
                        width: 2,
                        color: '#999'
                    }
                },
                axisLabel: {
                    distance: 16,
                    color: '#999',
                    fontSize: 10
                },
                anchor: {
                    show: false
                },
                title: {
                    show: true,
                    offsetCenter: [0, '-10%'],
                    fontSize: 14,
                    color: '#333'
                },
                detail: {
                    valueAnimation: true,
                    formatter: '{value}%',
                    fontSize: 16,
                    fontWeight: 'bold',
                    offsetCenter: [0, '70%']
                },
                data: [
                    {
                        value: performance.disk_usage_percent,
                        name: 'ç£ç›˜ä½¿ç”¨ç‡',
                        title: {
                            color: performance.disk_usage_percent > 80 ? '#ef4444' : '#10b981'
                        },
                        detail: {
                            color: performance.disk_usage_percent > 80 ? '#ef4444' : '#10b981'
                        }
                    }
                ]
            }
        ]
    };
    
    gaugesChart.setOption(option);
}

function updateSystemDetails(data) {
    document.getElementById('detail-uptime').textContent = formatUptime(data.uptime_seconds);
    document.getElementById('detail-db-health').textContent = data.database_health;
    document.getElementById('detail-last-check').textContent = 
        new Date(data.last_check).toLocaleString('zh-CN');
    
    document.getElementById('detail-cpu').textContent = data.performance.cpu_percent + '%';
    document.getElementById('detail-memory').textContent = data.performance.memory_percent + '%';
    document.getElementById('detail-disk').textContent = data.performance.disk_usage_percent + '%';
}

function showErrorState() {
    document.getElementById('uptime-display').textContent = 'é”™è¯¯';
    document.getElementById('uptime-text').textContent = 'æ— æ³•è·å–ç³»ç»ŸçŠ¶æ€';
    document.getElementById('uptime-text').style.color = 'var(--danger-color)';
    
    document.getElementById('db-status-icon').textContent = 'âŒ';
    document.getElementById('db-status-text').textContent = 'çŠ¶æ€æœªçŸ¥';
    document.getElementById('db-status-text').style.color = 'var(--danger-color)';
    document.getElementById('db-health-text').textContent = 'æ— æ³•è¿æ¥åˆ°ç›‘æ§æœåŠ¡';
}

function refreshStatus() {
    loadSystemStatus();
}

function exportStatus() {
    if (!statusData) {
        alert('æš‚æ— çŠ¶æ€æ•°æ®å¯å¯¼å‡º');
        return;
    }
    
    const statusReport = {
        timestamp: new Date().toISOString(),
        system_status: statusData,
        export_time: new Date().toLocaleString('zh-CN')
    };
    
    const blob = new Blob([JSON.stringify(statusReport, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `system_status_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadSystemStatus();
    
    // æ¯15ç§’è‡ªåŠ¨åˆ·æ–°
    setInterval(() => {
        if (document.querySelector('.monitor-container')) {
            loadSystemStatus();
        }
    }, 15000);
    
    // å“åº”å¼å›¾è¡¨
    window.addEventListener('resize', function() {
        if (gaugesChart) {
            gaugesChart.resize();
        }
    });
});

// é¡µé¢ç¦»å¼€æ—¶æ¸…ç†
window.addEventListener('beforeunload', function() {
    if (gaugesChart) {
        gaugesChart.dispose();
    }
});
</script>
{% endblock %}