{% extends "monitor/base_monitor.html" %}

{% block monitor_title %}系统性能监控{% endblock %}
{% block monitor_subtitle %}实时监控CPU、内存、磁盘使用情况和系统性能指标{% endblock %}

{% block monitor_content %}
<div class="monitor-grid">
    <!-- CPU使用率仪表盘 -->
    <div class="monitor-card">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M17 7H22V17H17V19A1 1 0 0 1 16 20H4A1 1 0 0 1 3 19V5A1 1 0 0 1 4 4H16A1 1 0 0 1 17 5V7ZM5 6V18H15V6H5ZM18 9V15H20V9H18ZM8 8H12V10H8V8ZM8 12H12V14H8V12Z"/>
                </svg>
                CPU使用率
            </h3>
            <span id="cpu-status" class="status-badge status-success">正常</span>
        </div>
        <div class="chart-container">
            <div id="cpu-gauge" style="height: 200px;"></div>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">当前使用率</span>
            <span id="cpu-value" class="monitor-metric-value">--</span>
        </div>
    </div>

    <!-- 内存使用率仪表盘 -->
    <div class="monitor-card">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M6 2V20H18V2H6ZM16 18H8V4H16V18ZM10 6H14V8H10V6ZM10 10H14V12H10V10ZM10 14H14V16H10V14Z"/>
                </svg>
                内存使用率
            </h3>
            <span id="memory-status" class="status-badge status-success">正常</span>
        </div>
        <div class="chart-container">
            <div id="memory-gauge" style="height: 200px;"></div>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">已用内存</span>
            <span id="memory-used" class="monitor-metric-value">--</span>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">可用内存</span>
            <span id="memory-available" class="monitor-metric-value">--</span>
        </div>
    </div>

    <!-- 磁盘使用率仪表盘 -->
    <div class="monitor-card">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M6 2C4.89 2 4 2.89 4 4V20A2 2 0 0 0 6 22H18A2 2 0 0 0 20 20V8L14 2H6ZM18 20H6V4H13V9H18V20Z"/>
                </svg>
                磁盘使用率
            </h3>
            <span id="disk-status" class="status-badge status-success">正常</span>
        </div>
        <div class="chart-container">
            <div id="disk-gauge" style="height: 200px;"></div>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">当前使用率</span>
            <span id="disk-value" class="monitor-metric-value">--</span>
        </div>
    </div>

    <!-- 系统信息卡片 -->
    <div class="monitor-card">
        <div class="monitor-card-header">
            <h3 class="monitor-card-title">
                <svg class="monitor-card-icon" viewBox="0 0 24 24">
                    <path d="M4 6H20V18H4V6ZM6 8V16H18V8H6ZM8 10H16V12H8V10ZM8 14H13V15H8V14Z"/>
                </svg>
                系统信息
            </h3>
            <button class="refresh-btn" onclick="refreshPerformance()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 4V2A10 10 0 0 0 2 12H4A8 8 0 0 1 12 4Z"/>
                </svg>
                刷新
            </button>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">psutil可用</span>
            <span id="psutil-available" class="monitor-metric-value">--</span>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">检查时间</span>
            <span id="check-time" class="monitor-metric-value">--</span>
        </div>
        <div class="monitor-metric">
            <span class="monitor-metric-label">数据来源</span>
            <span id="data-source" class="monitor-metric-value">--</span>
        </div>
    </div>
</div>

<!-- 性能趋势图表 -->
<div class="monitor-card">
    <div class="monitor-card-header">
        <h3 class="monitor-card-title">
            <svg class="monitor-card-icon" viewBox="0 0 24 24">
                <path d="M22 6.92L20.59 5.51L16.5 9.6L13 6.1L2.39 16.71L3.81 18.12L13 8.93L16.5 12.43L22 6.92Z"/>
            </svg>
            性能趋势图 (最近10次记录)
        </h3>
        <div>
            <button class="refresh-btn" onclick="toggleAutoRefresh()" id="auto-refresh-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 4V2A10 10 0 0 0 2 12H4A8 8 0 0 1 12 4Z"/>
                </svg>
                自动刷新
            </button>
        </div>
    </div>
    <div class="chart-container" style="height: 400px;">
        <div id="performance-trend"></div>
    </div>
</div>
{% endblock %}

{% block monitor_js %}
<script>
let performanceData = null;
let cpuChart = null;
let memoryChart = null;
let diskChart = null;
let trendChart = null;
let trendData = {
    timestamps: [],
    cpu: [],
    memory: [],
    disk: []
};
let autoRefreshEnabled = true;

async function loadPerformanceMetrics() {
    try {
        const response = await fetch('/tools/monitor/performance/metrics');
        const data = await response.json();
        performanceData = data;
        
        updateGauges(data);
        updateSystemInfo(data);
        updateTrendData(data);
        
    } catch (error) {
        console.error('加载性能指标失败:', error);
        updateStatus('异常');
    }
}

function updateGauges(data) {
    // 更新CPU仪表盘
    updateGauge('cpu-gauge', 'CPU使用率', data.cpu_percent, 100, '%');
    updateStatus('cpu-status', data.cpu_percent, [70, 90]);
    document.getElementById('cpu-value').textContent = data.cpu_percent + '%';
    
    // 更新内存仪表盘
    updateGauge('memory-gauge', '内存使用率', data.memory_percent, 100, '%');
    updateStatus('memory-status', data.memory_percent, [75, 85]);
    document.getElementById('memory-used').textContent = formatBytes(data.memory_used_mb * 1024 * 1024);
    document.getElementById('memory-available').textContent = formatBytes(data.memory_available_mb * 1024 * 1024);
    
    // 更新磁盘仪表盘
    updateGauge('disk-gauge', '磁盘使用率', data.disk_usage_percent, 100, '%');
    updateStatus('disk-status', data.disk_usage_percent, [80, 90]);
    document.getElementById('disk-value').textContent = data.disk_usage_percent + '%';
}

function updateGauge(containerId, title, value, max, unit) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // 清除之前的图表
    const existingChart = echarts.getInstanceByDom(container);
    if (existingChart) {
        existingChart.dispose();
    }
    
    const chart = echarts.init(container);
    
    // 根据值确定颜色
    let color = '#10b981'; // 绿色
    if (value > 80) color = '#ef4444'; // 红色
    else if (value > 60) color = '#f59e0b'; // 黄色
    
    const option = {
        series: [{
            type: 'gauge',
            progress: {
                show: true,
                width: 15,
                itemStyle: {
                    color: color
                }
            },
            axisLine: {
                lineStyle: {
                    width: 15,
                    color: [[1, '#e5e7eb']]
                }
            },
            axisTick: { show: false },
            splitLine: {
                length: 12,
                lineStyle: {
                    width: 2,
                    color: '#999'
                }
            },
            axisLabel: {
                distance: 20,
                color: '#666',
                fontSize: 12
            },
            anchor: { show: false },
            title: {
                show: false
            },
            detail: {
                valueAnimation: true,
                formatter: `{value}${unit}`,
                color: color,
                fontSize: 20,
                fontWeight: 'bold',
                offsetCenter: [0, '70%']
            },
            data: [{
                value: Math.round(value * 10) / 10,
                name: title
            }]
        }]
    };
    
    chart.setOption(option);
}

function updateStatus(elementId, value, thresholds) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    element.className = 'status-badge ';
    if (value < thresholds[0]) {
        element.className += 'status-success';
        element.textContent = '正常';
    } else if (value < thresholds[1]) {
        element.className += 'status-warning';
        element.textContent = '警告';
    } else {
        element.className += 'status-danger';
        element.textContent = '危险';
    }
}

function updateSystemInfo(data) {
    document.getElementById('check-time').textContent = 
        new Date(data.timestamp).toLocaleString('zh-CN');
    
    // 这里可以根据实际API响应调整
    const psutilAvailable = data.cpu_percent !== 25.0; // 25.0是模拟值
    document.getElementById('psutil-available').textContent = psutilAvailable ? '是' : '否';
    document.getElementById('data-source').textContent = psutilAvailable ? '实时数据' : '模拟数据';
}

function updateTrendData(data) {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('zh-CN');
    
    // 添加新数据点
    trendData.timestamps.push(timeStr);
    trendData.cpu.push(data.cpu_percent);
    trendData.memory.push(data.memory_percent);
    trendData.disk.push(data.disk_usage_percent);
    
    // 保持最近10个数据点
    if (trendData.timestamps.length > 10) {
        trendData.timestamps.shift();
        trendData.cpu.shift();
        trendData.memory.shift();
        trendData.disk.shift();
    }
    
    updateTrendChart();
}

function updateTrendChart() {
    if (!trendChart) {
        trendChart = echarts.init(document.getElementById('performance-trend'));
    }
    
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            }
        },
        legend: {
            data: ['CPU使用率', '内存使用率', '磁盘使用率'],
            bottom: 10
        },
        grid: {
            top: 30,
            left: 50,
            right: 30,
            bottom: 60
        },
        xAxis: {
            type: 'category',
            data: trendData.timestamps,
            boundaryGap: false
        },
        yAxis: {
            type: 'value',
            min: 0,
            max: 100,
            axisLabel: {
                formatter: '{value}%'
            }
        },
        series: [
            {
                name: 'CPU使用率',
                type: 'line',
                smooth: true,
                data: trendData.cpu,
                itemStyle: { color: '#3b82f6' },
                areaStyle: { opacity: 0.3 }
            },
            {
                name: '内存使用率',
                type: 'line',
                smooth: true,
                data: trendData.memory,
                itemStyle: { color: '#10b981' },
                areaStyle: { opacity: 0.3 }
            },
            {
                name: '磁盘使用率',
                type: 'line',
                smooth: true,
                data: trendData.disk,
                itemStyle: { color: '#f59e0b' },
                areaStyle: { opacity: 0.3 }
            }
        ]
    };
    
    trendChart.setOption(option);
}

function refreshPerformance() {
    loadPerformanceMetrics();
}

function toggleAutoRefresh() {
    const btn = document.getElementById('auto-refresh-btn');
    autoRefreshEnabled = !autoRefreshEnabled;
    
    if (autoRefreshEnabled) {
        btn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 4V2A10 10 0 0 0 2 12H4A8 8 0 0 1 12 4Z"/>
            </svg>
            自动刷新
        `;
        btn.className = 'refresh-btn';
        startPerformanceMonitoring();
    } else {
        btn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8 5V3A1 1 0 0 1 9 2H15A1 1 0 0 1 16 3V5H21V7H19V19A1 1 0 0 1 18 20H6A1 1 0 0 1 5 19V7H3V5H8ZM10 4V5H14V4H10Z"/>
            </svg>
            已暂停
        `;
        btn.style.background = '#6b7280';
        stopPerformanceMonitoring();
    }
}

let performanceInterval = null;

function startPerformanceMonitoring() {
    if (performanceInterval) clearInterval(performanceInterval);
    performanceInterval = setInterval(loadPerformanceMetrics, 5000); // 每5秒刷新
}

function stopPerformanceMonitoring() {
    if (performanceInterval) {
        clearInterval(performanceInterval);
        performanceInterval = null;
    }
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadPerformanceMetrics();
    
    if (autoRefreshEnabled) {
        startPerformanceMonitoring();
    }
    
    // 响应式图表
    window.addEventListener('resize', function() {
        if (trendChart) trendChart.resize();
        
        // 重绘仪表盘
        setTimeout(() => {
            if (performanceData) {
                updateGauges(performanceData);
            }
        }, 100);
    });
});

// 页面离开时清理定时器
window.addEventListener('beforeunload', function() {
    stopPerformanceMonitoring();
});
</script>
{% endblock %}