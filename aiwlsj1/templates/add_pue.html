{% extends "base.html" %}

{% block title %}æ·»åŠ PUEæ•°æ® - ç½‘ç»œè§†ç•ŒæŒ‡æ ‡åå°ç®¡ç†{% endblock %}

{% block content %}
<div class="card">
    <h2 class="card-title">æ·»åŠ PUEæ•°æ®</h2>

    <!-- æ·»åŠ é€‰é¡¹å¡ -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('manual')">æ‰‹åŠ¨æ·»åŠ </div>
        <div class="tab" onclick="switchTab('upload')">æ‰¹é‡å¯¼å…¥</div>
    </div>

    <!-- æ‰‹åŠ¨æ·»åŠ è¡¨å• -->
    <div id="manual-tab" class="tab-content active">
        <form action="/add_pue" method="post" style="display:flex;flex-direction:row;gap:32px;align-items:center;flex-wrap:wrap;background:#fff;padding:32px 28px 24px 28px;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.07);margin-bottom:24px;max-width:100%;width:auto;">
            <div style="display:flex;align-items:center;gap:8px;flex:1 1 220px;min-width:220px;max-width:320px;margin-bottom:12px;">
                <label for="location" style="font-weight:500;color:#333;white-space:nowrap;min-width:56px;">åœ°ç‚¹</label>
                <input type="text" id="location" name="location" class="form-control" required style="flex:1 1 120px;padding:10px 14px;border:1px solid #e0e0e0;border-radius:6px;font-size:15px;min-width:0;">
            </div>
            <div style="display:flex;align-items:center;gap:8px;flex:1 1 220px;min-width:220px;max-width:320px;margin-bottom:12px;">
                <label for="month" style="font-weight:500;color:#333;white-space:nowrap;min-width:56px;">æœˆä»½</label>
                <select id="month" name="month" class="form-control" required style="flex:1 1 120px;padding:10px 14px;border:1px solid #e0e0e0;border-radius:6px;font-size:15px;min-width:0;">
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="1">1æœˆ</option>
                    <option value="2">2æœˆ</option>
                    <option value="3">3æœˆ</option>
                    <option value="4">4æœˆ</option>
                    <option value="5">5æœˆ</option>
                    <option value="6">6æœˆ</option>
                    <option value="7">7æœˆ</option>
                    <option value="8">8æœˆ</option>
                    <option value="9">9æœˆ</option>
                    <option value="10">10æœˆ</option>
                    <option value="11">11æœˆ</option>
                    <option value="12">12æœˆ</option>
                </select>
            </div>
            <div style="display:flex;align-items:center;gap:8px;flex:1 1 220px;min-width:220px;max-width:320px;margin-bottom:12px;">
                <label for="pue_value" style="font-weight:500;color:#333;white-space:nowrap;min-width:56px;">PUEå€¼</label>
                <input type="number" id="pue_value" name="pue_value" step="0.01" min="1" max="3" required style="flex:1 1 120px;padding:10px 14px;border:1px solid #e0e0e0;border-radius:6px;font-size:15px;min-width:0;">
            </div>
            <div style="display:flex;align-items:center;gap:8px;flex:1 1 220px;min-width:220px;max-width:320px;margin-bottom:12px;">
                <label for="year" style="font-weight:500;color:#333;white-space:nowrap;min-width:56px;">å¹´ä»½</label>
                <input type="text" id="year" name="year" pattern="\d{4}" title="è¯·è¾“å…¥4ä½æ•°å­—å¹´ä»½" required style="flex:1 1 120px;padding:10px 14px;border:1px solid #e0e0e0;border-radius:6px;font-size:15px;min-width:0;">
            </div>
            <button type="submit" class="btn btn-primary" style="height:40px;min-width:80px;font-size:16px;margin-bottom:12px;">ä¿å­˜</button>
        </form>
    </div>

    <!-- Excelä¸Šä¼ è¡¨å• -->
    <div id="upload-tab" class="tab-content">
        <!-- ä¸Šä¼ åŒºåŸŸå†…å®¹ -->
        <div class="upload-header">
            <h3>Excelæ‰¹é‡å¯¼å…¥</h3>
            <a href="/download_pue_template" class="btn btn-info download-btn">
                <span class="download-icon">ğŸ“¥</span>ä¸‹è½½Excelæ¨¡æ¿
            </a>
        </div>

        <form action="/upload-pue-excel" method="post" enctype="multipart/form-data">
            <div class="upload-area" id="drop-area">
                <div class="upload-icon">ğŸ“Š</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©Excelæ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸ</div>
                <input type="file" id="file-input" name="file" class="file-input" accept=".xls,.xlsx" onchange="updateFileName(this)">
                <label for="file-input" class="btn btn-primary">é€‰æ‹©æ–‡ä»¶</label>
                <div id="file-name" class="file-name"></div>
            </div>
            <button type="submit" class="btn btn-success">ä¸Šä¼ å¹¶å¯¼å…¥</button>
        </form>

        <div class="card info-card">
            <h3 class="card-title">Excelå¯¼å…¥è¯´æ˜</h3>
            <p>è¯·ç¡®ä¿æ‚¨çš„Excelæ–‡ä»¶åŒ…å«ä»¥ä¸‹åˆ—ï¼š</p>
            <ul class="info-list">
                <li>åœ°ç‚¹</li>
                <li>æœˆä»½</li>
                <li>PUEå€¼</li>
                <li>å¹´ä»½</li>
            </ul>
            <p>ç³»ç»Ÿå°†æŒ‰ç…§åˆ—åè‡ªåŠ¨åŒ¹é…ç›¸åº”çš„å­—æ®µã€‚å¦‚æœåˆ—åä¸å®Œå…¨åŒ¹é…ï¼Œç³»ç»Ÿä¼šå°è¯•è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ã€‚</p>
            <p>æ‚¨å¯ä»¥ç‚¹å‡»ä¸Šæ–¹çš„"<strong>ä¸‹è½½Excelæ¨¡æ¿</strong>"æŒ‰é’®è·å–æ ‡å‡†æ ¼å¼çš„Excelæ¨¡æ¿æ–‡ä»¶ã€‚</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // è®¾ç½®é»˜è®¤å¹´ä»½ä¸ºå½“å‰å¹´
    document.addEventListener('DOMContentLoaded', function() {
        var currentYear = new Date().getFullYear();
        document.getElementById('year').value = currentYear;

        // åˆå§‹åŒ–æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ
        initDropArea();
    });

    // é€‰é¡¹å¡åˆ‡æ¢åŠŸèƒ½
    function switchTab(tabName) {
        // éšè—æ‰€æœ‰tabå†…å®¹
        var tabContents = document.getElementsByClassName('tab-content');
        for (var i = 0; i < tabContents.length; i++) {
            tabContents[i].classList.remove('active');
        }

        // å–æ¶ˆæ‰€æœ‰tabçš„activeçŠ¶æ€
        var tabs = document.getElementsByClassName('tab');
        for (var i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove('active');
        }

        // æ¿€æ´»é€‰ä¸­çš„tabå’Œå†…å®¹
        document.getElementById(tabName + '-tab').classList.add('active');
        var clickedTab = event.target;
        clickedTab.classList.add('active');
    }

    // æ›´æ–°é€‰æ‹©çš„æ–‡ä»¶åæ˜¾ç¤º
    function updateFileName(input) {
        var fileName = input.files[0] ? input.files[0].name : 'æœªé€‰æ‹©æ–‡ä»¶';
        document.getElementById('file-name').textContent = fileName;
    }

    // åˆå§‹åŒ–æ‹–æ‹½åŒºåŸŸ
    function initDropArea() {
        var dropArea = document.getElementById('drop-area');
        var fileInput = document.getElementById('file-input');

        if (!dropArea) return;

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('highlight');
        }

        function unhighlight() {
            dropArea.classList.remove('highlight');
        }

        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            var dt = e.dataTransfer;
            var files = dt.files;

            if (files.length > 0) {
                fileInput.files = files;
                updateFileName(fileInput);
            }
        }
    }
</script>
{% endblock %}