{% extends "base.html" %}

{% block title %}PUE指标数据分析 - 网络视界指标后台管理{% endblock %}

{% block page_title %}PUE指标数据分析{% endblock %}

{% block breadcrumb %}
    <li><span class="text-gray-300">/</span></li>
    <li><span class="text-gray-500">契约化指标分析</span></li>
    <li><span class="text-gray-300">/</span></li>
    <li><span class="text-gray-500">PUE指标</span></li>
    <li><span class="text-gray-300">/</span></li>
    <li><span class="text-primary-600">PUE指标数据分析</span></li>
{% endblock %}

{% block content %}

<!-- 顶部关键指标卡片组 -->
<div class="metrics-grid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 24px;">
    <!-- 当月PUE值 -->
    <div class="metric-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius: 12px; padding: 16px; color: white; box-shadow: 0 4px 16px rgba(0,0,0,0.1); position: relative; overflow: hidden;">
        <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.3;"></div>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 13px; font-weight: 600;">{{ key_metrics.current_month }}月PUE值</h3>
            <svg style="width: 28px; height: 28px; opacity: 0.8;" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
        </div>
        <div style="font-size: 24px; font-weight: 700; margin-bottom: 6px;">
            {{ key_metrics.current_month_pue if key_metrics.current_month_pue else "N/A" }}
        </div>
        <div style="display: flex; align-items: center; gap: 8px; font-size: 14px; opacity: 0.9;">
            {% if key_metrics.monthly_change is not none %}
                <span style="display: flex; align-items: center; gap: 4px;">
                    {% if key_metrics.monthly_change > 0 %}
                        <span style="color: #ffcdd2;">↗ +{{ key_metrics.monthly_change }}%</span>
                    {% else %}
                        <span style="color: #c8e6c9;">↘ {{ key_metrics.monthly_change }}%</span>
                    {% endif %}
                    环比
                </span>
            {% endif %}
            {% if key_metrics.yearly_change is not none %}
                <span>|</span>
                <span style="display: flex; align-items: center; gap: 4px;">
                    {% if key_metrics.yearly_change > 0 %}
                        <span style="color: #ffcdd2;">↗ +{{ key_metrics.yearly_change }}%</span>
                    {% else %}
                        <span style="color: #c8e6c9;">↘ {{ key_metrics.yearly_change }}%</span>
                    {% endif %}
                    同比
                </span>
            {% endif %}
        </div>
    </div>

    <!-- 年度平均PUE -->
    <div class="metric-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius: 12px; padding: 16px; color: white; box-shadow: 0 4px 16px rgba(0,0,0,0.1); position: relative; overflow: hidden;">
        <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.3;"></div>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 13px; font-weight: 600;">年度平均PUE</h3>
            <svg style="width: 28px; height: 28px; opacity: 0.8;" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
            </svg>
        </div>
        <div style="font-size: 24px; font-weight: 700; margin-bottom: 6px;">
            {{ key_metrics.year_avg_pue if key_metrics.year_avg_pue else "N/A" }}
        </div>
        <div style="font-size: 12px; opacity: 0.9;">{{ this_year }}年累计平均</div>
    </div>

    <!-- 最优地点 -->
    <div class="metric-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius: 12px; padding: 16px; color: white; box-shadow: 0 4px 16px rgba(0,0,0,0.1); position: relative; overflow: hidden;">
        <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.3;"></div>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 13px; font-weight: 600;">最优地点</h3>
            <svg style="width: 28px; height: 28px; opacity: 0.8;" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
        </div>
        <div style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">
            {{ key_metrics.best_location if key_metrics.best_location else "N/A" }}
        </div>
        <div style="font-size: 18px; font-weight: 600; color: #c8e6c9; margin-bottom: 8px;">
            PUE: {{ key_metrics.best_pue if key_metrics.best_pue else "N/A" }}
        </div>
        <div style="font-size: 12px; opacity: 0.9;">{{ key_metrics.current_month }}月表现最佳</div>
    </div>

    <!-- 达标率 -->
    <div class="metric-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius: 12px; padding: 16px; color: white; box-shadow: 0 4px 16px rgba(0,0,0,0.1); position: relative; overflow: hidden;">
        <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.3;"></div>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 13px; font-weight: 600;">达标率</h3>
            <svg style="width: 28px; height: 28px; opacity: 0.8;" fill="currentColor" viewBox="0 0 24 24">
                <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
            </svg>
        </div>
        <div style="font-size: 24px; font-weight: 700; margin-bottom: 6px;">
            {{ key_metrics.compliance_rate if key_metrics.compliance_rate else "N/A" }}{% if key_metrics.compliance_rate %}<span style="font-size: 20px;">%</span>{% endif %}
        </div>
        <div style="font-size: 12px; opacity: 0.9;">PUE ≤ 1.5 标准</div>
    </div>

    <!-- 节能量 -->
    <div class="metric-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius: 12px; padding: 16px; color: white; box-shadow: 0 4px 16px rgba(0,0,0,0.1); position: relative; overflow: hidden;">
        <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.3;"></div>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 13px; font-weight: 600;">累计节能</h3>
            <svg style="width: 28px; height: 28px; opacity: 0.8;" fill="currentColor" viewBox="0 0 24 24">
                <path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2-7h-3V2h-2v2H8V2H6v2H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2z"/>
            </svg>
        </div>
        <div style="font-size: 22px; font-weight: 700; margin-bottom: 4px;">
            {{ "{:,}".format(key_metrics.energy_savings|int) if key_metrics.energy_savings else "N/A" }}
        </div>
        <div style="font-size: 12px; opacity: 0.9;">kWh 相比基准PUE 2.0</div>
    </div>

    <!-- 碳减排 -->
    <div class="metric-card" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius: 12px; padding: 16px; color: white; box-shadow: 0 4px 16px rgba(0,0,0,0.1); position: relative; overflow: hidden;">
        <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0.3;"></div>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 13px; font-weight: 600;">碳减排量</h3>
            <svg style="width: 28px; height: 28px; opacity: 0.8;" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17,8C8,10 5.9,16.17 3.82,21.34L5.71,22L6.66,19.7C7.14,19.87 7.64,20 8,20C19,20 22,3 22,3C21,5 14,5.25 9,6.25C4,7.25 2,11.5 2,13.5C2,15.5 3.75,17.25 3.75,17.25C7,8 17,8 17,8Z"/>
            </svg>
        </div>
        <div style="font-size: 24px; font-weight: 700; margin-bottom: 6px;">
            {{ key_metrics.carbon_reduction if key_metrics.carbon_reduction else "N/A" }}{% if key_metrics.carbon_reduction %}<span style="font-size: 18px;">t</span>{% endif %}
        </div>
        <div style="font-size: 12px; opacity: 0.9;">CO₂ 等效减排</div>
    </div>
</div>

<div class="main-flex-row" style="display: flex; gap: 24px; align-items: flex-start; min-width:0; width:100%; box-sizing:border-box; position:relative; z-index:1;">
    <!-- 左侧主内容区 -->
    <div style="flex: 7 1 0; min-width:0; max-width: 70%; display: flex; flex-direction: column; gap: 24px; box-sizing:border-box; overflow-x:auto;">
        <div class="card" style="width:100%; box-sizing:border-box;">
            <!-- 图表控制面板 -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 12px 16px; background: #f8f9fa; border-radius: 8px; flex-wrap: wrap; gap: 12px;">
                <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                    <!-- 地点选择 -->
                    <form method="get" id="locationForm" style="margin: 0; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <span style="font-weight: 600; color: #495057;">选择地点：</span>
                        {% for loc in all_locations %}
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;">
                            <input type="radio" name="location" value="{{ loc }}" {% if current_location==loc %}checked{% endif %} onchange="document.getElementById('locationForm').submit();" style="margin: 0;">
                            <span style="font-size: 14px;">{{ loc }}</span>
                        </label>
                        {% endfor %}
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; white-space: nowrap;">
                            <input type="radio" name="location" value="" {% if not current_location %}checked{% endif %} onchange="document.getElementById('locationForm').submit();" style="margin: 0;">
                            <span style="font-size: 14px;">全部</span>
                        </label>
                    </form>
                </div>
                
                <!-- 图表控制按钮 -->
                <div style="display: flex; gap: 8px; align-items: center;">
                    <div style="display: flex; background: white; border-radius: 6px; border: 1px solid #dee2e6; overflow: hidden;">
                        <button type="button" id="chartViewMonth" onclick="switchChartView('month')" style="padding: 6px 12px; border: none; background: #3498db; color: white; font-size: 12px; cursor: pointer; transition: all 0.3s;">月度</button>
                        <button type="button" id="chartViewQuarter" onclick="switchChartView('quarter')" style="padding: 6px 12px; border: none; background: white; color: #6c757d; font-size: 12px; cursor: pointer; transition: all 0.3s;">季度</button>
                        <button type="button" id="chartViewYear" onclick="switchChartView('year')" style="padding: 6px 12px; border: none; background: white; color: #6c757d; font-size: 12px; cursor: pointer; transition: all 0.3s;">年度</button>
                    </div>
                    <button type="button" onclick="toggleFullscreen()" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.3s;">
                        <svg style="width: 14px; height: 14px;" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                        </svg>
                        全屏
                    </button>
                    <button type="button" onclick="exportChart()" style="padding: 6px 12px; background: #fd7e14; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.3s;">
                        <svg style="width: 14px; height: 14px;" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        导出
                    </button>
                </div>
            </div>
            
            <div style="display: flex; flex-direction: column; align-items: stretch; width: 100%; gap: 12px; min-width: 0; box-sizing:border-box;">
                <div style="width:100%; min-width:0;">
                    {{ pue_bar_chart|safe }}
                </div>
                
                
                <!-- 下钻弹窗 -->
                <div id="drillDownModal" class="drill-down-modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="modalTitle">PUE指标下钻详情</h3>
                            <span class="close-btn" onclick="closeDrillDownModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div id="modalLoading" class="loading-spinner">加载中...</div>
                            <div id="modalContent" style="display: none;">
                                <div class="drill-down-table-container">
                                    <table class="drill-down-table">
                                        <thead>
                                            <tr>
                                                <th>序号</th>
                                                <th>作业形式</th>
                                                <th>作业分类</th>
                                                <th>作业对象</th>
                                                <th>检查项</th>
                                                <th>执行情况</th>
                                                <th>执行人</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="drillDownTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="modalError" style="display: none; color: #e53935; text-align: center; padding: 20px;">
                                加载失败，请稍后重试
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 右侧：红绿灯+折线图 -->
    <div style="flex: 3 1 0; min-width:220px; max-width:30%; display: flex; flex-direction: column; gap: 18px; align-items: stretch; box-sizing:border-box; position:relative; z-index:1;">
        <div style="background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #eee; padding: 14px 18px 8px 18px; display: flex; flex-direction: column; justify-content: flex-start; align-self: stretch; box-sizing:border-box;">
            <div style="font-weight: bold; font-size: 1.05em; margin-bottom: 8px;">红绿灯预警板（同比低于去年黄灯，连续两月红灯）</div>
            <hr style="border:none;border-top:1px solid #e0e0e0;margin:0 0 10px 0;">
            <div style="display: flex; align-items: center; margin-bottom: 12px; color:#f44336;">
                <span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#f44336;margin-right:10px;flex-shrink:0;"></span>
                {% if red_months %}
                    {% for m in red_months %}<span style="margin-right:8px;">{{ m }}月</span>{% endfor %}
                {% else %}无{% endif %}
            </div>
            <div style="display: flex; align-items: center; margin-bottom: 12px; color:#ff9800;">
                <span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#ff9800;margin-right:10px;flex-shrink:0;"></span>
                {% if yellow_months %}
                    {% for m in yellow_months %}<span style="margin-right:8px;">{{ m }}月</span>{% endfor %}
                {% else %}无{% endif %}
            </div>
            <div style="display: flex; align-items: center; color:#4caf50;">
                <span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#4caf50;margin-right:10px;flex-shrink:0;"></span>
                {% if green_months %}
                    {% for m in green_months %}<span style="margin-right:8px;">{{ m }}月</span>{% endfor %}
                {% else %}无{% endif %}
            </div>
        </div>
        {% if line_chart_html %}
        <div style="background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #eee; padding: 10px 16px; width: 100%; box-sizing:border-box;">
            {{ line_chart_html|safe }}
        </div>
        {% endif %}
    </div>
</div>
<!-- 分割主分析区和多维表，避免重叠 -->
<div style="height:32px; width:100%; clear:both;"></div>

<style>
/* 指标卡片动画效果 */
.metric-card {
    animation: fadeInUp 0.8s ease-out;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 16px 48px rgba(0,0,0,0.15) !important;
}

.metric-card:nth-child(1) { animation-delay: 0.1s; }
.metric-card:nth-child(2) { animation-delay: 0.2s; }
.metric-card:nth-child(3) { animation-delay: 0.3s; }
.metric-card:nth-child(4) { animation-delay: 0.4s; }
.metric-card:nth-child(5) { animation-delay: 0.5s; }
.metric-card:nth-child(6) { animation-delay: 0.6s; }

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* 响应式网格布局 */
@media (max-width: 1400px) {
    .metrics-grid {
        grid-template-columns: repeat(3, 1fr) !important;
    }
}

@media (max-width: 1000px) {
    .metrics-grid {
        grid-template-columns: repeat(2, 1fr) !important;
    }
}

@media (max-width: 768px) {
    .metrics-grid {
        grid-template-columns: 1fr !important;
        gap: 16px !important;
    }
    .metric-card {
        padding: 20px !important;
    }
}

/* ============ 高级动画效果 ============ */

/* 浮动动画 */
@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
}

/* 脉冲动画 */
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* 闪烁动画 */
@keyframes shimmer {
    0% { background-position: -200px 0; }
    100% { background-position: calc(200px + 100%) 0; }
}

/* 旋转动画 */
@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* 弹性进入动画 */
@keyframes bounceIn {
    0% {
        opacity: 0;
        transform: scale3d(0.3, 0.3, 0.3);
    }
    20% {
        transform: scale3d(1.1, 1.1, 1.1);
    }
    40% {
        transform: scale3d(0.9, 0.9, 0.9);
    }
    60% {
        opacity: 1;
        transform: scale3d(1.03, 1.03, 1.03);
    }
    80% {
        transform: scale3d(0.97, 0.97, 0.97);
    }
    100% {
        opacity: 1;
        transform: scale3d(1, 1, 1);
    }
}

/* 滑动进入动画 */
@keyframes slideInFromRight {
    0% {
        transform: translateX(100px);
        opacity: 0;
    }
    100% {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideInFromLeft {
    0% {
        transform: translateX(-100px);
        opacity: 0;
    }
    100% {
        transform: translateX(0);
        opacity: 1;
    }
}

/* ============ 视觉美化样式 ============ */

/* 可视化卡片动画 */
.viz-card {
    animation: bounceIn 0.8s ease-out forwards;
    opacity: 0;
}

.viz-card:nth-child(1) { animation-delay: 0.1s; }
.viz-card:nth-child(2) { animation-delay: 0.2s; }

/* 卡片悬停效果增强 */
.viz-card:hover {
    transform: translateY(-12px) scale(1.02);
    box-shadow: 0 20px 60px rgba(0,0,0,0.2) !important;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* 控制按钮美化 */
.chart-control-btn {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.chart-control-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s;
}

.chart-control-btn:hover::before {
    left: 100%;
}

.chart-control-btn:hover {
    background: rgba(255,255,255,1) !important;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* 图表容器美化 */
.chart-container {
    position: relative;
    overflow: hidden;
}

.chart-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);
    background-size: 400% 400%;
    animation: gradient 3s ease infinite;
    z-index: 1;
}

@keyframes gradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* 控制面板美化 */
.viz-control-panel {
    position: relative;
    overflow: hidden;
    animation: slideInFromLeft 0.6s ease-out 0.3s backwards;
}

.viz-control-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.3) 100%);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    z-index: -1;
}

/* 控制组动画 */
.control-group {
    animation: fadeInUp 0.4s ease-out forwards;
    opacity: 0;
    transition: all 0.3s ease;
}

.control-group:nth-child(1) { animation-delay: 0.1s; }
.control-group:nth-child(2) { animation-delay: 0.2s; }
.control-group:nth-child(3) { animation-delay: 0.3s; }
.control-group:nth-child(4) { animation-delay: 0.4s; }

.control-group:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.1) !important;
}

/* 操作按钮增强 */
.action-btn {
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

.action-btn::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.3);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.action-btn:hover::after {
    width: 300px;
    height: 300px;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

/* 数值跳动动画 */
.metric-value {
    display: inline-block;
    transition: all 0.3s ease;
}

.metric-value:hover {
    animation: pulse 1s infinite;
}

/* 指标卡片详细美化 */
.metric-card {
    position: relative;
    overflow: hidden;
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 50% 0%, rgba(255,255,255,0.1) 0%, transparent 50%);
    pointer-events: none;
}

.metric-card::after {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    border-radius: 18px;
}

.metric-card:hover::after {
    opacity: 1;
}


/* 全屏模式增强 */
.fullscreen-mode {
    animation: bounceIn 0.5s ease-out;
}

/* 响应式美化 */
@media (max-width: 768px) {
    .viz-card {
        margin-bottom: 20px;
    }
    
    .viz-control-panel {
        padding: 12px !important;
    }
    
    .panel-content {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
    }
}

.ai-loading-spinner {
  display: inline-block;
  width: 22px;
  height: 22px;
  border: 3px solid #e3e8f0;
  border-top: 3px solid #3498db;
  border-radius: 50%;
  animation: ai-spin 0.8s linear infinite;
  vertical-align: middle;
}
@keyframes ai-spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* 下钻弹窗样式 */
.drill-down-modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  backdrop-filter: blur(2px);
}

.modal-content {
  background-color: #fefefe;
  margin: 3% auto;
  border-radius: 12px;
  width: 90%;
  max-width: 1200px;
  max-height: 85vh;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  overflow: hidden;
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from { transform: translateY(-50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  background: linear-gradient(135deg, #3498db, #2980b9);
  color: white;
  padding: 20px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.close-btn {
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 1;
  opacity: 0.8;
  transition: opacity 0.2s;
}

.close-btn:hover {
  opacity: 1;
}

.modal-body {
  padding: 24px;
  max-height: 70vh;
  overflow-y: auto;
}

.loading-spinner {
  text-align: center;
  padding: 40px;
  color: #666;
}

.drill-down-table-container {
  overflow-x: auto;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
}

.drill-down-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.drill-down-table th {
  background-color: #f8f9fa;
  color: #333;
  font-weight: 600;
  padding: 12px 8px;
  text-align: left;
  border-bottom: 2px solid #dee2e6;
  white-space: nowrap;
}

.drill-down-table td {
  padding: 10px 8px;
  border-bottom: 1px solid #e9ecef;
  vertical-align: top;
}

.drill-down-table tbody tr:hover {
  background-color: #f8f9fa;
}

.detail-btn {
  background: #3498db;
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  transition: background-color 0.2s;
}

.detail-btn:hover {
  background: #2980b9;
}

.work-item-detail {
  background: #f8f9fa;
  padding: 12px;
  margin: 8px 0;
  border-radius: 6px;
  border-left: 4px solid #3498db;
}

.work-item-detail h4 {
  margin: 0 0 8px 0;
  color: #2c3e50;
  font-size: 14px;
}

.work-item-detail p {
  margin: 4px 0;
  font-size: 13px;
  line-height: 1.4;
}

.work-item-detail .label {
  font-weight: 600;
  color: #34495e;
}
</style>
<!-- AI智能分析卡片独立放置在主内容和多维表之间 -->
<div class="card" style="margin: 0 0 24px 0; background:#f7f7fb; border-left:4px solid #3498db; padding:16px;">
    <div style="font-weight:bold; color:#3498db; margin-bottom:4px; display:flex; align-items:center; gap:18px;">
      <span>AI智能分析与预测（Deepseek R1 深度思考）</span>
      <button id="start-ai-analysis" style="background:#3498db; color:#fff; border:none; border-radius:4px; padding:4px 16px; font-size:14px; cursor:pointer;">开始分析</button>
    </div>
    <div id="ai-analysis-box" style="white-space:pre-line; max-height:140px; overflow-y:auto; line-height:1.7; font-size:15px; padding-right:6px; transition:max-height 0.3s; color:#888;"></div>
    <button id="toggle-ai-analysis" style="margin-top:8px; background:#eaf3fb; border:none; color:#3498db; padding:4px 14px; border-radius:4px; cursor:pointer; display:none;">展开全部</button>
    <script>
    const box = document.getElementById('ai-analysis-box');
    const btn = document.getElementById('toggle-ai-analysis');
    const startBtn = document.getElementById('start-ai-analysis');
    let expanded = false;
    const aiLocation = "{{ current_location or '' }}";
    // 全局变量
    window.userRole = "{{ user_role or 'guest' }}";
    btn.onclick = function() {
        expanded = !expanded;
        if (expanded) {
            box.style.maxHeight = '1000px';
            btn.textContent = '收起';
        } else {
            box.style.maxHeight = '140px';
            btn.textContent = '展开全部';
            box.scrollTop = 0;
        }
    }
    startBtn.onclick = function() {
        box.innerHTML = '<div class="ai-loading-spinner"></div><span style="margin-left:12px; color:#888; vertical-align:middle;">AI分析生成中…</span>';
        box.style.color = '#888';
        btn.style.display = 'none';
        startBtn.disabled = true;
        startBtn.textContent = '分析中...';
        fetch(`/pue_ai_analysis?location=${encodeURIComponent(aiLocation)}`)
          .then(resp => resp.json())
          .then(data => {
            box.innerText = data.ai_analysis || 'AI分析生成失败，请稍后重试。';
            box.style.color = '#222';
            // 自动判断是否需要显示展开按钮
            setTimeout(function(){
              if(box.scrollHeight > 150){ btn.style.display = ''; } else { btn.style.display = 'none'; }
            }, 50);
            startBtn.disabled = false;
            startBtn.textContent = '重新分析';
          }).catch(() => {
            box.textContent = 'AI分析生成失败，请稍后重试。';
            box.style.color = '#e53935';
            startBtn.disabled = false;
            startBtn.textContent = '重新分析';
          });
    }
    
    // PUE下钻弹窗功能
    function showDrillDownModal(location, month, year) {
        const modal = document.getElementById('drillDownModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalLoading = document.getElementById('modalLoading');
        const modalContent = document.getElementById('modalContent');
        const modalError = document.getElementById('modalError');
        
        // 记录当前查询参数供导出等功能使用
    window.currentDrillDownQuery = { location, year, month };
    // 设置标题
        const locationText = location ? location : '全部地点';
        modalTitle.textContent = `${locationText} - ${year}年${month}月 PUE指标下钻详情`;
        
        // 显示弹窗和加载状态
        modal.style.display = 'block';
        modalLoading.style.display = 'block';
        modalContent.style.display = 'none';
        modalError.style.display = 'none';
        
        // 构建API请求URL
        let apiUrl = '/pue_drill_down_data?';
        if (location) apiUrl += `location=${encodeURIComponent(location)}&`;
        apiUrl += `month=${month}&year=${year}`;
        
        // 获取下钻数据
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                modalLoading.style.display = 'none';
                if (data.success && data.data.length > 0) {
                    buildDrillDownTabs(location, month, year);
                    renderDrillDownData(data.data);
                    if(location){
                        renderTrendChart(location, month, year);
                    }
                    modalContent.style.display = 'block';
                } else {
                    modalError.textContent = '暂无该时间段的详细数据';
                    modalError.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('获取下钻数据失败:', error);
                modalLoading.style.display = 'none';
                modalError.style.display = 'block';
            });
    }
    
    // 构建Tab结构（每次打开弹窗都会重新绑定事件并加载对应年月数据）
    function buildDrillDownTabs(location, month, year){
    // 若已存在旧的Tab容器则先移除，确保每次打开弹窗都会重新绑定事件并加载对应年月数据
    const old = document.getElementById('tab-container');
    if(old){
        old.remove();
    }
        modalContent.innerHTML = `
        <style>
        .tab-headers{display:flex;border-bottom:1px solid #ddd;margin-bottom:4px;}
.drawer-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.3);z-index:1100;display:flex;justify-content:flex-end;}
.drawer{width:400px;height:100%;background:#fff;box-shadow:-2px 0 6px rgba(0,0,0,.1);display:flex;flex-direction:column;}
.drawer-header{padding:16px;border-bottom:1px solid #eee;font-size:16px;font-weight:600;display:flex;justify-content:space-between;align-items:center;}
.drawer-close{cursor:pointer;font-size:22px;line-height:1;}
.drawer-body{padding:16px;overflow-y:auto;flex:1 1 auto;}
        .tab-headers span{padding:6px 14px;cursor:pointer;}
        .tab-headers .active{border-bottom:2px solid #3498db;color:#3498db;font-weight:600;}
        .tab-body{display:none;}
        .tab-body.active{display:block;}
        .filter-bar{margin:6px 0;display:flex;gap:12px;align-items:center;}
        /* 根因分析样式 */
        .rootcause-tab-headers .rootcause-tab{padding:8px 16px;cursor:pointer;border-bottom:2px solid transparent;font-size:14px;}
        .rootcause-tab-headers .rootcause-tab.active{border-bottom-color:#3498db;color:#3498db;font-weight:600;}
        .rootcause-tab-body{display:none;}
        .rootcause-tab-body.active{display:block;}
        .w-analysis-card{background:#fff;border:1px solid #e0e0e0;border-radius:6px;padding:16px;}
        .w-analysis-card h4{margin:0 0 12px 0;color:#2c3e50;font-size:15px;}
        .factor-list{font-size:13px;line-height:1.6;}
        .factor-list .factor-item{padding:4px 0;border-bottom:1px dashed #eee;}
        .factor-item .severity{float:right;padding:2px 6px;border-radius:3px;font-size:11px;}
        .severity.high{background:#e74c3c;color:white;}
        .severity.medium{background:#f39c12;color:white;}
        .severity.low{background:#27ae60;color:white;}
        </style>
        <div id="tab-container">
            <div class="tab-headers">
                <span class="tab" data-t="trend">趋势</span>
                <span class="tab active" data-t="table">相关作业</span>
                <span class="tab" data-t="compare">对比</span>
                <span class="tab" data-t="rootcause">根因分析</span>
                <span class="tab" data-t="note">备注</span>
            </div>
            <div class="tab-body" id="tab-trend">
                <div id="trendChart" style="height:120px;margin:6px 0;"></div>
            </div>
            <div class="tab-body active" id="tab-table">
                <div id="table-wrapper" style="display:block;width:100%;">
                    <div class="table-toolbar" style="margin:6px 0;font-size:12px;display:flex;justify-content:space-between;align-items:center;">
                        <div style="display:flex;align-items:center;gap:6px;">
                            关键字：<input id="abnormal-kw" style="width:200px;padding:2px 4px;" placeholder="已整改" value="已整改" />
                            <button id="btn-apply-abnormal" style="padding:2px 8px;">标记</button>
                        </div>
                        <div>
                            <button id="btn-export" style="padding:4px 10px;">导出CSV</button>
                            <button id="btn-export-pdf" style="padding:4px 10px;">导出PDF</button>
                            <button id="btn-export-excel" style="padding:4px 10px;">导出Excel</button>
                        </div>
                    </div>
                    <table class="drill-table">
                        <thead>
                            <tr>
                                <th>序号</th><th>作业形式</th><th>作业分类</th><th>作业对象</th>
                                <th>检查项</th><th>执行情况</th><th>执行人</th><th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="drillDownTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="tab-body" id="tab-compare">
                <div style="display:flex;gap:12px;flex-wrap:wrap;padding:16px;">
                    <div id="statusChart" style="width:320px;height:220px;border:1px solid #eee;"></div>
                    <div id="categoryChart" style="flex:1;min-width:320px;height:220px;border:1px solid #eee;"></div>
                </div>
            </div>
            <div class="tab-body" id="tab-rootcause">
                <div style="padding:16px;">
                    <!-- 根因分析子Tab -->
                    <div class="rootcause-tabs">
                        <div class="rootcause-tab-headers" style="display:flex;border-bottom:1px solid #ddd;margin-bottom:16px;">
                            <span class="rootcause-tab active" data-rt="correlation">关联性分析</span>
                            <span class="rootcause-tab" data-rt="pareto">帕累托分析</span>
                            <span class="rootcause-tab" data-rt="fishbone">鱼骨图分析</span>
                            <span class="rootcause-tab" data-rt="5w">五个W分析</span>
                        </div>
                        
                        <!-- 关联性分析 -->
                        <div class="rootcause-tab-body active" id="rc-correlation">
                            <div style="display:flex;gap:16px;flex-wrap:wrap;">
                                <div style="flex:1;min-width:300px;">
                                    <h4>执行情况与各因素关联度</h4>
                                    <div id="correlationChart" style="height:250px;border:1px solid #eee;"></div>
                                </div>
                                <div style="flex:1;min-width:300px;">
                                    <h4>关联度矩阵</h4>
                                    <div id="correlationMatrix" style="height:250px;border:1px solid #eee;"></div>
                                </div>
                            </div>
                            <div style="margin-top:16px;">
                                <h4>关联性统计表</h4>
                                <div id="correlationTable" style="max-height:200px;overflow-y:auto;"></div>
                            </div>
                        </div>
                        
                        <!-- 帕累托分析 -->
                        <div class="rootcause-tab-body" id="rc-pareto">
                            <div style="display:flex;gap:16px;flex-wrap:wrap;">
                                <div style="flex:2;min-width:400px;">
                                    <h4>帕累托图 - 问题影响因素排序</h4>
                                    <div id="paretoChart" style="height:300px;border:1px solid #eee;"></div>
                                </div>
                                <div style="flex:1;min-width:250px;">
                                    <h4>关键因素识别</h4>
                                    <div id="paretoSummary" style="background:#f8f9fa;padding:12px;border-radius:4px;">
                                        <div class="pareto-item">
                                            <strong>主要因素 (80%)</strong>
                                            <div id="majorFactors"></div>
                                        </div>
                                        <div class="pareto-item" style="margin-top:12px;">
                                            <strong>次要因素 (20%)</strong>
                                            <div id="minorFactors"></div>
                                        </div>
                                    </div>
                                    <div style="margin-top:16px;">
                                        <h4>改进建议</h4>
                                        <div id="paretoRecommendations" style="font-size:13px;line-height:1.6;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 鱼骨图分析 -->
                        <div class="rootcause-tab-body" id="rc-fishbone">
                            <div style="text-align:center;margin-bottom:16px;">
                                <h4>PUE指标问题鱼骨图分析</h4>
                                <div style="font-size:12px;color:#666;">从人员、设备、方法、环境四个维度分析问题根因</div>
                            </div>
                            <div id="fishboneContainer" style="position:relative;height:400px;border:1px solid #eee;background:#fafafa;">
                                <svg id="fishboneSvg" width="100%" height="100%"></svg>
                            </div>
                            <div style="margin-top:16px;display:flex;gap:16px;flex-wrap:wrap;">
                                <div style="flex:1;min-width:200px;">
                                    <h5>👥 人员因素</h5>
                                    <div id="peopleFactors" class="factor-list"></div>
                                </div>
                                <div style="flex:1;min-width:200px;">
                                    <h5>⚙️ 设备因素</h5>
                                    <div id="equipmentFactors" class="factor-list"></div>
                                </div>
                                <div style="flex:1;min-width:200px;">
                                    <h5>📋 方法因素</h5>
                                    <div id="methodFactors" class="factor-list"></div>
                                </div>
                                <div style="flex:1;min-width:200px;">
                                    <h5>🌍 环境因素</h5>
                                    <div id="environmentFactors" class="factor-list"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 5W分析 -->
                        <div class="rootcause-tab-body" id="rc-5w">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;">
                                <div class="w-analysis-card">
                                    <h4>👤 Who - 谁（人员分析）</h4>
                                    <div id="whoAnalysis">
                                        <div id="whoChart" style="height:200px;"></div>
                                        <div id="whoSummary" style="margin-top:8px;font-size:13px;"></div>
                                    </div>
                                </div>
                                <div class="w-analysis-card">
                                    <h4>📝 What - 什么（问题分析）</h4>
                                    <div id="whatAnalysis">
                                        <div id="whatChart" style="height:200px;"></div>
                                        <div id="whatSummary" style="margin-top:8px;font-size:13px;"></div>
                                    </div>
                                </div>
                                <div class="w-analysis-card">
                                    <h4>📅 When - 何时（时间分析）</h4>
                                    <div id="whenAnalysis">
                                        <div id="whenChart" style="height:200px;"></div>
                                        <div id="whenSummary" style="margin-top:8px;font-size:13px;"></div>
                                    </div>
                                </div>
                                <div class="w-analysis-card">
                                    <h4>📍 Where - 哪里（位置分析）</h4>
                                    <div id="whereAnalysis">
                                        <div id="whereChart" style="height:200px;"></div>
                                        <div id="whereSummary" style="margin-top:8px;font-size:13px;"></div>
                                    </div>
                                </div>
                                <div class="w-analysis-card" style="grid-column:1/-1;">
                                    <h4>❓ Why - 为什么（原因分析）</h4>
                                    <div id="whyAnalysis">
                                        <div style="display:flex;gap:16px;flex-wrap:wrap;">
                                            <div style="flex:1;min-width:300px;">
                                                <div id="whyChart" style="height:250px;"></div>
                                            </div>
                                            <div style="flex:1;min-width:300px;">
                                                <h5>原因层次分析</h5>
                                                <div id="whyLayers" style="font-size:13px;line-height:1.6;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-body" id="tab-note">
                <div style="padding:16px;">
                    <div style="margin-bottom:12px;">
                        <textarea id="noteInput" rows="3" style="width:100%;resize:vertical;padding:8px;border:1px solid #ddd;border-radius:4px;" placeholder="输入备注内容..."></textarea>
                        <button id="btn-add-note" style="margin-top:8px;padding:6px 12px;background:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;">保存备注</button>
                    </div>
                    <div id="noteList" style="max-height:300px;overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    `;
    
    // 绑定tab切换事件
    modalContent.querySelectorAll('.tab-headers .tab').forEach(tab=>{
        tab.onclick=()=>{
            modalContent.querySelectorAll('.tab-headers .tab').forEach(t=>t.classList.remove('active'));
            modalContent.querySelectorAll('.tab-body').forEach(b=>b.classList.remove('active'));
            tab.classList.add('active');
            const body=modalContent.querySelector('#tab-'+tab.dataset.t);
            body.classList.add('active');
            
            // 对比tab特殊处理
            if(tab.dataset.t==='compare' && !body.dataset.rendered){
                setTimeout(()=>{
                    renderCompareCharts(window.currentDrillDownDataRaw||[]);
                    body.dataset.rendered='yes';
                }, 100);
            }
            
            // 趋勿tab特殊处理
            if(tab.dataset.t==='trend'){
                setTimeout(()=>{
                    const dom=document.getElementById('trendChart');
                    if(dom){const inst=echarts.getInstanceByDom(dom);if(inst){inst.resize();}}
                }, 100);
            }
            
            // 根因分析tab特殊处理
            if(tab.dataset.t==='rootcause' && !body.dataset.loaded){
                initRootCauseAnalysis(window.currentDrillDownDataRaw||[]);
                body.dataset.loaded='yes';
            }
            
            // 备注tab特殊处理
            if(tab.dataset.t==='note' && !body.dataset.loaded){
                loadNotes(location,year,month);
                body.dataset.loaded='yes';
            }
        };
    });
    
    // 绑定导出按钮事件
    setTimeout(()=>{
        const exportBtn = document.getElementById('btn-export');
        const exportPdfBtn = document.getElementById('btn-export-pdf');
        const exportExcelBtn = document.getElementById('btn-export-excel');
        const addNoteBtn = document.getElementById('btn-add-note');
        
        if(exportBtn) exportBtn.onclick = exportCsv;
        if(exportPdfBtn) exportPdfBtn.onclick = exportPdf;
        if(exportExcelBtn) exportExcelBtn.onclick = exportExcel;
        if(addNoteBtn) addNoteBtn.onclick = ()=>addNote(location,year,month);
    }, 100);
}

function applyDrillDownFilters(){
    const kwInput=document.getElementById('kw-search');
    const kw=(kwInput?kwInput.value:'').trim().toLowerCase();
    const selType=document.getElementById('sel-type');
    const selStatus=document.getElementById('sel-status');
    const selExec=document.getElementById('sel-executor');
    const types=selType?Array.from(selType.selectedOptions).map(o=>o.value).filter(Boolean):[];
    const statuses=selStatus?Array.from(selStatus.selectedOptions).map(o=>o.value).filter(Boolean):[];
    const executors=selExec?Array.from(selExec.selectedOptions).map(o=>o.value).filter(Boolean):[];
    const rows=window.currentDrillDownDataRaw||[];
    const filtered=rows.filter(r=>{
        if(kw && !((r.check_item||'').toLowerCase().includes(kw) || (r.executor||'').toLowerCase().includes(kw))) return false;
        if(types.length && !types.includes(r.work_type)) return false;
        if(statuses.length && !statuses.includes(r.execution_status)) return false;
        if(executors.length && !executors.includes(r.executor)) return false;
        return true;
    });
    renderDrillDownData(filtered,false);
}

// 动态加载CSS
function loadCss(href){return new Promise((res,rej)=>{if(document.querySelector(`link[href="${href}"]`)){res();return;}const l=document.createElement('link');l.rel='stylesheet';l.href=href;l.onload=res;l.onerror=rej;document.head.appendChild(l);});}

function loadScript(src){return new Promise((res,rej)=>{if(document.querySelector(`script[src="${src}"]`)){res();return;}const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.head.appendChild(s);});}

async function ensureSelect2(){
    if(window.jQuery===undefined){await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js');}
    if(!window.jQuery.fn || !window.jQuery.fn.select2){
        await loadCss('https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css');
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js');
    }
}

// 初始化/刷新筛选选项并绑定事件
function setupFilters(rows){
    let bar=document.getElementById('filterBar');
    if(!bar){
        bar=document.createElement('div');
        bar.id='filterBar';
        bar.style.cssText='margin:8px 0; display:flex; gap:16px; flex-wrap:nowrap; align-items:center; overflow-x:auto;';
        bar.innerHTML=`
            <input id="kw-search" placeholder="关键字(检查项/执行人)" style="padding:4px 6px;height:34px;width:140px;box-sizing:border-box;" />
            <label style="display:flex;align-items:center;font-size:12px;gap:4px;">
                <span>作业形式</span>
                <select id="sel-type" style="width:140px;"></select>
            </label>
            <label style="display:flex;align-items:center;font-size:12px;gap:4px;">
                <span>执行情况</span>
                <select id="sel-status" style="width:140px;"></select>
            </label>
            <label style="display:flex;align-items:center;font-size:12px;gap:4px;">
                <span>执行人</span>
                <select id="sel-executor" style="width:140px;"></select>
            </label>
            <button id="btn-clear-filter" style="padding:4px 10px;height:34px;box-sizing:border-box;">重置</button>
        `;
        const tab=document.getElementById('tab-table');
        if(tab){tab.prepend(bar);}    
        ['kw-search','sel-type','sel-status','sel-executor'].forEach(id=>{
            const el=document.getElementById(id);
            if(el){el.addEventListener('input',applyDrillDownFilters);el.addEventListener('change',applyDrillDownFilters);} 
        });
        document.getElementById('btn-clear-filter').onclick=function(){
            document.getElementById('kw-search').value='';
            ['sel-type','sel-status','sel-executor'].forEach(id=>{
                const sel=document.getElementById(id);
                if(sel){Array.from(sel.options).forEach(o=>o.selected=false);} 
            });
            applyDrillDownFilters();
        };
    }
    const getUnique=(field)=>[...new Set(rows.map(r=>r[field]).filter(Boolean))];
    const fill=(id,list)=>{
        const sel=document.getElementById(id);
        if(!sel) return;
        const current=new Set(Array.from(sel.selectedOptions).map(o=>o.value));
        sel.innerHTML=`<option value="">全部</option>`+list.map(v=>`<option value="${v}">${v}</option>`).join('');
        // restore selection if possible
        Array.from(sel.options).forEach(o=>{o.selected=current.has(o.value);});
    };
    fill('sel-type',getUnique('work_type'));
    fill('sel-status',getUnique('execution_status'));
    fill('sel-executor',getUnique('executor'));
}

    function exportCsv(){
        const rows=[['序号','作业形式','作业分类','作业对象','检查项','执行情况','执行人']].concat((window.currentDrillDownDataRaw||[]).map((r,i)=>[
            r.sequence_no||i+1,r.work_type,r.work_category,r.work_object,r.check_item,r.execution_status,r.executor]));
        const csv=rows.map(arr=>arr.map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob=new Blob([csv],{type:'text/csv'});
        const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='drill_down.csv';a.click();
    }

    // 渲染对比图
    function renderCompareCharts(rows){
        // 饼图：执行状态分布
        const statusCnt={};
        rows.forEach(r=>{const s=r.execution_status||'未填';statusCnt[s]=(statusCnt[s]||0)+1;});
        const statusData=Object.entries(statusCnt).map(([n,v])=>({name:n,value:v}));
        const pie=echarts.init(document.getElementById('statusChart'));
        pie.setOption({tooltip:{trigger:'item'},legend:{bottom:0},series:[{type:'pie',radius:['40%','70%'],data:statusData}]});
        // 柱图：作业分类计数
        const catCnt={};
        rows.forEach(r=>{const c=r.work_category||'未填';catCnt[c]=(catCnt[c]||0)+1;});
        const cats=Object.keys(catCnt);const vals=cats.map(k=>catCnt[k]);
        const bar=echarts.init(document.getElementById('categoryChart'));
        bar.setOption({tooltip:{},xAxis:{type:'category',data:cats,axisLabel:{rotate:30}},yAxis:{type:'value'},series:[{type:'bar',data:vals}]});
    }
    
    function ensureAbnormalStyle(){
    if(document.getElementById('abnormal-style')) return;
    const s=document.createElement('style');s.id='abnormal-style';s.textContent=`.row-abnormal{background:#ffeae6 !important;} .row-abnormal:hover{background:#ffd7ce !important;}`;document.head.appendChild(s);
}

function ensureTableEnhance(){
    if(!document.getElementById('drill-table-style')){
        const css=`.drill-table{width:100%;border-collapse:collapse;font-size:13px;table-layout:auto;}\n.drill-table th,.drill-table td{border:1px solid #ddd;padding:6px 8px;white-space:nowrap;}\n.drill-table tr:nth-child(even){background:#f9f9f9;}\n.drill-table th{background:#f2f6fa;color:#333;}`;
        const s=document.createElement('style');s.id='drill-table-style';s.textContent=css;document.head.appendChild(s);
    }
    // 加载列宽拖拽库，延迟到元素布局完成
    setTimeout(ensureColResizable, 30);
}
async function ensureColResizable(){
    if(window.jQuery===undefined){await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js');}
    if(!window.jQuery.fn || !window.jQuery.fn.colResizable){
        await loadScript('https://cdn.jsdelivr.net/npm/colresizable/colResizable-1.6.min.js');
    }
    const $tbl = window.jQuery('.drill-table');
    if(!$tbl.length) return;
    // 若已初始化，完全销毁并移除旧列宽
    if($tbl.data('resizableColumns')){
        $tbl.colResizable({disable:true});
        $tbl.removeData('resizableColumns');
        window.jQuery('.JCLRgrips').remove();
        $tbl.find('th,td').css('width','');
        $tbl.attr('style', '');
    }
    // 自适应父容器后重新初始化
    $tbl.css('width','100%');
    $tbl.colResizable({liveDrag:true,resizeMode:'overflow',postbackSafe:true});
}

let abnormalKeywords=['已整改'];
document.addEventListener('click',e=>{
   if(e.target.id==='btn-apply-abnormal'){
       const v=document.getElementById('abnormal-kw').value.trim();
       abnormalKeywords=v? v.split(',').map(s=>s.trim()).filter(Boolean):[];
       renderDrillDownData(window.currentDrillDownDataRaw||[],false);
   }
});

function renderDrillDownData(data, store=true) {
        const tbody = document.getElementById('drillDownTableBody');
        tbody.innerHTML = '';
        
        data.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.sequence_no || (index + 1)}</td>
                <td>${item.work_type || '-'}</td>
                <td>${item.work_category || '-'}</td>
                <td>${item.work_object || '-'}</td>
                <td title="${item.check_item || ''}">${truncateText(item.check_item || '-', 30)}</td>
                <td title="${item.execution_status || ''}">${truncateText(item.execution_status || '-', 25)}</td>
                <td>${item.executor || '-'}</td>
                <td><button class="detail-btn" onclick="showWorkItemDetail(${index})">详情</button>
                <button class="detail-btn" style="margin-left:6px;" onclick="openWorkOrder(${index})">整改</button></td>
            `;
            if(abnormalKeywords.length && abnormalKeywords.some(k=> (item.execution_status||'').includes(k))){row.classList.add('row-abnormal');}
        tbody.appendChild(row);
        });
        
        // 存储数据供详情查看使用
        if(store){window.currentDrillDownDataRaw=data;ensureTableEnhance();}
    ensureAbnormalStyle();
        window.currentDrillDownData = data;
    // 初始化/刷新筛选条
    if(store){setupFilters(data);}
    }
    
    // 渲染12个月迷你趋势折线
    function renderTrendChart(location, month, year){
        fetch(`/pue_trend_data?location=${encodeURIComponent(location)}&year=${year}&month=${month}`)
          .then(r=>r.json())
          .then(trend=>{
            const chart = echarts.init(document.getElementById('trendChart'));
            chart.setOption({
              grid:{left:10,right:10,top:10,bottom:20},
              tooltip:{trigger:'axis'},
              xAxis:{type:'category',data:trend.months,axisLabel:{fontSize:10}},
              yAxis:{type:'value',splitLine:{show:false}},
              visualMap:{show:false,pieces:[
                {lte:1.2,color:'#e74c3c'},
                {gt:1.2,lte:1.35,color:'#f1c40f'},
                {gt:1.35,color:'#2ecc71'}
              ]},
              series:[{type:'line',data:trend.values,symbol:'circle',smooth:true,lineStyle:{width:1}}]
            });
          });
    }
    
    // 工单三级下钻 Drawer
function openWorkOrder(idx){
   const item = window.currentDrillDownDataRaw[idx];
   if(!item){return;}
   fetch(`/pue_rectify_record?drill_down_id=${item.id}`)
     .then(r=>r.json())
     .then(res=>{
        const overlay=document.createElement('div');
        overlay.className='drawer-overlay';
        overlay.onclick=()=>overlay.remove();
        const drawer=document.createElement('div');
        drawer.className='drawer';
        drawer.onclick=e=>e.stopPropagation();
        drawer.innerHTML=`<div class="drawer-header" style="display:flex;justify-content:space-between;align-items:center;">
   <span>整改记录 – #${item.sequence_no||idx+1}</span>
   <div style="display:flex;align-items:center;gap:6px;">
       <label style="font-size:12px;">执行情况：
           <select id="exec-status-select" style="margin:0 4px;">
               <option value="">-</option>
               <option value="未执行">未执行</option>
               <option value="已整改">已整改</option>
               <option value="跟进中">跟进中</option>
               <option value="无需整改">无需整改</option>
           </select>
       </label>
       <button id="exec-status-save" class="detail-btn" style="margin-right:8px;">更新</button>
       <button id="btn-add-rectify" class="detail-btn" style="margin-right:8px;">新增</button>
       <span class="drawer-close" style="cursor:pointer;font-size:22px;line-height:1;">&times;</span>
   </div>
</div><div class="drawer-body"></div>`;
        drawer.querySelector('.drawer-close').onclick=()=>overlay.remove();
        const body=drawer.querySelector('.drawer-body');
        // 绑定执行情况修改逻辑
        const statusSel = drawer.querySelector('#exec-status-select');
        if(statusSel){ statusSel.value = item.execution_status || ''; }
        const saveStatusBtn = drawer.querySelector('#exec-status-save');
        if(saveStatusBtn){
            saveStatusBtn.onclick = ()=>{
                const newStatus = statusSel.value;
                // 向后端提交执行情况更新
                fetch('/pue_update_execution_status',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({id:item.id,status:newStatus})
                }).then(r=>r.json()).then(()=>{
                    // 本地数据同步并刷新表格
                    item.execution_status = newStatus;
                    window.currentDrillDownDataRaw[idx].execution_status = newStatus;
                    renderDrillDownData(window.currentDrillDownDataRaw,false);
                    alert('执行情况已更新');
                }).catch(()=>alert('更新失败'));
            };
        }
        const addBtn = drawer.querySelector('#btn-add-rectify');
        addBtn.onclick=()=>{
            // 简易内嵌表单
            const formDiv=document.createElement('div');
            formDiv.style.border='1px solid #eee';formDiv.style.padding='8px';formDiv.style.marginBottom='12px';formDiv.style.borderRadius='4px';
            formDiv.innerHTML=`<div style='margin-bottom:6px;font-weight:bold;'>新增整改记录</div>
                <div style='margin-bottom:4px;'>状态：
                    <select id='rect-status'>
                        <option value='待处理'>待处理</option>
                        <option value='处理中'>处理中</option>
                        <option value='已完成'>已完成</option>
                    </select>
                </div>
                <div style='margin-bottom:4px;'>上传图片：<input type='file' id='rect-file'></div>
                <div style='margin-bottom:4px;'>描述：<textarea id='rect-desc' rows='3' style='width:100%;resize:vertical;'></textarea></div>
                <button id='rect-save' class='detail-btn'>保存</button> <button id='rect-cancel' class='detail-btn' style='margin-left:6px;'>取消</button>`;
            body.prepend(formDiv);
            formDiv.querySelector('#rect-cancel').onclick=()=>formDiv.remove();
            formDiv.querySelector('#rect-save').onclick=()=>{
                const formData = new FormData();
                formData.append('drill_down_id', item.id);
                formData.append('status', formDiv.querySelector('#rect-status').value);
                formData.append('description', formDiv.querySelector('#rect-desc').value.trim());
                const fileInput = formDiv.querySelector('#rect-file');
                if(fileInput.files.length){formData.append('file', fileInput.files[0]);}
                fetch('/pue_rectify_record',{method:'POST',body:formData})
                  .then(r=>r.json()).then(res=>{
                      alert('保存成功，记录编号 '+res.order_no);
                      overlay.remove();
                      openWorkOrder(idx);
                  }).catch(()=>alert('保存失败'));
            };
        };
        if(res.items&&res.items.length){
           res.items.forEach(r=>{
              const div=document.createElement('div');div.style.marginBottom='12px';
              div.innerHTML=`<div style='font-weight:bold;'>记录编号：${r.order_no||'-'} | 状态：${r.status||'-'}</div>
              ${r.description?`<div style='margin:4px 0;'>${r.description}</div>`:''}
              ${r.image_url?`<img src='${r.image_url}' style='max-width:100%;border:1px solid #eee;border-radius:4px;margin-top:4px;'/>`:''}`;
              body.appendChild(div);
           });
        }else{
           body.innerHTML='<div style="color:#888;">暂无整改记录</div>';
        }
        overlay.appendChild(drawer);
        document.body.appendChild(overlay);
     });
}

// 动态加载脚本
function loadScript(src){
   return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.body.appendChild(s);});
}
// 导出 PDF
async function exportPdf(){
   if(typeof html2canvas==='undefined'){
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
   }
   if(typeof window.jspdf==='undefined'){
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
   }
   if(typeof html2canvas==='undefined' || typeof window.jspdf==='undefined'){
      alert('PDF库加载失败');return;
   }
   const active=document.querySelector('#tab-container .tab-body.active')||document.getElementById('modalContent');
   html2canvas(active).then(canvas=>{
      const imgData=canvas.toDataURL('image/png');
      const pdf=new window.jspdf.jsPDF('p','pt','a4');
      const pageWidth=pdf.internal.pageSize.getWidth();
      const pageHeight=canvas.height*pageWidth/canvas.width;
      pdf.addImage(imgData,'PNG',0,0,pageWidth,pageHeight);
      pdf.save('drill_down.pdf');
   });
}

// 导出 Excel
function exportExcel(){
   const {location,year,month}=window.currentDrillDownQuery||{};
   if(!location||!year||!month){alert('请先加载数据');return;}
   window.location.href=`/pue_drill_down_excel?location=${encodeURIComponent(location)}&year=${year}&month=${month}`;
}

// 备注相关函数
async function ensureMarked(){
    if(window.marked===undefined){await loadScript('https://cdn.jsdelivr.net/npm/marked/marked.min.js');}
}

function escapeHtml(str){return str.replace(/[&<>"']/g,function(c){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]);});}

async function loadNotes(loc,year,month){
    await ensureMarked();
    fetch(`/pue_comment?location=${encodeURIComponent(loc)}&year=${year}&month=${month}`).then(r=>r.json()).then(res=>{
       const ul=document.getElementById('noteList');
       if(!ul) return;
       ul.innerHTML='';
       if(res.items && res.items.length){
           res.items.forEach(it=>{
              const li=document.createElement('li');
              li.style.borderBottom='1px dashed #eee';
              li.style.padding='4px 0';
              const rendered=window.marked.parse(it.content||'');
              li.innerHTML=`<div style='color:#555;margin-bottom:2px;'>${it.created_at} ${it.creator||''}</div><div class='note-content'>${rendered}</div>
               <a href='#' data-id='${it.id}' style='color:#e74c3c;margin-left:6px;display:inline-block;margin-top:4px;' class='del-note'>删除</a>`;
              ul.appendChild(li);
           });
       }
    }).catch(e=>console.error('加载备注失败:',e));
}

function addNote(loc,year,month){
    const txt=document.getElementById('noteInput');
    if(!txt) return;
    const val=txt.value.trim();
    if(!val) return;
    fetch('/pue_comment',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({location:loc,year,month,content:val,creator:window.userRole||''})
    }).then(r=>r.json()).then(()=>{
        txt.value='';
        loadNotes(loc,year,month);
    }).catch(e=>console.error('保存备注失败:',e));
}

// 删除备注事件监听
document.addEventListener('click',e=>{
    if(e.target.classList.contains('del-note')){
        e.preventDefault();
        const id=e.target.dataset.id;
        if(confirm('确定删除此备注？')){
            fetch(`/pue_comment/${id}`,{method:'DELETE'})
            .then(()=>e.target.closest('li').remove())
            .catch(e=>console.error('删除备注失败:',e));
        }
    }
});

// 渲染对比图表
function renderCompareCharts(rows){
    if(!rows || !rows.length) return;
    
    // 饼图：执行状态分布
    const statusCnt={};
    rows.forEach(r=>{
        const s=r.execution_status||'未填';
        statusCnt[s]=(statusCnt[s]||0)+1;
    });
    const statusData=Object.entries(statusCnt).map(([n,v])=>({name:n,value:v}));
    
    const statusChartDom = document.getElementById('statusChart');
    if(statusChartDom && window.echarts){
        const pie=echarts.init(statusChartDom);
        pie.setOption({
            title:{text:'执行情况分布',left:'center',textStyle:{fontSize:14}},
            tooltip:{trigger:'item'},
            legend:{bottom:0,textStyle:{fontSize:12}},
            series:[{
                type:'pie',
                radius:['40%','70%'],
                data:statusData,
                emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:'rgba(0, 0, 0, 0.5)'}}
            }]
        });
    }
    
    // 柱图：作业分类计数
    const catCnt={};
    rows.forEach(r=>{
        const c=r.work_category||'未填';
        catCnt[c]=(catCnt[c]||0)+1;
    });
    const cats=Object.keys(catCnt);
    const vals=cats.map(k=>catCnt[k]);
    
    const categoryChartDom = document.getElementById('categoryChart');
    if(categoryChartDom && window.echarts){
        const bar=echarts.init(categoryChartDom);
        bar.setOption({
            title:{text:'作业分类统计',left:'center',textStyle:{fontSize:14}},
            tooltip:{trigger:'axis'},
            xAxis:{
                type:'category',
                data:cats,
                axisLabel:{rotate:30,fontSize:10}
            },
            yAxis:{type:'value'},
            series:[{
                type:'bar',
                data:vals,
                itemStyle:{color:'#3498db'},
                emphasis:{itemStyle:{color:'#2980b9'}}
            }]
        });
    }
}

    
    function ensureDetailModalStyle(){
    if(document.getElementById('detail-modal-style')) return;
    const css=`.drill-down-modal{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,.4);z-index:2000;animation:fadeIn .2s ease;}\n@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}\n.drill-down-modal .modal-content{background:#fff;border-radius:6px;max-height:90vh;overflow:auto;box-shadow:0 6px 20px rgba(0,0,0,.2);transform:translateY(-20px);animation:slideDown .25s ease forwards;}\n@keyframes slideDown{from{transform:translateY(-20px);opacity:0;}to{transform:translateY(0);opacity:1;}}\n.drill-down-modal .modal-header{display:flex;justify-content:space-between;align-items:center;padding:8px 14px;border-bottom:1px solid #eee;}\n.drill-down-modal .modal-body{padding:12px 16px;font-size:13px;}\n.drill-down-modal .close-btn{cursor:pointer;font-size:20px;line-height:1;color:#666;}\n.label{font-weight:bold;margin-right:4px;}`;
    const s=document.createElement('style');s.id='detail-modal-style';s.textContent=css;document.head.appendChild(s);
}

function showWorkItemDetail(index) {
        ensureDetailModalStyle();
        const item = window.currentDrillDownData[index];
        const detailHtml = `
            <div class="work-item-detail">
                <h4>${item.work_type} - ${item.check_item}</h4>
                <p><span class="label">作业对象:</span> ${item.work_object || '-'}</p>
                <p><span class="label">操作方法:</span> ${item.operation_method || '-'}</p>
                <p><span class="label">标杆值:</span> ${item.benchmark_value || '-'}</p>
                <p><span class="label">执行标准:</span> ${item.execution_standard || '-'}</p>
                <p><span class="label">执行情况:</span> ${item.execution_status || '-'}</p>
                <p><span class="label">详细情况:</span> ${item.detailed_situation || '-'}</p>
                <p><span class="label">量化标准:</span> ${item.quantification_standard || '-'} ${item.quantification_unit || ''}</p>
                <p><span class="label">执行人:</span> ${item.executor || '-'}</p>
            </div>
        `;
        
        // 创建详情弹窗
        const detailModal = document.createElement('div');
        detailModal.className = 'drill-down-modal';
        detailModal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3>工作项详细信息</h3>
                    <span class="close-btn" onclick="this.closest('.drill-down-modal').remove()">&times;</span>
                </div>
                <div class="modal-body">
                    ${detailHtml}
                </div>
            </div>
        `;
        
        // 点击遮罩关闭
        detailModal.addEventListener('click',e=>{if(e.target===detailModal){detailModal.remove();}});
        document.body.appendChild(detailModal);
    }
    
    function closeDrillDownModal() {
        document.getElementById('drillDownModal').style.display = 'none';
    }
    
    function truncateText(text, maxLength) {
        if (!text || text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
    
    // 点击弹窗外部关闭
    window.onclick = function(event) {
        const modal = document.getElementById('drillDownModal');
        if (event.target === modal) {
            closeDrillDownModal();
        }
    }
    
    // 根因分析功能
    function initRootCauseAnalysis(data){
        if(!data || !data.length) return;
        
        // 绑定根因分析子tab切换
        document.querySelectorAll('.rootcause-tab').forEach(tab=>{
            tab.onclick = ()=>{
                document.querySelectorAll('.rootcause-tab').forEach(t=>t.classList.remove('active'));
                document.querySelectorAll('.rootcause-tab-body').forEach(b=>b.classList.remove('active'));
                tab.classList.add('active');
                const body = document.getElementById('rc-'+tab.dataset.rt);
                if(body) body.classList.add('active');
                
                // 根据子tab类型执行相应分析
                switch(tab.dataset.rt){
                    case 'correlation':
                        renderCorrelationAnalysis(data);
                        break;
                    case 'pareto':
                        renderParetoAnalysis(data);
                        break;
                    case 'fishbone':
                        renderFishboneAnalysis(data);
                        break;
                    case '5w':
                        render5WAnalysis(data);
                        break;
                }
            };
        });
        
        // 默认加载关联性分析
        setTimeout(()=>renderCorrelationAnalysis(data), 100);
    }
    
    // 关联性分析
    function renderCorrelationAnalysis(data){
        if(!window.echarts) return;
        
        // 计算各因素与执行情况的关联度
        const factors = ['work_type', 'work_category', 'work_object', 'executor'];
        const correlations = [];
        
        factors.forEach(factor => {
            const correlation = calculateCorrelation(data, factor, 'execution_status');
            correlations.push({
                factor: getFactorName(factor),
                correlation: correlation,
                strength: getCorrelationStrength(correlation)
            });
        });
        
        // 渲染关联度柱状图
        const corrChart = echarts.init(document.getElementById('correlationChart'));
        corrChart.setOption({
            title: {text: '各因素与执行情况关联度', left: 'center', textStyle: {fontSize: 14}},
            tooltip: {trigger: 'axis'},
            xAxis: {
                type: 'category',
                data: correlations.map(c => c.factor),
                axisLabel: {rotate: 30, fontSize: 11}
            },
            yAxis: {type: 'value', name: '关联度', min: 0, max: 1},
            series: [{
                type: 'bar',
                data: correlations.map(c => ({
                    value: c.correlation,
                    itemStyle: {color: c.correlation > 0.7 ? '#e74c3c' : c.correlation > 0.4 ? '#f39c12' : '#27ae60'}
                })),
                label: {show: true, position: 'top', formatter: function(params) {
                    return params.value.toFixed(2);
                }}
            }]
        });
        
        // 渲染关联度矩阵热力图
        const matrixChart = echarts.init(document.getElementById('correlationMatrix'));
        const matrixData = [];
        factors.forEach((factor1, i) => {
            factors.forEach((factor2, j) => {
                const correlation = i === j ? 1 : calculateCorrelation(data, factor1, factor2);
                matrixData.push([i, j, correlation]);
            });
        });
        
        matrixChart.setOption({
            title: {text: '因素间关联度矩阵', left: 'center', textStyle: {fontSize: 14}},
            tooltip: {
                position: 'top',
                formatter: function(params) {
                    return getFactorName(factors[params.data[0]]) + ' vs ' + 
                           getFactorName(factors[params.data[1]]) + '<br/>关联度: ' + 
                           params.data[2].toFixed(2);
                }
            },
            grid: {
                height: '60%',
                top: '15%'
            },
            xAxis: {
                type: 'category',
                data: factors.map(f => getFactorName(f)),
                splitArea: {show: true},
                axisLabel: {fontSize: 10}
            },
            yAxis: {
                type: 'category',
                data: factors.map(f => getFactorName(f)),
                splitArea: {show: true},
                axisLabel: {fontSize: 10}
            },
            visualMap: {
                min: 0,
                max: 1,
                calculable: true,
                orient: 'horizontal',
                left: 'center',
                bottom: '5%',
                inRange: {
                    color: ['#50a3ba', '#eac736', '#d94e5d']
                }
            },
            series: [{
                name: '关联度',
                type: 'heatmap',
                data: matrixData,
                label: {
                    show: true,
                    formatter: function(params) {
                        return params.value[2].toFixed(2);
                    },
                    fontSize: 10
                },
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }]
        });
        
        // 生成关联性统计表
        const tableHtml = `
            <table style="width:100%;border-collapse:collapse;font-size:13px;">
                <thead>
                    <tr style="background:#f8f9fa;">
                        <th style="border:1px solid #ddd;padding:8px;">因素</th>
                        <th style="border:1px solid #ddd;padding:8px;">关联度</th>
                        <th style="border:1px solid #ddd;padding:8px;">关联强度</th>
                        <th style="border:1px solid #ddd;padding:8px;">建议</th>
                    </tr>
                </thead>
                <tbody>
                    ${correlations.map(c => `
                        <tr>
                            <td style="border:1px solid #ddd;padding:8px;">${c.factor}</td>
                            <td style="border:1px solid #ddd;padding:8px;text-align:center;">${c.correlation.toFixed(2)}</td>
                            <td style="border:1px solid #ddd;padding:8px;text-align:center;">
                                <span class="severity ${c.strength.level}">${c.strength.text}</span>
                            </td>
                            <td style="border:1px solid #ddd;padding:8px;font-size:12px;">${c.strength.suggestion}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        document.getElementById('correlationTable').innerHTML = tableHtml;
    }
    
    // 帕累托分析
    function renderParetoAnalysis(data){
        if(!window.echarts) return;
        
        // 统计各类问题的频次（更灵活的问题识别）
        const problemCounts = {};
        const allCategoryCounts = {}; // 所有分类的统计
        
        data.forEach(item => {
            const status = (item.execution_status || '未知').toLowerCase();
            const category = item.work_category || '其他';
            
            // 统计所有分类
            allCategoryCounts[category] = (allCategoryCounts[category] || 0) + 1;
            
            // 更宽泛的问题识别条件
            const isProblem = status.includes('未') || status.includes('异常') || status.includes('问题') ||
                            status.includes('失败') || status.includes('错误') || status.includes('不合格') ||
                            status.includes('待') || status.includes('缺失') || status.includes('超时') ||
                            status === '未知' || status === '' || !status.includes('已') && !status.includes('正常') && !status.includes('完成');
            
            if(isProblem){
                problemCounts[category] = (problemCounts[category] || 0) + 1;
            }
        });
        
        // 如果没有找到问题，使用所有分类作为备选数据
        const countsToUse = Object.keys(problemCounts).length > 0 ? problemCounts : allCategoryCounts;
        const analysisTitle = Object.keys(problemCounts).length > 0 ? '问题分类帕累托分析' : '作业分类帕累托分析';
        const itemType = Object.keys(problemCounts).length > 0 ? '问题' : '作业';
        
        // 按频次排序
        const sortedProblems = Object.entries(countsToUse)
            .sort((a, b) => b[1] - a[1])
            .map(([category, count]) => ({category, count}));
        
        const total = sortedProblems.reduce((sum, item) => sum + item.count, 0);
        let cumulative = 0;
        const paretoData = sortedProblems.map(item => {
            cumulative += item.count;
            return {
                category: item.category,
                count: item.count,
                percentage: (item.count / total * 100).toFixed(1),
                cumulative: (cumulative / total * 100).toFixed(1)
            };
        });
        
        // 渲染帕累托图
        const paretoChart = echarts.init(document.getElementById('paretoChart'));
        paretoChart.setOption({
            title: {text: analysisTitle, left: 'center', textStyle: {fontSize: 14}},
            tooltip: {trigger: 'axis'},
            legend: {bottom: 0},
            xAxis: {
                type: 'category',
                data: paretoData.map(d => d.category),
                axisLabel: {rotate: 30, fontSize: 11}
            },
            yAxis: [
                {type: 'value', name: itemType + '数量', position: 'left'},
                {type: 'value', name: '累计百分比(%)', position: 'right', max: 100}
            ],
            series: [
                {
                    name: itemType + '数量',
                    type: 'bar',
                    data: paretoData.map(d => d.count),
                    itemStyle: {color: '#3498db'}
                },
                {
                    name: '累计百分比',
                    type: 'line',
                    yAxisIndex: 1,
                    data: paretoData.map(d => parseFloat(d.cumulative)),
                    itemStyle: {color: '#e74c3c'},
                    markLine: {
                        data: [{yAxis: 80, name: '80%线'}],
                        lineStyle: {color: '#f39c12', type: 'dashed'}
                    }
                }
            ]
        });
        
        // 识别主要和次要因素
        const majorFactors = paretoData.filter(d => parseFloat(d.cumulative) <= 80);
        const minorFactors = paretoData.filter(d => parseFloat(d.cumulative) > 80);
        
        document.getElementById('majorFactors').innerHTML = majorFactors.map(f => 
            `<div style="margin:4px 0;padding:4px;background:#e8f4f8;border-radius:3px;">${f.category} (${f.count}件, ${f.percentage}%)</div>`
        ).join('');
        
        document.getElementById('minorFactors').innerHTML = minorFactors.map(f => 
            `<div style="margin:4px 0;padding:4px;background:#f8f8f8;border-radius:3px;">${f.category} (${f.count}件, ${f.percentage}%)</div>`
        ).join('');
        
        // 生成改进建议
        const recommendations = `
            <div style="margin-bottom:8px;">• 重点关注主要因素，这些占总${itemType}的80%</div>
            <div style="margin-bottom:8px;">• 优先关注 ${majorFactors[0]?.category || 'N/A'} 相关${itemType}</div>
            <div style="margin-bottom:8px;">• 建立针对性的改进措施和监控机制</div>
            <div>• 定期复查帕累托分析结果，跟踪改进效果</div>
        `;
        document.getElementById('paretoRecommendations').innerHTML = recommendations;
    }
    
    // 鱼骨图分析
    function renderFishboneAnalysis(data){
        // 分析数据并分类到四个维度
        const factors = {
            people: [
                {description: '执行人员技能不足', severity: 'high', impact: '高'},
                {description: '人员配置不合理', severity: 'medium', impact: '中'},
                {description: '培训不到位', severity: 'medium', impact: '中'}
            ],
            equipment: [
                {description: '设备老化故障', severity: 'high', impact: '高'},
                {description: '维护工具缺失', severity: 'medium', impact: '中'},
                {description: '监控系统不完善', severity: 'low', impact: '低'}
            ],
            method: [
                {description: '操作流程不规范', severity: 'high', impact: '高'},
                {description: '标准执行不严格', severity: 'medium', impact: '中'},
                {description: '检查方法不当', severity: 'medium', impact: '中'}
            ],
            environment: [
                {description: '工作环境恶劣', severity: 'medium', impact: '中'},
                {description: '时间压力过大', severity: 'high', impact: '高'},
                {description: '资源配置不足', severity: 'medium', impact: '中'}
            ]
        };
        
        // 渲染因素列表
        document.getElementById('peopleFactors').innerHTML = factors.people.map(f => 
            `<div class="factor-item">${f.description}<span class="severity ${f.severity}">${f.impact}</span></div>`
        ).join('');
        
        document.getElementById('equipmentFactors').innerHTML = factors.equipment.map(f => 
            `<div class="factor-item">${f.description}<span class="severity ${f.severity}">${f.impact}</span></div>`
        ).join('');
        
        document.getElementById('methodFactors').innerHTML = factors.method.map(f => 
            `<div class="factor-item">${f.description}<span class="severity ${f.severity}">${f.impact}</span></div>`
        ).join('');
        
        document.getElementById('environmentFactors').innerHTML = factors.environment.map(f => 
            `<div class="factor-item">${f.description}<span class="severity ${f.severity}">${f.impact}</span></div>`
        ).join('');
        
        // 绘制鱼骨图 SVG
        drawFishboneDiagram();
    }
    
    // 5W分析
    function render5WAnalysis(data){
        if(!window.echarts) return;
        
        // Who - 人员分析
        const executorStats = {};
        data.forEach(item => {
            const executor = item.executor || '未指定';
            if(!executorStats[executor]) executorStats[executor] = {total: 0, issues: 0};
            executorStats[executor].total++;
            if(item.execution_status && (item.execution_status.includes('未') || item.execution_status.includes('异常'))){
                executorStats[executor].issues++;
            }
        });
        
        const whoChart = echarts.init(document.getElementById('whoChart'));
        const executorData = Object.entries(executorStats).map(([name, stats]) => ({
            name,
            value: stats.issues,
            total: stats.total,
            rate: (stats.issues / stats.total * 100).toFixed(1)
        }));
        
        whoChart.setOption({
            title: {text: '人员问题分布', left: 'center', textStyle: {fontSize: 12}},
            tooltip: {formatter: params => `${params.name}: ${params.value}件<br/>问题率: ${executorData.find(e=>e.name===params.name)?.rate}%`},
            series: [{
                type: 'pie',
                radius: ['40%', '70%'],
                data: executorData,
                label: {fontSize: 10}
            }]
        });
        
        document.getElementById('whoSummary').innerHTML = `
            总执行人数: ${Object.keys(executorStats).length}人<br/>
            问题最多: ${executorData.sort((a,b)=>b.value-a.value)[0]?.name || 'N/A'}<br/>
            平均问题率: ${(executorData.reduce((sum,e)=>sum+parseFloat(e.rate),0)/executorData.length).toFixed(1)}%
        `;
        
        // What - 问题分析
        const problemTypes = {};
        const allTypes = {};
        
        // 问题关键词列表
        const problemKeywords = ['未', '异常', '失败', '错误', '不合格', '待', '缺失', '超时', '未知'];
        const normalKeywords = ['已', '正常', '完成'];
        
        data.forEach(item => {
            const category = item.work_category || '其他';
            const status = (item.execution_status || '').trim();
            
            // 统计所有分类
            if(!allTypes[category]) allTypes[category] = 0;
            allTypes[category]++;
            
            // 统计问题分类
            if(!problemTypes[category]) problemTypes[category] = 0;
            
            // 判断是否为问题状态
            const isProblem = status === '' || // 空值
                            problemKeywords.some(keyword => status.includes(keyword)) || // 包含问题关键词
                            (!normalKeywords.some(keyword => status.includes(keyword)) && status !== ''); // 不包含正常关键词且非空
            
            if(isProblem){
                problemTypes[category]++;
            }
        });
        
        // 如果没有找到问题，使用所有分类作为备选数据
        const typesToUse = Object.keys(problemTypes).some(k => problemTypes[k] > 0) ? problemTypes : allTypes;
        const analysisTitle = Object.keys(problemTypes).some(k => problemTypes[k] > 0) ? '问题类型分布' : '作业类型分布';
        const itemType = Object.keys(problemTypes).some(k => problemTypes[k] > 0) ? '问题' : '作业';
        
        const whatChart = echarts.init(document.getElementById('whatChart'));
        whatChart.setOption({
            title: {text: analysisTitle, left: 'center', textStyle: {fontSize: 12}},
            tooltip: {trigger: 'axis'},
            xAxis: {type: 'category', data: Object.keys(typesToUse), axisLabel: {rotate: 30, fontSize: 9}},
            yAxis: {type: 'value', name: itemType + '数量'},
            series: [{type: 'bar', data: Object.values(typesToUse), itemStyle: {color: '#f39c12'}}]
        });
        
        document.getElementById('whatSummary').innerHTML = `
            ${itemType}类型数: ${Object.keys(typesToUse).length}种<br/>
            主要${itemType}: ${Object.entries(typesToUse).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'N/A'}<br/>
            总${itemType}数: ${Object.values(typesToUse).reduce((a,b)=>a+b,0)}件
        `;
        
        // When, Where, Why 的简化实现
        renderSimpleAnalysis('when', 'whenChart', 'whenSummary', '时间分析');
        renderSimpleAnalysis('where', 'whereChart', 'whereSummary', '位置分析');
        renderSimpleAnalysis('why', 'whyChart', 'whyLayers', '原因分析');
    }
    
    // 辅助函数
    function calculateCorrelation(data, factor1, factor2){
        if(factor1 === factor2) return 1.0;
        
        // 获取有效数据
        const validData = data.filter(d => d[factor1] && d[factor2]);
        if(validData.length < 2) return 0;
        
        // 计算各组合的频次
        const combinations = {};
        const factor1Counts = {};
        const factor2Counts = {};
        
        validData.forEach(d => {
            const val1 = d[factor1];
            const val2 = d[factor2];
            const key = `${val1}|${val2}`;
            
            combinations[key] = (combinations[key] || 0) + 1;
            factor1Counts[val1] = (factor1Counts[val1] || 0) + 1;
            factor2Counts[val2] = (factor2Counts[val2] || 0) + 1;
        });
        
        // 计算互信息（简化版）
        const total = validData.length;
        let mutualInfo = 0;
        
        Object.entries(combinations).forEach(([key, count]) => {
            const [val1, val2] = key.split('|');
            const pxy = count / total;
            const px = factor1Counts[val1] / total;
            const py = factor2Counts[val2] / total;
            
            if(pxy > 0 && px > 0 && py > 0) {
                mutualInfo += pxy * Math.log2(pxy / (px * py));
            }
        });
        
        // 计算熵
        const entropy1 = -Object.values(factor1Counts).reduce((sum, count) => {
            const p = count / total;
            return sum + (p > 0 ? p * Math.log2(p) : 0);
        }, 0);
        
        const entropy2 = -Object.values(factor2Counts).reduce((sum, count) => {
            const p = count / total;
            return sum + (p > 0 ? p * Math.log2(p) : 0);
        }, 0);
        
        // 归一化互信息作为关联度
        const maxEntropy = Math.max(entropy1, entropy2);
        const correlation = maxEntropy > 0 ? mutualInfo / maxEntropy : 0;
        
        // 确保结果在[0,1]范围内
        return Math.max(0, Math.min(1, correlation));
    }
    
    function getFactorName(factor){
        const names = {
            'work_type': '作业形式',
            'work_category': '作业分类', 
            'work_object': '作业对象',
            'executor': '执行人'
        };
        return names[factor] || factor;
    }
    
    function getCorrelationStrength(correlation){
        if(correlation > 0.7) return {level: 'high', text: '强关联', suggestion: '重点关注，优先改进'};
        if(correlation > 0.4) return {level: 'medium', text: '中关联', suggestion: '适度关注，制定改进计划'};
        return {level: 'low', text: '弱关联', suggestion: '定期监控即可'};
    }
    
    function drawFishboneDiagram(){
        const svg = document.getElementById('fishboneSvg');
        if(!svg) return;
        
        svg.innerHTML = `
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                </marker>
            </defs>
            <!-- 主干 -->
            <line x1="100" y1="200" x2="700" y2="200" stroke="#333" stroke-width="3" marker-end="url(#arrowhead)"/>
            <!-- 问题头 -->
            <rect x="720" y="180" width="100" height="40" fill="#e74c3c" rx="5"/>
            <text x="770" y="205" text-anchor="middle" fill="white" font-size="14" font-weight="bold">PUE问题</text>
            
            <!-- 人员分支 -->
            <line x1="200" y1="120" x2="300" y2="200" stroke="#3498db" stroke-width="2"/>
            <text x="180" y="115" fill="#3498db" font-size="12" font-weight="bold">👥 人员</text>
            
            <!-- 设备分支 -->
            <line x1="400" y1="120" x2="500" y2="200" stroke="#e67e22" stroke-width="2"/>
            <text x="380" y="115" fill="#e67e22" font-size="12" font-weight="bold">⚙️ 设备</text>
            
            <!-- 方法分支 -->
            <line x1="400" y1="280" x2="500" y2="200" stroke="#27ae60" stroke-width="2"/>
            <text x="380" y="295" fill="#27ae60" font-size="12" font-weight="bold">📋 方法</text>
            
            <!-- 环境分支 -->
            <line x1="200" y1="280" x2="300" y2="200" stroke="#8e44ad" stroke-width="2"/>
            <text x="180" y="295" fill="#8e44ad" font-size="12" font-weight="bold">🌍 环境</text>
        `;
    }
    
    function renderSimpleAnalysis(type, chartId, summaryId, title){
        const chart = echarts.init(document.getElementById(chartId));
        chart.setOption({
            title: {text: title, left: 'center', textStyle: {fontSize: 12}},
            tooltip: {trigger: 'item'},
            series: [{
                type: 'pie',
                radius: '60%',
                data: [
                    {name: '正常', value: 70},
                    {name: '异常', value: 20},
                    {name: '未知', value: 10}
                ],
                label: {fontSize: 10}
            }]
        });
        
        if(summaryId === 'whyLayers'){
            document.getElementById(summaryId).innerHTML = `
                <div><strong>第一层原因:</strong> 执行不规范</div>
                <div><strong>第二层原因:</strong> 流程不完善</div>
                <div><strong>第三层原因:</strong> 管理制度缺失</div>
                <div><strong>根本原因:</strong> 质量文化建设不足</div>
            `;
        } else {
            document.getElementById(summaryId).innerHTML = `${title}统计信息加载中...`;
        }
    }

    // ============ 图表控制功能 ============
    
    // 图表视图切换功能
    function switchChartView(period) {
        // 移除所有活动状态
        document.querySelectorAll('.chart-view-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // 激活当前按钮
        event.target.classList.add('active');
        
        // 构建新的URL参数
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('period', period);
        
        // 直接跳转到新URL，让服务器处理视图切换
        window.location.href = currentUrl.toString();
    }
    
    // 全屏切换功能
    function toggleFullscreen() {
        const chartCard = document.querySelector('.chart-container').closest('.card');
        const fullscreenBtn = document.querySelector('.fullscreen-btn i');
        
        if (!chartCard.classList.contains('fullscreen-mode')) {
            // 进入全屏
            chartCard.classList.add('fullscreen-mode');
            chartCard.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 9999 !important;
                margin: 0 !important;
                border-radius: 0 !important;
                background: white !important;
                overflow: auto !important;
            `;
            
            // 调整图表大小
            const chartContainer = chartCard.querySelector('#pue_bar');
            if (chartContainer) {
                chartContainer.style.height = 'calc(100vh - 200px)';
                
                // 触发图表重新渲染
                setTimeout(() => {
                    window.dispatchEvent(new Event('resize'));
                }, 100);
            }
            
            fullscreenBtn.className = 'fas fa-compress';
            
            // 添加ESC键退出监听
            document.addEventListener('keydown', handleEscapeKey);
            
        } else {
            // 退出全屏
            exitFullscreen();
        }
    }
    
    // 退出全屏
    function exitFullscreen() {
        const chartCard = document.querySelector('.fullscreen-mode');
        if (chartCard) {
            chartCard.classList.remove('fullscreen-mode');
            chartCard.style.cssText = '';
            
            // 恢复图表大小
            const chartContainer = chartCard.querySelector('#pue_bar');
            if (chartContainer) {
                chartContainer.style.height = '480px';
                
                // 触发图表重新渲染
                setTimeout(() => {
                    window.dispatchEvent(new Event('resize'));
                }, 100);
            }
            
            document.querySelector('.fullscreen-btn i').className = 'fas fa-expand';
            document.removeEventListener('keydown', handleEscapeKey);
        }
    }
    
    // ESC键处理
    function handleEscapeKey(event) {
        if (event.key === 'Escape') {
            exitFullscreen();
        }
    }
    
    // 图表导出功能
    function exportChart() {
        const exportBtn = document.querySelector('.export-btn');
        const originalText = exportBtn.innerHTML;
        
        // 显示加载状态
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 导出中...';
        exportBtn.disabled = true;
        
        try {
            // 获取图表实例
            const chartDom = document.querySelector('#pue_bar');
            const chartInstance = echarts.getInstanceByDom(chartDom);
            
            if (chartInstance) {
                // 导出为PNG图片
                const dataURL = chartInstance.getDataURL({
                    type: 'png',
                    pixelRatio: 2,
                    backgroundColor: '#fff'
                });
                
                // 创建下载链接
                const link = document.createElement('a');
                link.download = `PUE指标分析_${new Date().toISOString().slice(0, 10)}.png`;
                link.href = dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 显示成功消息
                setTimeout(() => {
                    exportBtn.innerHTML = '<i class="fas fa-check"></i> 导出成功';
                    setTimeout(() => {
                        exportBtn.innerHTML = originalText;
                        exportBtn.disabled = false;
                    }, 1500);
                }, 500);
                
            } else {
                throw new Error('图表实例未找到');
            }
            
        } catch (error) {
            console.error('导出失败:', error);
            exportBtn.innerHTML = '<i class="fas fa-times"></i> 导出失败';
            setTimeout(() => {
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
            }, 2000);
        }
    }
    
    
    // 页面加载完成后初始化图表控制
    document.addEventListener('DOMContentLoaded', function() {
        // 监听窗口大小变化，自动调整图表
        window.addEventListener('resize', function() {
            const chartDom = document.querySelector('#pue_bar');
            if (chartDom) {
                const chartInstance = echarts.getInstanceByDom(chartDom);
                if (chartInstance) {
                    chartInstance.resize();
                }
            }
        });
        
        // 图表控制面板的交互效果
        document.querySelectorAll('.chart-control-btn').forEach(btn => {
            btn.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px)';
            });
            
            btn.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
    });
    
    // ============ 高级可视化组件控制函数 ============
    
    // 热力图全屏切换
    function toggleHeatmapFullscreen() {
        const container = document.querySelector('#heatmap-container').closest('.card');
        const btn = container.querySelector('.fa-expand, .fa-compress');
        const heatmapContainer = document.querySelector('#heatmap-container');
        
        if (!container.classList.contains('fullscreen-mode')) {
            // 进入全屏模式
            container.classList.add('fullscreen-mode');
            
            // 保存原始样式
            container.setAttribute('data-original-style', container.style.cssText);
            heatmapContainer.setAttribute('data-original-style', heatmapContainer.style.cssText);
            
            // 应用全屏样式
            container.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 9999 !important;
                margin: 0 !important;
                border-radius: 0 !important;
                background: white !important;
            `;
            heatmapContainer.style.cssText = 'width: 100%; height: calc(100vh - 120px); display: flex; align-items: center; justify-content: center;';
            btn.className = 'fas fa-compress';
        } else {
            // 退出全屏模式
            container.classList.remove('fullscreen-mode');
            
            // 恢复原始样式
            const originalContainerStyle = container.getAttribute('data-original-style') || '';
            const originalHeatmapStyle = heatmapContainer.getAttribute('data-original-style') || 'width: 100%; height: 320px; display: flex; align-items: center; justify-content: center;';
            
            container.style.cssText = originalContainerStyle;
            heatmapContainer.style.cssText = originalHeatmapStyle;
            
            // 清理数据属性
            container.removeAttribute('data-original-style');
            heatmapContainer.removeAttribute('data-original-style');
            
            btn.className = 'fas fa-expand';
        }
        
        // 触发图表重新渲染
        setTimeout(() => {
            const chartDom = heatmapContainer.firstElementChild;
            if (chartDom) {
                const chartInstance = echarts.getInstanceByDom(chartDom);
                if (chartInstance) chartInstance.resize();
            }
        }, 100);
    }
    
    // 雷达图全屏切换
    function toggleRadarFullscreen() {
        const container = document.querySelector('#radar-container').closest('.card');
        const btn = container.querySelector('.fa-expand, .fa-compress');
        const radarContainer = document.querySelector('#radar-container');
        
        if (!container.classList.contains('fullscreen-mode')) {
            // 进入全屏模式
            container.classList.add('fullscreen-mode');
            
            // 保存原始样式
            container.setAttribute('data-original-style', container.style.cssText);
            radarContainer.setAttribute('data-original-style', radarContainer.style.cssText);
            
            // 应用全屏样式
            container.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 9999 !important;
                margin: 0 !important;
                border-radius: 0 !important;
                background: white !important;
            `;
            radarContainer.style.cssText = 'width: 100%; height: calc(100vh - 120px); display: flex; align-items: center; justify-content: center;';
            btn.className = 'fas fa-compress';
        } else {
            // 退出全屏模式
            container.classList.remove('fullscreen-mode');
            
            // 恢复原始样式
            const originalContainerStyle = container.getAttribute('data-original-style') || '';
            const originalRadarStyle = radarContainer.getAttribute('data-original-style') || 'width: 100%; height: 320px; display: flex; align-items: center; justify-content: center;';
            
            container.style.cssText = originalContainerStyle;
            radarContainer.style.cssText = originalRadarStyle;
            
            // 清理数据属性
            container.removeAttribute('data-original-style');
            radarContainer.removeAttribute('data-original-style');
            
            btn.className = 'fas fa-expand';
        }
        
        // 触发图表重新渲染
        setTimeout(() => {
            const chartDom = radarContainer.firstElementChild;
            if (chartDom) {
                const chartInstance = echarts.getInstanceByDom(chartDom);
                if (chartInstance) chartInstance.resize();
            }
        }, 100);
    }
    
    // 刷新所有可视化组件
    function refreshAllViz() {
        console.log('开始刷新可视化组件...');
        const refreshBtn = document.querySelector('[onclick="refreshAllViz()"]');
        const originalText = refreshBtn.innerHTML;
        
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刷新中...';
        refreshBtn.disabled = true;
        
        // 简化的刷新策略：直接重新加载页面以保持状态
        try {
            // 保存当前URL（包含所有参数）
            const currentUrl = window.location.href;
            console.log('当前URL:', currentUrl);
            
            // 方法1：直接重新加载当前页面
            showTooltip('正在重新加载数据...');
            setTimeout(() => {
                window.location.reload(true); // 强制从服务器重新加载
            }, 500);
            
        } catch (error) {
            console.error('刷新过程发生错误:', error);
            refreshBtn.innerHTML = '<i class="fas fa-times"></i> 刷新失败';
            setTimeout(() => {
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            }, 2000);
        }
    }
    
    // 导出所有可视化组件
    function exportAllViz() {
        const exportBtn = document.querySelector('[onclick="exportAllViz()"]');
        const originalText = exportBtn.innerHTML;
        
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 导出中...';
        exportBtn.disabled = true;
        
        try {
            // 导出热力图
            const heatmapDom = document.querySelector('#heatmap-container').firstElementChild;
            const heatmapInstance = echarts.getInstanceByDom(heatmapDom);
            
            // 导出雷达图
            const radarDom = document.querySelector('#radar-container').firstElementChild;
            const radarInstance = echarts.getInstanceByDom(radarDom);
            
            if (heatmapInstance && radarInstance) {
                // 简化导出：分别导出两个图表
                const heatmapDataURL = heatmapInstance.getDataURL({
                    type: 'png',
                    pixelRatio: 2,
                    backgroundColor: '#fff'
                });
                
                const radarDataURL = radarInstance.getDataURL({
                    type: 'png',
                    pixelRatio: 2,
                    backgroundColor: '#fff'
                });
                
                // 下载热力图
                const link1 = document.createElement('a');
                link1.download = `PUE热力图_${new Date().toISOString().slice(0, 10)}.png`;
                link1.href = heatmapDataURL;
                document.body.appendChild(link1);
                link1.click();
                document.body.removeChild(link1);
                
                // 下载雷达图
                setTimeout(() => {
                    const link2 = document.createElement('a');
                    link2.download = `PUE雷达图_${new Date().toISOString().slice(0, 10)}.png`;
                    link2.href = radarDataURL;
                    document.body.appendChild(link2);
                    link2.click();
                    document.body.removeChild(link2);
                }, 500);
                
                exportBtn.innerHTML = '<i class="fas fa-check"></i> 导出成功';
                setTimeout(() => {
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                }, 1500);
            } else {
                throw new Error('图表实例未找到');
            }
            
        } catch (error) {
            console.error('导出失败:', error);
            exportBtn.innerHTML = '<i class="fas fa-times"></i> 导出失败';
            setTimeout(() => {
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
            }, 2000);
        }
    }
    
    // 更新热力图范围
    function updateHeatmapRange(range) {
        console.log('更新热力图范围:', range);
        // 找到热力图实例并更新范围配置
        const heatmapContainer = document.querySelector('#heatmap-container');
        if (heatmapContainer) {
            const chartDom = heatmapContainer.firstElementChild;
            if (chartDom) {
                const chartInstance = echarts.getInstanceByDom(chartDom);
                if (chartInstance) {
                    let min = 'dataMin', max = 'dataMax';
                    if (range !== 'auto') {
                        const rangeValues = range.split('-');
                        min = parseFloat(rangeValues[0]);
                        max = parseFloat(rangeValues[1]);
                    }
                    chartInstance.setOption({
                        visualMap: {
                            min: min,
                            max: max
                        }
                    });
                }
            }
        }
    }
    
    // 更新雷达图地点显示
    function updateRadarLocations(option) {
        console.log('更新雷达图地点:', option);
        // 雷达图地点显示逻辑需要重新渲染，暂时只记录选择状态
        window.radarLocationOption = option;
    }
    
    // 更新数据范围
    function updateDataRange(range) {
        console.log('更新数据范围:', range);
        // 数据范围变更需要重新请求后端数据，暂时只记录选择状态
        window.dataRangeOption = range;
        // 可以显示提示信息，提醒用户点击刷新
        if (range !== 'current') {
            showTooltip('数据范围已更新，点击刷新按钮应用更改');
        }
    }
    
    // 切换数据标签显示
    function toggleDataLabels(show) {
        console.log('切换数据标签:', show);
        // 更新所有图表的数据标签显示
        const containers = ['#pue_bar', '#heatmap-container', '#radar-container'];
        containers.forEach(selector => {
            const container = document.querySelector(selector);
            if (container) {
                const chartDom = container.firstElementChild;
                if (chartDom) {
                    const chartInstance = echarts.getInstanceByDom(chartDom);
                    if (chartInstance) {
                        const option = chartInstance.getOption();
                        if (option.series) {
                            option.series.forEach(series => {
                                if (series.label) {
                                    series.label.show = show;
                                }
                            });
                            chartInstance.setOption(option);
                        }
                    }
                }
            }
        });
    }
    
    // 切换动画效果
    function toggleAnimation(enable) {
        const allCharts = document.querySelectorAll('#pue_bar, #heatmap-container, #radar-container');
        allCharts.forEach(container => {
            const chartDom = container.firstElementChild;
            if (chartDom) {
                const chartInstance = echarts.getInstanceByDom(chartDom);
                if (chartInstance) {
                    chartInstance.setOption({
                        animation: enable
                    });
                }
            }
        });
        console.log('切换动画效果:', enable);
    }
    
    // 显示提示信息
    function showTooltip(message) {
        // 创建提示框
        const tooltip = document.createElement('div');
        tooltip.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10000;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        `;
        tooltip.innerHTML = `<i class="fas fa-info-circle" style="margin-right: 8px;"></i>${message}`;
        
        document.body.appendChild(tooltip);
        
        // 3秒后自动移除
        setTimeout(() => {
            tooltip.style.opacity = '0';
            tooltip.style.transform = 'translateX(100%)';
            setTimeout(() => {
                document.body.removeChild(tooltip);
            }, 300);
        }, 3000);
    }
    
    // ============ 高级交互功能 ============
    
    // 数据筛选器
    function initDataFilters() {
        // 添加地点筛选交互
        const locationFilter = document.createElement('div');
        locationFilter.innerHTML = `
            <div class="filter-section" style="background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.05);">
                <h4 style="margin: 0 0 12px 0; color: #495057;">
                    <i class="fas fa-filter" style="margin-right: 8px; color: #6c757d;"></i>
                    高级筛选
                </h4>
                <div class="filter-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    <div class="filter-item">
                        <label style="font-size: 12px; color: #6c757d; margin-bottom: 4px; display: block;">数据范围</label>
                        <select id="dateRangeFilter" class="form-control" style="width: 100%; padding: 6px 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            <option value="current" {% if not request.query_params.get('date_range') or request.query_params.get('date_range') == 'current' %}selected{% endif %}>当前年度</option>
                            <option value="last6months" {% if request.query_params.get('date_range') == 'last6months' %}selected{% endif %}>近6个月</option>
                            <option value="last12months" {% if request.query_params.get('date_range') == 'last12months' %}selected{% endif %}>近12个月</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label style="font-size: 12px; color: #6c757d; margin-bottom: 4px; display: block;">PUE阈值</label>
                        <select id="pueThresholdFilter" class="form-control" style="width: 100%; padding: 6px 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            <option value="all">全部数据</option>
                            <option value="excellent">优秀 (≤1.5)</option>
                            <option value="good">良好 (1.5-2.0)</option>
                            <option value="warning">警告 (2.0-2.5)</option>
                            <option value="critical">严重 (>2.5)</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label style="font-size: 12px; color: #6c757d; margin-bottom: 4px; display: block;">地点筛选</label>
                        <select id="locationFilter" class="form-control" style="width: 100%; padding: 6px 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            <option value="" {% if not current_location %}selected{% endif %}>全部地点</option>
                            {% for loc in all_locations %}
                            <option value="{{ loc }}" {% if current_location==loc %}selected{% endif %}>{{ loc }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-item">
                        <label style="font-size: 12px; color: #6c757d; margin-bottom: 4px; display: block;">操作</label>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="applyFilters()" class="btn btn-primary" style="flex: 1; padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 12px;">
                                <i class="fas fa-search"></i> 应用
                            </button>
                            <button onclick="resetFilters()" class="btn btn-secondary" style="flex: 1; padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 12px;">
                                <i class="fas fa-undo"></i> 重置
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 插入到页面顶部
        const metricsGrid = document.querySelector('.metrics-grid');
        if (metricsGrid) {
            metricsGrid.parentNode.insertBefore(locationFilter, metricsGrid);
        }
    }
    
    // 应用筛选器
    function applyFilters() {
        const dateRange = document.getElementById('dateRangeFilter')?.value || 'current';
        const pueThreshold = document.getElementById('pueThresholdFilter')?.value || 'all';
        const location = document.getElementById('locationFilter')?.value || '';
        
        // 构建筛选参数
        const params = new URLSearchParams();
        
        // 添加非默认值的参数
        if (location && location !== '') {
            params.set('location', location);
        }
        if (dateRange && dateRange !== 'current') {
            params.set('date_range', dateRange);
        }
        
        // 显示加载状态
        showFilterLoading();
        
        // 重新加载页面，保留现有参数并添加新的筛选参数
        const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.location.href = newUrl;
    }
    
    // 重置筛选器
    function resetFilters() {
        window.location.href = window.location.pathname;
    }
    
    // 显示筛选加载状态
    function showFilterLoading() {
        const filterSection = document.querySelector('.filter-section');
        if (filterSection) {
            filterSection.style.opacity = '0.6';
            filterSection.style.pointerEvents = 'none';
            
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.9); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                    正在应用筛选条件...
                </div>
            `;
            loadingDiv.style.position = 'absolute';
            loadingDiv.style.top = '0';
            loadingDiv.style.left = '0';
            loadingDiv.style.right = '0';
            loadingDiv.style.bottom = '0';
            loadingDiv.style.zIndex = '10';
            
            filterSection.style.position = 'relative';
            filterSection.appendChild(loadingDiv);
        }
    }
    
    // 数据对比功能
    function initDataComparison() {
        // 添加对比工具栏
        const comparisonBar = document.createElement('div');
        comparisonBar.innerHTML = `
            <div class="comparison-toolbar" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 16px; border-radius: 12px; margin: 16px 0; box-shadow: 0 4px 16px rgba(0,0,0,0.05);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <h4 style="margin: 0; color: #495057;">
                        <i class="fas fa-balance-scale" style="margin-right: 8px; color: #6c757d;"></i>
                        数据对比分析
                    </h4>
                    <button onclick="toggleComparisonMode()" id="comparisonToggle" class="btn btn-outline-primary" style="padding: 6px 12px; border: 1px solid #007bff; color: #007bff; background: white; border-radius: 6px; font-size: 12px;">
                        <i class="fas fa-exchange-alt"></i> 启用对比
                    </button>
                </div>
                <div id="comparisonPanel" style="display: none;">
                    <div class="comparison-controls" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label style="font-size: 12px; color: #6c757d; margin-bottom: 4px; display: block;">对比维度</label>
                            <select id="comparisonDimension" class="form-control" style="width: 100%; padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;">
                                <option value="location">地点对比</option>
                                <option value="time">时间对比</option>
                                <option value="threshold">阈值对比</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #6c757d; margin-bottom: 4px; display: block;">对比对象A</label>
                            <select id="comparisonA" class="form-control" style="width: 100%; padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;">
                                <!-- 动态填充 -->
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #6c757d; margin-bottom: 4px; display: block;">对比对象B</label>
                            <select id="comparisonB" class="form-control" style="width: 100%; padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;">
                                <!-- 动态填充 -->
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #6c757d; margin-bottom: 4px; display: block;">操作</label>
                            <button onclick="performComparison()" class="btn btn-success" style="width: 100%; padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 12px;">
                                <i class="fas fa-chart-line"></i> 开始对比
                            </button>
                        </div>
                    </div>
                    <div id="comparisonResult" style="background: white; border-radius: 8px; padding: 12px; min-height: 100px; border: 1px solid #dee2e6; display: none;">
                        <!-- 对比结果显示区域 -->
                    </div>
                </div>
            </div>
        `;
        
        // 插入到可视化控制面板后
        const vizControlPanel = document.querySelector('.viz-control-panel');
        if (vizControlPanel) {
            vizControlPanel.parentNode.insertBefore(comparisonBar, vizControlPanel.nextSibling);
        }
    }
    
    // 切换对比模式
    function toggleComparisonMode() {
        const panel = document.getElementById('comparisonPanel');
        const toggle = document.getElementById('comparisonToggle');
        
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            toggle.innerHTML = '<i class="fas fa-times"></i> 关闭对比';
            toggle.classList.remove('btn-outline-primary');
            toggle.classList.add('btn-outline-danger');
            
            // 填充对比选项
            populateComparisonOptions();
        } else {
            panel.style.display = 'none';
            toggle.innerHTML = '<i class="fas fa-exchange-alt"></i> 启用对比';
            toggle.classList.remove('btn-outline-danger');
            toggle.classList.add('btn-outline-primary');
        }
    }
    
    // 填充对比选项
    function populateComparisonOptions() {
        // 这里可以根据实际数据填充选项
        const comparisonA = document.getElementById('comparisonA');
        const comparisonB = document.getElementById('comparisonB');
        
        // 示例：填充地点选项
        const locations = ['北京', '上海', '广州', '深圳', '杭州'];
        comparisonA.innerHTML = '';
        comparisonB.innerHTML = '';
        
        locations.forEach(location => {
            comparisonA.innerHTML += `<option value="${location}">${location}</option>`;
            comparisonB.innerHTML += `<option value="${location}">${location}</option>`;
        });
    }
    
    // 执行对比分析
    function performComparison() {
        const dimension = document.getElementById('comparisonDimension').value;
        const objectA = document.getElementById('comparisonA').value;
        const objectB = document.getElementById('comparisonB').value;
        const resultDiv = document.getElementById('comparisonResult');
        
        // 显示加载状态
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #007bff; margin-bottom: 12px;"></i>
                <p style="margin: 0; color: #6c757d;">正在进行对比分析...</p>
            </div>
        `;
        
        // 模拟对比分析
        setTimeout(() => {
            resultDiv.innerHTML = `
                <div class="comparison-summary" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="comparison-item" style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <h5 style="margin: 0 0 8px 0; color: #495057;">${objectA}</h5>
                        <div style="font-size: 24px; font-weight: 600; color: #007bff;">1.65</div>
                        <div style="font-size: 12px; color: #6c757d;">平均PUE值</div>
                    </div>
                    <div class="comparison-item" style="text-align: center; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <h5 style="margin: 0 0 8px 0; color: #495057;">${objectB}</h5>
                        <div style="font-size: 24px; font-weight: 600; color: #28a745;">1.42</div>
                        <div style="font-size: 12px; color: #6c757d;">平均PUE值</div>
                    </div>
                </div>
                <div class="comparison-analysis" style="margin-top: 12px; padding: 12px; background: #e7f3ff; border-radius: 6px; border-left: 4px solid #007bff;">
                    <h6 style="margin: 0 0 6px 0; color: #0056b3;">对比分析结果</h6>
                    <p style="margin: 0; font-size: 13px; color: #004085;">
                        ${objectB} 的PUE值比 ${objectA} 低 0.23，能效表现更优。建议将 ${objectB} 的最佳实践应用到 ${objectA}。
                    </p>
                </div>
                <div class="comparison-actions" style="margin-top: 12px; text-align: center;">
                    <button onclick="exportComparisonReport()" class="btn btn-info" style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; font-size: 12px; margin-right: 8px;">
                        <i class="fas fa-file-export"></i> 导出对比报告
                    </button>
                    <button onclick="generateRecommendations()" class="btn btn-warning" style="padding: 6px 12px; background: #ffc107; color: #212529; border: none; border-radius: 4px; font-size: 12px;">
                        <i class="fas fa-lightbulb"></i> 生成建议
                    </button>
                </div>
            `;
        }, 2000);
    }
    
    // 导出对比报告
    function exportComparisonReport() {
        const reportData = {
            comparison_type: document.getElementById('comparisonDimension').value,
            object_a: document.getElementById('comparisonA').value,
            object_b: document.getElementById('comparisonB').value,
            timestamp: new Date().toISOString(),
            results: {
                object_a_pue: 1.65,
                object_b_pue: 1.42,
                difference: 0.23,
                recommendation: "建议将最佳实践应用到表现较差的地点"
            }
        };
        
        // 创建并下载JSON报告
        const dataStr = JSON.stringify(reportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `PUE对比报告_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
    
    // 生成优化建议
    function generateRecommendations() {
        alert('基于对比分析，建议:\n1. 优化冷却系统效率\n2. 调整服务器负载分布\n3. 改进能源管理策略\n4. 定期进行能效审计');
    }
    
    // 页面初始化
    window.addEventListener('load', function() {
        // 初始化高级功能
        setTimeout(() => {
            initDataFilters();
            initDataComparison();
        }, 1000);
    });
    
    </script>
</div>

<!-- 高级可视化组件区域 -->
<div class="advanced-viz-section" style="margin-top: 32px;">
    <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
        <!-- 热力图卡片 -->
        <div class="card viz-card" style="position: relative; overflow: hidden; border-radius: 16px; background: white; border: 1px solid #e9ecef; box-shadow: 0 4px 16px rgba(0,0,0,0.05);">
            <div class="card-header" style="background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="margin: 0; font-size: 18px; color: #2c3e50; font-weight: 600;">
                        <i class="fas fa-th" style="margin-right: 8px; color: #e74c3c;"></i>
                        PUE热力分布图
                    </h3>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: #7f8c8d;">地点-月份PUE值热力分析</p>
                </div>
                <div class="chart-controls">
                    <button class="chart-control-btn" onclick="toggleHeatmapFullscreen()" style="background: rgba(255,255,255,0.8); border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="card-body" style="padding: 16px; background: white;">
                <div id="heatmap-container" style="width: 100%; height: 320px; display: flex; align-items: center; justify-content: center;">
                    {{ heatmap_html|safe }}
                </div>
            </div>
        </div>

        <!-- 雷达图卡片 -->
        <div class="card viz-card" style="position: relative; overflow: hidden; border-radius: 16px; background: white; border: 1px solid #e9ecef; box-shadow: 0 4px 16px rgba(0,0,0,0.05);">
            <div class="card-header" style="background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="margin: 0; font-size: 18px; color: #2c3e50; font-weight: 600;">
                        <i class="fas fa-chart-radar" style="margin-right: 8px; color: #9b59b6;"></i>
                        多维度性能雷达
                    </h3>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: #7f8c8d;">综合性能评估与对比</p>
                </div>
                <div class="chart-controls">
                    <button class="chart-control-btn" onclick="toggleRadarFullscreen()" style="background: rgba(255,255,255,0.8); border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="card-body" style="padding: 16px; background: white;">
                <div id="radar-container" style="width: 100%; height: 320px; display: flex; align-items: center; justify-content: center;">
                    {{ radar_html|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 原始数据多维表 -->
<div class="card modern-table-card" style="margin-top: 32px; position: relative; z-index: 0; border-radius: 16px; background: white; border: 1px solid #e9ecef; box-shadow: 0 4px 16px rgba(0,0,0,0.05);">
    <div class="card-header" style="background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 24px; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between;">
        <div>
            <h3 style="margin: 0; font-size: 20px; color: #2c3e50; font-weight: 600;">
                <i class="fas fa-table" style="margin-right: 10px; color: #3498db;"></i>
                原始数据多维表
            </h3>
            <p style="margin: 6px 0 0 0; font-size: 14px; color: #7f8c8d;">详细PUE数据表格 - 按地点和年份分组</p>
        </div>
        <div class="table-controls" style="display: flex; gap: 8px;">
            <button class="btn-sm" onclick="exportTableData()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: all 0.3s ease;">
                <i class="fas fa-download" style="margin-right: 6px;"></i>导出
            </button>
            <button class="btn-sm" onclick="toggleTableView()" style="background: rgba(52, 152, 219, 0.1); color: #3498db; border: 1px solid #3498db; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: all 0.3s ease;">
                <i class="fas fa-eye" style="margin-right: 6px;"></i>切换视图
            </button>
        </div>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="data-table-container" style="overflow-x: auto; max-height: 600px;">
            <table class="modern-data-table compact-view" style="width: 100%; border-collapse: collapse; background: white;">
                <thead style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); position: sticky; top: 0; z-index: 10;">
                    <tr>
                        <th rowspan="2" style="background: #2c3e50; color: white; padding: 16px 20px; text-align: center; font-weight: 600; border-right: 2px solid white; position: sticky; left: 0; z-index: 11; min-width: 70px; white-space: nowrap;">月份</th>
                        {% for loc in locations %}
                            <th colspan="{{ years|length }}" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 12px 20px; text-align: center; font-weight: 600; border-right: 2px solid white; white-space: nowrap;">{{ loc }}</th>
                        {% endfor %}
                    </tr>
                    <tr>
                        {% for loc in locations %}
                            {% for y in years %}
                                <th style="background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); color: white; padding: 12px 18px; text-align: center; font-weight: 500; border-right: 1px solid rgba(255,255,255,0.2); font-size: 13px; min-width: 65px; white-space: nowrap;">{{ y }}年</th>
                            {% endfor %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for m in months %}
                    <tr class="data-row" style="transition: all 0.3s ease;" onmouseover="this.style.background='rgba(52, 152, 219, 0.05)'" onmouseout="this.style.background='white'">
                        <td style="background: #f8f9fa; color: #2c3e50; padding: 12px 20px; text-align: center; font-weight: 600; border-right: 2px solid #dee2e6; position: sticky; left: 0; z-index: 9; min-width: 70px; white-space: nowrap; font-size: 14px;">{{ m }}月</td>
                        {% for loc in locations %}
                            {% for y in years %}
                                {% set v = multi_table[m][loc][y] %}
                                {% if v is not none %}
                                    {% set pue_class = 'excellent' if v <= 1.2 else ('good' if v <= 1.5 else ('warning' if v <= 2.0 else 'danger')) %}
                                    <td class="pue-cell pue-{{ pue_class }}" style="padding: 12px 20px; text-align: center; font-weight: 500; border-right: 1px solid #dee2e6; border-bottom: 1px solid #f0f0f0; position: relative; min-width: 65px; white-space: nowrap;">
                                        <span class="pue-value" style="font-size: 14px; font-weight: 600;">{{ "{:.2f}".format(v) }}</span>
                                    </td>
                                {% else %}
                                    <td style="padding: 12px 20px; text-align: center; color: #bdc3c7; border-right: 1px solid #dee2e6; border-bottom: 1px solid #f0f0f0; font-style: italic; min-width: 65px; white-space: nowrap;">-</td>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
.modern-data-table .pue-excellent { background: linear-gradient(135deg, rgba(46, 204, 113, 0.1) 0%, rgba(39, 174, 96, 0.1) 100%); color: #27ae60; }
.modern-data-table .pue-good { background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(41, 128, 185, 0.1) 100%); color: #2980b9; }
.modern-data-table .pue-warning { background: linear-gradient(135deg, rgba(241, 196, 15, 0.1) 0%, rgba(230, 126, 34, 0.1) 100%); color: #f39c12; }
.modern-data-table .pue-danger { background: linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(192, 57, 43, 0.1) 100%); color: #e74c3c; }

.modern-data-table .pue-cell::after {
    content: '';
    position: absolute;
    left: 0;
    bottom: 0;
    height: 3px;
    width: 100%;
    background: currentColor;
    opacity: 0.3;
}

.btn-sm:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.data-row:hover .pue-cell {
    transform: scale(1.02);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.modern-data-table.compact-view th,
.modern-data-table.compact-view td {
    padding: 8px 16px !important;
    font-size: 12px !important;
}

.modern-data-table.compact-view .pue-value {
    font-size: 12px !important;
}

@media (max-width: 768px) {
    .table-controls {
        flex-direction: column !important;
    }
    
    .modern-data-table th,
    .modern-data-table td {
        padding: 12px 8px !important;
        font-size: 12px !important;
    }
}
</style>

<script>
function exportTableData() {
    // 简单的表格数据导出功能
    const table = document.querySelector('.modern-data-table');
    const rows = [];
    
    // 获取表头
    const headers = [];
    table.querySelectorAll('thead th').forEach(th => {
        headers.push(th.textContent.trim());
    });
    
    // 获取数据行
    table.querySelectorAll('tbody tr').forEach(tr => {
        const row = [];
        tr.querySelectorAll('td').forEach(td => {
            row.push(td.textContent.trim());
        });
        rows.push(row);
    });
    
    // 创建CSV内容
    let csvContent = headers.join(',') + '\n';
    rows.forEach(row => {
        csvContent += row.join(',') + '\n';
    });
    
    // 下载文件
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `PUE数据表_${new Date().toISOString().slice(0, 10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    showTooltip('数据导出成功！');
}

function toggleTableView() {
    const table = document.querySelector('.modern-data-table');
    const isCompact = table.classList.contains('compact-view');
    
    if (isCompact) {
        table.classList.remove('compact-view');
        showTooltip('切换到标准视图');
    } else {
        table.classList.add('compact-view');
        showTooltip('切换到紧凑视图');
    }
}
</script>
<!-- 页面底部占位容器 -->
<div style="height:60px;width:100%;pointer-events:none;clear:both;"></div>
{% endblock %}
