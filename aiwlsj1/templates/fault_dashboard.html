{% extends "base.html" %}

{% block title %}故障指标数据分析 - 网络视界指标后台管理{% endblock %}

{% block page_title %}故障指标数据分析{% endblock %}

{% block breadcrumb %}
    <li><span class="text-gray-400 mx-2">/</span></li>
    <li><span class="text-gray-600">契约化指标分析</span></li>
    <li><span class="text-gray-400 mx-2">/</span></li>
    <li><span class="text-gray-600">故障指标分析</span></li>
    <li><span class="text-gray-400 mx-2">/</span></li>
    <li><span class="text-blue-600">故障指标数据分析</span></li>
{% endblock %}

{% block extra_head %}
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.0/echarts.min.js"></script>
    <style>
        .chart-container {
            height: 400px;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #3b82f6;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" 
     x-data="{
         activeTab: 'overview',
         showDetailModal: false,
         showDrilldownModal: false,
         selectedFault: null,
         drilldownMonth: ''
     }">
    
    <!-- 导航标签 -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
        <nav class="flex space-x-8 px-6" aria-label="Tabs">
            <button @click="activeTab = 'overview'; loadOverviewData(); triggerChartResize()" 
                    :class="activeTab === 'overview' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                概览统计
            </button>
            <button @click="activeTab = 'trend'; loadTrendData(); triggerChartResize()" 
                    :class="activeTab === 'trend' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                趋势分析
            </button>
            <button @click="activeTab = 'category'; loadCategoryData(); triggerChartResize()" 
                    :class="activeTab === 'category' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                分类分析
            </button>
            <button @click="activeTab = 'duration'; loadDurationData(); triggerChartResize()" 
                    :class="activeTab === 'duration' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                时长分析
            </button>
            <button @click="activeTab = 'proactive'; loadProactiveData(); triggerChartResize()" 
                    :class="activeTab === 'proactive' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                主动发现
            </button>
            <button @click="activeTab = 'detail'; loadDetailList(); triggerChartResize()" 
                    :class="activeTab === 'detail' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                详细列表
            </button>
        </nav>
    </div>
    <!-- 概览统计 -->
    <div x-show="activeTab === 'overview'" x-transition class="fade-in">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">故障概览统计</h2>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center hover:shadow-md transition-shadow duration-200">
                <div class="metric-value" id="total-faults">-</div>
                <div class="metric-label">总故障数</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center hover:shadow-md transition-shadow duration-200">
                <div class="metric-value" id="monthly-faults">-</div>
                <div class="metric-label">本月故障数</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center hover:shadow-md transition-shadow duration-200">
                <div class="metric-value" id="avg-duration">-</div>
                <div class="metric-label">平均处理时长(小时)</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center hover:shadow-md transition-shadow duration-200">
                <div class="metric-value" id="proactive-rate">-</div>
                <div class="metric-label">主动发现率(%)</div>
            </div>
        </div>
    </div>
                
    <!-- 趋势分析 -->
    <div x-show="activeTab === 'trend'" x-transition class="fade-in">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">故障趋势分析</h2>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">月度故障数量趋势</h3>
            <div id="trend-chart" class="chart-container"></div>
        </div>
    </div>
                
    <!-- 分类分析 -->
    <div x-show="activeTab === 'category'" x-transition class="fade-in">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">故障分类分析</h2>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">按原因分类</h3>
                <div id="cause-chart" class="chart-container"></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">按故障类型</h3>
                <div id="type-chart" class="chart-container"></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">按通报级别</h3>
                <div id="level-chart" class="chart-container"></div>
            </div>
        </div>
    </div>
                
    <!-- 时长分析 -->
    <div x-show="activeTab === 'duration'" x-transition class="fade-in">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">故障处理时长分析</h2>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">处理时长分布</h3>
                <div id="duration-dist-chart" class="chart-container"></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">平均处理时长趋势</h3>
                <div id="duration-trend-chart" class="chart-container"></div>
            </div>
        </div>
    </div>
                
    <!-- 主动发现分析 -->
    <div x-show="activeTab === 'proactive'" x-transition class="fade-in">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">主动发现分析</h2>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">主动发现vs被动发现</h3>
                <div id="proactive-dist-chart" class="chart-container"></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">主动发现率趋势</h3>
                <div id="proactive-trend-chart" class="chart-container"></div>
            </div>
        </div>
    </div>
                
    <!-- 详细列表 -->
    <div x-show="activeTab === 'detail'" x-transition class="fade-in">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">故障详细列表</h2>
        </div>
        
        <!-- 搜索框 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <input type="text" id="search-keyword" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors duration-200" 
                           placeholder="搜索故障名称、原因、处理方式...">
                </div>
                <div>
                    <select id="filter-type" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors duration-200">
                        <option value="">全部故障类型</option>
                    </select>
                </div>
                <div>
                    <select id="filter-category" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors duration-200">
                        <option value="">全部原因分类</option>
                    </select>
                </div>
                <div>
                    <button onclick="searchFaults()" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                        搜索
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 故障列表 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">序号</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">故障时间</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">故障名称</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">故障类型</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">原因分类</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">通报级别</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">处理时长</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">主动发现</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="fault-table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mb-4"></div>
                                    <span>加载中...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 分页 -->
        <div class="mt-6">
            <nav class="flex justify-center" id="pagination">
                <!-- 分页内容将通过 JavaScript 生成 -->
            </nav>
        </div>
    </div>
    
    <!-- 故障详情模态框 -->
    <div x-show="showDetailModal" 
         x-transition.opacity.duration.300ms 
         class="fixed inset-0 z-50 overflow-y-auto" 
         style="display: none;">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div x-show="showDetailModal" 
                 x-transition.opacity.duration.300ms
                 @click="showDetailModal = false"
                 class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            
            <!-- 模态框内容 -->
            <div x-show="showDetailModal" 
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">故障详情</h3>
                        <button @click="showDetailModal = false" 
                                class="rounded-md bg-white text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="sr-only">关闭</span>
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div id="fault-detail-content">
                        <!-- 故障详情内容 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 下钻分析模态框 -->
    <div x-show="showDrilldownModal" 
         x-transition.opacity.duration.300ms 
         class="fixed inset-0 z-50 overflow-y-auto" 
         style="display: none;"
         x-data="{ drilldownActiveTab: 'pareto' }">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div x-show="showDrilldownModal" 
                 x-transition.opacity.duration.300ms
                 @click="showDrilldownModal = false"
                 class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            
            <!-- 模态框内容 -->
            <div x-show="showDrilldownModal" 
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full">
                
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">下钻分析 - <span id="drilldown-month" x-text="drilldownMonth">-</span></h3>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center space-x-2">
                                <label for="pareto-topn" class="text-sm font-medium text-gray-700">Pareto Top-N:</label>
                                <select id="pareto-topn" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="15">15</option>
                                    <option value="0">全部</option>
                                </select>
                            </div>
                            <button @click="showDrilldownModal = false" 
                                    class="rounded-md bg-white text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <span class="sr-only">关闭</span>
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 标签页导航 -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-8">
                            <button @click="drilldownActiveTab = 'pareto'"
                                    :class="drilldownActiveTab === 'pareto' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                    class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                                帕累托分析
                            </button>
                            <button @click="drilldownActiveTab = 'boxplot'"
                                    :class="drilldownActiveTab === 'boxplot' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                    class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                                处理时长箱线图
                            </button>
                            <button @click="drilldownActiveTab = 'control'"
                                    :class="drilldownActiveTab === 'control' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                    class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                                MTTR控制图
                            </button>
                            <button @click="drilldownActiveTab = 'heatmap'"
                                    :class="drilldownActiveTab === 'heatmap' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                    class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                                故障时段热力图
                            </button>
                            <button @click="drilldownActiveTab = 'compare'"
                                    :class="drilldownActiveTab === 'compare' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                    class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                                分组对比
                            </button>
                        </nav>
                    </div>
                    
                    <!-- 标签页内容 -->
                    <div class="space-y-4">
                        <div x-show="drilldownActiveTab === 'pareto'" x-transition class="fade-in">
                            <div id="chart-pareto" class="chart-container"></div>
                        </div>
                        <div x-show="drilldownActiveTab === 'boxplot'" x-transition class="fade-in">
                            <div id="chart-boxplot" class="chart-container"></div>
                        </div>
                        <div x-show="drilldownActiveTab === 'control'" x-transition class="fade-in">
                            <div id="chart-control" class="chart-container"></div>
                        </div>
                        <div x-show="drilldownActiveTab === 'heatmap'" x-transition class="fade-in">
                            <div id="chart-heatmap" class="chart-container"></div>
                        </div>
                        <div x-show="drilldownActiveTab === 'compare'" x-transition class="fade-in">
                            <div id="chart-compare" class="chart-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block scripts %}
    <script>
        // 全局变量
        let currentPage = 1;
        let currentFilters = {};
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[fault_dashboard] DOMContentLoaded');
            
            // 加载概览数据
            loadOverviewData();
            
            // 加载筛选选项
            loadFilterOptions();
        });
        
        // 页面加载后延迟触发图表自适应
        setTimeout(() => {
            resizeAllCharts();
        }, 500);
        
        // 标签切换后延迟触发图表自适应
        function triggerChartResize() {
            setTimeout(() => {
                resizeAllCharts();
            }, 100);
        }

        // 使容器内的所有 ECharts 实例自适应
        function resizeChartsIn(container) {
            if (!container) return;
            container.querySelectorAll('.chart-container').forEach(el => {
                try {
                    const inst = echarts.getInstanceByDom(el);
                    if (inst) inst.resize();
                } catch(e) {}
            });
        }

        // 全局图表自适应
        function resizeAllCharts() {
            document.querySelectorAll('.chart-container').forEach(el => {
                try {
                    const inst = echarts.getInstanceByDom(el);
                    if (inst) inst.resize();
                } catch(e) {}
            });
        }

        // 窗口尺寸变化时全局自适应
        window.addEventListener('resize', resizeAllCharts);
        
        // 加载概览数据
        function loadOverviewData() {
            fetch('/fault/api/overview')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('total-faults').textContent = data.data.total_faults;
                        document.getElementById('monthly-faults').textContent = data.data.monthly_faults;
                        document.getElementById('avg-duration').textContent = formatFixed2(data.data.avg_duration);
                        document.getElementById('proactive-rate').textContent = formatFixed2(data.data.proactive_rate);
                    }
                })
                .catch(error => console.error('加载概览数据失败:', error));
        }
        
        // 加载趋势数据
        function loadTrendData() {
            console.log('[fault_dashboard] loadTrendData');
            fetch('/fault/api/trend')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderTrendChart(data.data);
                        // 渲染趋势图后延迟绑定点击事件
                        setTimeout(() => { 
                            bindTrendChartClick(); 
                        }, 100);
                    }
                })
                .catch(error => console.error('加载趋势数据失败:', error));
        }
        
        // 渲染趋势图表
        function renderTrendChart(data) {
            const chart = echarts.init(document.getElementById('trend-chart'));
            const option = {
                title: {
                    text: '故障数量月度趋势'
                },
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    type: 'category',
                    data: data.map(item => item.date)
                },
                yAxis: {
                    type: 'value'
                },
                series: [{
                    data: data.map(item => item.count),
                    type: 'bar',
                    itemStyle: { color: '#3b82f6' }
                }]
            };
            chart.setOption(option);

            // 柱状图点击下钻
            chart.off('click');
            chart.on('click', function(params) {
                if (!params || !params.name) return;
                console.log('[trend click]', params);
                const monthStr = normalizeMonth(params.name);
                if (!monthStr) {
                    alert('无法识别月份标签：' + params.name);
                    return;
                }
                openDrilldown(monthStr);
            });

            // 鼠标样式提示可点击
            chart.getZr().on('mousemove', function(e){
                const pointInPixel = [e.offsetX, e.offsetY];
                const isOnGrid = chart.convertFromPixel({seriesIndex:0}, pointInPixel);
                chart.getDom().style.cursor = isOnGrid ? 'pointer' : 'default';
            });
        }
        
        // 绑定趋势图点击事件
        function bindTrendChartClick() {
            const el = document.getElementById('trend-chart');
            if (!el) return;
            let inst = null;
            try {
                inst = echarts.getInstanceByDom(el) || null;
            } catch (e) { inst = null; }
            if (!inst) return;
            try {
                inst.off('click'); // 移除旧事件
                inst.on('click', function(params){
                    if (!params || !params.name) return;
                    const monthStr = normalizeMonth(params.name);
                    if (monthStr) openDrilldown(monthStr);
                });
            } catch (e) {
                // 忽略，防止影响页面其它功能
            }
        }
        
        // 加载分类数据
        function loadCategoryData() {
            fetch('/fault/api/category_analysis')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderCategoryCharts(data.data);
                    }
                })
                .catch(error => console.error('加载分类数据失败:', error));
        }
        
        // 渲染分类图表
        function renderCategoryCharts(data) {
            // 原因分类饼图
            const causeChart = echarts.init(document.getElementById('cause-chart'));
            causeChart.setOption({
                tooltip: {
                    trigger: 'item'
                },
                series: [{
                    type: 'pie',
                    radius: '70%',
                    data: data.cause_category,
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            });
            
            // 故障类型饼图
            const typeChart = echarts.init(document.getElementById('type-chart'));
            typeChart.setOption({
                tooltip: {
                    trigger: 'item'
                },
                series: [{
                    type: 'pie',
                    radius: '70%',
                    data: data.fault_type,
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            });
            
            // 通报级别饼图
            const levelChart = echarts.init(document.getElementById('level-chart'));
            levelChart.setOption({
                tooltip: {
                    trigger: 'item'
                },
                series: [{
                    type: 'pie',
                    radius: '70%',
                    data: data.notification_level,
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            });
        }
        
        // 加载时长数据
        function loadDurationData() {
            fetch('/fault/api/duration_analysis')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderDurationCharts(data.data);
                    }
                })
                .catch(error => console.error('加载时长数据失败:', error));
        }
        
        // 渲染时长图表
        function renderDurationCharts(data) {
            // 时长分布柱状图
            const distChart = echarts.init(document.getElementById('duration-dist-chart'));
            distChart.setOption({
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    type: 'category',
                    data: data.duration_distribution.map(item => item.range)
                },
                yAxis: {
                    type: 'value'
                },
                series: [{
                    data: data.duration_distribution.map(item => item.count),
                    type: 'bar',
                    itemStyle: {
                        color: '#10b981'
                    }
                }]
            });
            
            // 平均时长趋势图
            const trendChart = echarts.init(document.getElementById('duration-trend-chart'));
            trendChart.setOption({
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    type: 'category',
                    data: data.duration_trend.map(item => item.date)
                },
                yAxis: {
                    type: 'value'
                },
                series: [{
                    data: data.duration_trend.map(item => item.avg_duration),
                    type: 'line',
                    smooth: true,
                    itemStyle: {
                        color: '#f59e0b'
                    }
                }]
            });
        }
        
        // 加载主动发现数据
        function loadProactiveData() {
            fetch('/fault/api/proactive_analysis')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderProactiveCharts(data.data);
                    }
                })
                .catch(error => console.error('加载主动发现数据失败:', error));
        }
        
        // 渲染主动发现图表
        function renderProactiveCharts(data) {
            // 主动发现分布饼图
            const distChart = echarts.init(document.getElementById('proactive-dist-chart'));
            distChart.setOption({
                tooltip: {
                    trigger: 'item'
                },
                series: [{
                    type: 'pie',
                    radius: '70%',
                    data: data.proactive_distribution,
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            });
            
            // 主动发现率趋势图
            const trendChart = echarts.init(document.getElementById('proactive-trend-chart'));
            trendChart.setOption({
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    type: 'category',
                    data: data.proactive_trend.map(item => item.date)
                },
                yAxis: {
                    type: 'value',
                    max: 100
                },
                series: [{
                    data: data.proactive_trend.map(item => item.proactive_rate),
                    type: 'line',
                    smooth: true,
                    itemStyle: {
                        color: '#ef4444'
                    }
                }]
            });
        }
        
        // 加载详细列表
        function loadDetailList(page = 1) {
            const params = new URLSearchParams({
                page: page,
                per_page: 20,
                ...currentFilters
            });
            
            fetch(`/fault/api/detail_list?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderFaultTable(data.data);
                        renderPagination(data.data);
                    }
                })
                .catch(error => console.error('加载详细列表失败:', error));
        }
        
        // 渲染故障表格
        function renderFaultTable(data) {
            const tbody = document.getElementById('fault-table-body');
            if (data.faults.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">暂无数据</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.faults.map(fault => `
                <tr>
                    <td>${fault.sequence_no || '-'}</td>
                    <td>${fault.fault_date}</td>
                    <td>${fault.fault_name || '-'}</td>
                    <td>${fault.province_fault_type || '-'}</td>
                    <td>${fault.cause_category || '-'}</td>
                    <td><span class="badge ${getBadgeClass(fault.notification_level)}">${fault.notification_level || '-'}</span></td>
                    <td>${formatDuration(fault.fault_duration_hours)}</td>
                    <td><span class="badge ${fault.is_proactive_discovery === '是' ? 'badge-success' : 'badge-warning'}">${fault.is_proactive_discovery || '-'}</span></td>
                    <td><button class="btn btn-sm btn-outline-primary" onclick="showFaultDetail(${fault.id})">详情</button></td>
                </tr>
            `).join('');
        }
        
        // 获取徽章样式类
        function getBadgeClass(level) {
            if (!level) return 'bg-secondary';
            if (level.includes('重大') || level.includes('严重')) return 'badge-danger';
            if (level.includes('一般')) return 'badge-warning';
            return 'badge-success';
        }
        
        // 格式化处理时长（小时），保留两位小数
        function formatDuration(value) {
            if (value === null || value === undefined || value === '') return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return '-';
            return num.toFixed(2) + '小时';
        }
        
        // 通用：格式化为保留两位小数（不加单位）
        function formatFixed2(value) {
            if (value === null || value === undefined || value === '') return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return '-';
            return num.toFixed(2);
        }
        
        // 渲染分页
        function renderPagination(data) {
            const pagination = document.getElementById('pagination');
            if (data.total_pages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // 上一页
            if (data.page > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadDetailList(${data.page - 1})">上一页</a></li>`;
            }
            
            // 页码
            for (let i = Math.max(1, data.page - 2); i <= Math.min(data.total_pages, data.page + 2); i++) {
                html += `<li class="page-item ${i === data.page ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadDetailList(${i})">${i}</a>
                </li>`;
            }
            
            // 下一页
            if (data.page < data.total_pages) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadDetailList(${data.page + 1})">下一页</a></li>`;
            }
            
            pagination.innerHTML = html;
        }
        
        // 加载筛选选项
        function loadFilterOptions() {
            fetch('/fault/api/category_analysis')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 填充故障类型选项
                        const typeSelect = document.getElementById('filter-type');
                        data.data.fault_type.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.name;
                            option.textContent = item.name;
                            typeSelect.appendChild(option);
                        });
                        
                        // 填充原因分类选项
                        const categorySelect = document.getElementById('filter-category');
                        data.data.cause_category.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.name;
                            option.textContent = item.name;
                            categorySelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('加载筛选选项失败:', error));
        }
        
        // 搜索故障
        function searchFaults() {
            const keyword = document.getElementById('search-keyword').value.trim();
            const faultType = document.getElementById('filter-type').value;
            const causeCategory = document.getElementById('filter-category').value;
            
            currentFilters = {};
            if (faultType) currentFilters.fault_type = faultType;
            if (causeCategory) currentFilters.cause_category = causeCategory;
            
            if (keyword) {
                // 关键词搜索
                fetch(`/fault/api/search?keyword=${encodeURIComponent(keyword)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            renderFaultTable({faults: data.data});
                            document.getElementById('pagination').innerHTML = '';
                        }
                    })
                    .catch(error => console.error('搜索失败:', error));
            } else {
                // 筛选搜索
                currentPage = 1;
                loadDetailList(1);
            }
        }
        
        // 显示故障详情
        function showFaultDetail(faultId) {
            fetch(`/fault/api/detail/${faultId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const fault = data.data;
                        const detailContent = `
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>故障ID:</strong> ${fault.id || '-'}</p>
                                    <p><strong>故障发生时间:</strong> ${fault.fault_occurrence_time || '-'}</p>
                                    <p><strong>故障恢复时间:</strong> ${fault.fault_recovery_time || '-'}</p>
                                    <p><strong>处理时长(小时):</strong> ${formatDuration(fault.fault_duration_hours)}</p>
                                    <p><strong>故障类型:</strong> ${fault.fault_type || '-'}</p>
                                    <p><strong>省份故障类型:</strong> ${fault.province_fault_type || '-'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>原因分类:</strong> ${fault.cause_category || '-'}</p>
                                    <p><strong>通报等级:</strong> <span class="badge ${getBadgeClass(fault.notification_level)}">${fault.notification_level || '-'}</span></p>
                                    <p><strong>主动发现:</strong> <span class="badge ${fault.is_proactive_discovery === '是' ? 'badge-success' : 'badge-warning'}">${fault.is_proactive_discovery || '-'}</span></p>
                                    <p><strong>故障描述:</strong> ${fault.fault_description || '-'}</p>
                                    <p><strong>处理措施:</strong> ${fault.handling_measures || '-'}</p>
                                    <p><strong>备注:</strong> ${fault.remarks || '-'}</p>
                                </div>
                            </div>
                        `;
                        document.getElementById('fault-detail-content').innerHTML = detailContent;
                        
                        // 使用 Alpine.js 的响应式状态来显示模态框
                        const dashboard = document.querySelector('[x-data]');
                        if (dashboard && dashboard._x_dataStack && dashboard._x_dataStack[0]) {
                            dashboard._x_dataStack[0].showDetailModal = true;
                        }
                    } else {
                        alert('获取故障详情失败: ' + (data.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('获取故障详情失败:', error);
                    alert('获取故障详情失败，请稍后重试');
                });
        }
        
        // 回车搜索
        document.getElementById('search-keyword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchFaults();
            }
        });

        // 下钻：打开弹窗并加载数据
        function openDrilldown(monthStr) {
            // 使用 Alpine.js 的响应式状态来显示模态框
            const dashboard = document.querySelector('[x-data]');
            if (dashboard && dashboard._x_dataStack && dashboard._x_dataStack[0]) {
                dashboard._x_dataStack[0].drilldownMonth = monthStr;
                dashboard._x_dataStack[0].showDrilldownModal = true;
            }

            // 延迟触发图表resize，当模态框显示后
            setTimeout(() => {
                ['chart-pareto','chart-boxplot','chart-control','chart-heatmap','chart-compare'].forEach(id => {
                    const inst = echarts.getInstanceByDom(document.getElementById(id));
                    if (inst) setTimeout(()=>inst.resize(), 50);
                });
            }, 300);

            fetch(`/fault/api/drilldown?month=${encodeURIComponent(monthStr)}`)
                .then(r => r.json())
                .then(res => {
                    if (!res.success) throw new Error(res.error || '加载失败');
                    window.__faultDrilldownData = res.data || {};
                    // Pareto 使用 Top-N
                    renderPareto(getParetoTopN());
                    // 其他图表
                    renderBoxplot(res.data.boxplot || {categories:[], data:[]});
                    renderControl(res.data.control || {series:[], mean:0, ucl:0, lcl:0});
                    renderHeatmap(res.data.heatmap || []);
                    renderGroupCompare(res.data.group_compare || {levels:[], counts:[], avg_duration:[]});
                })
                .catch(err => {
                    console.error('下钻数据加载失败:', err);
                    alert('下钻数据加载失败：' + err.message);
                });
        }

        // 获取 Pareto Top-N 数据
        function getParetoTopN() {
            const all = (window.__faultDrilldownData && window.__faultDrilldownData.pareto) ? window.__faultDrilldownData.pareto : [];
            const n = parseInt(document.getElementById('pareto-topn').value || '10', 10);
            if (!n || n <= 0) return all;
            return all.slice(0, n);
        }

        // 监听 Top-N 变化
        document.addEventListener('change', function(e){
            if (e.target && e.target.id === 'pareto-topn') {
                try { renderPareto(getParetoTopN()); } catch (err) { console.warn('重绘Pareto失败', err); }
            }
        });

        // 规范化月份字符串为 YYYY-MM
        function normalizeMonth(s) {
            if (!s) return '';
            // 常见格式：YYYY-MM 或 YYYY/M 或 YYYY/M M
            const m = String(s).trim().replace(/年|\//g, '-').replace(/\s+/g, '');
            let m2 = m;
            const m1 = m.match(/^(\d{4})-(\d{1,2})$/);
            if (m1) {
                const mm = m1[2].padStart(2, '0');
                return `${m1[1]}-${mm}`;
            }
            const m2match = m.match(/^(\d{4})-(\d{1,2})-?$/);
            if (m2match) {
                const mm = m2match[2].padStart(2, '0');
                return `${m2match[1]}-${mm}`;
            }
            // 已经是YYYY-MM
            if (/^\d{4}-\d{2}$/.test(m2)) return m2;
            return '';
        }

        // 下钻：帕累托图
        function renderPareto(pareto) {
            const el = echarts.init(document.getElementById('chart-pareto'));
            const names = pareto.map(i => i.name);
            const counts = pareto.map(i => i.count);
            const cum = pareto.map(i => i.cum_percent);
            el.setOption({
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: names },
                yAxis: [
                    { type: 'value', name: '数量' },
                    { type: 'value', name: '累计占比(%)', min: 0, max: 100 }
                ],
                series: [
                    { type: 'bar', data: counts, itemStyle: { color: '#3b82f6' }, name: '数量' },
                    { type: 'line', yAxisIndex: 1, data: cum, name: '累计占比', smooth: true, itemStyle: { color: '#f59e0b' } }
                ]
            });
        }

        // 下钻：箱线图
        function renderBoxplot(box) {
            const el = echarts.init(document.getElementById('chart-boxplot'));
            const option = {
                tooltip: { trigger: 'item' },
                xAxis: { type: 'category', data: box.categories },
                yAxis: { type: 'value', name: '处理时长(小时)' },
                series: [{
                    name: '时长分布',
                    type: 'boxplot',
                    data: box.data
                }]
            };
            el.setOption(option);
        }

        // 下钻：控制图
        function renderControl(ctrl) {
            const el = echarts.init(document.getElementById('chart-control'));
            const n = ctrl.series.length;
            el.setOption({
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: Array.from({length: n}, (_, i) => i + 1) },
                yAxis: { type: 'value', name: '处理时长(小时)' },
                series: [
                    { type: 'line', data: ctrl.series, name: '时长', smooth: true, itemStyle: { color: '#10b981' } },
                    { type: 'line', data: Array(n).fill(ctrl.mean), name: '均值', lineStyle: { type: 'dashed' } },
                    { type: 'line', data: Array(n).fill(ctrl.ucl), name: 'UCL', lineStyle: { type: 'dotted', color: '#ef4444' } },
                    { type: 'line', data: Array(n).fill(ctrl.lcl), name: 'LCL', lineStyle: { type: 'dotted', color: '#ef4444' } }
                ]
            });
        }

        // 下钻：热力图 (周x小时)
        function renderHeatmap(heatmapData) {
            const el = echarts.init(document.getElementById('chart-heatmap'));
            const hours = Array.from({length:24}, (_,i)=>i);
            const days = ['一','二','三','四','五','六','日'];
            const vmax = (heatmapData && heatmapData.length) ? Math.max.apply(null, heatmapData.map(i=>i[2])) : 10;
            el.setOption({
                tooltip: {},
                grid: { top: 40 },
                xAxis: { type: 'category', data: hours, name: '小时' },
                yAxis: { type: 'category', data: [0,1,2,3,4,5,6].map(i => '周' + days[i]) },
                visualMap: { min: 0, max: vmax, calculable: true, orient: 'horizontal', left: 'center', bottom: 0 },
                series: [{
                    type: 'heatmap',
                    data: heatmapData,
                    emphasis: { itemStyle: { borderColor: '#333' } }
                }]
            });
        }

        // 下钻图表自适应（由Alpine.js标签页切换触发）
        function resizeDrilldownCharts() {
            ['chart-pareto','chart-boxplot','chart-control','chart-heatmap','chart-compare'].forEach(id => {
                const container = document.getElementById(id);
                if (!container) return;
                try {
                    const inst = echarts.getInstanceByDom(container);
                    if (inst) inst.resize();
                } catch(e) {}
            });
        }

        // 下钻：分组对比（通报级别计数与平均时长）
        function renderGroupCompare(gc) {
            const el = echarts.init(document.getElementById('chart-compare'));
            el.setOption({
                tooltip: { trigger: 'axis' },
                legend: { data: ['数量', '平均时长'] },
                xAxis: { type: 'category', data: gc.levels },
                yAxis: [ { type: 'value', name: '数量' }, { type: 'value', name: '平均时长(小时)' } ],
                series: [
                    { type: 'bar', data: gc.counts, name: '数量', itemStyle: { color: '#3b82f6' } },
                    { type: 'line', data: gc.avg_duration, yAxisIndex: 1, name: '平均时长', itemStyle: { color: '#f59e0b' } }
                ]
            });
        }
    </script>
{% endblock %}
