<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒ‡æ ‡ç®¡ç†ä¸ç»©æ•ˆè¯„ä¼° - æ•…éšœåˆ†æç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .card-modern {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .card-modern:hover {
            transform: translateY(-5px);
        }
        .metric-card {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-left: 5px solid #007bff;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .status-excellent { color: #28a745; }
        .status-good { color: #ffc107; }
        .status-warning { color: #fd7e14; }
        .status-alert { color: #dc3545; }
        .chart-container {
            height: 400px;
            margin: 20px 0;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">æ•…éšœåˆ†æç³»ç»Ÿ</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/fault">æ•…éšœåˆ†æ</a>
                <a class="nav-link" href="/fault/prediction">æ•…éšœé¢„æµ‹</a>
                <a class="nav-link active" href="/fault/indicators">æŒ‡æ ‡ç®¡ç†</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card-modern card gradient-bg p-4">
                    <h1 class="mb-0">ğŸ“Š æŒ‡æ ‡ç®¡ç†ä¸ç»©æ•ˆè¯„ä¼°</h1>
                    <p class="mb-0 mt-2">å…¨é¢çš„KPIç›‘æ§ã€ç»©æ•ˆè¯„ä¼°å’Œè¶‹åŠ¿åˆ†æ</p>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½å¯¼èˆªæ ‡ç­¾ -->
        <ul class="nav nav-tabs mb-4" id="mainTabs">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#indicators-tab">ğŸ“ˆ æŒ‡æ ‡æ¦‚è§ˆ</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#performance-tab">ğŸ¯ ç»©æ•ˆè¯„ä¼°</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#dashboard-tab">ğŸ“Š å®æ—¶ä»ªè¡¨ç›˜</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#targets-tab">âš™ï¸ ç›®æ ‡ç®¡ç†</button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- æŒ‡æ ‡æ¦‚è§ˆ Tab -->
            <div class="tab-pane fade show active" id="indicators-tab">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <select class="form-select" id="timePeriod">
                            <option value="last_7_days">æœ€è¿‘7å¤©</option>
                            <option value="last_30_days" selected>æœ€è¿‘30å¤©</option>
                            <option value="last_90_days">æœ€è¿‘90å¤©</option>
                            <option value="last_365_days">æœ€è¿‘1å¹´</option>
                            <option value="all_data">æ‰€æœ‰å†å²æ•°æ®</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="loadIndicators()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                    </div>
                </div>

                <!-- æ•°æ®æ¦‚å†µ -->
                <div class="row mb-3" id="dataOverview" style="display: none;">
                    <div class="col-12">
                        <div class="alert alert-info d-flex justify-content-between align-items-center">
                            <div>
                                <strong>ğŸ“‹ æ•°æ®æ¦‚å†µ:</strong> 
                                <span id="dataStats">æ­£åœ¨åŠ è½½...</span>
                            </div>
                            <small class="text-muted" id="lastUpdated">æœ€åæ›´æ–°: --</small>
                        </div>
                    </div>
                </div>

                <!-- KPIæŒ‡æ ‡å¡ç‰‡ -->
                <div class="row mb-4" id="kpiCards">
                    <div class="loading">
                        <div class="spinner-border text-primary"></div>
                        <p>åŠ è½½æŒ‡æ ‡æ•°æ®ä¸­...</p>
                    </div>
                </div>

                <!-- è¶‹åŠ¿åˆ†æå›¾è¡¨ -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card card-modern">
                            <div class="card-header">
                                <h5>ğŸ“ˆ æ•…éšœé‡è¶‹åŠ¿</h5>
                            </div>
                            <div class="card-body">
                                <div id="faultTrendChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card card-modern">
                            <div class="card-header">
                                <h5>âš ï¸ ä¸¥é‡ç¨‹åº¦åˆ†å¸ƒ</h5>
                            </div>
                            <div class="card-body">
                                <div id="severityChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é£é™©æŒ‡æ ‡å‘Šè­¦ -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card card-modern">
                            <div class="card-header">
                                <h5>ğŸš¨ é£é™©æŒ‡æ ‡å‘Šè­¦</h5>
                            </div>
                            <div class="card-body" id="riskAlerts">
                                <div class="loading">
                                    <div class="spinner-border text-warning"></div>
                                    <p>åˆ†æé£é™©æŒ‡æ ‡ä¸­...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç»©æ•ˆè¯„ä¼° Tab -->
            <div class="tab-pane fade" id="performance-tab">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <select class="form-select" id="evaluationPeriod">
                            <option value="weekly">å‘¨åº¦è¯„ä¼°</option>
                            <option value="monthly" selected>æœˆåº¦è¯„ä¼°</option>
                            <option value="quarterly">å­£åº¦è¯„ä¼°</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-success" onclick="loadPerformanceEvaluation()">ğŸ“Š ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š</button>
                    </div>
                </div>

                <!-- ç»©æ•ˆè¯„ä¼°ç»“æœ -->
                <div id="performanceResults">
                    <div class="loading">
                        <div class="spinner-border text-success"></div>
                        <p>ç”Ÿæˆç»©æ•ˆè¯„ä¼°æŠ¥å‘Šä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- å®æ—¶ä»ªè¡¨ç›˜ Tab -->
            <div class="tab-pane fade" id="dashboard-tab">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card card-modern metric-card">
                            <div class="card-body text-center">
                                <div class="metric-value" id="realtimeFaults">-</div>
                                <div class="metric-label">å½“å‰æ•…éšœæ•°</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-modern metric-card">
                            <div class="card-body text-center">
                                <div class="metric-value" id="realtimeSeverity">-</div>
                                <div class="metric-label">é«˜ä¸¥é‡ç¨‹åº¦æ•…éšœ</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-modern metric-card">
                            <div class="card-body text-center">
                                <div class="metric-value" id="realtimeProactive">-</div>
                                <div class="metric-label">ä¸»åŠ¨å‘ç°ç‡</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å®æ—¶å›¾è¡¨ -->
                <div class="row">
                    <div class="col-12">
                        <div class="card card-modern">
                            <div class="card-header">
                                <h5>ğŸ“Š å®æ—¶ç›‘æ§ä»ªè¡¨ç›˜</h5>
                                <span class="badge bg-success">å®æ—¶æ›´æ–°</span>
                            </div>
                            <div class="card-body">
                                <div id="realtimeDashboard" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç›®æ ‡ç®¡ç† Tab -->
            <div class="tab-pane fade" id="targets-tab">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card card-modern">
                            <div class="card-header">
                                <h5>ğŸ¯ ç»©æ•ˆç›®æ ‡è®¾ç½®</h5>
                            </div>
                            <div class="card-body">
                                <form id="targetsForm">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">æœˆåº¦æ•…éšœæ•°é‡ç›®æ ‡</label>
                                            <input type="number" class="form-control" id="faultVolumeTarget" value="100">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">é«˜ä¸¥é‡ç¨‹åº¦æ•…éšœæ¯”ä¾‹ç›®æ ‡(%)</label>
                                            <input type="number" class="form-control" id="severityRateTarget" value="15" step="0.1">
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">å¹³å‡è§£å†³æ—¶é—´ç›®æ ‡(å°æ—¶)</label>
                                            <input type="number" class="form-control" id="resolutionTimeTarget" value="4" step="0.1">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">ä¸»åŠ¨å‘ç°ç‡ç›®æ ‡(%)</label>
                                            <input type="number" class="form-control" id="proactiveRateTarget" value="70">
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="saveTargets()">ğŸ’¾ ä¿å­˜ç›®æ ‡</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-modern">
                            <div class="card-header">
                                <h5>ğŸ“‹ ç›®æ ‡è¿½è¸ªè®¡åˆ’</h5>
                            </div>
                            <div class="card-body" id="trackingPlan">
                                <p class="text-muted">è®¾ç½®ç›®æ ‡åå°†è‡ªåŠ¨ç”Ÿæˆè¿½è¸ªè®¡åˆ’</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let indicatorsData = null;
        let performanceData = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadIndicators();
            loadDashboard();
            
            // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
            setInterval(loadDashboard, 300000); // 5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
        });

        // åŠ è½½æŒ‡æ ‡ç®¡ç†æ•°æ®
        async function loadIndicators() {
            try {
                const timePeriod = document.getElementById('timePeriod').value;
                const response = await fetch(`/fault/api/indicators/management?time_period=${timePeriod}`);
                const data = await response.json();
                
                indicatorsData = data;
                
                // æ˜¾ç¤ºæ•°æ®æ¦‚å†µ
                showDataOverview(data);
                
                // æ£€æŸ¥æ•°æ®å¯ç”¨æ€§
                if (!data.data_available) {
                    showNoDataMessage(data.data_status);
                    return;
                }
                
                renderKPICards(data.kpis);
                renderTrendAnalysis(data.trend_analysis);
                renderRiskAlerts(data.risk_alerts);
                
            } catch (error) {
                console.error('åŠ è½½æŒ‡æ ‡æ•°æ®å¤±è´¥:', error);
                showLoadingError('æŒ‡æ ‡æ•°æ®åŠ è½½å¤±è´¥', error.message);
            }
        }

        // æ¸²æŸ“KPIå¡ç‰‡
        function renderKPICards(kpis) {
            const container = document.getElementById('kpiCards');
            let html = '';
            
            for (const [key, kpi] of Object.entries(kpis)) {
                const statusClass = getStatusClass(kpi.status);
                const statusIcon = getStatusIcon(kpi.status);
                
                html += `
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card card-modern metric-card">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <span class="badge bg-light text-dark">${getKPICategory(key)}</span>
                                    <span>${statusIcon}</span>
                                </div>
                                <div class="metric-value ${statusClass}">
                                    ${kpi.value}
                                </div>
                                <div class="metric-label">${getKPILabel(key)}</div>
                                <div class="mt-2">
                                    <small class="text-muted">ç›®æ ‡: ${kpi.target}${kpi.unit}</small>
                                    <div class="progress mt-1" style="height: 4px;">
                                        <div class="progress-bar ${getProgressBarClass(kpi.status)}" 
                                             style="width: ${getProgressPercentage(kpi)}%">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // åŠ è½½ç»©æ•ˆè¯„ä¼°
        async function loadPerformanceEvaluation() {
            try {
                const period = document.getElementById('evaluationPeriod').value;
                const response = await fetch(`/fault/api/performance/evaluation?evaluation_period=${period}`);
                const data = await response.json();
                
                performanceData = data;
                renderPerformanceResults(data);
                
            } catch (error) {
                console.error('åŠ è½½ç»©æ•ˆè¯„ä¼°å¤±è´¥:', error);
                showLoadingError('ç»©æ•ˆè¯„ä¼°åŠ è½½å¤±è´¥', error.message, 'performanceResults');
            }
        }

        // æ¸²æŸ“ç»©æ•ˆè¯„ä¼°ç»“æœ
        function renderPerformanceResults(data) {
            const container = document.getElementById('performanceResults');
            const summary = data.evaluation_summary;
            
            let html = `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card card-modern">
                            <div class="card-header">
                                <h5>ğŸ“ˆ è¯„ä¼°æ€»ç»“</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <h6>æ•´ä½“è¯„ä¼°</h6>
                                    <p>${summary.overall_assessment}</p>
                                </div>
            `;
            
            // å…³é”®å‘ç°
            if (summary.key_findings && summary.key_findings.length > 0) {
                html += `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>ğŸ” å…³é”®å‘ç°</h6>
                            <ul class="list-group list-group-flush">
                `;
                summary.key_findings.forEach(finding => {
                    html += `<li class="list-group-item">${finding}</li>`;
                });
                html += `</ul></div>`;
            }
            
            // ç»©æ•ˆäº®ç‚¹
            if (summary.performance_highlights && summary.performance_highlights.length > 0) {
                html += `
                    <div class="col-md-6">
                        <h6>âœ¨ ç»©æ•ˆäº®ç‚¹</h6>
                        <ul class="list-group list-group-flush">
                `;
                summary.performance_highlights.forEach(highlight => {
                    html += `<li class="list-group-item text-success">${highlight}</li>`;
                });
                html += `</ul></div></div>`;
            }
            
            html += `</div></div></div></div>`;
            
            container.innerHTML = html;
        }

        // åŠ è½½å®æ—¶ä»ªè¡¨ç›˜
        async function loadDashboard() {
            try {
                const response = await fetch('/fault/api/indicators/dashboard');
                const data = await response.json();
                
                // æ›´æ–°å®æ—¶æŒ‡æ ‡
                if (data.realtime_data) {
                    document.getElementById('realtimeFaults').textContent = data.realtime_data.current_fault_count || '-';
                    document.getElementById('realtimeSeverity').textContent = data.realtime_data.high_severity_count || '-';
                    document.getElementById('realtimeProactive').textContent = 
                        (data.realtime_data.proactive_discovery_rate || 0).toFixed(1) + '%';
                }
                
            } catch (error) {
                console.error('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜ç»©æ•ˆç›®æ ‡
        async function saveTargets() {
            try {
                const targets = {
                    fault_volume_target: parseInt(document.getElementById('faultVolumeTarget').value),
                    high_severity_rate_target: parseFloat(document.getElementById('severityRateTarget').value),
                    avg_resolution_time_target: parseFloat(document.getElementById('resolutionTimeTarget').value),
                    proactive_discovery_rate_target: parseInt(document.getElementById('proactiveRateTarget').value)
                };
                
                const response = await fetch('/fault/api/indicators/targets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(targets)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showSuccess('ç›®æ ‡è®¾ç½®æˆåŠŸï¼');
                    renderTrackingPlan(result.tracking_plan);
                } else {
                    showError('ç›®æ ‡è®¾ç½®å¤±è´¥');
                }
                
            } catch (error) {
                console.error('ä¿å­˜ç›®æ ‡å¤±è´¥:', error);
                showError('ä¿å­˜ç›®æ ‡å¤±è´¥');
            }
        }

        // æ¸²æŸ“è¿½è¸ªè®¡åˆ’
        function renderTrackingPlan(plan) {
            const container = document.getElementById('trackingPlan');
            let html = `
                <h6>ğŸ“… è¯„å®¡è®¡åˆ’</h6>
                <p><strong>è¯„å®¡é¢‘ç‡:</strong> ${plan.review_frequency}</p>
                <h6>ğŸ¯ é‡Œç¨‹ç¢‘</h6>
                <ul class="list-group list-group-flush">
            `;
            
            if (plan.milestone_dates) {
                plan.milestone_dates.forEach(milestone => {
                    html += `<li class="list-group-item d-flex justify-content-between">
                        <span>${milestone.milestone}</span>
                        <small class="text-muted">${milestone.date}</small>
                    </li>`;
                });
            }
            
            html += `</ul>`;
            container.innerHTML = html;
        }

        // æ¸²æŸ“è¶‹åŠ¿åˆ†æå›¾è¡¨
        function renderTrendAnalysis(trendData) {
            // è¿™é‡Œå¯ä»¥æ·»åŠ EChartså›¾è¡¨æ¸²æŸ“é€»è¾‘
            console.log('è¶‹åŠ¿æ•°æ®:', trendData);
        }

        // æ¸²æŸ“é£é™©å‘Šè­¦
        function renderRiskAlerts(riskData) {
            const container = document.getElementById('riskAlerts');
            let html = '';
            
            if (riskData.high_risk_indicators && riskData.high_risk_indicators.length > 0) {
                html += '<h6 class="text-danger">ğŸ”´ é«˜é£é™©æŒ‡æ ‡</h6>';
                riskData.high_risk_indicators.forEach(risk => {
                    html += `
                        <div class="alert alert-danger">
                            <strong>${risk.indicator}</strong>: ${risk.current_value}
                            <br><small>${risk.recommendation}</small>
                        </div>
                    `;
                });
            }
            
            if (riskData.warning_indicators && riskData.warning_indicators.length > 0) {
                html += '<h6 class="text-warning mt-3">ğŸŸ¡ é¢„è­¦æŒ‡æ ‡</h6>';
                riskData.warning_indicators.forEach(risk => {
                    html += `
                        <div class="alert alert-warning">
                            <strong>${risk.indicator}</strong>: ${risk.current_value}
                            <br><small>${risk.recommendation}</small>
                        </div>
                    `;
                });
            }
            
            if (!html) {
                html = '<div class="alert alert-success">âœ… æ‰€æœ‰æŒ‡æ ‡æ­£å¸¸ï¼Œæ— é£é™©å‘Šè­¦</div>';
            }
            
            container.innerHTML = html;
        }

        // å·¥å…·å‡½æ•°
        function getStatusClass(status) {
            const statusMap = {
                'excellent': 'status-excellent',
                'good': 'status-good', 
                'normal': 'status-good',
                'warning': 'status-warning',
                'alert': 'status-alert',
                'needs_improvement': 'status-warning'
            };
            return statusMap[status] || 'status-good';
        }

        function getStatusIcon(status) {
            const iconMap = {
                'excellent': 'ğŸ‰',
                'good': 'âœ…',
                'normal': 'âœ…',
                'warning': 'âš ï¸',
                'alert': 'ğŸš¨',
                'needs_improvement': 'ğŸ“ˆ'
            };
            return iconMap[status] || 'âœ…';
        }

        function getKPILabel(key) {
            const labelMap = {
                'fault_volume': 'æ•…éšœæ€»é‡',
                'high_severity_rate': 'é«˜ä¸¥é‡ç¨‹åº¦æ¯”ä¾‹',
                'avg_resolution_time': 'å¹³å‡è§£å†³æ—¶é—´',
                'proactive_discovery_rate': 'ä¸»åŠ¨å‘ç°ç‡',
                'repeat_fault_rate': 'é‡å¤æ•…éšœç‡'
            };
            return labelMap[key] || key;
        }

        function getKPICategory(key) {
            const categoryMap = {
                'fault_volume': 'æ•°é‡',
                'high_severity_rate': 'è´¨é‡',
                'avg_resolution_time': 'æ•ˆç‡',
                'proactive_discovery_rate': 'é¢„é˜²',
                'repeat_fault_rate': 'è´¨é‡'
            };
            return categoryMap[key] || 'æŒ‡æ ‡';
        }

        function getProgressBarClass(status) {
            const classMap = {
                'excellent': 'bg-success',
                'good': 'bg-success',
                'normal': 'bg-primary',
                'warning': 'bg-warning',
                'alert': 'bg-danger',
                'needs_improvement': 'bg-warning'
            };
            return classMap[status] || 'bg-primary';
        }

        function getProgressPercentage(kpi) {
            // æ ¹æ®KPIç±»å‹è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
            if (kpi.status === 'excellent' || kpi.status === 'good') {
                return 100;
            } else if (kpi.status === 'normal') {
                return 75;
            } else if (kpi.status === 'warning' || kpi.status === 'needs_improvement') {
                return 50;
            } else if (kpi.status === 'alert') {
                return 25;
            }
            return 60; // é»˜è®¤å€¼
        }

        function showSuccess(message) {
            // ç®€å•çš„æˆåŠŸæç¤º
            alert('âœ… ' + message);
        }

        function showError(message) {
            // ç®€å•çš„é”™è¯¯æç¤º
            alert('âŒ ' + message);
        }

        function showLoadingError(title, errorMessage, targetContainer = null) {
            // æ˜¾ç¤ºè¯¦ç»†çš„åŠ è½½é”™è¯¯ä¿¡æ¯
            const errorHtml = `
                <div class="col-12">
                    <div class="card card-modern border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">âŒ ${title}</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-danger">
                                <h6>é”™è¯¯è¯¦æƒ…ï¼š</h6>
                                <pre class="mb-3">${errorMessage || 'æœªçŸ¥é”™è¯¯'}</pre>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>å¯èƒ½åŸå› ï¼š</h6>
                                        <ul class="list-unstyled">
                                            <li>â€¢ ç½‘ç»œè¿æ¥é—®é¢˜</li>
                                            <li>â€¢ æœåŠ¡å™¨ä¸´æ—¶ä¸å¯ç”¨</li>
                                            <li>â€¢ APIæ¥å£å¼‚å¸¸</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>è§£å†³æ–¹æ¡ˆï¼š</h6>
                                        <ul class="list-unstyled">
                                            <li>â€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥</li>
                                            <li>â€¢ åˆ·æ–°é¡µé¢é‡è¯•</li>
                                            <li>â€¢ è”ç³»æŠ€æœ¯æ”¯æŒ</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-primary btn-sm" onclick="location.reload()">
                                        ğŸ”„ åˆ·æ–°é¡µé¢
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="loadIndicators()">
                                        ğŸ” é‡æ–°åŠ è½½æ•°æ®
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // æ ¹æ®ç›®æ ‡å®¹å™¨æ˜¾ç¤ºé”™è¯¯
            if (targetContainer) {
                const container = document.getElementById(targetContainer);
                if (container) {
                    container.innerHTML = errorHtml;
                }
            } else {
                // é»˜è®¤æ˜¾ç¤ºåœ¨KPIå¡ç‰‡å®¹å™¨ä¸­
                const kpiContainer = document.getElementById('kpiCards');
                if (kpiContainer) {
                    kpiContainer.innerHTML = errorHtml;
                }
            }
        }

        function showNoDataMessage(dataStatus) {
            // æ¸…ç©ºæ‰€æœ‰æ•°æ®å®¹å™¨å¹¶æ˜¾ç¤ºæ— æ•°æ®æç¤º
            const kpiContainer = document.getElementById('kpiCards');
            const riskContainer = document.getElementById('riskAlerts');
            
            const noDataHtml = `
                <div class="col-12">
                    <div class="card card-modern">
                        <div class="card-body text-center p-5">
                            <div style="font-size: 4rem; color: #6c757d; margin-bottom: 2rem;">ğŸ“Š</div>
                            <h4 class="text-muted mb-3">${dataStatus.message}</h4>
                            <p class="text-muted mb-4">${dataStatus.suggestion}</p>
                            ${dataStatus.action_required ? `
                                <div class="alert alert-info">
                                    <strong>ğŸ’¡ å»ºè®®æ“ä½œï¼š</strong><br>
                                    â€¢ å°è¯•é€‰æ‹©æ›´å¤§çš„æ—¶é—´èŒƒå›´ï¼ˆå¦‚90å¤©ï¼‰<br>
                                    â€¢ æ£€æŸ¥æ˜¯å¦æœ‰å†å²æ•°æ®å¯ä¾›åˆ†æ<br>
                                    â€¢ è”ç³»ç®¡ç†å‘˜å¯¼å…¥æ›´å¤šæ•…éšœæ•°æ®
                                </div>
                                <button class="btn btn-primary" onclick="showHistoricalData()">
                                    ğŸ” æŸ¥çœ‹å†å²æ•°æ®
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            kpiContainer.innerHTML = noDataHtml;
            riskContainer.innerHTML = `
                <div class="alert alert-info">
                    <h6>ğŸ“‹ æ•°æ®çŠ¶æ€</h6>
                    <p>å½“å‰æ—¶é—´èŒƒå›´å†…æ— æ•…éšœæ•°æ®ï¼Œæ— æ³•ç”Ÿæˆé£é™©åˆ†ææŠ¥å‘Šã€‚</p>
                </div>
            `;
        }

        function showHistoricalData() {
            // è‡ªåŠ¨è®¾ç½®ä¸ºæ‰€æœ‰å†å²æ•°æ®å¹¶é‡æ–°åŠ è½½
            document.getElementById('timePeriod').value = 'all_data';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('kpiCards').innerHTML = `
                <div class="col-12 text-center">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2">æ­£åœ¨åŠ è½½æ‰€æœ‰å†å²æ•°æ®...</p>
                </div>
            `;
            
            loadIndicators();
        }

        function showDataOverview(data) {
            // æ˜¾ç¤ºæ•°æ®æ¦‚å†µä¿¡æ¯
            const overviewElement = document.getElementById('dataOverview');
            const statsElement = document.getElementById('dataStats');
            const updatedElement = document.getElementById('lastUpdated');
            
            if (data.data_available) {
                const timePeriodText = getTimePeriodText(data.time_period);
                statsElement.innerHTML = `
                    ${timePeriodText}å†…å…±æœ‰ <strong>${data.total_records}</strong> æ¡æ•…éšœè®°å½•
                    (${data.date_range.start_date} è‡³ ${data.date_range.end_date})
                `;
            } else {
                statsElement.innerHTML = `
                    ${getTimePeriodText(data.time_period)}å†… <strong>æ— æ•…éšœæ•°æ®</strong>
                    (${data.date_range.start_date} è‡³ ${data.date_range.end_date})
                `;
            }
            
            updatedElement.textContent = `æœ€åæ›´æ–°: ${new Date(data.last_updated).toLocaleString()}`;
            overviewElement.style.display = 'block';
        }

        function getTimePeriodText(period) {
            const periodMap = {
                'last_7_days': 'æœ€è¿‘7å¤©',
                'last_30_days': 'æœ€è¿‘30å¤©', 
                'last_90_days': 'æœ€è¿‘90å¤©',
                'last_365_days': 'æœ€è¿‘1å¹´',
                'all_data': 'æ‰€æœ‰å†å²æ•°æ®'
            };
            return periodMap[period] || 'æŒ‡å®šæ—¶é—´èŒƒå›´';
        }
    </script>
</body>
</html>