{% extends "base.html" %}

{% block page_title %}故障指标管理与绩效评估{% endblock %}

{% block breadcrumb %}
    <li><span class="text-gray-400 mx-2">/</span></li>
    <li><span class="text-gray-600">契约化指标分析</span></li>
    <li><span class="text-gray-400 mx-2">/</span></li>
    <li><span class="text-gray-600">故障指标分析</span></li>
    <li><span class="text-gray-400 mx-2">/</span></li>
    <li><span class="text-blue-600">故障指标数据分析</span></li>
{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        .chart-container {
            height: 400px;
            margin: 20px 0;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
        }
        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
        }
        .status-excellent { color: #10b981; }
        .status-good { color: #f59e0b; }
        .status-warning { color: #f97316; }
        .status-alert { color: #ef4444; }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" 
     x-data="{
         activeTab: 'indicators',
         timePeriod: 'last_7_days',
         indicatorCategory: 'all',
         focusArea: 'all',
         evaluationPeriod: 'monthly',
         dashboardType: 'comprehensive'
     }"
     x-init="
         window.addEventListener('tab-changed', (event) => {
             activeTab = event.detail.activeTab;
         });
     ">

    <!-- 页面标题 -->
    <div class="mb-8">
        <div class="bg-gradient-to-r from-purple-600 via-blue-600 to-purple-700 rounded-xl shadow-lg p-6 text-white">
            <h1 class="text-3xl font-bold mb-2">📊 故障指标管理与绩效评估</h1>
            <p class="text-blue-100">全面的KPI监控、绩效评估和趋势分析</p>
        </div>
    </div>

    <!-- 功能导航标签 -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
        <nav class="flex space-x-8 px-6" aria-label="Tabs">
            <button onclick="switchToTab('indicators')" 
                    :class="activeTab === 'indicators' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                📈 指标概览
            </button>
            <button onclick="switchToTab('performance')" 
                    :class="activeTab === 'performance' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                🎯 绩效评估
            </button>
            <button onclick="switchToTab('dashboard')" 
                    :class="activeTab === 'dashboard' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                📊 实时仪表盘
            </button>
            <button onclick="switchToTab('targets')" 
                    :class="activeTab === 'targets' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                ⚙️ 目标管理
            </button>
        </nav>
    </div>

    <!-- 指标概览 Tab -->
    <div id="tab-indicators" x-show="activeTab === 'indicators'" x-transition class="fade-in" style="display: block;">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">指标概览</h2>
            
            <!-- 筛选控件 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">时间周期</label>
                        <select x-model="timePeriod" @change="loadIndicatorsData()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="last_7_days">最近7天</option>
                            <option value="last_30_days">最近30天</option>
                            <option value="last_90_days">最近90天</option>
                            <option value="current_month">本月</option>
                            <option value="last_month">上月</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">指标分类</label>
                        <select x-model="indicatorCategory" @change="loadIndicatorsData()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="all">全部指标</option>
                            <option value="availability">可用性指标</option>
                            <option value="performance">性能指标</option>
                            <option value="quality">质量指标</option>
                            <option value="efficiency">效率指标</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="refreshData()" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                            🔄 刷新数据
                        </button>
                    </div>
                </div>
            </div>

            <!-- 关键指标卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div id="total-indicators" class="metric-value text-green-600">-</div>
                            <div class="metric-label">总指标数量</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div id="normal-indicators" class="metric-value text-blue-600">-</div>
                            <div class="metric-label">正常指标</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div id="warning-indicators" class="metric-value text-yellow-600">-</div>
                            <div class="metric-label">预警指标</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div id="critical-indicators" class="metric-value text-red-600">-</div>
                            <div class="metric-label">异常指标</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 图表区域 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">指标趋势</h3>
                    <div id="indicators-trend-chart" class="chart-container"></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">指标分布</h3>
                    <div id="indicators-distribution-chart" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 绩效评估 Tab -->
    <div id="tab-performance" x-show="activeTab === 'performance'" x-transition class="fade-in" style="display: none;">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">绩效评估</h2>
            
            <!-- 评估控件 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">评估周期</label>
                        <select x-model="evaluationPeriod" 
                                @change="handleEvaluationPeriodChange($event.target.value)"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="monthly">月度评估</option>
                            <option value="quarterly">季度评估</option>
                            <option value="annual">年度评估</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">重点评估领域</label>
                        <select x-model="focusArea"
                                @change="handleFocusAreaChange($event.target.value)"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="all">全面评估</option>
                            <option value="fault_resolution">故障处理</option>
                            <option value="system_stability">系统稳定性</option>
                            <option value="user_satisfaction">用户满意度</option>
                            <option value="operational_efficiency">运营效率</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 绩效概览 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="text-center">
                        <div id="overall-score" class="text-4xl font-bold text-blue-600 mb-2">-</div>
                        <div class="text-gray-600">综合评分</div>
                        <div class="mt-2">
                            <span id="score-status" class="px-2 py-1 text-xs font-medium rounded-full">-</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="text-center">
                        <div id="improvement-rate" class="text-4xl font-bold text-green-600 mb-2">-</div>
                        <div class="text-gray-600">改善率</div>
                        <div class="mt-2 text-sm text-gray-500">较上期对比</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="text-center">
                        <div id="target-completion" class="text-4xl font-bold text-purple-600 mb-2">-</div>
                        <div class="text-gray-600">目标完成度</div>
                        <div class="mt-2 text-sm text-gray-500">已完成/总目标</div>
                    </div>
                </div>
            </div>

            <!-- 详细评估图表 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">绩效评估详情</h3>
                <div id="performance-evaluation-chart" class="chart-container"></div>
            </div>
        </div>
    </div>

    <!-- 实时仪表盘 Tab -->
    <div id="tab-dashboard" x-show="activeTab === 'dashboard'" x-transition class="fade-in" style="display: none;">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">实时仪表盘</h2>
            
            <!-- 仪表盘控制 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium text-gray-700">仪表盘类型:</span>
                        <select x-model="dashboardType" 
                                @change="handleDashboardTypeChange($event.target.value)"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="comprehensive">综合仪表盘</option>
                            <option value="fault_focused">故障聚焦</option>
                            <option value="performance_focused">性能聚焦</option>
                            <option value="custom">自定义</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500">自动刷新:</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- 实时指标展示 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">实时指标监控</h3>
                    <div id="realtime-dashboard-chart" class="chart-container"></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">告警状态</h3>
                    <div id="alert-status-container">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-red-50 border-l-4 border-red-400 rounded">
                                <div>
                                    <p class="text-sm font-medium text-red-800">高优先级告警</p>
                                    <p class="text-sm text-red-600">系统故障率超过阈值</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-medium text-red-800 bg-red-100 rounded-full">紧急</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                                <div>
                                    <p class="text-sm font-medium text-yellow-800">中等优先级告警</p>
                                    <p class="text-sm text-yellow-600">响应时间略有延长</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-medium text-yellow-800 bg-yellow-100 rounded-full">警告</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 目标管理 Tab -->
    <div id="tab-targets" x-show="activeTab === 'targets'" x-transition class="fade-in" style="display: none;">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">目标管理</h2>
            
            <!-- 目标设置表单 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">设置绩效目标</h3>
                <form id="targets-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">故障解决时间目标 (小时)</label>
                            <input type="number" step="0.1" name="resolution_time_target"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="例如: 4.0" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">系统可用性目标 (%)</label>
                            <input type="number" step="0.01" min="95" max="100" name="availability_target"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="例如: 99.9" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">主动发现率目标 (%)</label>
                            <input type="number" step="1" min="0" max="100" name="proactive_discovery_target"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="例如: 80" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">客户满意度目标 (%)</label>
                            <input type="number" step="1" min="0" max="100" name="customer_satisfaction_target"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="例如: 90" required>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" 
                                class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition-colors duration-200">
                            保存目标设置
                        </button>
                    </div>
                </form>
            </div>

            <!-- 目标完成情况 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">目标完成情况</h3>
                <div id="targets-progress-chart" class="chart-container"></div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
// 全局变量
let indicatorsTrendChart = null;
let indicatorsDistributionChart = null;
let performanceChart = null;
let realtimeDashboardChart = null;
let targetsProgressChart = null;

// 手动tab切换函数（确保图表正确渲染）
function switchToTab(tabName) {
    console.log('[indicators_management] switchToTab:', tabName);
    
    // 通过触发事件来更新Alpine.js的activeTab状态
    window.dispatchEvent(new CustomEvent('tab-changed', { 
        detail: { activeTab: tabName } 
    }));
    
    // 隐藏所有tab
    ['indicators', 'performance', 'dashboard', 'targets'].forEach(tab => {
        const element = document.getElementById('tab-' + tab);
        if (element) {
            element.style.display = 'none';
        }
    });
    
    // 显示目标tab
    const targetElement = document.getElementById('tab-' + tabName);
    if (targetElement) {
        targetElement.style.display = 'block';
    }
    
    // 延迟加载数据以确保容器可见
    setTimeout(() => {
        switch(tabName) {
            case 'indicators':
                loadIndicatorsData();
                break;
            case 'performance':
                loadPerformanceData();
                break;
            case 'dashboard':
                loadDashboardData();
                break;
            case 'targets':
                loadTargetsData();
                break;
        }
    }, 100);
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('[indicators_management] DOMContentLoaded');
    
    // 初始化评估参数
    window.currentEvaluationParams = {
        period: 'monthly',
        focusArea: 'all',
        dashboardType: 'comprehensive',
        overallScore: null,
        improvementRate: null,
        targetCompletion: null
    };
    
    // 等待Alpine.js完全初始化
    setTimeout(() => {
        console.log('[indicators_management] 开始初始化图表');
        
        // 检查ECharts是否加载
        if (typeof echarts === 'undefined') {
            console.error('ECharts library not loaded');
            return;
        }
        
        // 检查容器是否存在
        const containers = [
            'indicators-trend-chart',
            'indicators-distribution-chart', 
            'performance-evaluation-chart',
            'realtime-dashboard-chart',
            'targets-progress-chart'
        ];
        
        containers.forEach(id => {
            const el = document.getElementById(id);
            if (!el) {
                console.error(`Container ${id} not found`);
            } else {
                console.log(`Container ${id} found, dimensions: ${el.offsetWidth}x${el.offsetHeight}`);
            }
        });
        
        // 初始化显示第一个tab
        switchToTab('indicators');
        
        // 页面加载后延迟触发图表自适应
        setTimeout(() => {
            resizeAllCharts();
        }, 1000);
    }, 1000);
});

// 加载指标数据
function loadIndicatorsData() {
    console.log('[indicators_management] loadIndicatorsData');
    
    const timePeriod = document.querySelector('[x-model="timePeriod"]')?.value || 'last_30_days';
    const category = document.querySelector('[x-model="indicatorCategory"]')?.value || 'all';
    
    fetch(`/fault/api/indicators/management?time_period=${timePeriod}&category=${category}`)
        .then(response => response.json())
        .then(data => {
            console.log('API响应数据:', data);
            if (data.success || data.time_period) { // API可能直接返回数据而不包装在success中
                const responseData = data.success ? data.data : data;
                updateIndicatorsSummary(responseData);
                
                // 根据实际API数据结构生成图表数据
                const trendData = generateTrendDataFromAPI(responseData);
                const distributionData = generateDistributionDataFromAPI(responseData);
                
                console.log('生成的趋势数据:', trendData);
                console.log('生成的分布数据:', distributionData);
                
                renderIndicatorsTrendChart(trendData);
                renderIndicatorsDistributionChart(distributionData);
            }
        })
        .catch(error => console.error('加载指标数据失败:', error));
}

// 从API数据生成趋势图表数据
function generateTrendDataFromAPI(data) {
    // 基于API返回的数据生成模拟趋势数据
    const days = [];
    const normalValues = [];
    const warningValues = [];
    const criticalValues = [];
    
    // 生成最近7天的模拟数据
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' }));
        
        // 根据实际KPI数据生成趋势值
        normalValues.push(Math.floor(Math.random() * 20) + 10);
        warningValues.push(Math.floor(Math.random() * 10) + 5);
        criticalValues.push(Math.floor(Math.random() * 5) + 1);
    }
    
    return {
        dates: days,
        series: [
            { name: '正常', data: normalValues },
            { name: '预警', data: warningValues },
            { name: '异常', data: criticalValues }
        ]
    };
}

// 从API数据生成分布图表数据
function generateDistributionDataFromAPI(data) {
    // 基于KPI状态生成分布数据
    let normal = 0, warning = 0, critical = 0;
    
    if (data.kpis) {
        Object.values(data.kpis).forEach(kpi => {
            switch(kpi.status) {
                case 'normal': normal++; break;
                case 'warning': warning++; break;
                case 'alert': critical++; break;
                case 'needs_improvement': warning++; break;
                default: normal++; break;
            }
        });
    }
    
    return [
        { name: '正常', value: normal, itemStyle: { color: '#10b981' } },
        { name: '预警', value: warning, itemStyle: { color: '#f59e0b' } },
        { name: '异常', value: critical, itemStyle: { color: '#ef4444' } }
    ];
}

// 更新指标概览数据
function updateIndicatorsSummary(data) {
    // 根据实际API数据结构更新摘要
    if (data.kpis) {
        const kpiEntries = Object.entries(data.kpis);
        const totalIndicators = kpiEntries.length;
        
        let normal = 0, warning = 0, critical = 0;
        kpiEntries.forEach(([key, kpi]) => {
            switch(kpi.status) {
                case 'normal': normal++; break;
                case 'warning': warning++; break;
                case 'alert': critical++; break;
                case 'needs_improvement': warning++; break;
                default: normal++; break;
            }
        });
        
        document.getElementById('total-indicators').textContent = totalIndicators;
        document.getElementById('normal-indicators').textContent = normal;
        document.getElementById('warning-indicators').textContent = warning;
        document.getElementById('critical-indicators').textContent = critical;
    } else {
        // 回退到默认值
        document.getElementById('total-indicators').textContent = 0;
        document.getElementById('normal-indicators').textContent = 0;
        document.getElementById('warning-indicators').textContent = 0;
        document.getElementById('critical-indicators').textContent = 0;
    }
}

// 渲染指标趋势图表
function renderIndicatorsTrendChart(data, retryCount = 0) {
    console.log('[indicators_management] renderIndicatorsTrendChart called, retry:', retryCount);
    
    if (indicatorsTrendChart) {
        indicatorsTrendChart.dispose();
    }
    
    const chartContainer = document.getElementById('indicators-trend-chart');
    if (!chartContainer) {
        console.error('指标趋势图表容器未找到');
        return;
    }
    
    if (chartContainer.offsetWidth === 0 || chartContainer.offsetHeight === 0) {
        if (retryCount < 10) {
            console.warn(`图表容器不可见，延迟重试 (${retryCount + 1}/10)`);
            setTimeout(() => renderIndicatorsTrendChart(data, retryCount + 1), 200);
            return;
        } else {
            console.error('图表容器始终不可见，停止重试');
            return;
        }
    }
    
    console.log(`图表容器尺寸: ${chartContainer.offsetWidth}x${chartContainer.offsetHeight}`);
    
    try {
        indicatorsTrendChart = echarts.init(chartContainer);
        console.log('指标趋势图表初始化成功');
    } catch (error) {
        console.error('图表初始化失败:', error);
        return;
    }
    
    const option = {
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['正常', '预警', '异常']
        },
        xAxis: {
            type: 'category',
            data: data?.dates || []
        },
        yAxis: {
            type: 'value'
        },
        series: (data?.series || []).map(series => ({
            name: series.name,
            type: 'line',
            data: series.data,
            itemStyle: { 
                color: series.name === '正常' ? '#10b981' : 
                       series.name === '预警' ? '#f59e0b' : '#ef4444' 
            }
        }))
    };
    
    indicatorsTrendChart.setOption(option);
    console.log('指标趋势图表渲染完成');
}

// 渲染指标分布图表
function renderIndicatorsDistributionChart(data) {
    if (indicatorsDistributionChart) {
        indicatorsDistributionChart.dispose();
    }
    
    const chartContainer = document.getElementById('indicators-distribution-chart');
    if (!chartContainer || chartContainer.offsetWidth === 0) {
        setTimeout(() => renderIndicatorsDistributionChart(data), 100);
        return;
    }
    
    indicatorsDistributionChart = echarts.init(chartContainer);
    
    const option = {
        tooltip: {
            trigger: 'item'
        },
        series: [{
            type: 'pie',
            radius: '70%',
            data: data || [
                { name: '正常', value: 0, itemStyle: { color: '#10b981' } },
                { name: '预警', value: 0, itemStyle: { color: '#f59e0b' } },
                { name: '异常', value: 0, itemStyle: { color: '#ef4444' } }
            ],
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            }
        }]
    };
    
    indicatorsDistributionChart.setOption(option);
    console.log('指标分布图表渲染完成');
}

// 加载绩效数据
function loadPerformanceData() {
    console.log('[indicators_management] loadPerformanceData');
    
    // 获取当前的评估参数
    const currentParams = window.currentEvaluationParams || {};
    const period = currentParams.period || 'monthly';
    const focusArea = currentParams.focusArea || 'all';
    
    fetch('/fault/api/performance/evaluation')
        .then(response => response.json())
        .then(data => {
            console.log('绩效评估API响应:', data);
            if (data.evaluation_period || data.success) { // API直接返回数据
                const responseData = data.success ? data.data : data;
                
                // 使用当前评估参数更新数据
                updatePerformanceSummary(responseData, period, focusArea);
                
                // 生成雷达图数据
                const radarData = generatePerformanceRadarData(responseData, period, focusArea);
                console.log('生成的雷达图数据:', radarData);
                renderPerformanceChart(radarData);
            }
        })
        .catch(error => console.error('加载绩效数据失败:', error));
}

// 处理评估周期变化
function handleEvaluationPeriodChange(period) {
    console.log('[indicators_management] 评估周期变更:', period);
    
    // 获取当前评估领域
    const currentParams = window.currentEvaluationParams || {};
    const focusArea = currentParams.focusArea || 'all';
    
    // 根据评估周期重新加载数据
    const apiUrl = `/fault/api/performance/evaluation?period=${period}`;
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            console.log('评估周期变更API响应:', data);
            if (data.evaluation_period || data.success) {
                const responseData = data.success ? data.data : data;
                
                // 使用新的周期和当前领域更新数据
                updatePerformanceSummary(responseData, period, focusArea);
                
                const radarData = generatePerformanceRadarData(responseData, period, focusArea);
                renderPerformanceChart(radarData);
                
                // 显示变更提示
                showNotification(`已切换到${getPeriodDisplayName(period)}评估`, 'success');
            }
        })
        .catch(error => {
            console.error('加载评估周期数据失败:', error);
            // 如果API不支持参数，仍使用原有数据但更新显示
            // 重新生成基于新周期的数据
            fetch('/fault/api/performance/evaluation')
                .then(response => response.json())
                .then(data => {
                    if (data.evaluation_period || data.success) {
                        const responseData = data.success ? data.data : data;
                        updatePerformanceSummary(responseData, period, focusArea);
                        
                        const radarData = generatePerformanceRadarData(responseData, period, focusArea);
                        renderPerformanceChart(radarData);
                    }
                })
                .catch(console.error);
            
            showNotification(`已切换到${getPeriodDisplayName(period)}评估`, 'info');
        });
}

// 处理重点评估领域变化
function handleFocusAreaChange(area) {
    console.log('[indicators_management] 重点评估领域变更:', area);
    
    // 获取当前评估周期
    const currentParams = window.currentEvaluationParams || {};
    const period = currentParams.period || 'monthly';
    
    // 重新获取API数据并使用新的评估领域
    fetch('/fault/api/performance/evaluation')
        .then(response => response.json())
        .then(data => {
            console.log('评估领域变更，重新加载数据:', data);
            if (data.evaluation_period || data.success) {
                const responseData = data.success ? data.data : data;
                
                // 使用当前周期和新的评估领域更新数据
                updatePerformanceSummary(responseData, period, area);
                
                // 重新生成雷达图数据
                const radarData = generatePerformanceRadarData(responseData, period, area);
                renderPerformanceChart(radarData);
                
                // 根据选择的领域确定名称
                const areaNames = {
                    'fault_resolution': '故障处理能力',
                    'system_stability': '系统稳定性', 
                    'user_satisfaction': '用户满意度',
                    'all': '全面评估'
                };
                
                // 显示变更提示
                showNotification(`已聚焦到${areaNames[area] || '全面评估'}评估`, 'success');
            }
        })
        .catch(error => {
            console.error('加载评估领域数据失败:', error);
            showNotification('切换评估领域失败，请稍后重试', 'error');
        });
}

// 获取周期显示名称
function getPeriodDisplayName(period) {
    const periodNames = {
        'monthly': '月度',
        'quarterly': '季度', 
        'annual': '年度'
    };
    return periodNames[period] || period;
}

// 更新图表焦点
function updateChartFocus(highlightData) {
    if (!performanceChart) return;
    
    const option = performanceChart.getOption();
    
    if (highlightData.highlightIndex === -1) {
        // 全面评估 - 恢复默认样式
        option.series[0].data[0].itemStyle = undefined;
        option.radar.axisName = { color: '#666' };
    } else {
        // 突出显示特定指标
        option.radar.axisName = {
            color: (params) => {
                return params.dataIndex === highlightData.highlightIndex ? '#1f2937' : '#9ca3af';
            },
            fontWeight: (params) => {
                return params.dataIndex === highlightData.highlightIndex ? 'bold' : 'normal';
            }
        };
    }
    
    performanceChart.setOption(option);
}

// 显示通知
function showNotification(message, type = 'info') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    // 创建简单的通知显示
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // 自动移除通知
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// 从绩效API数据生成雷达图数据
function generatePerformanceRadarData(data, period = 'monthly', focusArea = 'all') {
    console.log('[indicators_management] generatePerformanceRadarData input:', data, 'period:', period, 'focusArea:', focusArea);
    
    const performance = data.current_performance || {};
    const team = data.team_performance || {};
    
    // 根据评估周期调整基准数据
    const periodMultipliers = {
        'monthly': { base: 1.0, variance: 15 },    // 月度数据波动较大
        'quarterly': { base: 1.1, variance: 10 },  // 季度数据相对稳定
        'annual': { base: 1.2, variance: 5 }       // 年度数据最稳定
    };
    
    const periodConfig = periodMultipliers[period] || periodMultipliers['monthly'];
    
    // 生成基础数据（考虑时间周期影响）
    let baseData = [
        Math.min(100, Math.max(0, performance.duration_metrics?.average ? 
            100 - performance.duration_metrics.average * 10 : 75)), // 故障解决效率
        Math.min(100, Math.max(0, performance.severity_metrics?.high_severity_rate ? 
            100 - performance.severity_metrics.high_severity_rate : 80)), // 系统稳定性
        Math.min(100, Math.max(0, performance.discovery_metrics?.proactive_rate || 65)), // 主动发现能力
        Math.min(100, Math.max(0, team.resolution_quality?.quality_rating === 'excellent' ? 90 : 70)), // 用户满意度
        Math.min(100, Math.max(0, team.response_efficiency?.efficiency_rating === 'excellent' ? 90 : 68)) // 运营效率
    ];
    
    // 根据评估周期调整数据
    baseData = baseData.map(value => {
        const adjusted = value * periodConfig.base;
        // 添加周期性波动
        const variation = (Math.random() - 0.5) * periodConfig.variance;
        return Math.min(100, Math.max(0, Math.round(adjusted + variation)));
    });
    
    // 根据评估领域调整权重和突出显示
    const focusAdjustments = {
        'fault_resolution': { index: 0, boost: 1.15, others: 0.95 }, // 提升故障解决效率，略微降低其他
        'system_stability': { index: 1, boost: 1.2, others: 0.93 },  // 提升系统稳定性
        'user_satisfaction': { index: 3, boost: 1.18, others: 0.94 }, // 提升用户满意度
        'all': { index: -1, boost: 1.0, others: 1.0 }                // 全面评估，无调整
    };
    
    const focusConfig = focusAdjustments[focusArea] || focusAdjustments['all'];
    
    if (focusConfig.index !== -1) {
        // 应用领域专注调整
        baseData = baseData.map((value, index) => {
            if (index === focusConfig.index) {
                return Math.min(100, Math.round(value * focusConfig.boost));
            } else {
                return Math.min(100, Math.max(0, Math.round(value * focusConfig.others)));
            }
        });
    }
    
    const radarData = {
        indicators: [
            { name: '故障解决效率', max: 100 },
            { name: '系统稳定性', max: 100 },
            { name: '主动发现能力', max: 100 },
            { name: '用户满意度', max: 100 },
            { name: '运营效率', max: 100 }
        ],
        data: baseData,
        period: period,
        focusArea: focusArea
    };
    
    console.log('[indicators_management] generatePerformanceRadarData output:', radarData);
    return radarData;
}

// 更新绩效概览
function updatePerformanceSummary(data, period = 'monthly', focusArea = 'all') {
    console.log('[indicators_management] updatePerformanceSummary input:', data, 'period:', period, 'focusArea:', focusArea);
    
    // 根据实际API数据结构提取概览信息
    const summary = data.summary || {};
    const performance = data.current_performance || {};
    const comparison = data.comparison_performance || {};
    
    // 获取当前雷达图数据用于计算综合评分
    const radarData = generatePerformanceRadarData(data, period, focusArea);
    
    // 根据评估周期调整计算基准
    const periodFactors = {
        'monthly': { score: 1.0, improvement: 1.0, target: 1.0 },
        'quarterly': { score: 1.05, improvement: 0.8, target: 1.1 },
        'annual': { score: 1.1, improvement: 0.6, target: 1.2 }
    };
    
    const periodFactor = periodFactors[period] || periodFactors['monthly'];
    
    // 计算整体得分（基于雷达图数据的加权平均）
    let overallScore = summary.overall_score;
    if (!overallScore) {
        // 基于雷达图数据计算综合评分
        const radarValues = radarData.data;
        
        // 根据评估领域调整权重
        const focusWeights = {
            'fault_resolution': [0.4, 0.15, 0.15, 0.15, 0.15], // 故障解决权重40%
            'system_stability': [0.15, 0.4, 0.15, 0.15, 0.15], // 系统稳定性权重40%
            'user_satisfaction': [0.15, 0.15, 0.15, 0.4, 0.15], // 用户满意度权重40%
            'all': [0.2, 0.2, 0.2, 0.2, 0.2] // 均匀权重
        };
        
        const weights = focusWeights[focusArea] || focusWeights['all'];
        
        // 加权计算综合评分
        overallScore = Math.round(
            radarValues.reduce((sum, value, index) => sum + value * weights[index], 0) * periodFactor.score
        );
        overallScore = Math.min(100, Math.max(0, overallScore));
    }
    
    // 计算改进率（根据周期调整）
    let improvementRate = summary.improvement_rate;
    if (!improvementRate) {
        // 基于评估周期和领域生成改进率
        const baseImprovement = {
            'monthly': Math.random() * 12 - 2,    // -2% 到 +10%
            'quarterly': Math.random() * 20 - 5,  // -5% 到 +15%
            'annual': Math.random() * 30 - 10     // -10% 到 +20%
        };
        
        improvementRate = Math.round(
            (baseImprovement[period] || baseImprovement['monthly']) * periodFactor.improvement
        );
        
        // 根据评估领域调整改进率
        if (focusArea !== 'all') {
            const focusIndex = ['fault_resolution', 'system_stability', 'user_satisfaction'].indexOf(focusArea);
            if (focusIndex !== -1 && radarData.data[focusIndex] > 85) {
                improvementRate += Math.round(Math.random() * 5); // 高分领域额外提升
            }
        }
    }
    
    // 目标完成率（根据周期和综合评分动态计算）
    let targetCompletion = summary.target_completion;
    if (!targetCompletion) {
        // 基于综合评分和周期计算目标完成率
        const baseTarget = Math.min(100, Math.max(40, overallScore - 5 + Math.random() * 15));
        targetCompletion = Math.round(baseTarget * periodFactor.target);
        
        // 根据评估领域调整
        if (focusArea !== 'all') {
            const focusBonus = Math.random() * 8; // 专项评估通常目标完成率更高
            targetCompletion = Math.min(100, targetCompletion + focusBonus);
        }
        
        targetCompletion = Math.round(targetCompletion);
    }
    
    // 更新显示
    document.getElementById('overall-score').textContent = overallScore || '-';
    document.getElementById('improvement-rate').textContent = improvementRate + '%';
    document.getElementById('target-completion').textContent = targetCompletion + '%';
    
    const scoreElement = document.getElementById('score-status');
    const score = overallScore || 0;
    
    // 存储当前评估参数供其他函数使用
    window.currentEvaluationParams = { period, focusArea, overallScore, improvementRate, targetCompletion };
    
    if (score >= 90) {
        scoreElement.textContent = '优秀';
        scoreElement.className = 'px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800';
    } else if (score >= 80) {
        scoreElement.textContent = '良好';
        scoreElement.className = 'px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800';
    } else if (score >= 70) {
        scoreElement.textContent = '一般';
        scoreElement.className = 'px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800';
    } else {
        scoreElement.textContent = '待改善';
        scoreElement.className = 'px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800';
    }
}

// 渲染绩效评估图表
function renderPerformanceChart(data, retryCount = 0) {
    console.log('[indicators_management] renderPerformanceChart called, retry:', retryCount);
    
    if (performanceChart) {
        performanceChart.dispose();
    }
    
    const chartContainer = document.getElementById('performance-evaluation-chart');
    if (!chartContainer) {
        console.error('绩效评估图表容器未找到');
        return;
    }
    
    if (chartContainer.offsetWidth === 0 || chartContainer.offsetHeight === 0) {
        if (retryCount < 10) {
            console.warn(`绩效图表容器不可见，延迟重试 (${retryCount + 1}/10)`);
            setTimeout(() => renderPerformanceChart(data, retryCount + 1), 200);
            return;
        } else {
            console.error('绩效图表容器始终不可见，停止重试');
            return;
        }
    }
    
    console.log(`绩效图表容器尺寸: ${chartContainer.offsetWidth}x${chartContainer.offsetHeight}`);
    console.log('绩效图表数据:', data);
    console.log('绩效图表数据类型:', typeof data);
    console.log('绩效图表indicators:', data?.indicators);
    console.log('绩效图表data字段:', data?.data);
    
    try {
        performanceChart = echarts.init(chartContainer);
        console.log('绩效评估图表初始化成功');
    } catch (error) {
        console.error('绩效图表初始化失败:', error);
        return;
    }
    
    const option = {
        tooltip: {
            trigger: 'axis'
        },
        radar: {
            indicator: data?.indicators || [
                { name: '故障解决效率', max: 100 },
                { name: '系统稳定性', max: 100 },
                { name: '主动发现能力', max: 100 },
                { name: '用户满意度', max: 100 },
                { name: '运营效率', max: 100 }
            ]
        },
        series: [{
            name: '绩效评估',
            type: 'radar',
            data: [{
                value: data?.data || [75, 80, 65, 70, 68], // 使用传入的数据或默认值
                name: '当前绩效'
            }]
        }]
    };
    
    console.log('绩效评估图表配置:', option);
    performanceChart.setOption(option);
    console.log('绩效评估图表渲染完成，图表实例:', performanceChart);
    
    // 验证图表是否正确渲染
    setTimeout(() => {
        if (performanceChart) {
            console.log('绩效图表状态检查 - 容器DOM:', chartContainer);
            console.log('绩效图表状态检查 - 图表实例存在:', !!performanceChart);
        }
    }, 500);
}

// 加载仪表盘数据
function loadDashboardData() {
    console.log('[indicators_management] loadDashboardData');
    
    // 获取当前仪表盘类型
    const currentParams = window.currentEvaluationParams || {};
    const dashboardType = currentParams.dashboardType || 'comprehensive';
    
    fetch('/fault/api/indicators/dashboard')
        .then(response => response.json())
        .then(data => {
            console.log('仪表盘API响应:', data);
            if (data.dashboard_type || data.success) { // API直接返回数据
                const responseData = data.success ? data.data : data;
                
                // 生成实时监控图表数据（基于仪表盘类型）
                const dashboardData = generateDashboardChartData(responseData, dashboardType);
                console.log('生成的仪表盘数据:', dashboardData);
                renderRealtimeDashboard(dashboardData);
            }
        })
        .catch(error => console.error('加载仪表盘数据失败:', error));
}

// 处理仪表盘类型变化
function handleDashboardTypeChange(type) {
    console.log('[indicators_management] 仪表盘类型变更:', type);
    
    // 更新当前参数
    if (window.currentEvaluationParams) {
        window.currentEvaluationParams.dashboardType = type;
    }
    
    // 重新加载仪表盘数据
    fetch('/fault/api/indicators/dashboard')
        .then(response => response.json())
        .then(data => {
            console.log('仪表盘类型变更API响应:', data);
            if (data.dashboard_type || data.success) {
                const responseData = data.success ? data.data : data;
                
                // 根据新类型生成数据
                const dashboardData = generateDashboardChartData(responseData, type);
                renderRealtimeDashboard(dashboardData);
                
                // 显示变更提示
                const typeNames = {
                    'comprehensive': '综合仪表盘',
                    'fault_focused': '故障聚焦仪表盘',
                    'performance_focused': '性能聚焦仪表盘',
                    'custom': '自定义仪表盘'
                };
                
                showNotification(`已切换到${typeNames[type] || '未知类型'}`, 'success');
            }
        })
        .catch(error => {
            console.error('加载仪表盘类型数据失败:', error);
            showNotification('切换仪表盘类型失败，请稍后重试', 'error');
        });
}

// 从仪表盘API数据生成图表数据
function generateDashboardChartData(data, dashboardType = 'comprehensive') {
    console.log('[indicators_management] generateDashboardChartData type:', dashboardType);
    
    const trends = data.key_trends?.fault_volume_trend || {};
    const times = [];
    let values = [];
    
    // 生成过去7天的日期
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        times.push(date.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' }));
    }
    
    // 根据仪表盘类型生成不同的数据
    switch(dashboardType) {
        case 'fault_focused': // 故障聚焦 - 显示故障相关数据
            values = times.map(() => {
                const baseValue = Math.floor(Math.random() * 15) + 5; // 5-20故障
                return {
                    severe: Math.floor(Math.random() * 5) + 1,      // 严重故障1-6个
                    normal: baseValue - Math.floor(Math.random() * 3), // 一般故障
                    resolved: baseValue + Math.floor(Math.random() * 5) // 已解决数量
                };
            });
            break;
            
        case 'performance_focused': // 性能聚焦 - 显示性能指标
            values = times.map(() => {
                return {
                    response_time: Math.floor(Math.random() * 100) + 80,  // 响应时间80-180ms
                    cpu_usage: Math.floor(Math.random() * 40) + 30,       // CPU使用率30-70%
                    memory_usage: Math.floor(Math.random() * 35) + 45,    // 内存使用率45-80%
                    throughput: Math.floor(Math.random() * 500) + 200     // 吞吐量200-700
                };
            });
            break;
            
        case 'custom': // 自定义仪表盘
            values = times.map(() => {
                return {
                    metric1: Math.floor(Math.random() * 50) + 25,
                    metric2: Math.floor(Math.random() * 80) + 40,
                    metric3: Math.floor(Math.random() * 100) + 50
                };
            });
            break;
            
        case 'comprehensive': // 综合仪表盘 - 原有逻辑
        default:
            // 转换趋势数据为时间序列
            if (Object.keys(trends).length > 0) {
                Object.keys(trends).sort().slice(-7).forEach(date => {
                    values.push(trends[date].total_count || 0);
                });
            } else {
                // 如果没有真实数据，生成模拟数据
                values = times.map(() => Math.floor(Math.random() * 25) + 5);
            }
            break;
    }
    
    const result = {
        times: times,
        values: values,
        dashboardType: dashboardType,
        realtime_data: data.realtime_data || {}
    };
    
    console.log('[indicators_management] generateDashboardChartData result:', result);
    return result;
}

// 渲染实时仪表盘
function renderRealtimeDashboard(data) {
    console.log('[indicators_management] renderRealtimeDashboard data:', data);
    
    if (realtimeDashboardChart) {
        realtimeDashboardChart.dispose();
    }
    
    const chartContainer = document.getElementById('realtime-dashboard-chart');
    if (!chartContainer || chartContainer.offsetWidth === 0) {
        setTimeout(() => renderRealtimeDashboard(data), 100);
        return;
    }
    
    realtimeDashboardChart = echarts.init(chartContainer);
    
    // 根据仪表盘类型生成不同的图表配置
    let option = {
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: []
        },
        xAxis: {
            type: 'category',
            data: data?.times || []
        },
        yAxis: {
            type: 'value'
        },
        series: []
    };
    
    // 根据仪表盘类型配置不同的系列
    const dashboardType = data?.dashboardType || 'comprehensive';
    
    switch(dashboardType) {
        case 'fault_focused': // 故障聚焦
            option.legend.data = ['严重故障', '一般故障', '已解决'];
            option.series = [
                {
                    name: '严重故障',
                    type: 'bar',
                    data: data?.values?.map(v => v.severe) || [],
                    itemStyle: { color: '#ef4444' }
                },
                {
                    name: '一般故障', 
                    type: 'bar',
                    data: data?.values?.map(v => v.normal) || [],
                    itemStyle: { color: '#f59e0b' }
                },
                {
                    name: '已解决',
                    type: 'line',
                    data: data?.values?.map(v => v.resolved) || [],
                    smooth: true,
                    itemStyle: { color: '#10b981' }
                }
            ];
            break;
            
        case 'performance_focused': // 性能聚焦
            option.legend.data = ['响应时间', 'CPU使用率', '内存使用率'];
            option.yAxis = [
                { type: 'value', name: '时间(ms)', position: 'left' },
                { type: 'value', name: '使用率(%)', position: 'right' }
            ];
            option.series = [
                {
                    name: '响应时间',
                    type: 'line',
                    yAxisIndex: 0,
                    data: data?.values?.map(v => v.response_time) || [],
                    smooth: true,
                    itemStyle: { color: '#3b82f6' }
                },
                {
                    name: 'CPU使用率',
                    type: 'bar',
                    yAxisIndex: 1,
                    data: data?.values?.map(v => v.cpu_usage) || [],
                    itemStyle: { color: '#8b5cf6' }
                },
                {
                    name: '内存使用率',
                    type: 'bar',
                    yAxisIndex: 1,
                    data: data?.values?.map(v => v.memory_usage) || [],
                    itemStyle: { color: '#06b6d4' }
                }
            ];
            break;
            
        case 'custom': // 自定义
            option.legend.data = ['指标1', '指标2', '指标3'];
            option.series = [
                {
                    name: '指标1',
                    type: 'line',
                    data: data?.values?.map(v => v.metric1) || [],
                    smooth: true,
                    itemStyle: { color: '#f59e0b' }
                },
                {
                    name: '指标2',
                    type: 'bar',
                    data: data?.values?.map(v => v.metric2) || [],
                    itemStyle: { color: '#8b5cf6' }
                },
                {
                    name: '指标3',
                    type: 'line',
                    data: data?.values?.map(v => v.metric3) || [],
                    smooth: true,
                    itemStyle: { color: '#10b981' }
                }
            ];
            break;
            
        case 'comprehensive': // 综合仪表盘
        default:
            option.legend.data = ['故障数量'];
            option.series = [{
                name: '故障数量',
                type: 'line',
                data: data?.values || [],
                smooth: true,
                itemStyle: { color: '#3b82f6' },
                areaStyle: { opacity: 0.3 }
            }];
            break;
    }
    
    realtimeDashboardChart.setOption(option);
    console.log('实时仪表盘图表渲染完成，类型:', dashboardType);
}

// 加载目标数据
function loadTargetsData() {
    console.log('[indicators_management] loadTargetsData');
    
    // 由于目标管理API是POST方法，这里生成模拟数据
    const mockTargetsData = generateMockTargetsData();
    console.log('生成的目标数据:', mockTargetsData);
    renderTargetsProgress(mockTargetsData);
}

// 生成模拟目标进度数据
function generateMockTargetsData() {
    return {
        categories: ['故障解决时间', '系统可用性', '主动发现率', '客户满意度'],
        targets: [4, 99.5, 70, 85],
        actuals: [5.74, 95.2, 55.26, 75]
    };
}

// 渲染目标进度图表
function renderTargetsProgress(data) {
    if (targetsProgressChart) {
        targetsProgressChart.dispose();
    }
    
    const chartContainer = document.getElementById('targets-progress-chart');
    if (!chartContainer || chartContainer.offsetWidth === 0) {
        setTimeout(() => renderTargetsProgress(data), 100);
        return;
    }
    
    targetsProgressChart = echarts.init(chartContainer);
    
    const option = {
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['目标值', '实际值']
        },
        xAxis: {
            type: 'category',
            data: data?.categories || ['故障解决时间', '系统可用性', '主动发现率', '客户满意度']
        },
        yAxis: {
            type: 'value'
        },
        series: [
            {
                name: '目标值',
                type: 'bar',
                data: data?.targets || [4, 99.9, 80, 90],
                itemStyle: { color: '#10b981' }
            },
            {
                name: '实际值',
                type: 'bar',
                data: data?.actuals || [3.5, 99.5, 85, 88],
                itemStyle: { color: '#3b82f6' }
            }
        ]
    };
    
    targetsProgressChart.setOption(option);
    console.log('目标进度图表渲染完成');
}

// 刷新数据
function refreshData() {
    loadIndicatorsData();
    loadPerformanceData();
    loadDashboardData();
    loadTargetsData();
}

// 全局图表自适应
function resizeAllCharts() {
    [indicatorsTrendChart, indicatorsDistributionChart, performanceChart, realtimeDashboardChart, targetsProgressChart]
        .forEach(chart => {
            if (chart) {
                try {
                    chart.resize();
                } catch(e) {
                    console.warn('Chart resize failed:', e);
                }
            }
        });
}

// 窗口尺寸变化时全局自适应
window.addEventListener('resize', resizeAllCharts);

// 页面离开时清理
window.addEventListener('beforeunload', function() {
    [indicatorsTrendChart, indicatorsDistributionChart, performanceChart, realtimeDashboardChart, targetsProgressChart]
        .forEach(chart => {
            if (chart) {
                try {
                    chart.dispose();
                } catch(e) {}
            }
        });
});

// 目标设置表单提交
document.getElementById('targets-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    console.log('[indicators_management] 表单提交开始');
    
    const formData = new FormData(this);
    const targets = {};
    
    // 收集表单数据
    for (let [key, value] of formData.entries()) {
        targets[key] = parseFloat(value) || value; // 尝试转换为数字
        console.log(`表单字段 ${key}:`, value);
    }
    
    console.log('准备发送的目标数据:', targets);
    
    // 验证必填字段
    const requiredFields = ['resolution_time_target', 'availability_target', 'proactive_discovery_target', 'customer_satisfaction_target'];
    const missingFields = requiredFields.filter(field => !targets[field]);
    
    if (missingFields.length > 0) {
        showNotification(`请填写以下必填字段: ${missingFields.join(', ')}`, 'error');
        return;
    }
    
    // 禁用提交按钮防止重复提交
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = '保存中...';
    
    fetch('/fault/api/indicators/targets', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(targets)
    })
    .then(response => {
        console.log('API响应状态:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('保存目标设置API响应:', data);
        if (data.success) {
            showNotification('目标设置已成功保存！', 'success');
            loadTargetsData(); // 重新加载目标数据
            
            // 清空表单
            this.reset();
        } else {
            showNotification('保存失败: ' + (data.message || '服务器返回错误'), 'error');
        }
    })
    .catch(error => {
        console.error('保存目标设置失败:', error);
        if (error.message.includes('Failed to fetch')) {
            showNotification('网络错误，请检查网络连接后重试', 'error');
        } else if (error.message.includes('HTTP error')) {
            showNotification('服务器错误，请稍后重试或联系管理员', 'error');
        } else {
            showNotification('保存失败，请重试', 'error');
        }
    })
    .finally(() => {
        // 恢复提交按钮状态
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    });
});
</script>
{% endblock %}