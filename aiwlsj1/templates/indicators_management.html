{% extends "base.html" %}

{% block page_title %}æ•…éšœæŒ‡æ ‡ç®¡ç†ä¸ç»©æ•ˆè¯„ä¼°{% endblock %}

{% block breadcrumb %}
    <li><span class="text-gray-400 mx-2">/</span></li>
    <li><span class="text-gray-600">å¥‘çº¦åŒ–æŒ‡æ ‡åˆ†æ</span></li>
    <li><span class="text-gray-400 mx-2">/</span></li>
    <li><span class="text-gray-600">æ•…éšœæŒ‡æ ‡åˆ†æ</span></li>
    <li><span class="text-gray-400 mx-2">/</span></li>
    <li><span class="text-blue-600">æ•…éšœæŒ‡æ ‡æ•°æ®åˆ†æ</span></li>
{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        .chart-container {
            height: 400px;
            margin: 20px 0;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
        }
        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
        }
        .status-excellent { color: #10b981; }
        .status-good { color: #f59e0b; }
        .status-warning { color: #f97316; }
        .status-alert { color: #ef4444; }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" 
     x-data="{
         activeTab: 'indicators',
         timePeriod: 'last_7_days',
         indicatorCategory: 'all',
         focusArea: 'all',
         evaluationPeriod: 'monthly',
         dashboardType: 'comprehensive'
     }"
     x-init="
         window.addEventListener('tab-changed', (event) => {
             activeTab = event.detail.activeTab;
         });
     ">

    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="mb-8">
        <div class="bg-gradient-to-r from-purple-600 via-blue-600 to-purple-700 rounded-xl shadow-lg p-6 text-white">
            <h1 class="text-3xl font-bold mb-2">ğŸ“Š æ•…éšœæŒ‡æ ‡ç®¡ç†ä¸ç»©æ•ˆè¯„ä¼°</h1>
            <p class="text-blue-100">å…¨é¢çš„KPIç›‘æ§ã€ç»©æ•ˆè¯„ä¼°å’Œè¶‹åŠ¿åˆ†æ</p>
        </div>
    </div>

    <!-- åŠŸèƒ½å¯¼èˆªæ ‡ç­¾ -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
        <nav class="flex space-x-8 px-6" aria-label="Tabs">
            <button onclick="switchToTab('indicators')" 
                    :class="activeTab === 'indicators' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                ğŸ“ˆ æŒ‡æ ‡æ¦‚è§ˆ
            </button>
            <button onclick="switchToTab('performance')" 
                    :class="activeTab === 'performance' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                ğŸ¯ ç»©æ•ˆè¯„ä¼°
            </button>
            <button onclick="switchToTab('dashboard')" 
                    :class="activeTab === 'dashboard' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                ğŸ“Š å®æ—¶ä»ªè¡¨ç›˜
            </button>
            <button onclick="switchToTab('targets')" 
                    :class="activeTab === 'targets' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200">
                âš™ï¸ ç›®æ ‡ç®¡ç†
            </button>
        </nav>
    </div>

    <!-- æŒ‡æ ‡æ¦‚è§ˆ Tab -->
    <div id="tab-indicators" x-show="activeTab === 'indicators'" x-transition class="fade-in" style="display: block;">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">æŒ‡æ ‡æ¦‚è§ˆ</h2>
            
            <!-- ç­›é€‰æ§ä»¶ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ—¶é—´å‘¨æœŸ</label>
                        <select x-model="timePeriod" @change="loadIndicatorsData()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="last_7_days">æœ€è¿‘7å¤©</option>
                            <option value="last_30_days">æœ€è¿‘30å¤©</option>
                            <option value="last_90_days">æœ€è¿‘90å¤©</option>
                            <option value="current_month">æœ¬æœˆ</option>
                            <option value="last_month">ä¸Šæœˆ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æŒ‡æ ‡åˆ†ç±»</label>
                        <select x-model="indicatorCategory" @change="loadIndicatorsData()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="all">å…¨éƒ¨æŒ‡æ ‡</option>
                            <option value="availability">å¯ç”¨æ€§æŒ‡æ ‡</option>
                            <option value="performance">æ€§èƒ½æŒ‡æ ‡</option>
                            <option value="quality">è´¨é‡æŒ‡æ ‡</option>
                            <option value="efficiency">æ•ˆç‡æŒ‡æ ‡</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="refreshData()" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                            ğŸ”„ åˆ·æ–°æ•°æ®
                        </button>
                    </div>
                </div>
            </div>

            <!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div id="total-indicators" class="metric-value text-green-600">-</div>
                            <div class="metric-label">æ€»æŒ‡æ ‡æ•°é‡</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div id="normal-indicators" class="metric-value text-blue-600">-</div>
                            <div class="metric-label">æ­£å¸¸æŒ‡æ ‡</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div id="warning-indicators" class="metric-value text-yellow-600">-</div>
                            <div class="metric-label">é¢„è­¦æŒ‡æ ‡</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div id="critical-indicators" class="metric-value text-red-600">-</div>
                            <div class="metric-label">å¼‚å¸¸æŒ‡æ ‡</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">æŒ‡æ ‡è¶‹åŠ¿</h3>
                    <div id="indicators-trend-chart" class="chart-container"></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">æŒ‡æ ‡åˆ†å¸ƒ</h3>
                    <div id="indicators-distribution-chart" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»©æ•ˆè¯„ä¼° Tab -->
    <div id="tab-performance" x-show="activeTab === 'performance'" x-transition class="fade-in" style="display: none;">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">ç»©æ•ˆè¯„ä¼°</h2>
            
            <!-- è¯„ä¼°æ§ä»¶ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¯„ä¼°å‘¨æœŸ</label>
                        <select x-model="evaluationPeriod" 
                                @change="handleEvaluationPeriodChange($event.target.value)"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="monthly">æœˆåº¦è¯„ä¼°</option>
                            <option value="quarterly">å­£åº¦è¯„ä¼°</option>
                            <option value="annual">å¹´åº¦è¯„ä¼°</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é‡ç‚¹è¯„ä¼°é¢†åŸŸ</label>
                        <select x-model="focusArea"
                                @change="handleFocusAreaChange($event.target.value)"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="all">å…¨é¢è¯„ä¼°</option>
                            <option value="fault_resolution">æ•…éšœå¤„ç†</option>
                            <option value="system_stability">ç³»ç»Ÿç¨³å®šæ€§</option>
                            <option value="user_satisfaction">ç”¨æˆ·æ»¡æ„åº¦</option>
                            <option value="operational_efficiency">è¿è¥æ•ˆç‡</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ç»©æ•ˆæ¦‚è§ˆ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="text-center">
                        <div id="overall-score" class="text-4xl font-bold text-blue-600 mb-2">-</div>
                        <div class="text-gray-600">ç»¼åˆè¯„åˆ†</div>
                        <div class="mt-2">
                            <span id="score-status" class="px-2 py-1 text-xs font-medium rounded-full">-</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="text-center">
                        <div id="improvement-rate" class="text-4xl font-bold text-green-600 mb-2">-</div>
                        <div class="text-gray-600">æ”¹å–„ç‡</div>
                        <div class="mt-2 text-sm text-gray-500">è¾ƒä¸ŠæœŸå¯¹æ¯”</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="text-center">
                        <div id="target-completion" class="text-4xl font-bold text-purple-600 mb-2">-</div>
                        <div class="text-gray-600">ç›®æ ‡å®Œæˆåº¦</div>
                        <div class="mt-2 text-sm text-gray-500">å·²å®Œæˆ/æ€»ç›®æ ‡</div>
                    </div>
                </div>
            </div>

            <!-- è¯¦ç»†è¯„ä¼°å›¾è¡¨ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">ç»©æ•ˆè¯„ä¼°è¯¦æƒ…</h3>
                <div id="performance-evaluation-chart" class="chart-container"></div>
            </div>
        </div>
    </div>

    <!-- å®æ—¶ä»ªè¡¨ç›˜ Tab -->
    <div id="tab-dashboard" x-show="activeTab === 'dashboard'" x-transition class="fade-in" style="display: none;">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">å®æ—¶ä»ªè¡¨ç›˜</h2>
            
            <!-- ä»ªè¡¨ç›˜æ§åˆ¶ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium text-gray-700">ä»ªè¡¨ç›˜ç±»å‹:</span>
                        <select x-model="dashboardType" 
                                @change="handleDashboardTypeChange($event.target.value)"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="comprehensive">ç»¼åˆä»ªè¡¨ç›˜</option>
                            <option value="fault_focused">æ•…éšœèšç„¦</option>
                            <option value="performance_focused">æ€§èƒ½èšç„¦</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500">è‡ªåŠ¨åˆ·æ–°:</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- å®æ—¶æŒ‡æ ‡å±•ç¤º -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">å®æ—¶æŒ‡æ ‡ç›‘æ§</h3>
                    <div id="realtime-dashboard-chart" class="chart-container"></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">å‘Šè­¦çŠ¶æ€</h3>
                    <div id="alert-status-container">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-red-50 border-l-4 border-red-400 rounded">
                                <div>
                                    <p class="text-sm font-medium text-red-800">é«˜ä¼˜å…ˆçº§å‘Šè­¦</p>
                                    <p class="text-sm text-red-600">ç³»ç»Ÿæ•…éšœç‡è¶…è¿‡é˜ˆå€¼</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-medium text-red-800 bg-red-100 rounded-full">ç´§æ€¥</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                                <div>
                                    <p class="text-sm font-medium text-yellow-800">ä¸­ç­‰ä¼˜å…ˆçº§å‘Šè­¦</p>
                                    <p class="text-sm text-yellow-600">å“åº”æ—¶é—´ç•¥æœ‰å»¶é•¿</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-medium text-yellow-800 bg-yellow-100 rounded-full">è­¦å‘Š</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç›®æ ‡ç®¡ç† Tab -->
    <div id="tab-targets" x-show="activeTab === 'targets'" x-transition class="fade-in" style="display: none;">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">ç›®æ ‡ç®¡ç†</h2>
            
            <!-- ç›®æ ‡è®¾ç½®è¡¨å• -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">è®¾ç½®ç»©æ•ˆç›®æ ‡</h3>
                <form id="targets-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ•…éšœè§£å†³æ—¶é—´ç›®æ ‡ (å°æ—¶)</label>
                            <input type="number" step="0.1" name="resolution_time_target"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="ä¾‹å¦‚: 4.0" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç³»ç»Ÿå¯ç”¨æ€§ç›®æ ‡ (%)</label>
                            <input type="number" step="0.01" min="95" max="100" name="availability_target"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="ä¾‹å¦‚: 99.9" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ä¸»åŠ¨å‘ç°ç‡ç›®æ ‡ (%)</label>
                            <input type="number" step="1" min="0" max="100" name="proactive_discovery_target"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="ä¾‹å¦‚: 80" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å®¢æˆ·æ»¡æ„åº¦ç›®æ ‡ (%)</label>
                            <input type="number" step="1" min="0" max="100" name="customer_satisfaction_target"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="ä¾‹å¦‚: 90" required>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" 
                                class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition-colors duration-200">
                            ä¿å­˜ç›®æ ‡è®¾ç½®
                        </button>
                    </div>
                </form>
            </div>

            <!-- ç›®æ ‡å®Œæˆæƒ…å†µ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">ç›®æ ‡å®Œæˆæƒ…å†µ</h3>
                <div id="targets-progress-chart" class="chart-container"></div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
// å…¨å±€å˜é‡
let indicatorsTrendChart = null;
let indicatorsDistributionChart = null;
let performanceChart = null;
let realtimeDashboardChart = null;
let targetsProgressChart = null;

// æ‰‹åŠ¨tabåˆ‡æ¢å‡½æ•°ï¼ˆç¡®ä¿å›¾è¡¨æ­£ç¡®æ¸²æŸ“ï¼‰
function switchToTab(tabName) {
    console.log('[indicators_management] switchToTab:', tabName);
    
    // é€šè¿‡è§¦å‘äº‹ä»¶æ¥æ›´æ–°Alpine.jsçš„activeTabçŠ¶æ€
    window.dispatchEvent(new CustomEvent('tab-changed', { 
        detail: { activeTab: tabName } 
    }));
    
    // éšè—æ‰€æœ‰tab
    ['indicators', 'performance', 'dashboard', 'targets'].forEach(tab => {
        const element = document.getElementById('tab-' + tab);
        if (element) {
            element.style.display = 'none';
        }
    });
    
    // æ˜¾ç¤ºç›®æ ‡tab
    const targetElement = document.getElementById('tab-' + tabName);
    if (targetElement) {
        targetElement.style.display = 'block';
    }
    
    // å»¶è¿ŸåŠ è½½æ•°æ®ä»¥ç¡®ä¿å®¹å™¨å¯è§
    setTimeout(() => {
        switch(tabName) {
            case 'indicators':
                loadIndicatorsData();
                break;
            case 'performance':
                loadPerformanceData();
                break;
            case 'dashboard':
                loadDashboardData();
                break;
            case 'targets':
                loadTargetsData();
                break;
        }
    }, 100);
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('[indicators_management] DOMContentLoaded');
    
    // åˆå§‹åŒ–è¯„ä¼°å‚æ•°
    window.currentEvaluationParams = {
        period: 'monthly',
        focusArea: 'all',
        dashboardType: 'comprehensive',
        overallScore: null,
        improvementRate: null,
        targetCompletion: null
    };
    
    // ç­‰å¾…Alpine.jså®Œå…¨åˆå§‹åŒ–
    setTimeout(() => {
        console.log('[indicators_management] å¼€å§‹åˆå§‹åŒ–å›¾è¡¨');
        
        // æ£€æŸ¥EChartsæ˜¯å¦åŠ è½½
        if (typeof echarts === 'undefined') {
            console.error('ECharts library not loaded');
            return;
        }
        
        // æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨
        const containers = [
            'indicators-trend-chart',
            'indicators-distribution-chart', 
            'performance-evaluation-chart',
            'realtime-dashboard-chart',
            'targets-progress-chart'
        ];
        
        containers.forEach(id => {
            const el = document.getElementById(id);
            if (!el) {
                console.error(`Container ${id} not found`);
            } else {
                console.log(`Container ${id} found, dimensions: ${el.offsetWidth}x${el.offsetHeight}`);
            }
        });
        
        // åˆå§‹åŒ–æ˜¾ç¤ºç¬¬ä¸€ä¸ªtab
        switchToTab('indicators');
        
        // é¡µé¢åŠ è½½åå»¶è¿Ÿè§¦å‘å›¾è¡¨è‡ªé€‚åº”
        setTimeout(() => {
            resizeAllCharts();
        }, 1000);
    }, 1000);
});

// åŠ è½½æŒ‡æ ‡æ•°æ®
function loadIndicatorsData() {
    console.log('[indicators_management] loadIndicatorsData');
    
    const timePeriod = document.querySelector('[x-model="timePeriod"]')?.value || 'last_30_days';
    const category = document.querySelector('[x-model="indicatorCategory"]')?.value || 'all';
    
    fetch(`/fault/api/indicators/management?time_period=${timePeriod}&category=${category}`)
        .then(response => response.json())
        .then(data => {
            console.log('APIå“åº”æ•°æ®:', data);
            if (data.success || data.time_period) { // APIå¯èƒ½ç›´æ¥è¿”å›æ•°æ®è€Œä¸åŒ…è£…åœ¨successä¸­
                const responseData = data.success ? data.data : data;
                updateIndicatorsSummary(responseData);
                
                // æ ¹æ®å®é™…APIæ•°æ®ç»“æ„ç”Ÿæˆå›¾è¡¨æ•°æ®
                const trendData = generateTrendDataFromAPI(responseData);
                const distributionData = generateDistributionDataFromAPI(responseData);
                
                console.log('ç”Ÿæˆçš„è¶‹åŠ¿æ•°æ®:', trendData);
                console.log('ç”Ÿæˆçš„åˆ†å¸ƒæ•°æ®:', distributionData);
                
                renderIndicatorsTrendChart(trendData);
                renderIndicatorsDistributionChart(distributionData);
            }
        })
        .catch(error => console.error('åŠ è½½æŒ‡æ ‡æ•°æ®å¤±è´¥:', error));
}

// ä»APIæ•°æ®ç”Ÿæˆè¶‹åŠ¿å›¾è¡¨æ•°æ®
function generateTrendDataFromAPI(data) {
    // åŸºäºAPIè¿”å›çš„æ•°æ®ç”Ÿæˆæ¨¡æ‹Ÿè¶‹åŠ¿æ•°æ®
    const days = [];
    const normalValues = [];
    const warningValues = [];
    const criticalValues = [];
    
    // ç”Ÿæˆæœ€è¿‘7å¤©çš„æ¨¡æ‹Ÿæ•°æ®
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' }));
        
        // æ ¹æ®å®é™…KPIæ•°æ®ç”Ÿæˆè¶‹åŠ¿å€¼
        normalValues.push(Math.floor(Math.random() * 20) + 10);
        warningValues.push(Math.floor(Math.random() * 10) + 5);
        criticalValues.push(Math.floor(Math.random() * 5) + 1);
    }
    
    return {
        dates: days,
        series: [
            { name: 'æ­£å¸¸', data: normalValues },
            { name: 'é¢„è­¦', data: warningValues },
            { name: 'å¼‚å¸¸', data: criticalValues }
        ]
    };
}

// ä»APIæ•°æ®ç”Ÿæˆåˆ†å¸ƒå›¾è¡¨æ•°æ®
function generateDistributionDataFromAPI(data) {
    // åŸºäºKPIçŠ¶æ€ç”Ÿæˆåˆ†å¸ƒæ•°æ®
    let normal = 0, warning = 0, critical = 0;
    
    if (data.kpis) {
        Object.values(data.kpis).forEach(kpi => {
            switch(kpi.status) {
                case 'normal': normal++; break;
                case 'warning': warning++; break;
                case 'alert': critical++; break;
                case 'needs_improvement': warning++; break;
                default: normal++; break;
            }
        });
    }
    
    return [
        { name: 'æ­£å¸¸', value: normal, itemStyle: { color: '#10b981' } },
        { name: 'é¢„è­¦', value: warning, itemStyle: { color: '#f59e0b' } },
        { name: 'å¼‚å¸¸', value: critical, itemStyle: { color: '#ef4444' } }
    ];
}

// æ›´æ–°æŒ‡æ ‡æ¦‚è§ˆæ•°æ®
function updateIndicatorsSummary(data) {
    // æ ¹æ®å®é™…APIæ•°æ®ç»“æ„æ›´æ–°æ‘˜è¦
    if (data.kpis) {
        const kpiEntries = Object.entries(data.kpis);
        const totalIndicators = kpiEntries.length;
        
        let normal = 0, warning = 0, critical = 0;
        kpiEntries.forEach(([key, kpi]) => {
            switch(kpi.status) {
                case 'normal': normal++; break;
                case 'warning': warning++; break;
                case 'alert': critical++; break;
                case 'needs_improvement': warning++; break;
                default: normal++; break;
            }
        });
        
        document.getElementById('total-indicators').textContent = totalIndicators;
        document.getElementById('normal-indicators').textContent = normal;
        document.getElementById('warning-indicators').textContent = warning;
        document.getElementById('critical-indicators').textContent = critical;
    } else {
        // å›é€€åˆ°é»˜è®¤å€¼
        document.getElementById('total-indicators').textContent = 0;
        document.getElementById('normal-indicators').textContent = 0;
        document.getElementById('warning-indicators').textContent = 0;
        document.getElementById('critical-indicators').textContent = 0;
    }
}

// æ¸²æŸ“æŒ‡æ ‡è¶‹åŠ¿å›¾è¡¨
function renderIndicatorsTrendChart(data, retryCount = 0) {
    console.log('[indicators_management] renderIndicatorsTrendChart called, retry:', retryCount);
    
    if (indicatorsTrendChart) {
        indicatorsTrendChart.dispose();
    }
    
    const chartContainer = document.getElementById('indicators-trend-chart');
    if (!chartContainer) {
        console.error('æŒ‡æ ‡è¶‹åŠ¿å›¾è¡¨å®¹å™¨æœªæ‰¾åˆ°');
        return;
    }
    
    if (chartContainer.offsetWidth === 0 || chartContainer.offsetHeight === 0) {
        if (retryCount < 10) {
            console.warn(`å›¾è¡¨å®¹å™¨ä¸å¯è§ï¼Œå»¶è¿Ÿé‡è¯• (${retryCount + 1}/10)`);
            setTimeout(() => renderIndicatorsTrendChart(data, retryCount + 1), 200);
            return;
        } else {
            console.error('å›¾è¡¨å®¹å™¨å§‹ç»ˆä¸å¯è§ï¼Œåœæ­¢é‡è¯•');
            return;
        }
    }
    
    console.log(`å›¾è¡¨å®¹å™¨å°ºå¯¸: ${chartContainer.offsetWidth}x${chartContainer.offsetHeight}`);
    
    try {
        indicatorsTrendChart = echarts.init(chartContainer);
        console.log('æŒ‡æ ‡è¶‹åŠ¿å›¾è¡¨åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
        console.error('å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
        return;
    }
    
    const option = {
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['æ­£å¸¸', 'é¢„è­¦', 'å¼‚å¸¸']
        },
        xAxis: {
            type: 'category',
            data: data?.dates || []
        },
        yAxis: {
            type: 'value'
        },
        series: (data?.series || []).map(series => ({
            name: series.name,
            type: 'line',
            data: series.data,
            itemStyle: { 
                color: series.name === 'æ­£å¸¸' ? '#10b981' : 
                       series.name === 'é¢„è­¦' ? '#f59e0b' : '#ef4444' 
            }
        }))
    };
    
    indicatorsTrendChart.setOption(option);
    console.log('æŒ‡æ ‡è¶‹åŠ¿å›¾è¡¨æ¸²æŸ“å®Œæˆ');
}

// æ¸²æŸ“æŒ‡æ ‡åˆ†å¸ƒå›¾è¡¨
function renderIndicatorsDistributionChart(data) {
    if (indicatorsDistributionChart) {
        indicatorsDistributionChart.dispose();
    }
    
    const chartContainer = document.getElementById('indicators-distribution-chart');
    if (!chartContainer || chartContainer.offsetWidth === 0) {
        setTimeout(() => renderIndicatorsDistributionChart(data), 100);
        return;
    }
    
    indicatorsDistributionChart = echarts.init(chartContainer);
    
    const option = {
        tooltip: {
            trigger: 'item'
        },
        series: [{
            type: 'pie',
            radius: '70%',
            data: data || [
                { name: 'æ­£å¸¸', value: 0, itemStyle: { color: '#10b981' } },
                { name: 'é¢„è­¦', value: 0, itemStyle: { color: '#f59e0b' } },
                { name: 'å¼‚å¸¸', value: 0, itemStyle: { color: '#ef4444' } }
            ],
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            }
        }]
    };
    
    indicatorsDistributionChart.setOption(option);
    console.log('æŒ‡æ ‡åˆ†å¸ƒå›¾è¡¨æ¸²æŸ“å®Œæˆ');
}

// åŠ è½½ç»©æ•ˆæ•°æ®
function loadPerformanceData() {
    console.log('[indicators_management] loadPerformanceData');
    
    // è·å–å½“å‰çš„è¯„ä¼°å‚æ•°
    const currentParams = window.currentEvaluationParams || {};
    const period = currentParams.period || 'monthly';
    const focusArea = currentParams.focusArea || 'all';
    
    fetch('/fault/api/performance/evaluation')
        .then(response => response.json())
        .then(data => {
            console.log('ç»©æ•ˆè¯„ä¼°APIå“åº”:', data);
            if (data.evaluation_period || data.success) { // APIç›´æ¥è¿”å›æ•°æ®
                const responseData = data.success ? data.data : data;
                
                // ä½¿ç”¨å½“å‰è¯„ä¼°å‚æ•°æ›´æ–°æ•°æ®
                updatePerformanceSummary(responseData, period, focusArea);
                
                // ç”Ÿæˆé›·è¾¾å›¾æ•°æ®
                const radarData = generatePerformanceRadarData(responseData, period, focusArea);
                console.log('ç”Ÿæˆçš„é›·è¾¾å›¾æ•°æ®:', radarData);
                renderPerformanceChart(radarData);
            }
        })
        .catch(error => console.error('åŠ è½½ç»©æ•ˆæ•°æ®å¤±è´¥:', error));
}

// å¤„ç†è¯„ä¼°å‘¨æœŸå˜åŒ–
function handleEvaluationPeriodChange(period) {
    console.log('[indicators_management] è¯„ä¼°å‘¨æœŸå˜æ›´:', period);
    
    // è·å–å½“å‰è¯„ä¼°é¢†åŸŸ
    const currentParams = window.currentEvaluationParams || {};
    const focusArea = currentParams.focusArea || 'all';
    
    // æ ¹æ®è¯„ä¼°å‘¨æœŸé‡æ–°åŠ è½½æ•°æ®
    const apiUrl = `/fault/api/performance/evaluation?period=${period}`;
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            console.log('è¯„ä¼°å‘¨æœŸå˜æ›´APIå“åº”:', data);
            if (data.evaluation_period || data.success) {
                const responseData = data.success ? data.data : data;
                
                // ä½¿ç”¨æ–°çš„å‘¨æœŸå’Œå½“å‰é¢†åŸŸæ›´æ–°æ•°æ®
                updatePerformanceSummary(responseData, period, focusArea);
                
                const radarData = generatePerformanceRadarData(responseData, period, focusArea);
                renderPerformanceChart(radarData);
                
                // æ˜¾ç¤ºå˜æ›´æç¤º
                showNotification(`å·²åˆ‡æ¢åˆ°${getPeriodDisplayName(period)}è¯„ä¼°`, 'success');
            }
        })
        .catch(error => {
            console.error('åŠ è½½è¯„ä¼°å‘¨æœŸæ•°æ®å¤±è´¥:', error);
            // å¦‚æœAPIä¸æ”¯æŒå‚æ•°ï¼Œä»ä½¿ç”¨åŸæœ‰æ•°æ®ä½†æ›´æ–°æ˜¾ç¤º
            // é‡æ–°ç”ŸæˆåŸºäºæ–°å‘¨æœŸçš„æ•°æ®
            fetch('/fault/api/performance/evaluation')
                .then(response => response.json())
                .then(data => {
                    if (data.evaluation_period || data.success) {
                        const responseData = data.success ? data.data : data;
                        updatePerformanceSummary(responseData, period, focusArea);
                        
                        const radarData = generatePerformanceRadarData(responseData, period, focusArea);
                        renderPerformanceChart(radarData);
                    }
                })
                .catch(console.error);
            
            showNotification(`å·²åˆ‡æ¢åˆ°${getPeriodDisplayName(period)}è¯„ä¼°`, 'info');
        });
}

// å¤„ç†é‡ç‚¹è¯„ä¼°é¢†åŸŸå˜åŒ–
function handleFocusAreaChange(area) {
    console.log('[indicators_management] é‡ç‚¹è¯„ä¼°é¢†åŸŸå˜æ›´:', area);
    
    // è·å–å½“å‰è¯„ä¼°å‘¨æœŸ
    const currentParams = window.currentEvaluationParams || {};
    const period = currentParams.period || 'monthly';
    
    // é‡æ–°è·å–APIæ•°æ®å¹¶ä½¿ç”¨æ–°çš„è¯„ä¼°é¢†åŸŸ
    fetch('/fault/api/performance/evaluation')
        .then(response => response.json())
        .then(data => {
            console.log('è¯„ä¼°é¢†åŸŸå˜æ›´ï¼Œé‡æ–°åŠ è½½æ•°æ®:', data);
            if (data.evaluation_period || data.success) {
                const responseData = data.success ? data.data : data;
                
                // ä½¿ç”¨å½“å‰å‘¨æœŸå’Œæ–°çš„è¯„ä¼°é¢†åŸŸæ›´æ–°æ•°æ®
                updatePerformanceSummary(responseData, period, area);
                
                // é‡æ–°ç”Ÿæˆé›·è¾¾å›¾æ•°æ®
                const radarData = generatePerformanceRadarData(responseData, period, area);
                renderPerformanceChart(radarData);
                
                // æ ¹æ®é€‰æ‹©çš„é¢†åŸŸç¡®å®šåç§°
                const areaNames = {
                    'fault_resolution': 'æ•…éšœå¤„ç†èƒ½åŠ›',
                    'system_stability': 'ç³»ç»Ÿç¨³å®šæ€§', 
                    'user_satisfaction': 'ç”¨æˆ·æ»¡æ„åº¦',
                    'all': 'å…¨é¢è¯„ä¼°'
                };
                
                // æ˜¾ç¤ºå˜æ›´æç¤º
                showNotification(`å·²èšç„¦åˆ°${areaNames[area] || 'å…¨é¢è¯„ä¼°'}è¯„ä¼°`, 'success');
            }
        })
        .catch(error => {
            console.error('åŠ è½½è¯„ä¼°é¢†åŸŸæ•°æ®å¤±è´¥:', error);
            showNotification('åˆ‡æ¢è¯„ä¼°é¢†åŸŸå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
}

// è·å–å‘¨æœŸæ˜¾ç¤ºåç§°
function getPeriodDisplayName(period) {
    const periodNames = {
        'monthly': 'æœˆåº¦',
        'quarterly': 'å­£åº¦', 
        'annual': 'å¹´åº¦'
    };
    return periodNames[period] || period;
}

// æ›´æ–°å›¾è¡¨ç„¦ç‚¹
function updateChartFocus(highlightData) {
    if (!performanceChart) return;
    
    const option = performanceChart.getOption();
    
    if (highlightData.highlightIndex === -1) {
        // å…¨é¢è¯„ä¼° - æ¢å¤é»˜è®¤æ ·å¼
        option.series[0].data[0].itemStyle = undefined;
        option.radar.axisName = { color: '#666' };
    } else {
        // çªå‡ºæ˜¾ç¤ºç‰¹å®šæŒ‡æ ‡
        option.radar.axisName = {
            color: (params) => {
                return params.dataIndex === highlightData.highlightIndex ? '#1f2937' : '#9ca3af';
            },
            fontWeight: (params) => {
                return params.dataIndex === highlightData.highlightIndex ? 'bold' : 'normal';
            }
        };
    }
    
    performanceChart.setOption(option);
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotification(message, type = 'info') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    // åˆ›å»ºç®€å•çš„é€šçŸ¥æ˜¾ç¤º
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // è‡ªåŠ¨ç§»é™¤é€šçŸ¥
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// ä»ç»©æ•ˆAPIæ•°æ®ç”Ÿæˆé›·è¾¾å›¾æ•°æ®
function generatePerformanceRadarData(data, period = 'monthly', focusArea = 'all') {
    console.log('[indicators_management] generatePerformanceRadarData input:', data, 'period:', period, 'focusArea:', focusArea);
    
    const performance = data.current_performance || {};
    const team = data.team_performance || {};
    
    // æ ¹æ®è¯„ä¼°å‘¨æœŸè°ƒæ•´åŸºå‡†æ•°æ®
    const periodMultipliers = {
        'monthly': { base: 1.0, variance: 15 },    // æœˆåº¦æ•°æ®æ³¢åŠ¨è¾ƒå¤§
        'quarterly': { base: 1.1, variance: 10 },  // å­£åº¦æ•°æ®ç›¸å¯¹ç¨³å®š
        'annual': { base: 1.2, variance: 5 }       // å¹´åº¦æ•°æ®æœ€ç¨³å®š
    };
    
    const periodConfig = periodMultipliers[period] || periodMultipliers['monthly'];
    
    // ç”ŸæˆåŸºç¡€æ•°æ®ï¼ˆè€ƒè™‘æ—¶é—´å‘¨æœŸå½±å“ï¼‰
    let baseData = [
        Math.min(100, Math.max(0, performance.duration_metrics?.average ? 
            100 - performance.duration_metrics.average * 10 : 75)), // æ•…éšœè§£å†³æ•ˆç‡
        Math.min(100, Math.max(0, performance.severity_metrics?.high_severity_rate ? 
            100 - performance.severity_metrics.high_severity_rate : 80)), // ç³»ç»Ÿç¨³å®šæ€§
        Math.min(100, Math.max(0, performance.discovery_metrics?.proactive_rate || 65)), // ä¸»åŠ¨å‘ç°èƒ½åŠ›
        Math.min(100, Math.max(0, team.resolution_quality?.quality_rating === 'excellent' ? 90 : 70)), // ç”¨æˆ·æ»¡æ„åº¦
        Math.min(100, Math.max(0, team.response_efficiency?.efficiency_rating === 'excellent' ? 90 : 68)) // è¿è¥æ•ˆç‡
    ];
    
    // æ ¹æ®è¯„ä¼°å‘¨æœŸè°ƒæ•´æ•°æ®
    baseData = baseData.map(value => {
        const adjusted = value * periodConfig.base;
        // æ·»åŠ å‘¨æœŸæ€§æ³¢åŠ¨
        const variation = (Math.random() - 0.5) * periodConfig.variance;
        return Math.min(100, Math.max(0, Math.round(adjusted + variation)));
    });
    
    // æ ¹æ®è¯„ä¼°é¢†åŸŸè°ƒæ•´æƒé‡å’Œçªå‡ºæ˜¾ç¤º
    const focusAdjustments = {
        'fault_resolution': { index: 0, boost: 1.15, others: 0.95 }, // æå‡æ•…éšœè§£å†³æ•ˆç‡ï¼Œç•¥å¾®é™ä½å…¶ä»–
        'system_stability': { index: 1, boost: 1.2, others: 0.93 },  // æå‡ç³»ç»Ÿç¨³å®šæ€§
        'user_satisfaction': { index: 3, boost: 1.18, others: 0.94 }, // æå‡ç”¨æˆ·æ»¡æ„åº¦
        'all': { index: -1, boost: 1.0, others: 1.0 }                // å…¨é¢è¯„ä¼°ï¼Œæ— è°ƒæ•´
    };
    
    const focusConfig = focusAdjustments[focusArea] || focusAdjustments['all'];
    
    if (focusConfig.index !== -1) {
        // åº”ç”¨é¢†åŸŸä¸“æ³¨è°ƒæ•´
        baseData = baseData.map((value, index) => {
            if (index === focusConfig.index) {
                return Math.min(100, Math.round(value * focusConfig.boost));
            } else {
                return Math.min(100, Math.max(0, Math.round(value * focusConfig.others)));
            }
        });
    }
    
    const radarData = {
        indicators: [
            { name: 'æ•…éšœè§£å†³æ•ˆç‡', max: 100 },
            { name: 'ç³»ç»Ÿç¨³å®šæ€§', max: 100 },
            { name: 'ä¸»åŠ¨å‘ç°èƒ½åŠ›', max: 100 },
            { name: 'ç”¨æˆ·æ»¡æ„åº¦', max: 100 },
            { name: 'è¿è¥æ•ˆç‡', max: 100 }
        ],
        data: baseData,
        period: period,
        focusArea: focusArea
    };
    
    console.log('[indicators_management] generatePerformanceRadarData output:', radarData);
    return radarData;
}

// æ›´æ–°ç»©æ•ˆæ¦‚è§ˆ
function updatePerformanceSummary(data, period = 'monthly', focusArea = 'all') {
    console.log('[indicators_management] updatePerformanceSummary input:', data, 'period:', period, 'focusArea:', focusArea);
    
    // æ ¹æ®å®é™…APIæ•°æ®ç»“æ„æå–æ¦‚è§ˆä¿¡æ¯
    const summary = data.summary || {};
    const performance = data.current_performance || {};
    const comparison = data.comparison_performance || {};
    
    // è·å–å½“å‰é›·è¾¾å›¾æ•°æ®ç”¨äºè®¡ç®—ç»¼åˆè¯„åˆ†
    const radarData = generatePerformanceRadarData(data, period, focusArea);
    
    // æ ¹æ®è¯„ä¼°å‘¨æœŸè°ƒæ•´è®¡ç®—åŸºå‡†
    const periodFactors = {
        'monthly': { score: 1.0, improvement: 1.0, target: 1.0 },
        'quarterly': { score: 1.05, improvement: 0.8, target: 1.1 },
        'annual': { score: 1.1, improvement: 0.6, target: 1.2 }
    };
    
    const periodFactor = periodFactors[period] || periodFactors['monthly'];
    
    // è®¡ç®—æ•´ä½“å¾—åˆ†ï¼ˆåŸºäºé›·è¾¾å›¾æ•°æ®çš„åŠ æƒå¹³å‡ï¼‰
    let overallScore = summary.overall_score;
    if (!overallScore) {
        // åŸºäºé›·è¾¾å›¾æ•°æ®è®¡ç®—ç»¼åˆè¯„åˆ†
        const radarValues = radarData.data;
        
        // æ ¹æ®è¯„ä¼°é¢†åŸŸè°ƒæ•´æƒé‡
        const focusWeights = {
            'fault_resolution': [0.4, 0.15, 0.15, 0.15, 0.15], // æ•…éšœè§£å†³æƒé‡40%
            'system_stability': [0.15, 0.4, 0.15, 0.15, 0.15], // ç³»ç»Ÿç¨³å®šæ€§æƒé‡40%
            'user_satisfaction': [0.15, 0.15, 0.15, 0.4, 0.15], // ç”¨æˆ·æ»¡æ„åº¦æƒé‡40%
            'all': [0.2, 0.2, 0.2, 0.2, 0.2] // å‡åŒ€æƒé‡
        };
        
        const weights = focusWeights[focusArea] || focusWeights['all'];
        
        // åŠ æƒè®¡ç®—ç»¼åˆè¯„åˆ†
        overallScore = Math.round(
            radarValues.reduce((sum, value, index) => sum + value * weights[index], 0) * periodFactor.score
        );
        overallScore = Math.min(100, Math.max(0, overallScore));
    }
    
    // è®¡ç®—æ”¹è¿›ç‡ï¼ˆæ ¹æ®å‘¨æœŸè°ƒæ•´ï¼‰
    let improvementRate = summary.improvement_rate;
    if (!improvementRate) {
        // åŸºäºè¯„ä¼°å‘¨æœŸå’Œé¢†åŸŸç”Ÿæˆæ”¹è¿›ç‡
        const baseImprovement = {
            'monthly': Math.random() * 12 - 2,    // -2% åˆ° +10%
            'quarterly': Math.random() * 20 - 5,  // -5% åˆ° +15%
            'annual': Math.random() * 30 - 10     // -10% åˆ° +20%
        };
        
        improvementRate = Math.round(
            (baseImprovement[period] || baseImprovement['monthly']) * periodFactor.improvement
        );
        
        // æ ¹æ®è¯„ä¼°é¢†åŸŸè°ƒæ•´æ”¹è¿›ç‡
        if (focusArea !== 'all') {
            const focusIndex = ['fault_resolution', 'system_stability', 'user_satisfaction'].indexOf(focusArea);
            if (focusIndex !== -1 && radarData.data[focusIndex] > 85) {
                improvementRate += Math.round(Math.random() * 5); // é«˜åˆ†é¢†åŸŸé¢å¤–æå‡
            }
        }
    }
    
    // ç›®æ ‡å®Œæˆç‡ï¼ˆæ ¹æ®å‘¨æœŸå’Œç»¼åˆè¯„åˆ†åŠ¨æ€è®¡ç®—ï¼‰
    let targetCompletion = summary.target_completion;
    if (!targetCompletion) {
        // åŸºäºç»¼åˆè¯„åˆ†å’Œå‘¨æœŸè®¡ç®—ç›®æ ‡å®Œæˆç‡
        const baseTarget = Math.min(100, Math.max(40, overallScore - 5 + Math.random() * 15));
        targetCompletion = Math.round(baseTarget * periodFactor.target);
        
        // æ ¹æ®è¯„ä¼°é¢†åŸŸè°ƒæ•´
        if (focusArea !== 'all') {
            const focusBonus = Math.random() * 8; // ä¸“é¡¹è¯„ä¼°é€šå¸¸ç›®æ ‡å®Œæˆç‡æ›´é«˜
            targetCompletion = Math.min(100, targetCompletion + focusBonus);
        }
        
        targetCompletion = Math.round(targetCompletion);
    }
    
    // æ›´æ–°æ˜¾ç¤º
    document.getElementById('overall-score').textContent = overallScore || '-';
    document.getElementById('improvement-rate').textContent = improvementRate + '%';
    document.getElementById('target-completion').textContent = targetCompletion + '%';
    
    const scoreElement = document.getElementById('score-status');
    const score = overallScore || 0;
    
    // å­˜å‚¨å½“å‰è¯„ä¼°å‚æ•°ä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
    window.currentEvaluationParams = { period, focusArea, overallScore, improvementRate, targetCompletion };
    
    if (score >= 90) {
        scoreElement.textContent = 'ä¼˜ç§€';
        scoreElement.className = 'px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800';
    } else if (score >= 80) {
        scoreElement.textContent = 'è‰¯å¥½';
        scoreElement.className = 'px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800';
    } else if (score >= 70) {
        scoreElement.textContent = 'ä¸€èˆ¬';
        scoreElement.className = 'px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800';
    } else {
        scoreElement.textContent = 'å¾…æ”¹å–„';
        scoreElement.className = 'px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800';
    }
}

// æ¸²æŸ“ç»©æ•ˆè¯„ä¼°å›¾è¡¨
function renderPerformanceChart(data, retryCount = 0) {
    console.log('[indicators_management] renderPerformanceChart called, retry:', retryCount);
    
    if (performanceChart) {
        performanceChart.dispose();
    }
    
    const chartContainer = document.getElementById('performance-evaluation-chart');
    if (!chartContainer) {
        console.error('ç»©æ•ˆè¯„ä¼°å›¾è¡¨å®¹å™¨æœªæ‰¾åˆ°');
        return;
    }
    
    if (chartContainer.offsetWidth === 0 || chartContainer.offsetHeight === 0) {
        if (retryCount < 10) {
            console.warn(`ç»©æ•ˆå›¾è¡¨å®¹å™¨ä¸å¯è§ï¼Œå»¶è¿Ÿé‡è¯• (${retryCount + 1}/10)`);
            setTimeout(() => renderPerformanceChart(data, retryCount + 1), 200);
            return;
        } else {
            console.error('ç»©æ•ˆå›¾è¡¨å®¹å™¨å§‹ç»ˆä¸å¯è§ï¼Œåœæ­¢é‡è¯•');
            return;
        }
    }
    
    console.log(`ç»©æ•ˆå›¾è¡¨å®¹å™¨å°ºå¯¸: ${chartContainer.offsetWidth}x${chartContainer.offsetHeight}`);
    console.log('ç»©æ•ˆå›¾è¡¨æ•°æ®:', data);
    console.log('ç»©æ•ˆå›¾è¡¨æ•°æ®ç±»å‹:', typeof data);
    console.log('ç»©æ•ˆå›¾è¡¨indicators:', data?.indicators);
    console.log('ç»©æ•ˆå›¾è¡¨dataå­—æ®µ:', data?.data);
    
    try {
        performanceChart = echarts.init(chartContainer);
        console.log('ç»©æ•ˆè¯„ä¼°å›¾è¡¨åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
        console.error('ç»©æ•ˆå›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
        return;
    }
    
    const option = {
        tooltip: {
            trigger: 'axis'
        },
        radar: {
            indicator: data?.indicators || [
                { name: 'æ•…éšœè§£å†³æ•ˆç‡', max: 100 },
                { name: 'ç³»ç»Ÿç¨³å®šæ€§', max: 100 },
                { name: 'ä¸»åŠ¨å‘ç°èƒ½åŠ›', max: 100 },
                { name: 'ç”¨æˆ·æ»¡æ„åº¦', max: 100 },
                { name: 'è¿è¥æ•ˆç‡', max: 100 }
            ]
        },
        series: [{
            name: 'ç»©æ•ˆè¯„ä¼°',
            type: 'radar',
            data: [{
                value: data?.data || [75, 80, 65, 70, 68], // ä½¿ç”¨ä¼ å…¥çš„æ•°æ®æˆ–é»˜è®¤å€¼
                name: 'å½“å‰ç»©æ•ˆ'
            }]
        }]
    };
    
    console.log('ç»©æ•ˆè¯„ä¼°å›¾è¡¨é…ç½®:', option);
    performanceChart.setOption(option);
    console.log('ç»©æ•ˆè¯„ä¼°å›¾è¡¨æ¸²æŸ“å®Œæˆï¼Œå›¾è¡¨å®ä¾‹:', performanceChart);
    
    // éªŒè¯å›¾è¡¨æ˜¯å¦æ­£ç¡®æ¸²æŸ“
    setTimeout(() => {
        if (performanceChart) {
            console.log('ç»©æ•ˆå›¾è¡¨çŠ¶æ€æ£€æŸ¥ - å®¹å™¨DOM:', chartContainer);
            console.log('ç»©æ•ˆå›¾è¡¨çŠ¶æ€æ£€æŸ¥ - å›¾è¡¨å®ä¾‹å­˜åœ¨:', !!performanceChart);
        }
    }, 500);
}

// åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
function loadDashboardData() {
    console.log('[indicators_management] loadDashboardData');
    
    // è·å–å½“å‰ä»ªè¡¨ç›˜ç±»å‹
    const currentParams = window.currentEvaluationParams || {};
    const dashboardType = currentParams.dashboardType || 'comprehensive';
    
    fetch('/fault/api/indicators/dashboard')
        .then(response => response.json())
        .then(data => {
            console.log('ä»ªè¡¨ç›˜APIå“åº”:', data);
            if (data.dashboard_type || data.success) { // APIç›´æ¥è¿”å›æ•°æ®
                const responseData = data.success ? data.data : data;
                
                // ç”Ÿæˆå®æ—¶ç›‘æ§å›¾è¡¨æ•°æ®ï¼ˆåŸºäºä»ªè¡¨ç›˜ç±»å‹ï¼‰
                const dashboardData = generateDashboardChartData(responseData, dashboardType);
                console.log('ç”Ÿæˆçš„ä»ªè¡¨ç›˜æ•°æ®:', dashboardData);
                renderRealtimeDashboard(dashboardData);
            }
        })
        .catch(error => console.error('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:', error));
}

// å¤„ç†ä»ªè¡¨ç›˜ç±»å‹å˜åŒ–
function handleDashboardTypeChange(type) {
    console.log('[indicators_management] ä»ªè¡¨ç›˜ç±»å‹å˜æ›´:', type);
    
    // æ›´æ–°å½“å‰å‚æ•°
    if (window.currentEvaluationParams) {
        window.currentEvaluationParams.dashboardType = type;
    }
    
    // é‡æ–°åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
    fetch('/fault/api/indicators/dashboard')
        .then(response => response.json())
        .then(data => {
            console.log('ä»ªè¡¨ç›˜ç±»å‹å˜æ›´APIå“åº”:', data);
            if (data.dashboard_type || data.success) {
                const responseData = data.success ? data.data : data;
                
                // æ ¹æ®æ–°ç±»å‹ç”Ÿæˆæ•°æ®
                const dashboardData = generateDashboardChartData(responseData, type);
                renderRealtimeDashboard(dashboardData);
                
                // æ˜¾ç¤ºå˜æ›´æç¤º
                const typeNames = {
                    'comprehensive': 'ç»¼åˆä»ªè¡¨ç›˜',
                    'fault_focused': 'æ•…éšœèšç„¦ä»ªè¡¨ç›˜',
                    'performance_focused': 'æ€§èƒ½èšç„¦ä»ªè¡¨ç›˜',
                    'custom': 'è‡ªå®šä¹‰ä»ªè¡¨ç›˜'
                };
                
                showNotification(`å·²åˆ‡æ¢åˆ°${typeNames[type] || 'æœªçŸ¥ç±»å‹'}`, 'success');
            }
        })
        .catch(error => {
            console.error('åŠ è½½ä»ªè¡¨ç›˜ç±»å‹æ•°æ®å¤±è´¥:', error);
            showNotification('åˆ‡æ¢ä»ªè¡¨ç›˜ç±»å‹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        });
}

// ä»ä»ªè¡¨ç›˜APIæ•°æ®ç”Ÿæˆå›¾è¡¨æ•°æ®
function generateDashboardChartData(data, dashboardType = 'comprehensive') {
    console.log('[indicators_management] generateDashboardChartData type:', dashboardType);
    
    const trends = data.key_trends?.fault_volume_trend || {};
    const times = [];
    let values = [];
    
    // ç”Ÿæˆè¿‡å»7å¤©çš„æ—¥æœŸ
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        times.push(date.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' }));
    }
    
    // æ ¹æ®ä»ªè¡¨ç›˜ç±»å‹ç”Ÿæˆä¸åŒçš„æ•°æ®
    switch(dashboardType) {
        case 'fault_focused': // æ•…éšœèšç„¦ - æ˜¾ç¤ºæ•…éšœç›¸å…³æ•°æ®
            values = times.map(() => {
                const baseValue = Math.floor(Math.random() * 15) + 5; // 5-20æ•…éšœ
                return {
                    severe: Math.floor(Math.random() * 5) + 1,      // ä¸¥é‡æ•…éšœ1-6ä¸ª
                    normal: baseValue - Math.floor(Math.random() * 3), // ä¸€èˆ¬æ•…éšœ
                    resolved: baseValue + Math.floor(Math.random() * 5) // å·²è§£å†³æ•°é‡
                };
            });
            break;
            
        case 'performance_focused': // æ€§èƒ½èšç„¦ - æ˜¾ç¤ºæ€§èƒ½æŒ‡æ ‡
            values = times.map(() => {
                return {
                    response_time: Math.floor(Math.random() * 100) + 80,  // å“åº”æ—¶é—´80-180ms
                    cpu_usage: Math.floor(Math.random() * 40) + 30,       // CPUä½¿ç”¨ç‡30-70%
                    memory_usage: Math.floor(Math.random() * 35) + 45,    // å†…å­˜ä½¿ç”¨ç‡45-80%
                    throughput: Math.floor(Math.random() * 500) + 200     // ååé‡200-700
                };
            });
            break;
            
        case 'custom': // è‡ªå®šä¹‰ä»ªè¡¨ç›˜
            values = times.map(() => {
                return {
                    metric1: Math.floor(Math.random() * 50) + 25,
                    metric2: Math.floor(Math.random() * 80) + 40,
                    metric3: Math.floor(Math.random() * 100) + 50
                };
            });
            break;
            
        case 'comprehensive': // ç»¼åˆä»ªè¡¨ç›˜ - åŸæœ‰é€»è¾‘
        default:
            // è½¬æ¢è¶‹åŠ¿æ•°æ®ä¸ºæ—¶é—´åºåˆ—
            if (Object.keys(trends).length > 0) {
                Object.keys(trends).sort().slice(-7).forEach(date => {
                    values.push(trends[date].total_count || 0);
                });
            } else {
                // å¦‚æœæ²¡æœ‰çœŸå®æ•°æ®ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
                values = times.map(() => Math.floor(Math.random() * 25) + 5);
            }
            break;
    }
    
    const result = {
        times: times,
        values: values,
        dashboardType: dashboardType,
        realtime_data: data.realtime_data || {}
    };
    
    console.log('[indicators_management] generateDashboardChartData result:', result);
    return result;
}

// æ¸²æŸ“å®æ—¶ä»ªè¡¨ç›˜
function renderRealtimeDashboard(data) {
    console.log('[indicators_management] renderRealtimeDashboard data:', data);
    
    if (realtimeDashboardChart) {
        realtimeDashboardChart.dispose();
    }
    
    const chartContainer = document.getElementById('realtime-dashboard-chart');
    if (!chartContainer || chartContainer.offsetWidth === 0) {
        setTimeout(() => renderRealtimeDashboard(data), 100);
        return;
    }
    
    realtimeDashboardChart = echarts.init(chartContainer);
    
    // æ ¹æ®ä»ªè¡¨ç›˜ç±»å‹ç”Ÿæˆä¸åŒçš„å›¾è¡¨é…ç½®
    let option = {
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: []
        },
        xAxis: {
            type: 'category',
            data: data?.times || []
        },
        yAxis: {
            type: 'value'
        },
        series: []
    };
    
    // æ ¹æ®ä»ªè¡¨ç›˜ç±»å‹é…ç½®ä¸åŒçš„ç³»åˆ—
    const dashboardType = data?.dashboardType || 'comprehensive';
    
    switch(dashboardType) {
        case 'fault_focused': // æ•…éšœèšç„¦
            option.legend.data = ['ä¸¥é‡æ•…éšœ', 'ä¸€èˆ¬æ•…éšœ', 'å·²è§£å†³'];
            option.series = [
                {
                    name: 'ä¸¥é‡æ•…éšœ',
                    type: 'bar',
                    data: data?.values?.map(v => v.severe) || [],
                    itemStyle: { color: '#ef4444' }
                },
                {
                    name: 'ä¸€èˆ¬æ•…éšœ', 
                    type: 'bar',
                    data: data?.values?.map(v => v.normal) || [],
                    itemStyle: { color: '#f59e0b' }
                },
                {
                    name: 'å·²è§£å†³',
                    type: 'line',
                    data: data?.values?.map(v => v.resolved) || [],
                    smooth: true,
                    itemStyle: { color: '#10b981' }
                }
            ];
            break;
            
        case 'performance_focused': // æ€§èƒ½èšç„¦
            option.legend.data = ['å“åº”æ—¶é—´', 'CPUä½¿ç”¨ç‡', 'å†…å­˜ä½¿ç”¨ç‡'];
            option.yAxis = [
                { type: 'value', name: 'æ—¶é—´(ms)', position: 'left' },
                { type: 'value', name: 'ä½¿ç”¨ç‡(%)', position: 'right' }
            ];
            option.series = [
                {
                    name: 'å“åº”æ—¶é—´',
                    type: 'line',
                    yAxisIndex: 0,
                    data: data?.values?.map(v => v.response_time) || [],
                    smooth: true,
                    itemStyle: { color: '#3b82f6' }
                },
                {
                    name: 'CPUä½¿ç”¨ç‡',
                    type: 'bar',
                    yAxisIndex: 1,
                    data: data?.values?.map(v => v.cpu_usage) || [],
                    itemStyle: { color: '#8b5cf6' }
                },
                {
                    name: 'å†…å­˜ä½¿ç”¨ç‡',
                    type: 'bar',
                    yAxisIndex: 1,
                    data: data?.values?.map(v => v.memory_usage) || [],
                    itemStyle: { color: '#06b6d4' }
                }
            ];
            break;
            
        case 'custom': // è‡ªå®šä¹‰
            option.legend.data = ['æŒ‡æ ‡1', 'æŒ‡æ ‡2', 'æŒ‡æ ‡3'];
            option.series = [
                {
                    name: 'æŒ‡æ ‡1',
                    type: 'line',
                    data: data?.values?.map(v => v.metric1) || [],
                    smooth: true,
                    itemStyle: { color: '#f59e0b' }
                },
                {
                    name: 'æŒ‡æ ‡2',
                    type: 'bar',
                    data: data?.values?.map(v => v.metric2) || [],
                    itemStyle: { color: '#8b5cf6' }
                },
                {
                    name: 'æŒ‡æ ‡3',
                    type: 'line',
                    data: data?.values?.map(v => v.metric3) || [],
                    smooth: true,
                    itemStyle: { color: '#10b981' }
                }
            ];
            break;
            
        case 'comprehensive': // ç»¼åˆä»ªè¡¨ç›˜
        default:
            option.legend.data = ['æ•…éšœæ•°é‡'];
            option.series = [{
                name: 'æ•…éšœæ•°é‡',
                type: 'line',
                data: data?.values || [],
                smooth: true,
                itemStyle: { color: '#3b82f6' },
                areaStyle: { opacity: 0.3 }
            }];
            break;
    }
    
    realtimeDashboardChart.setOption(option);
    console.log('å®æ—¶ä»ªè¡¨ç›˜å›¾è¡¨æ¸²æŸ“å®Œæˆï¼Œç±»å‹:', dashboardType);
}

// åŠ è½½ç›®æ ‡æ•°æ®
function loadTargetsData() {
    console.log('[indicators_management] loadTargetsData');
    
    // ç”±äºç›®æ ‡ç®¡ç†APIæ˜¯POSTæ–¹æ³•ï¼Œè¿™é‡Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
    const mockTargetsData = generateMockTargetsData();
    console.log('ç”Ÿæˆçš„ç›®æ ‡æ•°æ®:', mockTargetsData);
    renderTargetsProgress(mockTargetsData);
}

// ç”Ÿæˆæ¨¡æ‹Ÿç›®æ ‡è¿›åº¦æ•°æ®
function generateMockTargetsData() {
    return {
        categories: ['æ•…éšœè§£å†³æ—¶é—´', 'ç³»ç»Ÿå¯ç”¨æ€§', 'ä¸»åŠ¨å‘ç°ç‡', 'å®¢æˆ·æ»¡æ„åº¦'],
        targets: [4, 99.5, 70, 85],
        actuals: [5.74, 95.2, 55.26, 75]
    };
}

// æ¸²æŸ“ç›®æ ‡è¿›åº¦å›¾è¡¨
function renderTargetsProgress(data) {
    if (targetsProgressChart) {
        targetsProgressChart.dispose();
    }
    
    const chartContainer = document.getElementById('targets-progress-chart');
    if (!chartContainer || chartContainer.offsetWidth === 0) {
        setTimeout(() => renderTargetsProgress(data), 100);
        return;
    }
    
    targetsProgressChart = echarts.init(chartContainer);
    
    const option = {
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['ç›®æ ‡å€¼', 'å®é™…å€¼']
        },
        xAxis: {
            type: 'category',
            data: data?.categories || ['æ•…éšœè§£å†³æ—¶é—´', 'ç³»ç»Ÿå¯ç”¨æ€§', 'ä¸»åŠ¨å‘ç°ç‡', 'å®¢æˆ·æ»¡æ„åº¦']
        },
        yAxis: {
            type: 'value'
        },
        series: [
            {
                name: 'ç›®æ ‡å€¼',
                type: 'bar',
                data: data?.targets || [4, 99.9, 80, 90],
                itemStyle: { color: '#10b981' }
            },
            {
                name: 'å®é™…å€¼',
                type: 'bar',
                data: data?.actuals || [3.5, 99.5, 85, 88],
                itemStyle: { color: '#3b82f6' }
            }
        ]
    };
    
    targetsProgressChart.setOption(option);
    console.log('ç›®æ ‡è¿›åº¦å›¾è¡¨æ¸²æŸ“å®Œæˆ');
}

// åˆ·æ–°æ•°æ®
function refreshData() {
    loadIndicatorsData();
    loadPerformanceData();
    loadDashboardData();
    loadTargetsData();
}

// å…¨å±€å›¾è¡¨è‡ªé€‚åº”
function resizeAllCharts() {
    [indicatorsTrendChart, indicatorsDistributionChart, performanceChart, realtimeDashboardChart, targetsProgressChart]
        .forEach(chart => {
            if (chart) {
                try {
                    chart.resize();
                } catch(e) {
                    console.warn('Chart resize failed:', e);
                }
            }
        });
}

// çª—å£å°ºå¯¸å˜åŒ–æ—¶å…¨å±€è‡ªé€‚åº”
window.addEventListener('resize', resizeAllCharts);

// é¡µé¢ç¦»å¼€æ—¶æ¸…ç†
window.addEventListener('beforeunload', function() {
    [indicatorsTrendChart, indicatorsDistributionChart, performanceChart, realtimeDashboardChart, targetsProgressChart]
        .forEach(chart => {
            if (chart) {
                try {
                    chart.dispose();
                } catch(e) {}
            }
        });
});

// ç›®æ ‡è®¾ç½®è¡¨å•æäº¤
document.getElementById('targets-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    console.log('[indicators_management] è¡¨å•æäº¤å¼€å§‹');
    
    const formData = new FormData(this);
    const targets = {};
    
    // æ”¶é›†è¡¨å•æ•°æ®
    for (let [key, value] of formData.entries()) {
        targets[key] = parseFloat(value) || value; // å°è¯•è½¬æ¢ä¸ºæ•°å­—
        console.log(`è¡¨å•å­—æ®µ ${key}:`, value);
    }
    
    console.log('å‡†å¤‡å‘é€çš„ç›®æ ‡æ•°æ®:', targets);
    
    // éªŒè¯å¿…å¡«å­—æ®µ
    const requiredFields = ['resolution_time_target', 'availability_target', 'proactive_discovery_target', 'customer_satisfaction_target'];
    const missingFields = requiredFields.filter(field => !targets[field]);
    
    if (missingFields.length > 0) {
        showNotification(`è¯·å¡«å†™ä»¥ä¸‹å¿…å¡«å­—æ®µ: ${missingFields.join(', ')}`, 'error');
        return;
    }
    
    // ç¦ç”¨æäº¤æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'ä¿å­˜ä¸­...';
    
    fetch('/fault/api/indicators/targets', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(targets)
    })
    .then(response => {
        console.log('APIå“åº”çŠ¶æ€:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('ä¿å­˜ç›®æ ‡è®¾ç½®APIå“åº”:', data);
        if (data.success) {
            showNotification('ç›®æ ‡è®¾ç½®å·²æˆåŠŸä¿å­˜ï¼', 'success');
            loadTargetsData(); // é‡æ–°åŠ è½½ç›®æ ‡æ•°æ®
            
            // æ¸…ç©ºè¡¨å•
            this.reset();
        } else {
            showNotification('ä¿å­˜å¤±è´¥: ' + (data.message || 'æœåŠ¡å™¨è¿”å›é”™è¯¯'), 'error');
        }
    })
    .catch(error => {
        console.error('ä¿å­˜ç›®æ ‡è®¾ç½®å¤±è´¥:', error);
        if (error.message.includes('Failed to fetch')) {
            showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', 'error');
        } else if (error.message.includes('HTTP error')) {
            showNotification('æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜', 'error');
        } else {
            showNotification('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    })
    .finally(() => {
        // æ¢å¤æäº¤æŒ‰é’®çŠ¶æ€
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    });
});
</script>
{% endblock %}