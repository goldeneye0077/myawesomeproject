{% extends "base.html" %}

{% block title %}故障指标数据管理 - 网络视界指标后台管理{% endblock %}

{% block page_title %}故障指标数据管理{% endblock %}

{% block breadcrumb %}
    <li><span class="text-gray-300">/</span></li>
    <li><span class="text-gray-500">契约化指标分析</span></li>
    <li><span class="text-gray-300">/</span></li>
    <li><span class="text-gray-500">故障指标分析</span></li>
    <li><span class="text-gray-300">/</span></li>
    <li><span class="text-primary-600">故障指标数据管理</span></li>
{% endblock %}

{% block content %}
<!-- 故障数据列表卡片 -->
<div class="card">
    <h2 class="card-title">故障指标数据管理</h2>

    <!-- 筛选表单 -->
    <form method="get" id="filterForm" style="margin-bottom: 18px; display: flex; gap: 18px; align-items: center; flex-wrap: wrap;">
        <label>故障类型：
            <select name="fault_type" onchange="document.getElementById('filterForm').submit();" style="min-width: 120px;">
                <option value="">全部</option>
                {% for type in all_fault_types %}
                <option value="{{ type }}" {% if current_fault_type==type %}selected{% endif %}>{{ type }}</option>
                {% endfor %}
            </select>
        </label>
        <label>原因分类：
            <select name="cause_category" onchange="document.getElementById('filterForm').submit();" style="min-width: 120px;">
                <option value="">全部</option>
                {% for category in all_cause_categories %}
                <option value="{{ category }}" {% if current_cause_category==category %}selected{% endif %}>{{ category }}</option>
                {% endfor %}
            </select>
        </label>
        <label>通报级别：
            <select name="notification_level" onchange="document.getElementById('filterForm').submit();" style="min-width: 100px;">
                <option value="">全部</option>
                {% for level in all_notification_levels %}
                <option value="{{ level }}" {% if current_notification_level==level %}selected{% endif %}>{{ level }}</option>
                {% endfor %}
            </select>
        </label>
        <input type="hidden" name="page" value="1">
    </form>

    <!-- 操作按钮区 -->
    <div class="action-bar">
        <div class="action-left">
            <a href="/fault/add_fault_data" class="btn btn-primary">添加故障数据</a>
            <a href="/fault/import_fault_data" class="btn btn-secondary">批量导入</a>
            <a href="/fault/export_fault_data" class="btn btn-success">导出数据</a>
        </div>
        <div class="action-right">
            <span id="selectedCount" class="selected-count">0 项已选中</span>
            <button type="button" id="batchDeleteBtn" class="btn btn-danger" disabled>批量删除</button>
        </div>
    </div>

    <div class="data-table-container">
        <table class="data-table">
            <thead class="sticky-header">
                <tr>
                    <th class="checkbox-column">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    </th>
                    <th style="min-width: 130px;" title="故障发生的日期和时间">故障日期</th>
                    <th title="故障的具体名称和描述">故障名称</th>
                    <th title="省级对故障类型的分类">省-故障类型</th>
                    <th title="故障原因的分类类型">原因分类</th>
                    <th title="故障通报的级别和重要性">通报级别</th>
                    <th title="故障处理所耗费的时间（小时）">处理时长(小时)</th>
                    <th title="是否为主动发现的故障">主动发现</th>
                    <th style="min-width: 130px;" title="故障开始发生的具体时间">发生时间</th>
                    <th style="min-width: 130px;" title="故障处理完成的具体时间">结束时间</th>
                    <th title="用户投诉的具体情况和处理结果">投诉情况</th>
                    <th title="引起故障的具体原因分析">故障原因</th>
                    <th title="故障的处理过程和解决方案">故障处理</th>
                    <th title="省级对故障原因的分类">省-原因分类</th>
                    <th title="省级对故障原因的详细分析">省-故障原因分析</th>
                    <th title="其他补充说明和备注信息">备注</th>
                    <th style="min-width: 100px;" title="记录创建的日期和时间">创建时间</th>
                    <th style="min-width: 100px;" title="记录最后修改的日期和时间">更新时间</th>
                    <th title="编辑、删除、查看等操作按钮">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for item in fault_data_list %}
                <tr>
                    <td class="checkbox-column">
                        <input type="checkbox" class="row-checkbox" value="{{ item.id }}" onchange="updateSelectedCount()">
                    </td>
                    <td title="{{ item.fault_date.strftime('%Y-%m-%d %H:%M:%S') if item.fault_date else '无日期' }}" style="min-width: 130px; white-space: nowrap;">
                        {{ item.fault_date.strftime('%Y-%m-%d %H:%M') if item.fault_date else '-' }}
                    </td>
                    <td title="{{ item.fault_name or '' }}" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        {{ (item.fault_name[:30] + '...') if item.fault_name and item.fault_name|length > 30 else (item.fault_name or '-') }}
                    </td>
                    <td>{{ item.province_fault_type or '-' }}</td>
                    <td>{{ item.cause_category or '-' }}</td>
                    <td>
                        <span class="badge {% if item.notification_level and ('重大' in item.notification_level or '严重' in item.notification_level) %}badge-danger{% elif item.notification_level and '一般' in item.notification_level %}badge-warning{% else %}badge-info{% endif %}">
                            {{ item.notification_level or '-' }}
                        </span>
                    </td>
                    <td>{{ "{:.2f}".format(item.fault_duration_hours) if item.fault_duration_hours else '-' }}</td>
                    <td>
                        <span class="badge {% if item.is_proactive_discovery == '是' %}badge-success{% elif item.is_proactive_discovery == '否' %}badge-secondary{% else %}badge-light{% endif %}">
                            {{ item.is_proactive_discovery or '-' }}
                        </span>
                    </td>
                    <td title="{{ item.start_time.strftime('%Y-%m-%d %H:%M:%S') if item.start_time else '无发生时间' }}" style="min-width: 130px; white-space: nowrap;">
                        {{ item.start_time.strftime('%Y-%m-%d %H:%M') if item.start_time else '-' }}
                    </td>
                    <td title="{{ item.end_time.strftime('%Y-%m-%d %H:%M:%S') if item.end_time else '无结束时间' }}" style="min-width: 130px; white-space: nowrap;">
                        {{ item.end_time.strftime('%Y-%m-%d %H:%M') if item.end_time else '-' }}
                    </td>
                    <td title="{{ item.complaint_situation or '' }}" style="max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        {{ (item.complaint_situation[:20] + '...') if item.complaint_situation and item.complaint_situation|length > 20 else (item.complaint_situation or '-') }}
                    </td>
                    <td title="{{ item.fault_cause or '' }}" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        {{ (item.fault_cause[:30] + '...') if item.fault_cause and item.fault_cause|length > 30 else (item.fault_cause or '-') }}
                    </td>
                    <td title="{{ item.fault_handling or '' }}" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        {{ (item.fault_handling[:30] + '...') if item.fault_handling and item.fault_handling|length > 30 else (item.fault_handling or '-') }}
                    </td>
                    <td>{{ item.province_cause_category or '-' }}</td>
                    <td title="{{ item.province_cause_analysis or '' }}" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        {{ (item.province_cause_analysis[:30] + '...') if item.province_cause_analysis and item.province_cause_analysis|length > 30 else (item.province_cause_analysis or '-') }}
                    </td>
                    <td title="{{ item.remarks or '' }}" style="max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        {{ (item.remarks[:20] + '...') if item.remarks and item.remarks|length > 20 else (item.remarks or '-') }}
                    </td>
                    <td title="{{ item.created_at.strftime('%Y-%m-%d %H:%M:%S') if item.created_at else '无创建时间' }}" style="min-width: 100px; white-space: nowrap;">
                        {{ item.created_at.strftime('%Y-%m-%d') if item.created_at else '-' }}
                    </td>
                    <td title="{{ item.updated_at.strftime('%Y-%m-%d %H:%M:%S') if item.updated_at else '无更新时间' }}" style="min-width: 100px; white-space: nowrap;">
                        {{ item.updated_at.strftime('%Y-%m-%d') if item.updated_at else '-' }}
                    </td>
                    <td class="action-column">
                        <div class="action-buttons">
                            <a href="/fault/edit_fault_data/{{ item.id }}" class="btn-xs btn-primary" title="编辑">编辑</a>
                            <a href="/fault/delete_fault_data/{{ item.id }}" class="btn-xs btn-danger" onclick="return confirm('确定要删除吗？');" title="删除">删除</a>
                            <a href="/fault/view_fault_data/{{ item.id }}" class="btn-xs btn-info" title="详情">详情</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- 分页控件 -->
    <div class="pagination" style="margin-top: 18px; display: flex; justify-content: center; align-items: center; gap: 8px;">
        {% if page > 1 %}
            <a href="?page=1{% if current_fault_type %}&fault_type={{ current_fault_type }}{% endif %}{% if current_cause_category %}&cause_category={{ current_cause_category }}{% endif %}{% if current_notification_level %}&notification_level={{ current_notification_level }}{% endif %}" class="page-link">首页</a>
            <a href="?page={{ page - 1 }}{% if current_fault_type %}&fault_type={{ current_fault_type }}{% endif %}{% if current_cause_category %}&cause_category={{ current_cause_category }}{% endif %}{% if current_notification_level %}&notification_level={{ current_notification_level }}{% endif %}" class="page-link">上一页</a>
        {% endif %}
        <span>第 {{ page }} / {{ pages }} 页</span>
        {% if page < pages %}
            <a href="?page={{ page + 1 }}{% if current_fault_type %}&fault_type={{ current_fault_type }}{% endif %}{% if current_cause_category %}&cause_category={{ current_cause_category }}{% endif %}{% if current_notification_level %}&notification_level={{ current_notification_level }}{% endif %}" class="page-link">下一页</a>
            <a href="?page={{ pages }}{% if current_fault_type %}&fault_type={{ current_fault_type }}{% endif %}{% if current_cause_category %}&cause_category={{ current_cause_category }}{% endif %}{% if current_notification_level %}&notification_level={{ current_notification_level }}{% endif %}" class="page-link">末页</a>
        {% endif %}
        <span style="margin-left:12px;">共 {{ total }} 条</span>
    </div>
</div>

<style>
.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: 500;
}
.badge-danger { background-color: #dc3545; color: white; }
.badge-warning { background-color: #ffc107; color: #212529; }
.badge-success { background-color: #28a745; color: white; }
.badge-info { background-color: #17a2b8; color: white; }
.badge-secondary { background-color: #6c757d; color: white; }
.badge-light { background-color: #f8f9fa; color: #212529; border: 1px solid #dee2e6; }

/* 批量操作样式 */
.action-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.action-left, .action-right {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.selected-count {
    font-size: 0.9em;
    color: #6c757d;
    margin-right: 0.5rem;
}

.checkbox-column {
    width: 40px;
    text-align: center;
    padding: 6px 4px !important;
}

.checkbox-column input[type="checkbox"] {
    margin: 0;
    cursor: pointer;
}

.row-checkbox:checked {
    accent-color: #007bff;
}

#selectAll {
    cursor: pointer;
}

.data-table th, .data-table td {
    padding: 6px 4px;
    font-size: 0.8em;
    line-height: 1.3;
    vertical-align: middle;
}

.data-table {
    font-size: 0.8em;
}

.data-table th {
    font-size: 0.75em;
    font-weight: 600;
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    white-space: nowrap;
}

.data-table tbody tr:hover {
    background-color: #f5f5f5;
}

.data-table-container {
    overflow-x: auto;
    max-width: 100%;
}

/* 操作列样式 */
.action-column {
    min-width: 120px;
    width: 120px;
    text-align: center;
    padding: 4px 2px !important;
}

.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 2px;
    align-items: center;
}

/* 小按钮样式 */
.btn-xs {
    display: inline-block;
    padding: 2px 6px;
    font-size: 0.7em;
    line-height: 1.2;
    border-radius: 3px;
    text-decoration: none;
    color: white;
    font-weight: 500;
    min-width: 32px;
    text-align: center;
    transition: all 0.2s ease;
}

.btn-xs:hover {
    text-decoration: none;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.btn-primary {
    background-color: #007bff;
    border: 1px solid #007bff;
}

.btn-primary:hover {
    background-color: #0056b3;
    border-color: #0056b3;
}

.btn-danger {
    background-color: #dc3545;
    border: 1px solid #dc3545;
}

.btn-danger:hover {
    background-color: #c82333;
    border-color: #bd2130;
}

.btn-info {
    background-color: #17a2b8;
    border: 1px solid #17a2b8;
}

.btn-info:hover {
    background-color: #138496;
    border-color: #117a8b;
}

/* 分页样式 */
.pagination {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.page-link {
    display: inline-block;
    padding: 8px 12px;
    margin: 0 2px;
    text-decoration: none;
    color: #007bff;
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 0.9em;
    transition: all 0.2s ease;
}

.page-link:hover {
    color: #0056b3;
    background-color: #e9ecef;
    border-color: #adb5bd;
    text-decoration: none;
}

.page-link:active {
    color: #fff;
    background-color: #007bff;
    border-color: #007bff;
}

.pagination span {
    padding: 8px 12px;
    margin: 0 4px;
    font-size: 0.9em;
    color: #6c757d;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .action-buttons {
        flex-direction: row;
        gap: 1px;
    }
    
    .btn-xs {
        padding: 1px 4px;
        font-size: 0.65em;
        min-width: 28px;
    }
    
    .action-column {
        min-width: 100px;
        width: 100px;
    }
}
</style>

<script>
// 全选/取消全选功能
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    
    rowCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateSelectedCount();
}

// 更新选中数量
function updateSelectedCount() {
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
    const selectAllCheckbox = document.getElementById('selectAll');
    const selectedCountSpan = document.getElementById('selectedCount');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    
    const selectedCount = checkedBoxes.length;
    const totalCount = rowCheckboxes.length;
    
    // 更新选中数量显示
    selectedCountSpan.textContent = `${selectedCount} 项已选中`;
    
    // 更新批量删除按钮状态
    batchDeleteBtn.disabled = selectedCount === 0;
    
    // 更新全选复选框状态
    if (selectedCount === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (selectedCount === totalCount) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
        selectAllCheckbox.checked = false;
    }
}

// 批量删除功能
function batchDelete() {
    console.log('批量删除函数被调用');
    const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
    console.log('选中的复选框数量:', checkedBoxes.length);
    
    if (checkedBoxes.length === 0) {
        alert('请先选择要删除的记录');
        return;
    }
    
    const selectedIds = Array.from(checkedBoxes).map(checkbox => checkbox.value);
    const confirmMessage = `确定要删除选中的 ${selectedIds.length} 条记录吗？此操作不可撤销。`;
    
    if (confirm(confirmMessage)) {
        // 创建表单并提交
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/fault/batch_delete';
        form.style.display = 'none';
        
        selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ids';
            input.value = id;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('页面加载完成');
    updateSelectedCount();
    
    // 绑定批量删除按钮事件
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    console.log('批量删除按钮:', batchDeleteBtn);
    if (batchDeleteBtn) {
        batchDeleteBtn.addEventListener('click', batchDelete);
        console.log('批量删除按钮事件已绑定');
    }
});
</script>
{% endblock %}

{% block scripts %}
<script>
    function confirmDelete(id) {
        if (confirm('确定要删除这条故障数据记录吗？此操作不可恢复。')) {
            window.location.href = '/delete_fault_data/' + id;
        }
    }
</script>
{% endblock %}
